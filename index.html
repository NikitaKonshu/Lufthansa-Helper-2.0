<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lufthansa Helper — Liquid Glass</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-top:#041426; --bg-bot:#072b3a;
  --accent:#ffd54a; --accent-2:#ffb54a;
  --muted:#9fc0d8; --text:#eaf4ff;
  --radius:12px;
  --blur: blur(10px);
  font-family: Inter, system-ui, Roboto, Arial, sans-serif;
  font-size:15px;
}

/* Reset */
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  margin:0;padding:20px;
  background: linear-gradient(180deg,var(--bg-top),var(--bg-bot));
  color:var(--text); -webkit-font-smoothing:antialiased;
  display:flex;justify-content:center;align-items:flex-start;
}

/* Container */
.container{width:100%;max-width:1120px}

/* Glass card */
.card{border-radius:14px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border:1px solid rgba(255,255,255,0.03);backdrop-filter:var(--blur);box-shadow:0 18px 48px rgba(2,8,20,0.5)}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:14px;background:linear-gradient(90deg,#06384a,#073a4f)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#073842,#043430);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);font-size:18px}
.title{font-weight:800}
.subtitle{font-size:12px;color:var(--muted)}

/* Right header */
.header-right{display:flex;gap:10px;align-items:center}
.session-badge{padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);color:var(--muted);font-weight:700}

/* Buttons */
.btn{
  padding:10px 14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
  color:var(--text); border:1px solid rgba(255,255,255,0.06); font-weight:800; cursor:pointer;
  box-shadow: 0 18px 48px rgba(2,8,20,0.45), inset 0 6px 18px rgba(255,255,255,0.03);
  transition: transform .16s ease, box-shadow .16s ease;
  backdrop-filter: var(--blur);
}
.btn:active{ transform: translateY(2px); box-shadow: 0 8px 24px rgba(2,8,20,0.45); }
.btn-primary{
  background: linear-gradient(180deg,var(--accent),var(--accent-2)); color:#04202a; border:none;
  box-shadow: 0 30px 100px rgba(255,150,40,0.12), inset 0 -8px 20px rgba(255,255,255,0.06);
}
.btn-primary:active{ transform: translateY(2px) scale(.997); }

/* Pill filter (compact) */
.btn-pill{padding:6px 10px;border-radius:999px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:700;cursor:pointer}
.btn-pill.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#04202a;transform:translateY(-3px)}

/* Layout */
.layout{margin-top:14px;display:grid;grid-template-columns:1fr 320px;gap:14px}
@media(max-width:1000px){ .layout{grid-template-columns:1fr} }

/* Main area */
.main-card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:10px}
.tab{padding:8px 12px;border-radius:10px;background:transparent;color:var(--muted);cursor:pointer;font-weight:800}
.tab.active{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#04202a;transform:translateY(-3px)}

/* Generator area (compact filters) */
.generator{display:flex;flex-direction:column;gap:12px}
.filter-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.filters-compact{display:flex;gap:6px;align-items:center;flex-wrap:wrap}

/* Smaller pill sizes to fit screen */
.filters-compact .btn-pill{padding:6px 8px;font-size:13px}
.filters-compact select{padding:8px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--text)}

/* Right panel */
.right-panel{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
.confirmed{margin-top:8px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(200,245,194,0.06), rgba(0,0,0,0.02));border-left:4px solid #c8f5c2}

/* Directions list */
.route-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
.route-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02);cursor:pointer}

/* Fleet list */
.fleet-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
.fleet-item{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border:1px solid rgba(255,255,255,0.02)}

/* Sidebar pilots & log */
.sidebar-card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);margin-bottom:12px}
.pilot-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);background:transparent}

/* Modal (login) - blocks UI */
.modal-back{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:9999}
.modal{width:min(640px,94%);padding:18px;border-radius:12px;background:linear-gradient(180deg,#062b31,#04222a);border:1px solid rgba(255,255,255,0.03)}

/* small utilities */
.kv{font-size:13px;color:var(--muted)}
.hidden{display:none}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
select.input{appearance:none}
.small{font-size:13px}

/* --- Improved generate button styles (replace previous button) --- */
:root{
  --gen-accent-1: #ffd54a;
  --gen-accent-2: #ffb84d;
  --gen-text: #04202a;
  --gen-radius: 14px;
}
.gen-btn{
  --pad-x: 20px; --pad-y: 12px;
  position:relative; display:inline-flex; align-items:center; gap:10px;
  padding:var(--pad-y) var(--pad-x); min-width:160px; border-radius:var(--gen-radius);
  border:0; cursor:pointer; user-select:none; font-weight:800; font-family:Inter, system-ui, sans-serif;
  font-size:15px; color:var(--gen-text);
  background: linear-gradient(180deg, var(--gen-accent-1), var(--gen-accent-2));
  box-shadow: 0 28px 80px rgba(2,8,20,0.55), inset 0 10px 30px rgba(255,255,255,0.12);
  transition: transform 180ms cubic-bezier(.2,.9,.2,1), box-shadow 180ms, filter 180ms;
  overflow:hidden;
}
.gen-btn::before{
  content:""; position:absolute; inset:0; border-radius:var(--gen-radius); pointer-events:none;
  box-shadow: inset 0 2px 0 rgba(255,255,255,0.18);
}
.gen-btn:hover{ transform:translateY(-4px) scale(1.01); box-shadow: 0 44px 120px rgba(255,160,40,0.14); filter: saturate(1.02); }
.gen-btn:active{ transform: translateY(-1px) scale(.998); box-shadow: 0 12px 40px rgba(2,8,20,0.45); }
.gen-btn[disabled]{ opacity:0.6; cursor:not-allowed; transform:none; box-shadow: none; }
.gen-btn .label{ display:inline-block; line-height:1; }
.gen-btn .icon{ width:18px;height:18px; flex:0 0 18px; display:inline-block; }
.gen-btn .ripple{ position:absolute;border-radius:999px;transform:scale(0); background: radial-gradient(circle,#ffffff 0%, rgba(255,255,255,0.6) 30%, rgba(255,255,255,0) 70%); opacity:0; pointer-events:none; transition: transform 420ms cubic-bezier(.2,.9,.2,1), opacity 420ms; }
.gen-btn .spinner{ display:none; width:18px;height:18px;border-radius:50%; border:3px solid rgba(4,35,35,0.12); border-top-color:var(--gen-text); animation: spin 800ms linear infinite; }
@keyframes spin{ to{ transform:rotate(360deg); } }
.gen-btn.loading{ color: rgba(4,35,35,0.9); }
.gen-btn.loading .label{ opacity:0; }
.gen-btn.loading .spinner{ display:inline-block; }
.sr-only{ position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

</style>
</head>
<body>
<div class="container">
  <header class="header card">
    <div class="brand">
      <div class="logo">LH</div>
      <div>
        <div class="title">Lufthansa Helper</div>
        <div class="subtitle small">Liquid Glass UI</div>
      </div>
    </div>

    <div class="header-right">
      <div id="sessionBadge" class="session-badge">Неавторизован</div>
      <button id="logoutBtn" class="btn" style="display:none">Выйти</button>
      <button id="openGateBtn" class="btn btn-primary">Войти</button>
    </div>
  </header>

  <div class="layout">
    <main>
      <div class="main-card card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:900">Генерация рейсов</div>
            <div class="kv">Здесь только фильтры и генерация. Просмотр маршрутов во вкладке «Направления».</div>
          </div>
        </div>

        <div class="tabs" style="margin-top:12px">
          <div id="tabGenerate" class="tab active">Генерация</div>
          <div id="tabRoutes" class="tab">Направления</div>
          <div id="tabFleet" class="tab">Флот</div>
        </div>

        <!-- Panels -->
        <div id="panelGenerate" class="generator" >
          <div class="filter-row">
            <div class="filters-compact" id="airlines"></div>
            <div class="filters-compact" id="durations" style="margin-left:8px"></div>
            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
              <div id="pilotBadge" class="btn" style="min-width:200px;display:flex;justify-content:space-between"><span class="small kv">Пилот</span><strong id="pilotName">—</strong></div>

              <!-- Improved generate button -->
              <div class="gen-wrap">
                <button id="genBtn" class="gen-btn" aria-label="Сгенерировать рейс" title="Сгенерировать рейс" type="button">
                  <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5v14M5 12h14" stroke="#062323" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  <span class="label">Сгенерировать</span>
                  <span class="spinner" aria-hidden="true"></span>
                  <span class="ripple" aria-hidden="true"></span>
                  <span class="sr-only">Запустить процесс генерации рейса</span>
                </button>
              </div>

              <button id="resetBtn" class="btn">Сброс</button>
            </div>
          </div>
          <div class="kv">Список предложенных рейсов убран. Открой «Направления», чтобы просмотреть все маршруты.</div>
        </div>

        <div id="panelRoutes" class="hidden">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div>
              <div style="font-weight:800">Направления</div>
              <div class="kv small">Фильтры: авиакомпания, хаб, длительность</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="filterAirline" class="input">
                <option value="all">Все авиакомпании</option>
              </select>
              <select id="filterHub" class="input">
                <option value="all">Все хабы</option>
              </select>
              <select id="filterDuration" class="input">
                <option value="all">Все длительности</option>
                <option value="0">1–2ч</option>
                <option value="1">3–4ч</option>
                <option value="2">5–6ч</option>
                <option value="3">7–8ч</option>
              </select>
            </div>
          </div>
          <div id="routesList" class="route-list"></div>
        </div>

        <div id="panelFleet" class="hidden">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div>
              <div style="font-weight:800">Флот</div>
              <div class="kv small">Состояние самолётов</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="filterFleetAirline" class="input"><option value="all">Все</option></select>
              <select id="filterFleetStatus" class="input"><option value="all">Все статусы</option><option value="idle">idle</option><option value="reserved">reserved</option><option value="inFlight">inFlight</option></select>
            </div>
          </div>
          <div id="fleetList" class="fleet-list"></div>
        </div>

      </div>

      <!-- right panel -->
      <div class="right-panel card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Результат</div>
          <div class="kv small">Подтверждённый рейс — внизу</div>
        </div>

        <div id="confirmedSection" class="confirmed hidden"></div>
        <div id="currentFlightWrap" style="margin-top:8px"></div>
      </div>
    </main>

    <aside>
      <div class="sidebar-card card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Пилоты</div>
          <div class="kv small">Demo</div>
        </div>
        <div style="margin-top:8px"><input id="pilotSearch" class="input" placeholder="Поиск" /></div>
        <div id="pilotList" style="margin-top:8px"></div>
        <div class="kv small" style="margin-top:8px">Переключение между аккаунтами запрещено при активной сессии.</div>
      </div>

      <div class="sidebar-card card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Журнал</div>
          <div><button id="showGate" class="btn">Открыть вход</button></div>
        </div>
        <div id="assignLog" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>
</div>

<!-- Login modal (blocks UI) -->
<div id="gateModal" class="modal-back" style="display:none">
  <div class="modal">
    <h3 style="margin:0 0 8px 0;color:var(--accent)">Вход</h3>
    <div class="kv small">Введите позывной и пароль или используйте кодовое слово</div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <input id="loginCall" class="input" placeholder="Позывной" />
      <input id="loginPass" class="input" placeholder="Пароль или кодовое слово" type="password" />
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="btnLoginPilot" class="btn-primary">Войти</button>
      <button id="btnCloseGate" class="btn">Закрыть</button>
    </div>
    <div class="kv small" style="margin-top:8px">Кодовое слово: <strong>quickaccess2025</strong></div>
  </div>
</div>

<!-- Route modal -->
<div id="routeModal" class="modal-back" style="display:none">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><div id="routeTitle" style="font-weight:900"></div><div id="routeSub" class="kv small" style="margin-top:6px"></div></div>
      <div id="routeDur" class="kv small"></div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button id="routeCloseBtn" class="btn">Закрыть</button>
    </div>
  </div>
</div>

<script>
/* ================= DATA & STATE ================= */
const CODEWORD='quickaccess2025';
const SESSION_KEY='lh_session_v_final';
const CURRENT_FLIGHT_PREFIX='current_flight:';

const AIRLINES=[
  {name:"Lufthansa",hubs:["EDDF","EDDM"]},
  {name:"Eurowings",hubs:["EDDF","EDDM"]},
  {name:"SunExpress",hubs:["EDDF","EDDM"]}
];
const ROUTES=[
  {airline:"Lufthansa",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Oslo",toICAO:"ENGM",durationMinutes:120},
  {airline:"Lufthansa",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Amsterdam",toICAO:"EHAM",durationMinutes:70},
  {airline:"SunExpress",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Antalya",toICAO:"LTAI",durationMinutes:180},
  {airline:"Eurowings",fromCity:"Munich",fromICAO:"EDDM",toCity:"Zurich",toICAO:"LSZH",durationMinutes:60},
  {airline:"Lufthansa",fromCity:"Munich",fromICAO:"EDDM",toCity:"Berlin",toICAO:"EDDB",durationMinutes:50}
];
const FLEET=[
  {id:'LH-A320-01',airline:'Lufthansa',type:'A320',seats:180,turnaround:40,status:'idle',locationICAO:'EDDF'},
  {id:'EW-A320-01',airline:'Eurowings',type:'A320',seats:180,turnaround:40,status:'idle',locationICAO:'EDDM'},
  {id:'SX-B737-01',airline:'SunExpress',type:'737-800',seats:189,turnaround:35,status:'idle',locationICAO:'EDDF'}
];
let PILOTS=[
  {id:'pilot_loui',name:'Loui Desulier',callSign:'FRENCH',verified:true,password:'louiSecret'},
  {id:'pilot_ivan',name:'Ivan Petrov',callSign:'IPET',verified:true},
  {id:'pilot_anna',name:'Anna Müller',callSign:'AMUL',verified:false}
];

let FLEET_LOG=[];
let SESSION=(function(){ try{ const s=sessionStorage.getItem(SESSION_KEY); return s?JSON.parse(s):{pilotId:null}; }catch(e){return {pilotId:null}; } })();

const DURATIONS=[
  {label:"1–2ч",min:60,max:120},
  {label:"3–4ч",min:180,max:240},
  {label:"5–6ч",min:300,max:360},
  {label:"7–8ч",min:420,max:480}
];

let chosenDur=null;

/* ================= HELPERS ================= */
function uid(p='id'){return p+'_'+Math.random().toString(36).slice(2,9);}
function nowMs(){return Date.now();}
function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function saveSession(){ try{ sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); }catch(e){} }
function getCFKey(pid){ return CURRENT_FLIGHT_PREFIX + (pid||'anon'); }
function persistCurrentFlight(pilotId,obj){ try{ localStorage.setItem(getCFKey(pilotId), JSON.stringify(obj)); }catch(e){} }
function loadCurrentFlight(pilotId){ try{ const v=localStorage.getItem(getCFKey(pilotId)); return v?JSON.parse(v):null;}catch(e){return null;} }
function clearCurrentFlight(pilotId){ try{ localStorage.removeItem(getCFKey(pilotId)); }catch(e){} }

/* ================= UI REFS ================= */
const airlinesWrap=document.getElementById('airlines');
const durationsWrap=document.getElementById('durations');
const pilotNameEl=document.getElementById('pilotName');
const pilotListEl=document.getElementById('pilotList');
const pilotSearch=document.getElementById('pilotSearch');
const assignLog=document.getElementById('assignLog');
const confirmedSection=document.getElementById('confirmedSection');
const currentFlightWrap=document.getElementById('currentFlightWrap');

const filterAirline=document.getElementById('filterAirline');
const filterHub=document.getElementById('filterHub');
const filterDuration=document.getElementById('filterDuration');
const routesList=document.getElementById('routesList');

const filterFleetAirline=document.getElementById('filterFleetAirline');
const filterFleetStatus=document.getElementById('filterFleetStatus');
const fleetList=document.getElementById('fleetList');

const gateModal=document.getElementById('gateModal');
const openGateBtn=document.getElementById('openGateBtn');
const btnCloseGate=document.getElementById('btnCloseGate');
const btnLoginPilot=document.getElementById('btnLoginPilot');
const logoutBtn=document.getElementById('logoutBtn');
const sessionBadge=document.getElementById('sessionBadge');

/* Tabs */
const tabGenerate=document.getElementById('tabGenerate');
const tabRoutes=document.getElementById('tabRoutes');
const tabFleet=document.getElementById('tabFleet');
const panelGenerate=document.getElementById('panelGenerate');
const panelRoutes=document.getElementById('panelRoutes');
const panelFleet=document.getElementById('panelFleet');

/* Route modal */
const routeModal=document.getElementById('routeModal');
const routeTitleEl=document.getElementById('routeTitle');
const routeSubEl=document.getElementById('routeSub');
const routeDurEl=document.getElementById('routeDur');

/* Generate button refs */
const genBtn = document.getElementById('genBtn');
const genRipple = genBtn ? genBtn.querySelector('.ripple') : null;
const genSpinner = genBtn ? genBtn.querySelector('.spinner') : null;

/* ================= RENDER ================= */

function renderAirlines(){
  airlinesWrap.innerHTML='';
  AIRLINES.forEach(a=>{
    const btn=document.createElement('button');
    btn.className='btn-pill';
    btn.textContent=a.name;
    btn.addEventListener('click', ()=>{
      Array.from(airlinesWrap.children).forEach(n=>n.classList.remove('active'));
      btn.classList.add('active');
      filterAirline.value = a.name;
      renderRoutesPane();
    });
    airlinesWrap.appendChild(btn);
  });

  durationsWrap.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const p=document.createElement('button');
    p.className='btn-pill';
    p.textContent=d.label;
    p.dataset.i = i;
    p.addEventListener('click', ()=>{
      chosenDur = (chosenDur===i) ? null : i;
      Array.from(durationsWrap.children).forEach(n=>n.classList.toggle('active', n===p));
    });
    durationsWrap.appendChild(p);
  });
}

function renderPilots(){
  pilotListEl.innerHTML='';
  const q=(pilotSearch.value||'').toLowerCase().trim();
  const list = PILOTS.filter(p=> !q || (p.name+' '+p.callSign).toLowerCase().includes(q));
  list.forEach(p=>{
    const row=document.createElement('div'); row.className='pilot-item';
    row.innerHTML = `<div><strong>${esc(p.name)}</strong><div class="kv small">${esc(p.callSign)} ${p.verified? '· Verified':''}</div></div>`;
    const btn=document.createElement('button');
    btn.className='btn btn-primary';
    if(SESSION.pilotId){
      btn.disabled=true; btn.textContent='Недоступно'; btn.style.opacity='0.6';
    } else {
      btn.textContent='Войти';
      btn.addEventListener('click', ()=> signInAsPilot(p.id));
    }
    row.appendChild(btn);
    pilotListEl.appendChild(row);
  });
}

function renderAssignLog(){
  assignLog.innerHTML='';
  if(!FLEET_LOG.length){ assignLog.innerHTML='<div class="kv small">Пусто</div>'; return; }
  FLEET_LOG.slice(-40).reverse().forEach(e=>{
    const el=document.createElement('div'); el.className='kv small'; el.style.marginTop='6px';
    el.textContent = `${new Date(e.ts).toLocaleString()} — ${e.event}${e.aircraft? ' ' + e.aircraft : ''}${e.route? ' ' + e.route : ''}`;
    assignLog.appendChild(el);
  });
}

/* current flight render */
let intervals={};
function renderCurrentFlight(){
  currentFlightWrap.innerHTML='';
  if(!SESSION.pilotId){ pilotNameEl.textContent='—'; sessionBadge.textContent='Неавторизован'; logoutBtn.style.display='none'; openGateBtn.style.display='inline-block'; return; }
  const pilot = PILOTS.find(p=>p.id===SESSION.pilotId) || {};
  pilotNameEl.textContent = `${pilot.name || '—'} (${pilot.callSign || '—'})`;
  sessionBadge.textContent = pilot.callSign ? `Вошёл ${pilot.callSign}` : 'Вошёл';
  logoutBtn.style.display='inline-block'; openGateBtn.style.display='none';

  const cur = loadCurrentFlight(SESSION.pilotId);
  if(!cur) return;
  const el=document.createElement('div'); el.className='card'; el.style.padding='10px';
  el.innerHTML = `
    <div style="font-weight:800">${esc(cur.airline)} · ${esc(cur.route.fromICAO)}→${esc(cur.route.toICAO)}</div>
    <div class="kv small" style="margin-top:6px">Flight: ${esc(cur.flightId)} · ${esc(cur.aircraftId)}</div>
    <div class="kv small" style="margin-top:8px">Pilot: ${esc(cur.pilotName)} (${esc(cur.pilotCall)})</div>
    <div class="kv small" style="margin-top:8px">ETA: ${new Date(cur.confirmedAt + cur.etaMs).toLocaleString()}</div>
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
      <button id="mark_${esc(cur.flightId)}" class="btn btn-primary">Отметить долетел</button>
      <button id="clear_${esc(cur.flightId)}" class="btn">Удалить</button>
    </div>
  `;
  currentFlightWrap.appendChild(el);

  if(intervals[cur.flightId]) clearInterval(intervals[cur.flightId]);
  intervals[cur.flightId] = setInterval(()=>{
    const nowc = loadCurrentFlight(SESSION.pilotId);
    if(!nowc){ clearInterval(intervals[cur.flightId]); renderCurrentFlight(); return; }
    const leftNow = Math.max(0,Math.floor(((nowc.confirmedAt+nowc.etaMs)-Date.now())/1000));
    if(leftNow<=0){ clearInterval(intervals[cur.flightId]); renderCurrentFlight(); }
  },1000);

  document.getElementById('mark_'+cur.flightId).addEventListener('click', ()=>{
    if(!confirm('Отметить как долетел?')) return;
    FLEET_LOG.push({ts:nowMs(),event:'pilot_arrived',aircraft:cur.aircraftId,route:`${cur.route.fromICAO}->${cur.route.toICAO}`,pilotId:cur.pilotId});
    clearCurrentFlight(SESSION.pilotId); renderAssignLog(); renderCurrentFlight();
  });
  document.getElementById('clear_'+cur.flightId).addEventListener('click', ()=>{
    if(!confirm('Удалить запись?')) return;
    clearCurrentFlight(SESSION.pilotId); renderCurrentFlight();
  });
}

/* reservation + confirm */
function reserveAircraft(ac, ownerId, ttlMs=120000){
  if(ac.status==='inFlight') return {ok:false,reason:'inflight'};
  if(ac.status==='reserved') return {ok:false,reason:'already_reserved'};
  ac.status='reserved'; ac.reservedBy=ownerId;
  ac.reservedToken = ownerId+':'+Date.now()+':'+Math.random().toString(36).slice(2,8);
  ac.reservedUntil = nowMs()+ttlMs;
  FLEET_LOG.push({ts:nowMs(),event:'reserved',aircraft:ac.id});
  renderAssignLog(); renderFleetList();
  return {ok:true,token:ac.reservedToken};
}
function confirmReservation(token,route,pilotId){
  const ac = FLEET.find(a=>a.reservedToken===token);
  if(!ac) return {ok:false,reason:'no_res'};
  const p = PILOTS.find(x=>x.id===pilotId);
  if(!(p && p.verified)) return {ok:false,reason:'pilot_not_verified'};
  const now=nowMs(); const durMs = (Number(route.durationMinutes)||120)*60*1000;
  ac.status='inFlight'; ac.availableAt = now + durMs + (ac.turnaround||0)*60*1000; ac.nextLocation = route.toICAO;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;
  FLEET_LOG.push({ts:now,event:'assign_confirmed',aircraft:ac.id,route:`${route.fromICAO}->${route.toICAO}`});
  renderAssignLog(); renderFleetList();
  const current = {
    flightId: uid('flt'),
    aircraftId: ac.id,
    aircraftType: ac.type,
    seats: ac.seats,
    airline: ac.airline,
    route,
    pilotId: p.id,
    pilotName: p.name,
    pilotCall: p.callSign,
    confirmedAt: now,
    etaMs: durMs
  };
  persistCurrentFlight(p.id,current);
  renderCurrentFlight();
  renderConfirmedSection(ac,route,p.id);
  return {ok:true,ac,current};
}

/* choose pilot: only logged-in user */
function choosePilotForAssignment(){
  if(SESSION.pilotId){
    const p=PILOTS.find(x=>x.id===SESSION.pilotId); if(p) return p;
  }
  return null;
}

/* generate flight */
function generateFlight(){
  const chosenPilot = choosePilotForAssignment();
  if(!chosenPilot){ alert('Пожалуйста, войдите — пилот назначается автоматически.'); return; }

  let pool = ROUTES.slice();
  const activeAir = Array.from(airlinesWrap.children).find(c=>c.classList.contains('active'));
  if(activeAir) pool = pool.filter(r=> r.airline === activeAir.textContent);
  if(chosenDur !== null){ const range=DURATIONS[chosenDur]; pool = pool.filter(r=> r.durationMinutes >= range.min && r.durationMinutes <= range.max); }
  if(!pool.length){ alert('Нет маршрутов по выбранным фильтрам'); return; }

  const route = pool[Math.floor(Math.random()*pool.length)];
  let candidates = FLEET.filter(ac=> (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status==='idle');
  if(!candidates.length) candidates = FLEET.filter(ac=>ac.status==='idle');
  if(!candidates.length){ alert('Нет свободных самолётов'); return; }
  candidates.sort((a,b)=> Math.abs(a.seats-180)-Math.abs(b.seats-180));
  const candidate = candidates[0];
  const r=reserveAircraft(candidate, chosenPilot.id);
  if(!r.ok){ alert('Ошибка резерва: '+r.reason); return; }
  const conf=confirmReservation(r.token, route, chosenPilot.id);
  if(!conf.ok){ alert('Ошибка подтверждения: '+conf.reason); return; }
}

/* render confirmed section */
function renderConfirmedSection(ac,route,pilotId){
  confirmedSection.classList.remove('hidden');
  confirmedSection.innerHTML = `<div style="font-weight:800">Рейс подтверждён</div>
    <div class="kv small" style="margin-top:6px">${esc(ac.id)} · ${esc(ac.airline)} · ${esc(route.fromICAO)}→${esc(route.toICAO)}</div>
    <div class="kv small" style="margin-top:6px">Pilot: ${esc((PILOTS.find(p=>p.id===pilotId)||{}).name)}</div>
    <div class="kv small" style="margin-top:6px">ETA: ${new Date(Date.now() + (route.durationMinutes||120)*60*1000).toLocaleString()}</div>`;
}

/* render routes pane (filters applied) */
function renderRoutesPane(){
  routesList.innerHTML='';
  const fa = filterAirline.value||'all';
  const fh = filterHub.value||'all';
  const fd = filterDuration.value||'all';
  let list = ROUTES.filter(r=>{
    if(fa!=='all' && r.airline !== fa) return false;
    if(fh!=='all' && r.fromICAO !== fh && r.toICAO !== fh) return false;
    if(fd!=='all'){ const range=DURATIONS[Number(fd)]; if(!(r.durationMinutes>=range.min && r.durationMinutes<=range.max)) return false; }
    return true;
  });
  if(!list.length){ routesList.innerHTML='<div class="kv small">Нет направлений</div>'; return; }
  list.sort((a,b)=> a.airline.localeCompare(b.airline) || a.durationMinutes - b.durationMinutes);
  list.forEach(r=>{
    const row=document.createElement('div'); row.className='route-item';
    row.innerHTML = `<div><strong>${esc(r.fromICAO)} → ${esc(r.toICAO)}</strong><div class="kv small">${esc(r.fromCity)} → ${esc(r.toCity)} · ${r.durationMinutes} мин</div></div><div class="kv small">${esc(r.airline)}</div>`;
    row.addEventListener('click', ()=> openRouteModal(r));
    routesList.appendChild(row);
  });
}

/* fleet list */
function renderFleetList(){
  fleetList.innerHTML='';
  const fa = filterFleetAirline.value||'all';
  const fs = filterFleetStatus.value||'all';
  const list = FLEET.filter(a=> { if(fa!=='all' && a.airline !== fa) return false; if(fs!=='all' && a.status !== fs) return false; return true; });
  if(!list.length){ fleetList.innerHTML='<div class="kv small">Нет самолётов</div>'; return; }
  list.forEach(a=>{
    const el=document.createElement('div'); el.className='fleet-item';
    el.innerHTML = `<div><strong>${esc(a.id)}</strong><div class="kv small">${esc(a.airline)} · ${esc(a.type)} · ${a.seats} мест · ${esc(a.locationICAO)}</div></div><div class="kv small">${esc(a.status)}</div>`;
    fleetList.appendChild(el);
  });
}

/* route modal */
function openRouteModal(route){
  routeTitleEl.textContent = `${route.airline} • ${route.fromICAO} → ${route.toICAO}`;
  routeSubEl.textContent = `${route.fromCity} → ${route.toCity}`;
  routeDurEl.textContent = `${route.durationMinutes} мин`;
  routeModal.style.display='flex';
}

/* expiry loop (reservations and arrivals) */
setInterval(()=>{
  const now = nowMs();
  FLEET.forEach(ac=>{
    if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil <= now){
      ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil; FLEET_LOG.push({ts:now,event:'reservation_expired',aircraft:ac.id});
    }
    if(ac.status==='inFlight' && ac.availableAt && ac.availableAt <= now){
      ac.status='idle'; if(ac.nextLocation) ac.locationICAO = ac.nextLocation; delete ac.availableAt; delete ac.nextLocation; FLEET_LOG.push({ts:now,event:'aircraft_available',aircraft:ac.id,location:ac.locationICAO});
    }
  });
  renderAssignLog(); renderFleetList();
},1500);

/* AUTH: login/logout */
function signInAsPilot(pid){
  const p = PILOTS.find(x=>x.id===pid);
  if(!p) return;
  SESSION.pilotId = pid; saveSession();
  renderAll();
  closeGate();
}

function attemptLoginFromModal(){
  const cs = document.getElementById('loginCall').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if(!cs){ alert('Введите позывной'); return; }
  const p = PILOTS.find(x=> (x.callSign||'').toLowerCase() === cs.toLowerCase());
  if(!p){ alert('Пилот не найден'); return; }
  if(pass === CODEWORD || (p.password && pass === p.password)){
    SESSION.pilotId = p.id; saveSession();
    renderAll();
    closeGate();
  } else {
    alert('Неверный пароль или кодовое слово');
  }
}

function logout(){
  if(!SESSION.pilotId) return;
  SESSION.pilotId = null; saveSession();
  renderAll();
  showGate();
}

/* modal helpers */
function showGate(){ gateModal.style.display = 'flex'; }
function closeGate(){ gateModal.style.display = 'none'; }

/* UI events */
document.getElementById('genBtn').addEventListener('click', generateBtnHandler);
document.getElementById('resetBtn').addEventListener('click', ()=>{
  chosenDur = null;
  Array.from(durationsWrap.children).forEach(n=>n.classList.remove('active'));
  Array.from(airlinesWrap.children).forEach(n=>n.classList.remove('active'));
  confirmedSection.classList.add('hidden'); confirmedSection.innerHTML='';
});
openGateBtn.addEventListener('click', ()=> showGate());
btnCloseGate.addEventListener('click', ()=> closeGate());
btnLoginPilot.addEventListener('click', ()=> attemptLoginFromModal());
logoutBtn.addEventListener('click', ()=> logout());
document.getElementById('showGate').addEventListener('click', ()=> showGate());
document.getElementById('routeCloseBtn').addEventListener('click', ()=> routeModal.style.display='none');
pilotSearch.addEventListener('input', ()=> renderPilots());

filterAirline.addEventListener('change', ()=> renderRoutesPane());
filterHub.addEventListener('change', ()=> renderRoutesPane());
filterDuration.addEventListener('change', ()=> renderRoutesPane());
filterFleetAirline.addEventListener('change', ()=> renderFleetList());
filterFleetStatus.addEventListener('change', ()=> renderFleetList());

/* tabs switching */
tabGenerate.addEventListener('click', ()=> { panelGenerate.classList.remove('hidden'); panelRoutes.classList.add('hidden'); panelFleet.classList.add('hidden'); tabGenerate.classList.add('active'); tabRoutes.classList.remove('active'); tabFleet.classList.remove('active'); });
tabRoutes.addEventListener('click', ()=> { panelGenerate.classList.add('hidden'); panelRoutes.classList.remove('hidden'); panelFleet.classList.add('hidden'); tabGenerate.classList.remove('active'); tabRoutes.classList.add('active'); tabFleet.classList.remove('active'); });
tabFleet.addEventListener('click', ()=> { panelGenerate.classList.add('hidden'); panelRoutes.classList.add('hidden'); panelFleet.classList.remove('hidden'); tabGenerate.classList.remove('active'); tabRoutes.classList.remove('active'); tabFleet.classList.add('active'); });

/* generate button logic with ripple + loading */
function generateBtnHandler(e){
  const btn = genBtn;
  if(!btn) return;
  if(btn.disabled) return;
  // ripple
  if(genRipple){
    const rect = btn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height) * 1.6;
    genRipple.style.width = genRipple.style.height = size + 'px';
    const x = (e.clientX || (rect.left + rect.width/2)) - rect.left - size/2;
    const y = (e.clientY || (rect.top + rect.height/2)) - rect.top - size/2;
    genRipple.style.left = x + 'px';
    genRipple.style.top = y + 'px';
    genRipple.style.opacity = '0.28';
    genRipple.style.transform = 'scale(0)';
    void genRipple.offsetWidth;
    genRipple.style.transform = 'scale(1)';
    setTimeout(()=> genRipple.style.opacity = '0', 300);
  }

  // If not logged in, prompt
  if(!SESSION.pilotId){ alert('Пожалуйста, войдите — пилот назначается автоматически.'); return; }

  // Loading UI
  if(btn.classList.contains('loading')) return;
  btn.classList.add('loading');
  btn.setAttribute('aria-busy','true');
  if(genSpinner) genSpinner.style.display='inline-block';

  // Simulate async generation then call generateFlight
  setTimeout(()=>{
    generateFlight();
    btn.classList.remove('loading');
    btn.removeAttribute('aria-busy');
    if(genSpinner) genSpinner.style.display='none';
  }, 600);
}

/* init render */
function renderAll(){
  renderAirlines();
  renderPilots();
  renderAssignLog();
  renderFleetList();
  renderRoutesPane();
  renderCurrentFlight();

  // sync filters: fill filter selects
  filterAirline.innerHTML = '<option value="all">Все авиакомпании</option>';
  filterFleetAirline.innerHTML = '<option value="all">Все</option>';
  AIRLINES.forEach(a=>{
    const o=document.createElement('option'); o.value=a.name; o.textContent=a.name; filterAirline.appendChild(o);
    const o2=document.createElement('option'); o2.value=a.name; o2.textContent=a.name; filterFleetAirline.appendChild(o2);
  });
  const hubs = Array.from(new Set(AIRLINES.flatMap(a=>a.hubs)));
  filterHub.innerHTML = '<option value="all">Все хабы</option>';
  hubs.forEach(h=>{ const o=document.createElement('option'); o.value=h; o.textContent=h; filterHub.appendChild(o); });

  if(!SESSION.pilotId){
    showGate();
    sessionBadge.textContent='Неавторизован';
    logoutBtn.style.display='none';
    openGateBtn.style.display='inline-block';
  } else {
    closeGate();
    openGateBtn.style.display='none';
    logoutBtn.style.display='inline-block';
    const p=PILOTS.find(x=>x.id===SESSION.pilotId)||{};
    sessionBadge.textContent = p.callSign ? `Вошёл ${p.callSign}` : 'Вошёл';
  }
}

renderAll();

/* debug */
window._lh = {PILOTS,ROUTES,AIRLINES,FLEET,SESSION};
</script>
</body>
</html>
