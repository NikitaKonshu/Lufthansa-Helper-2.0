<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOT Premium v161 Fixed</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* === CONFIGURATION === */
        :root {
            --accent-gold: #c5a47e; 
            --accent-gold-dark: #8f7250;
            --accent-gold-glow: rgba(197, 164, 126, 0.4);
            --bg-deep: #050b14;
            --glass-panel: rgba(20, 25, 40, 0.85);
            --glass-border: rgba(255, 255, 255, 0.15);
            --text-main: #ffffff;
            --text-sec: #94a3b8;
            --radius-lg: 24px;
            --radius-md: 18px;
            --nav-h: 85px;
            --ease-out: cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* === RESET === */
        html, body {
            width: 100%; height: 100%; overflow-x: hidden; position: relative;
            touch-action: pan-y; margin: 0; padding: 0;
            box-sizing: border-box; -webkit-tap-highlight-color: transparent;
        }
        body {
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at 50% 0%, #172a52 0%, #050b14 80%);
            background-attachment: fixed;
            color: var(--text-main);
            padding-top: 0; padding-bottom: 140px; 
        }
        .hidden { display: none !important; }
        .mono { font-family: 'JetBrains Mono', monospace; }

        /* === LOADER === */
        #flight-loader {
            position: fixed; inset: 0; background: rgba(5, 11, 20, 0.95); backdrop-filter: blur(20px);
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #flight-loader.active { opacity: 1; pointer-events: all; }
        .loader-spinner { width: 60px; height: 60px; border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid var(--accent-gold); border-radius: 50%; animation: spin 1s cubic-bezier(0.5,0,0.5,1) infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* === SEAMLESS HEADER === */
        #header-wrapper {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 600px; z-index: 3000;
            display: flex; flex-direction: column;
        }
        header { 
            width: 100%; height: 60px; 
            background: rgba(15, 20, 35, 0.95); backdrop-filter: blur(25px); 
            border: 1px solid var(--glass-border); border-radius: 30px;
            display: flex; justify-content: center; align-items: center; 
            cursor: pointer; transition: 0.3s var(--ease-out);
            position: relative; z-index: 2;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        header.open {
            border-bottom-left-radius: 0; border-bottom-right-radius: 0;
            border-bottom-color: rgba(255,255,255,0.02); background: #0f1219;
        }
        .brand { font-weight: 800; font-size: 0.95rem; letter-spacing: 1px; text-transform: uppercase; color: #fff; transition: 0.3s; }
        header.open .brand { color: var(--accent-gold); }
        
        #about-panel {
            width: 100%; background: #0f1219;
            border: 1px solid var(--glass-border); border-top: none;
            border-radius: 0 0 30px 30px;
            max-height: 0; opacity: 0; overflow: hidden;
            padding: 0 25px; transition: all 0.4s var(--ease-out);
            position: relative; z-index: 1; margin-top: -1px;
        }
        #about-panel.open { max-height: 350px; opacity: 1; padding: 25px; padding-top: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .header-spacer { height: 110px; width: 100%; }

        /* === UI CARDS === */
        .container { max-width: 800px; margin: 0 auto; padding: 0 20px; }
        .anim-item, .ticket { 
            background: var(--glass-panel); backdrop-filter: blur(30px); 
            border: 1px solid var(--glass-border); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.25); 
            border-radius: var(--radius-lg); position: relative; margin-bottom: 20px; 
            transition: transform 0.2s; 
        }
        .anim-item { padding: 24px; }
        .anim-item:active { transform: scale(0.99); }

        /* === TICKETS === */
        .ticket { padding: 0 !important; display: flex; overflow: hidden; cursor: pointer; }
        .ticket-l { flex: 1; padding: 22px; position: relative; }
        .ticket-r { width: 80px; background: linear-gradient(180deg, var(--accent-gold) 0%, #8f7250 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; color: #000; }
        .al-tag { font-size: 0.7rem; font-weight: 700; color: var(--accent-gold); letter-spacing: 1px; margin-bottom: 8px; text-transform: uppercase; }
        .route-path { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; }
        .ap { font-size: 1.8rem; font-weight: 800; color: #fff; line-height: 1; }
        .ap-lbl { font-size: 0.65rem; color: var(--text-sec); font-weight: 600; letter-spacing: 1px; margin-top: 5px; }

        /* === BUTTONS === */
        button { font-family: 'Inter', sans-serif; border: none; cursor: pointer; outline: none; -webkit-tap-highlight-color: transparent; }
        .btn-primary { 
            width: 100%; padding: 18px; 
            background: linear-gradient(135deg, var(--accent-gold) 0%, #8f7250 100%); 
            color: #050b14; font-weight: 800; font-size: 1rem; letter-spacing: 0.5px; 
            border-radius: var(--radius-md); 
            box-shadow: 0 10px 25px var(--accent-gold-glow); 
            transition: transform 0.2s, box-shadow 0.2s; 
        }
        .btn-primary:active { transform: scale(0.96); box-shadow: 0 4px 12px var(--accent-gold-glow); }
        .btn-filter { background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border); color: #fff; padding: 10px 20px; border-radius: 20px; font-weight: 700; font-size: 0.85rem; transition: 0.2s; }

        /* === VIP EXCLUSIVES === */
        .vip-card { background: linear-gradient(135deg, #111 0%, #252525 100%); border: 1px solid rgba(255, 215, 0, 0.4); box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        .vip-input-wrap { display: flex; gap: 10px; margin-top: 15px; }
        .vip-input { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #444; color: #ffd700; padding: 15px; border-radius: 12px; font-family: 'JetBrains Mono'; text-transform: uppercase; outline: none; text-align: center; font-weight: 700; }
        .vip-save { background: #ffd700; color: #000; border: none; font-weight: 800; padding: 0 20px; border-radius: 12px; cursor: pointer; }
        
        .news-item { border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px; }
        .news-tag { color: #ffd700; font-size: 0.7rem; font-weight: 800; letter-spacing: 1px; border: 1px solid #ffd700; display: inline-block; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; }

        /* === MAPS === */
        #live-map-c, #ofp-map-c { width: 100%; height: 200px; border-radius: 16px; margin-top: 20px; border: 1px solid #444; overflow: hidden; display: none; }
        .plane-marker { font-size: 24px; color: #ffd700; text-shadow: 0 0 10px #000; display: block; text-align: center; line-height: 24px; }
        #map-wrap { height: 450px; border-radius: 24px; overflow: hidden; border: 1px solid var(--glass-border); position: relative; }

        /* === NAV DOCK === */
        .nav-dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 450px; height: var(--nav-h); background: rgba(10, 15, 30, 0.9); backdrop-filter: blur(30px); border-radius: 35px; border: 1px solid var(--glass-border); box-shadow: 0 20px 50px rgba(0,0,0,0.6); z-index: 1900; display: flex; justify-content: space-evenly; align-items: center; }
        .nav-btn { background: none; border: none; color: #556677; display: flex; flex-direction: column; align-items: center; transition: 0.3s; }
        .nav-btn.active { color: #fff; } 
        .nav-btn i { font-style: normal; font-size: 1.6rem; margin-bottom: 6px; display: block; filter: grayscale(1); transition: 0.3s; }
        #nav-btn-vip i { filter: none !important; text-shadow: 0 0 10px rgba(255, 215, 0, 0.6); }

        .tab-view { display: none; opacity: 0; transform: translateY(20px); transition: none; }
        .tab-view.active { display: block; animation: tabEntrance 0.5s var(--ease-out) forwards; }
        @keyframes tabEntrance { to { opacity: 1; transform: translateY(0); } }

        /* === MODALS (FIXED LOGIN) === */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; align-items: flex-end; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; }
        .modal-body { width: 100%; max-width: 600px; background: #111620; border-radius: 36px 36px 0 0; padding: 40px 30px; max-height: 90vh; overflow-y: auto; border-top: 1px solid rgba(255,255,255,0.15); box-shadow: 0 -20px 60px rgba(0,0,0,0.7); transform: translateY(100%); transition: transform 0.4s var(--ease-out); color: #fff; }
        .modal-overlay.visible .modal-body { transform: translateY(0); }

        /* Specific Login Modal Fix to ensure visibility */
        #login-modal { display: flex !important; opacity: 1 !important; background: rgba(0,0,0,0.95) !important; z-index: 9999 !important; }

        /* === OFP GRID === */
        .ofp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .ofp-box { background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
        .ofp-lbl { font-size: 0.7rem; color: #666; font-weight: 600; font-family: 'JetBrains Mono'; display: block; margin-bottom: 5px; letter-spacing: 1px; }
        .ofp-val { font-size: 1.1rem; color: var(--accent-gold); font-weight: 700; font-family: 'JetBrains Mono'; }

        /* === HANGAR SELECTOR (STAGGERED) === */
        #hangar-selector-wrap {
            border-radius: 24px; overflow: hidden; 
            border: 1px solid var(--glass-border); 
            background: rgba(10, 15, 30, 0.4); 
            margin-bottom: 25px; padding: 20px;
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
            min-height: 100px;
        }
        .hangar-chip {
            padding: 12px 16px; background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 14px;
            color: #ccc; font-weight: 600; font-size: 0.85rem; letter-spacing: 0.5px;
            cursor: pointer; transition: 0.2s; opacity: 0; transform: translateY(10px);
        }
        .hangar-chip:active { transform: scale(0.95) !important; }
        .hangar-chip.selected { 
            background: var(--accent-gold); color: #000; font-weight: 800; 
            border-color: var(--accent-gold); box-shadow: 0 4px 15px var(--accent-gold-glow); 
        }
        @keyframes softPop { 0% { opacity: 0; transform: translateY(15px); } 60% { transform: translateY(-2px); } 100% { opacity: 1; transform: translateY(0); } }

        .ios-input { width: 100%; padding: 18px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 18px; margin-bottom: 16px; font-size: 1.1rem; color: #fff; text-align: center; font-weight: 500; }
        .btn-float { position: fixed; bottom: 130px; right: 25px; width: 64px; height: 64px; border-radius: 50%; background: var(--accent-gold); color: #000; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; z-index: 1800; border: 2px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div id="header-wrapper">
    <header id="main-header" onclick="app.toggleAbout()">
        <div class="brand">LOT Polish Airlines ‚ñæ</div>
    </header>
    <div id="about-panel">
        <h3 style="color:#fff; font-size:1.5rem; margin-bottom:5px;">System Info</h3>
        <p style="color:#888; margin-bottom:20px; font-size:0.9rem;">EFN/LOT Portal v161.0 (Fixed)</p>
        <div style="background:#1a1a1a; padding:15px; border-radius:12px; border:1px solid #333;">
            <div style="display:flex; justify-content:space-between;">
                <span style="color:#888; font-size:0.8rem;">SERVER</span>
                <span style="color:#22c55e; font-size:0.8rem;">ONLINE (EU)</span>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <span style="color:#888; font-size:0.8rem;">ACARS</span>
                <span style="color:#22c55e; font-size:0.8rem;">CONNECTED</span>
            </div>
        </div>
        <p style="color:#555; font-size:0.8rem; margin-top:20px;">¬© 2024 LOT Polish Airlines Virtual.<br>RFS Operations Authorized.</p>
    </div>
</div>

<div class="nav-dock hidden" id="nav">
    <button class="nav-btn active" onclick="app.nav('dash')"><i>‚åÇ</i></button>
    <button class="nav-btn" onclick="app.nav('routes')"><i>‚úà</i></button>
    <button class="nav-btn" onclick="app.nav('fleet')"><i>‚óà</i></button>
    <button class="nav-btn" onclick="app.nav('map')"><i>‚óç</i></button>
    <button class="nav-btn" onclick="app.nav('crew')"><i>‚ò∫</i></button>
    <button class="nav-btn hidden" id="nav-btn-vip" onclick="app.nav('vip')"><i style="color:#ffd700;">‚ôõ</i></button>
</div>

<div class="container hidden" id="app">

    <div id="view-dash" class="tab-view active">
        <div class="header-spacer"></div>
        <div id="pilot-profile-card"></div>
        
        <div class="anim-item">
            <h3 style="font-size:1.5rem; color:#fff; font-weight:300;">Daily Roster</h3>
            <p style="font-size:0.8rem; color:var(--text-sec); margin-bottom:25px; font-family:'JetBrains Mono'; margin-top:5px;">UTC /// 08:00 ZULU</p>
            <div id="daily-content" style="font-size:1.8rem; font-weight:800; margin-bottom:25px; color:#fff;">Loading...</div>
            <button class="btn-primary" onclick="app.prep(app.dailyIdx, 'std')">INITIATE BRIEFING</button>
        </div>

        <div id="flight-card" class="anim-item hidden" style="border: 1px solid var(--accent-gold);">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span style="font-weight:900; color:var(--accent-gold); font-size:0.8rem;">ACTIVE FLIGHT</span>
                <span id="af-timer" class="mono" style="font-size:0.9rem;">00:00:00</span>
            </div>
            <h2 id="af-route" style="font-size:2rem; font-weight:200;">DEP - ARR</h2>
            <p id="af-ac" style="color:#888; font-family:'JetBrains Mono'; font-size:0.8rem; margin-bottom:20px;">Aircraft</p>
            
            <div style="height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden;">
                <div id="af-bar" style="height:100%; width:0%; background:var(--accent-gold); transition: width 1s linear;"></div>
            </div>
            
            <div id="live-map-c"></div>

            <button class="btn-primary" style="background:transparent; border:1px solid #444; color:#fff; margin-top:15px;" onclick="app.cancel()">ABORT FLIGHT</button>
        </div>
    </div>

    <div id="view-vip" class="tab-view">
        <div class="header-spacer"></div>
        
        <div class="anim-item vip-card">
            <h3 style="color:#ffd700;">Callsign Override</h3>
            <p style="color:#888; font-size:0.8rem;">Set custom transponder ID for RFS.</p>
            <div class="vip-input-wrap">
                <input type="text" id="vip-cs-input" class="vip-input" placeholder="E.G. MAVERICK">
                <button class="vip-save" onclick="app.setCallsign()">SET</button>
            </div>
        </div>

        <div class="anim-item">
            <h3>Classified Intel</h3>
            <div style="margin-top:15px;">
                <div class="news-item">
                    <div class="news-tag">NOTAM 001</div>
                    <div style="color:#fff;">Presidential Escort</div>
                    <div style="color:#666; font-size:0.8rem;">Prepare for diplomatic flight to Washington.</div>
                </div>
                 <div class="news-item" style="border:none; margin:0; padding:0;">
                    <div class="news-tag">FLEET</div>
                    <div style="color:#fff;">New Supersonic Jet</div>
                    <div style="color:#666; font-size:0.8rem;">Prototype available for Elite members.</div>
                </div>
            </div>
        </div>

        <div class="anim-item">
            <h3>Elite Routes</h3>
            <div id="vip-routes-list" style="margin-top:15px;"></div>
        </div>
    </div>

    <div id="view-routes" class="tab-view">
        <div class="header-spacer"></div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <div style="font-weight:200; font-size:2rem;">Departures</div>
            <button class="btn-filter" onclick="app.openFilter('routes')">FILTER</button>
        </div>
        <div id="routes-list"></div>
        <button class="btn-float" onclick="app.openGenerator()">üé≤</button>
    </div>

    <div id="view-fleet" class="tab-view">
        <div class="header-spacer"></div>
        <div style="margin-bottom:20px;">
            <div class="title" style="font-weight:200; font-size:2rem;">Hangar <span id="fleet-filter-lbl" style="font-size:1rem; color:var(--accent-gold); font-weight:700;">(ALL)</span></div>
        </div>
        <div id="hangar-selector-wrap"></div>
        <div id="fleet-list"></div>
    </div>

    <div id="view-map" class="tab-view">
        <div class="header-spacer"></div>
        <div class="anim-item" style="padding:0; overflow:hidden; border:none;">
            <div id="map-wrap"></div>
        </div>
    </div>

    <div id="view-crew" class="tab-view">
        <div class="header-spacer"></div>
        <div style="margin-bottom:20px;"><div style="font-weight:200; font-size:2rem;">Ops Center</div></div>
        <div id="crew-roster-view"></div>
    </div>

</div>

<div id="login-modal" class="modal-overlay">
    <div class="modal-body" style="background:transparent; border:none; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <h1 style="color:#fff; font-size:3rem; margin-bottom:10px;">‚úà</h1>
        <h2 style="font-size:2rem; font-weight:300; color:#fff; margin-bottom:5px;">Welcome</h2>
        <input type="text" id="travel-id" class="ios-input" placeholder="ID (LOT001)" style="text-transform:uppercase;">
        <input type="password" id="travel-pass" class="ios-input" placeholder="PASSWORD">
        <button class="btn-primary" onclick="app.login()" style="margin-top:20px;">ENTER SYSTEM</button>
        <p id="login-err" style="color:#ef4444; margin-top:20px; font-weight:700; font-size:0.8rem;"></p>
    </div>
</div>

<div id="efb-modal" class="modal-overlay">
    <div class="modal-body">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:15px; margin-bottom:15px;">
            <span class="mono" style="color:#888;">FLIGHT PLAN</span>
            <span style="background:var(--accent-gold); color:#000; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:800;">READY</span>
        </div>
        <div class="ofp-grid">
            <div class="ofp-box"><span class="ofp-lbl">CALLSIGN</span><span class="ofp-val" id="br-cs"></span></div>
            <div class="ofp-box"><span class="ofp-lbl">AIRCRAFT</span><span class="ofp-val" id="br-ac"></span></div>
            <div class="ofp-box"><span class="ofp-lbl">DEP</span><span class="ofp-val" id="br-dep"></span></div>
            <div class="ofp-box"><span class="ofp-lbl">ARR</span><span class="ofp-val" id="br-arr"></span></div>
            <div class="ofp-box"><span class="ofp-lbl">FUEL</span><span class="ofp-val" id="br-fuel"></span></div>
            <div class="ofp-box"><span class="ofp-lbl">TIME</span><span class="ofp-val" id="br-time"></span></div>
        </div>
        
        <div id="ofp-map-c"></div>

        <button class="btn-primary" style="margin-top:20px; background:#fff; color:#000;" onclick="app.accept()">ACCEPT & SIGN</button>
        <button class="btn-primary" style="margin-top:10px; background:transparent; border:1px solid #333; color:#fff; box-shadow:none;" onclick="app.closeM()">CLOSE</button>
    </div>
</div>

<div id="filter-modal" class="modal-overlay"><div class="modal-body"><h3 style="color:#fff;">Filter</h3><div id="filter-container" style="display:flex; flex-wrap:wrap;"></div><button class="btn-primary" style="margin-top:20px; background:transparent; border:1px solid #333; color:#fff;" onclick="app.closeM()">CLOSE</button></div></div>
<div id="gen-modal" class="modal-overlay"><div class="modal-body"><h3 style="color:#fff;">Generator</h3><div style="margin-bottom:30px;"><div style="display:flex; flex-wrap:wrap;"><div class="hangar-chip" onclick="app.generateSmart()">RANDOM ROUTE</div></div></div><button class="btn-primary" style="background:transparent; border:1px solid #333; color:#fff;" onclick="app.closeM()">CANCEL</button></div></div>

<script>
const DB = {
    PILOTS: [
        { id: "LOT001", pwd: "1234", name: "Capt. Mueller", rank: "Captain", base: "EDDF", callsign: "GHOST", vip: true },
        { id: "LOT002", pwd: "1234", name: "F.O. Weber", rank: "First Officer", base: "EDDM", callsign: "SPEEDBIRD", vip: false },
        { id: "LOT003", pwd: "1234", name: "S.O. Schmidt", rank: "Second Officer", base: "LSZH", callsign: "ALPINE", vip: false }
    ],
    ROUTES: [
        { al: "LOT", d: "EPWA", a: "KJFK", t: 9.0, ac: "B787-9", fuel: "75t" },
        { al: "Swiss", d: "LSZH", a: "KJFK", t: 8.8, ac: "A330-300", fuel: "70t" },
        { al: "Lufthansa", d: "EDDF", a: "EGLL", t: 1.5, ac: "A320", fuel: "6t" },
        { al: "Austrian", d: "LOWW", a: "VTBS", t: 10.0, ac: "B777-200", fuel: "130t" },
        { al: "Eurowings", d: "EDDL", a: "LEPA", t: 2.2, ac: "A320", fuel: "8.5t" },
        { al: "Condor", d: "EDDF", a: "CUN", t: 11.5, ac: "A330neo", fuel: "85t" },
        { al: "Air Dolomiti", d: "EDDM", a: "LIPZ", t: 0.8, ac: "E195", fuel: "4t" },
        { al: "Brussels", d: "EBBR", a: "GOSS", t: 6.5, ac: "A330", fuel: "50t" },
        { al: "Discover", d: "EDDF", a: "VTAA", t: 10.5, ac: "A330-300", fuel: "90t" },
        { al: "Croatia", d: "LDZA", a: "EDDF", t: 1.5, ac: "A319", fuel: "6t" },
        { al: "LOT", d: "EPWA", a: "LHR", t: 2.5, ac: "B737-8", fuel: "9t" },
        { al: "Luxair", d: "ELLX", a: "LPPR", t: 2.5, ac: "B737-8", fuel: "10t" },
        { al: "TAP", d: "LPPT", a: "SBGL", t: 10.0, ac: "A330neo", fuel: "95t" }
    ],
    VIP_ROUTES: [
        { al: "GOV", d: "ADW", a: "EPWA", t: 8.5, ac: "VC-25", fuel: "90t" },
        { al: "ROYAL", d: "EPWA", a: "OMDB", t: 5.5, ac: "B737-BBJ", fuel: "30t" }
    ],
    FLEET: [
        { t: "Boeing 787-9", op: "LOT", r: "14,800km", spd: "M0.85" },
        { t: "Airbus A320neo", op: "LOT", r: "6,300km", spd: "M0.82" },
        { t: "Embraer 195", op: "LOT", r: "4,200km", spd: "M0.78" },
        { t: "Airbus A330-300", op: "Swiss", r: "11,750km", spd: "M0.86" },
        { t: "Boeing 777-200", op: "Austrian", r: "13,650km", spd: "M0.84" },
        { t: "Airbus A340-300", op: "Lufthansa", r: "12,500km", spd: "M0.86" },
        { t: "Boeing 747-8", op: "Lufthansa", r: "14,800km", spd: "M0.86" }
    ],
    COORDS: { 
        "EPWA":[52.16,20.96], "KJFK":[40.64,-73.77], "EDDF":[50.03,8.56], "EGLL":[51.47,-0.45], 
        "LSZH":[47.45,8.55], "LOWW":[48.11,16.56], "VTBS":[13.69,100.75], "EDDL":[51.28,6.76], 
        "LEPA":[39.55,2.73], "CUN":[21.04,-86.87], "EDDM":[48.35,11.77], "LIPZ":[45.50,12.35], 
        "EBBR":[50.90,4.48], "GOSS":[14.24,-16.42], "VTAA":[45.67,11.53], "LDZA":[45.74,16.06], 
        "LHR":[51.47,-0.45], "ELLX":[49.62,6.20], "LPPR":[41.24,-8.68], "LPPT":[38.77,-9.13], 
        "SBGL":[-22.81,-43.25], "ADW":[38.81,-76.86], "OMDB":[25.25,55.36], "MLE":[4.19,73.52]
    },
    GATES: ["A10", "Z50", "E05", "G08", "K14", "B22", "C15"]
};

const app = {
    user: null, active: null, temp: null, customCS: null, ofpMap: null, liveMap: null, map: null, dailyIdx: 0,
    filters: { al: 'ALL' },
    stats: { h: 0, l: 0 },

    init: function() {
        // Safe check for localStorage
        try {
            const s = JSON.parse(localStorage.getItem('lot_stats_v160'));
            if(s) this.stats = s;
            const f = JSON.parse(localStorage.getItem('lot_flight'));
            if(f) { this.active = f; this.timer(); }
        } catch(e) { console.log("Storage disallowed"); }

        const today = new Date().toDateString();
        let hash = 0;
        for(let i=0; i<today.length; i++) hash = today.charCodeAt(i) + ((hash << 5) - hash);
        this.dailyIdx = Math.abs(hash) % DB.ROUTES.length;

        // Force Login Visible
        document.getElementById('login-modal').classList.add('visible');
    },

    login: function() {
        const u = document.getElementById('travel-id').value.toUpperCase();
        const p = document.getElementById('travel-pass').value;
        const usr = DB.PILOTS.find(x => x.id === u && x.pwd === p);
        if(usr) {
            this.user = usr;
            
            // Hide Login
            const login = document.getElementById('login-modal');
            login.classList.remove('visible');
            login.style.opacity = '0';
            setTimeout(() => {
                login.style.display = 'none';
                document.getElementById('nav').classList.remove('hidden');
                document.getElementById('app').classList.remove('hidden');
                
                if(usr.vip) document.getElementById('nav-btn-vip').classList.remove('hidden');
                
                this.nav('dash');
                this.profile();
                this.dailyUI();
                this.renderRoutes();
                this.renderVipRoutes();
                this.initFleetSelector();
                this.renderF('ALL');
                this.renderCrew();
            }, 500);
            
        } else {
            document.getElementById('login-err').innerText = "INVALID CREDENTIALS";
        }
    },

    toggleAbout: function() {
        document.getElementById('main-header').classList.toggle('open');
        document.getElementById('about-panel').classList.toggle('open');
    },

    nav: function(id) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(id === 'vip') document.getElementById('nav-btn-vip').classList.add('active');
        else {
             // Basic active toggle logic
             if(id=='dash') document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
             if(id=='routes') document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
             if(id=='fleet') document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
             if(id=='map') document.querySelector('.nav-btn:nth-child(4)').classList.add('active');
             if(id=='crew') document.querySelector('.nav-btn:nth-child(5)').classList.add('active');
        }
        
        ['dash','routes','fleet','map','vip','crew'].forEach(v => {
            const el = document.getElementById('view-'+v);
            if(el) { el.classList.remove('active'); setTimeout(()=> el.style.display='none', 200); }
        });
        
        const target = document.getElementById('view-'+id);
        target.style.display='block';
        setTimeout(()=> target.classList.add('active'), 10);
        
        if(id === 'map') this.initGlobalMap();
    },

    profile: function() {
        const cs = this.customCS || this.user.id;
        const badge = this.user.vip ? '<span style="color:#ffd700; border:1px solid #ffd700; padding:2px 6px; font-size:0.7rem; border-radius:4px; margin-left:8px;">VIP</span>' : '';
        document.getElementById('pilot-profile-card').className = 'anim-item';
        document.getElementById('pilot-profile-card').innerHTML = `<div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;"><div style="width:70px; height:70px; border-radius:50%; background:var(--accent-gold); display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:#000;">${this.user.name[0]}</div><div><h2 style="font-weight:700; color:#fff;">${this.user.name} ${badge}</h2><div style="font-size:0.8rem; color:var(--accent-gold); margin-top:5px; font-family:'JetBrains Mono';">${cs}</div></div></div>`;
    },

    setCallsign: function() {
        const val = document.getElementById('vip-cs-input').value.toUpperCase();
        if(val) { this.customCS = val; alert("SET: " + val); this.profile(); }
    },

    dailyUI: function() { const r = DB.ROUTES[this.dailyIdx]; document.getElementById('daily-content').innerText = `${r.d} ‚ûù ${r.a} (${r.ac})`; },

    renderRoutes: function() {
        const c = document.getElementById('routes-list'); c.innerHTML = '';
        DB.ROUTES.forEach((r, i) => {
            if(this.filters.al !== 'ALL' && r.al !== this.filters.al) return;
            c.innerHTML += this.tk(r, `app.prep(${i}, 'std')`);
        });
    },
    renderVipRoutes: function() {
        const c = document.getElementById('vip-routes-list'); c.innerHTML = '';
        DB.VIP_ROUTES.forEach((r, i) => {
            let h = this.tk(r, `app.prep(${i}, 'vip')`);
            h = h.replace('class="ticket"', 'class="ticket" style="border:1px solid #ffd700"');
            c.innerHTML += h;
        });
    },
    tk: function(r, fn) {
        return `<div class="ticket" onclick="${fn}"><div class="ticket-l"><div class="al-tag">${r.al}</div><div class="route-path"><div class="ap">${r.d}</div><div>‚úà</div><div class="ap">${r.a}</div></div><div style="font-size:0.8rem; color:#888;">${r.ac}</div></div><div class="ticket-r">${r.t}h</div></div>`;
    },

    initFleetSelector: function() {
        const wrap = document.getElementById('hangar-selector-wrap');
        wrap.innerHTML = '';
        const airlines = ['ALL', ...new Set(DB.ROUTES.map(r => r.al))];
        airlines.forEach((al, idx) => {
            const chip = document.createElement('div');
            chip.className = al === 'ALL' ? 'hangar-chip selected' : 'hangar-chip';
            chip.innerText = al;
            chip.style.animation = `softPop 0.6s ease forwards`;
            chip.style.animationDelay = `${idx * 0.08}s`;
            chip.onclick = () => {
                document.querySelectorAll('.hangar-chip').forEach(c => c.classList.remove('selected'));
                chip.classList.add('selected');
                this.renderF(al);
                document.getElementById('fleet-filter-lbl').innerText = `(${al})`;
            };
            wrap.appendChild(chip);
        });
    },

    renderF: function(f='ALL') {
        const l = document.getElementById('fleet-list'); l.innerHTML = '';
        const list = f === 'ALL' ? DB.FLEET : DB.FLEET.filter(x => x.op === f);
        list.forEach(x => {
            l.innerHTML += `<div class="anim-item"><div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px;"><span style="font-weight:700; color:#fff;">${x.t}</span><span style="font-size:0.7rem; font-weight:700; background:var(--accent-gold); color:#000; padding:3px 8px; border-radius:6px;">${x.op}</span></div><div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;"><div><div style="font-size:0.6rem; color:#666;">RANGE</div><div style="font-size:0.9rem; font-weight:600; color:#fff;">${x.r}</div></div><div><div style="font-size:0.6rem; color:#666;">SPEED</div><div style="font-size:0.9rem; font-weight:600; color:#fff;">${x.spd}</div></div></div></div>`;
        });
    },

    renderCrew: function() {
        const c = document.getElementById('crew-roster-view');
        c.innerHTML = DB.PILOTS.filter(p=>p.id!==this.user.id).map(p=>`<div class="anim-item" style="display:flex; align-items:center; gap:15px;"><div style="width:50px; height:50px; border-radius:50%; background:#222; display:flex; align-items:center; justify-content:center; color:#fff; border:2px solid #444;">${p.name[0]}</div><div><div style="font-weight:700; color:#fff;">${p.name}</div><div style="font-size:0.8rem; color:#666;">${p.rank}</div></div></div>`).join('');
    },

    prep: function(idx, type) {
        if(this.active) { alert("Flight in progress"); return; }
        const r = type === 'vip' ? DB.VIP_ROUTES[idx] : DB.ROUTES[idx];
        this.temp = { ...r, n: this.customCS || this.user.id, gate: DB.GATES[Math.floor(Math.random()*DB.GATES.length)] };
        
        document.getElementById('flight-loader').classList.add('active');
        setTimeout(() => {
            document.getElementById('flight-loader').classList.remove('active');
            
            document.getElementById('br-cs').innerText = this.temp.n;
            document.getElementById('br-ac').innerText = r.ac;
            document.getElementById('br-dep').innerText = r.d;
            document.getElementById('br-arr').innerText = r.a;
            document.getElementById('br-fuel').innerText = r.fuel;
            document.getElementById('br-time').innerText = r.t + 'H';
            
            this.openM('efb-modal');
            
            if(this.user.vip) this.initOFPMap(r);
            else document.getElementById('ofp-map-c').style.display='none';
            
        }, 1000);
    },

    initOFPMap: function(r) {
        setTimeout(() => {
            const c = document.getElementById('ofp-map-c'); c.style.display = 'block';
            if(this.ofpMap) this.ofpMap.remove();
            
            this.ofpMap = L.map('ofp-map-c', {zoomControl:false}).setView([0,0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.ofpMap);
            
            const p1 = DB.COORDS[r.d] || [50,10];
            const p2 = DB.COORDS[r.a] || [40,-70];
            
            L.polyline([p1, p2], {color: '#c5a47e'}).addTo(this.ofpMap);
            L.circleMarker(p1, {color:'#0f0', radius:5}).addTo(this.ofpMap);
            L.circleMarker(p2, {color:'#f00', radius:5}).addTo(this.ofpMap);
            
            this.ofpMap.fitBounds(L.latLngBounds(p1, p2), {padding:[20,20]});
        }, 300);
    },

    accept: function() {
        this.closeM();
        this.active = { ...this.temp, start: Date.now(), dur: 20000 }; 
        try { localStorage.setItem('lot_flight', JSON.stringify(this.active)); } catch(e){}
        this.nav('dash');
        document.getElementById('flight-card').classList.remove('hidden');
        document.getElementById('af-route').innerText = `${this.active.d} - ${this.active.a}`;
        document.getElementById('af-ac').innerText = this.active.ac;
        
        if(this.user.vip) this.initLiveMap(this.active);
        
        this.tmr = setInterval(() => {
            const pct = Math.min((Date.now() - this.active.start)/this.active.dur, 1);
            document.getElementById('af-bar').style.width = (pct*100) + "%";
            
            if(this.user.vip && this.liveMap && this.planeMarker) {
                const p1 = DB.COORDS[this.active.d]; const p2 = DB.COORDS[this.active.a];
                const lat = p1[0] + (p2[0]-p1[0]) * pct;
                const lng = p1[1] + (p2[1]-p1[1]) * pct;
                this.planeMarker.setLatLng([lat, lng]);
                
                const angle = Math.atan2(p2[1]-p1[1], p2[0]-p1[0]) * 180 / Math.PI;
                document.querySelector('.plane-marker').style.transform = `rotate(${angle}deg)`;
            }

            if(pct >= 1) { clearInterval(this.tmr); alert("Arrived"); this.active = null; document.getElementById('flight-card').classList.add('hidden'); try{localStorage.removeItem('lot_flight');}catch(e){} }
            else {
                const rem = this.active.dur - (Date.now() - this.active.start);
                const s = Math.ceil(rem/1000);
                document.getElementById('af-timer').innerText = s + "s LEFT";
            }
        }, 100);
    },

    initLiveMap: function(r) {
        const c = document.getElementById('live-map-c'); c.style.display = 'block';
        if(this.liveMap) this.liveMap.remove();
        
        this.liveMap = L.map('live-map-c', {zoomControl:false, attributionControl:false});
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.liveMap);
        
        const p1 = DB.COORDS[r.d]; const p2 = DB.COORDS[r.a];
        this.liveMap.fitBounds(L.latLngBounds(p1, p2));
        L.polyline([p1, p2], {color:'#444', dashArray:'5,5'}).addTo(this.liveMap);
        
        const icon = L.divIcon({html:'‚úà', className:'plane-marker', iconSize:[24,24], iconAnchor:[12,12]});
        this.planeMarker = L.marker(p1, {icon:icon}).addTo(this.liveMap);
    },

    initGlobalMap: function() {
        setTimeout(() => { 
            if(!this.map) {
                this.map = L.map('map-wrap').setView([48, 15], 4);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(this.map);
                
                DB.ROUTES.forEach(r => {
                    const c1 = DB.COORDS[r.d]; const c2 = DB.COORDS[r.a];
                    if(c1 && c2) {
                        L.polyline([c1, c2], {color: '#c5a47e', weight: 1, opacity: 0.5}).addTo(this.map);
                        L.circleMarker(c1, {color:'#c5a47e', radius:3}).addTo(this.map);
                    }
                });
            }
            this.map.invalidateSize();
        }, 100);
    },

    openFilter: function(t) {
        const c = document.getElementById('filter-container');
        const data = t === 'routes' ? ['ALL', ...new Set(DB.ROUTES.map(r => r.al))] : [];
        c.innerHTML = data.map(x => `<div class="hangar-chip" onclick="app.applyFilter('${t}', '${x}')">${x}</div>`).join('');
        this.openM('filter-modal');
    },
    applyFilter: function(t, v) { 
        this.closeM(); 
        if(t==='routes') { this.filters.al = v; this.renderRoutes(); } 
    },
    generateSmart: function() { this.closeM(); this.prep(Math.floor(Math.random()*DB.ROUTES.length), 'std'); },

    cancel: function() { clearInterval(this.tmr); this.active = null; document.getElementById('flight-card').classList.add('hidden'); try{localStorage.removeItem('lot_flight');}catch(e){} },
    openM: function(id) { document.getElementById(id).style.display='flex'; setTimeout(()=>document.getElementById(id).classList.add('visible'), 10); },
    closeM: function() { document.querySelectorAll('.modal-overlay').forEach(x=> { x.classList.remove('visible'); setTimeout(()=>x.style.display='none', 300); }); }
};
window.onload = () => app.init();
</script>
</body>
</html>
