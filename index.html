<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flight Helper — Lufthansa Group</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#031022; --bg-2:#063046;
  --text:#eaf4ff; --muted:rgba(234,244,255,0.72);
  --muted-weak:rgba(234,244,255,0.54);
  --accent:#ffd54a; --accent2:#ffbf3a;
  --glass-border:rgba(255,255,255,0.06);
  --panel-radius:12px;
  --ease-soft: cubic-bezier(.16,.84,.35,1);
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  font-size:15px;
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  min-height:100vh;color:var(--text);
  background:
    radial-gradient(900px 600px at 10% 10%, rgba(6,24,44,0.36), transparent 34%),
    radial-gradient(700px 500px at 90% 0%, rgba(4,20,36,0.28), transparent 30%),
    linear-gradient(160deg,var(--bg-1),var(--bg-2));
  padding:18px;-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  transition:background .36s var(--ease-soft);
}
body.modal-open{ overflow:hidden; }

/* Shell */
.shell{max-width:1200px;margin:0 auto;border-radius:16px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid var(--glass-border);box-shadow:0 40px 140px rgba(0,0,0,0.55)}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.02);gap:12px;position:sticky;top:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));z-index:20}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);background:linear-gradient(180deg,#052b36,#041721);box-shadow:0 12px 44px rgba(0,0,0,0.5)}
.title{font-weight:900}
.subtitle{font-size:13px;color:var(--muted-weak)}
.session{display:flex;gap:8px;align-items:center}

/* Tabs */
.tabs{display:flex;gap:8px;align-items:center}
.tab{padding:10px 12px;border-radius:12px;font-weight:800;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .12s var(--ease-soft)}
.tab.active{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#06141e;transform:translateY(-4px);box-shadow:0 34px 120px rgba(255,170,40,0.12)}

/* Layout: single column (удалена правая панель) */
.container{padding:18px;max-width:1200px;margin:0 auto}
.grid{display:block}
@media(min-width:920px){ .grid{display:grid;grid-template-columns:1fr;gap:18px} }

/* Panels */
.panel{padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border:1px solid var(--glass-border);margin-bottom:14px;backdrop-filter: blur(8px);box-shadow:0 8px 30px rgba(0,0,0,0.25)}
.panel .heading {font-weight:900}
.panel .note {color:var(--muted-weak);font-size:13px;margin-top:6px}

/* Inputs */
.input-glass{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));color:var(--text);outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);transition:box-shadow .12s,var(--ease-soft)}
.input-glass::placeholder{color:rgba(234,244,255,0.42)}
.input-glass:focus{box-shadow:0 24px 80px rgba(0,0,0,0.48), 0 0 30px rgba(255,200,50,0.04)}

/* Lists & cards */
.airline-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:12px}
.airline{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .14s var(--ease-soft),box-shadow .14s var(--ease-soft);position:relative;overflow:hidden}
.brand-dot{width:18px;height:18px;border-radius:4px;flex:0 0 18px;box-shadow:0 8px 28px rgba(0,0,0,0.26)}
.airline .name{font-weight:900;color:var(--text)}
.airline .meta{font-size:13px;color:var(--muted)}
.code-pill{margin-left:auto;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,0.12);border:1px solid rgba(255,255,255,0.03);font-weight:800;font-family:ui-monospace,monospace}
.airline:hover{transform:translateY(-6px);box-shadow:0 36px 120px rgba(0,0,0,0.48)}
.airline.selected{border:1px solid rgba(255,190,60,0.28);box-shadow:0 44px 160px rgba(255,180,60,0.08);transform:translateY(-6px) scale(1.01)}
.airline.selected .code-pill{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#06141e}

/* routes & fleet cards */
.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;margin-top:12px}
.route-card, .fleet-card{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 20px rgba(0,0,0,0.18)}
.route-card .title, .fleet-card .title{font-weight:900;color:var(--text)}
.route-card .meta, .fleet-card .meta{color:var(--muted);font-size:13px;margin-top:6px}

/* small screens */
@media(max-width:720px){
  .tabs{display:none}
  .grid{grid-template-columns:1fr}
  .modal-card{ width: min(92%, 520px); max-height:86vh; }
}

/* buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid transparent;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));color:var(--text);font-weight:800;cursor:pointer;position:relative;transition:transform .12s var(--ease-soft),box-shadow .12s var(--ease-soft),background .12s var(--ease-soft);box-shadow: 0 8px 22px rgba(0,0,0,0.32)}
.btn-primary{background: linear-gradient(180deg, var(--accent), var(--accent2));color:#06141e;border-color: rgba(0,0,0,0.08);box-shadow: 0 26px 96px rgba(255,170,40,0.14)}
.btn-secondary{background: linear-gradient(180deg, rgba(6,24,44,0.88), rgba(4,18,34,0.92));color: var(--text);border: 1px solid rgba(255,255,255,0.04);box-shadow: 0 12px 44px rgba(2,8,18,0.5)}
.btn-ghost{background: transparent;color: var(--text);border: 1px solid rgba(255,255,255,0.06);box-shadow: none}

/* ripple */
.ripple{position:absolute;border-radius:50%;pointer-events:none;mix-blend-mode:screen}

/* modals */
.modal-backdrop{
  display:none;position:fixed;inset:0;z-index:17000;background:rgba(0,0,0,0.56);align-items:center;justify-content:center;padding:24px;
  animation: fadeInBackdrop 220ms var(--ease-soft) both;
}
@keyframes fadeInBackdrop{from{opacity:0}to{opacity:1}}
.modal-card{
  width:min(720px,92%);max-height:86vh;overflow:auto;border-radius:12px;padding:18px;background:linear-gradient(180deg, rgba(20,28,38,0.98), rgba(10,14,20,0.98));border:1px solid var(--glass-border);box-shadow:0 40px 140px rgba(0,0,0,0.6);
  color:var(--text);
  transform:translateY(6px) scale(.992);opacity:0;
  transition:transform 260ms var(--ease-soft),opacity 220ms var(--ease-soft);
}
.modal-backdrop.showing .modal-card{ transform:none; opacity:1; }
.modal-card .title{font-weight:900;font-size:18px;color:var(--text)}
.modal-card .body{color:var(--muted);margin-top:10px;line-height:1.45}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:16000;background:linear-gradient(180deg, rgba(0,6,18,0.96), rgba(2,14,30,0.99));">
  <div style="text-align:center;animation:fadeInBackdrop 360ms var(--ease-soft) both;">
    <h2 style="font-size:28px;color:var(--text);margin-bottom:8px">Welcome to Lufthansa Group</h2>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
      <button id="splashContinue" class="btn btn-primary" type="button">Продолжить</button>
    </div>
  </div>
</div>

<!-- APP SHELL -->
<div class="shell" role="application" aria-label="Flight Helper">
  <div class="topbar">
    <div class="brand">
      <div class="logo">LH</div>
      <div><div class="title">Lufthansa Helper</div><div class="subtitle">—</div></div>
    </div>

    <div style="display:flex;align-items:center;gap:12px">
      <div class="tabs" id="tabs">
        <div class="tab active" data-page="home">Главная</div>
        <div class="tab" data-page="routes">Направления</div>
        <div class="tab" data-page="fleet">Флот</div>
        <div class="tab" data-page="flights">Рейсы</div>
        <div class="tab" data-page="pilots">Пилоты</div>
      </div>

      <div class="session">
        <div id="sessionBadge" class="subtitle">Неавторизован</div>
        <button id="openGateBtn" class="btn btn-secondary" type="button">Вход</button>
        <button id="logoutBtn" class="btn btn-ghost" style="display:none" type="button">Выйти</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- MAIN column: весь контент растянут сюда, правой панели нет -->
      <div id="pageHost">
        <!-- Главная: генерация + ВСЕ авиакомпании -->
        <section id="page-home" class="panel page active">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="heading">Генерация рейса</div>
              <div class="note">Выбери авиакомпанию, интервал времени и запусти генерацию</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="openInstructionBtn" class="btn btn-secondary" type="button">Инструкция</button>
            </div>
          </div>

          <div style="margin-top:12px;display:grid;grid-template-columns:1fr 320px;gap:12px">
            <div>
              <div style="margin-bottom:10px">
                <input id="airSearchMain" class="input-glass" placeholder="Поиск авиакомпании или кода" />
              </div>

              <div style="display:flex;gap:10px;flex-wrap:wrap">
                <div style="flex:1">
                  <div style="font-weight:800;margin-bottom:8px">Интервал времени</div>
                  <div id="durationsMain" style="display:flex;gap:8px;flex-wrap:wrap"></div>
                </div>
              </div>

              <div style="margin-top:12px">
                <div style="font-weight:800;margin-bottom:8px">Авиакомпании</div>
                <div id="airGrid" class="airline-grid" aria-live="polite"></div>
              </div>
            </div>

            <div>
              <div style="font-weight:900">Выбранная авиакомпания</div>
              <div id="selectedAir" style="margin-top:8px;color:var(--muted)">Не выбрана</div>

              <div style="margin-top:12px;font-weight:800">Действия</div>
              <div style="margin-top:8px;color:var(--muted)">Сгенерируй маршрут или выбери конкретный рейс на вкладке Направления</div>

              <div style="margin-top:18px;display:flex;gap:8px;flex-direction:column">
                <button id="generateBtn" class="btn btn-primary" type="button">Сгенерировать случайный</button>
                <button id="clearSelection" class="btn btn-ghost" type="button">Сбросить выбор</button>
              </div>
            </div>
          </div>
        </section>

        <!-- empty placeholder for dynamic pages (routes, fleet, flights, pilots) -->
        <div id="dynamicPages"></div>

        <!-- Local help block -->
        <section class="panel">
          <div class="heading">Быстро</div>
          <div class="note">Главная показывает все авиакомпании и генератор рейса. Переключайся по вкладкам, чтобы работать с направлениями, флотом, рейсами и пилотами.</div>
        </section>
      </div>
    </div>
  </div>
</div>

<!-- FILTER modal -->
<div id="filterPanel" class="modal-backdrop" role="dialog" aria-hidden="true" aria-modal="true">
  <div class="modal-card filter-panel" role="document" aria-label="Фильтры">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="title">Фильтры</div>
      <div class="subtitle" style="color:var(--muted)">Компактно</div>
    </div>

    <div class="body" style="margin-top:12px">
      <label style="font-weight:700;font-size:13px">Авиакомпания</label>
      <select id="filterCompany" class="input-glass" style="margin-top:8px">
        <option value="">Все</option>
      </select>

      <label style="font-weight:700;font-size:13px;margin-top:12px;display:block">Интервал (ч)</label>
      <div id="filterDurations" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap"></div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
        <button id="applyFilters" class="btn btn-primary" type="button">Применить</button>
        <button id="resetFilters" class="btn btn-ghost" type="button">Сброс</button>
      </div>
    </div>
  </div>
</div>

<!-- FLIGHT DETAIL modal -->
<div id="flightDetailModal" class="modal-backdrop" role="dialog" aria-hidden="true">
  <div class="modal-card" role="document" aria-label="Детали рейса">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="title" id="detailTitle">Рейс</div>
      <div class="subtitle" id="detailStatus"></div>
    </div>
    <div class="body" id="detailBody" style="margin-top:10px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="btnArrived" class="btn btn-primary" type="button">Прилетел</button>
      <button id="btnCancelFlight" class="btn btn-ghost" type="button">Отменить</button>
      <button id="closeDetail" class="btn btn-secondary" type="button">Закрыть</button>
    </div>
  </div>
</div>

<!-- GATE modal -->
<div id="gateModal" class="modal-backdrop" role="dialog" aria-hidden="true" aria-modal="true">
  <div class="modal-card" role="document" aria-label="Вход">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="title">Вход</div>
      <div class="subtitle" style="color:var(--muted)">Авторизация</div>
    </div>
    <div class="body" style="margin-top:12px">
      <input id="loginCall" class="input-glass" placeholder="Позывной (callSign)" />
      <input id="loginPass" class="input-glass" type="password" placeholder="Пароль" style="margin-top:10px" />
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="btnLogin" class="btn btn-primary" type="button">Войти</button>
    </div>
  </div>
</div>

<!-- INSTRUCTION modal -->
<div id="instructionModal" class="modal-backdrop" role="dialog" aria-hidden="true" aria-modal="true">
  <div class="modal-card" role="document" aria-label="Инструкция">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="title">Инструкция</div>
      <div class="subtitle" style="color:var(--muted)">Кратко</div>
    </div>
    <div class="body" style="margin-top:12px">
      <div style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px"><strong>Вход</strong>: Введите позывной и пароль.</div>
      <div style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px"><strong>Генерация</strong>: Выберите авиакомпанию и интервал; затем нажмите «Сгенерировать случайный».</div>
      <div style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)"><strong>Подтверждение</strong>: Подтвердите резерв — рейс сохранится в вашем профиле.</div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="closeInstruction" class="btn btn-secondary" type="button">Закрыть</button>
    </div>
  </div>
</div>

<!-- CONFIRM modal -->
<div id="confirmModal" class="modal-backdrop" role="dialog" aria-hidden="true" aria-modal="true">
  <div class="modal-card" role="document" aria-label="Подтвердить рейс">
    <div class="title">Подтвердить рейс</div>
    <div id="confirmDetails" class="body" style="margin-top:8px;color:var(--muted)"></div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="btn btn-ghost" type="button">Отменить</button>
      <button id="confirmAccept" class="btn btn-primary" type="button">Подтвердить</button>
    </div>
  </div>
</div>

<script>
/* ============================
   ДАННЫЕ
   ============================ */
const AIRLINES = [
  {name:"Swiss International Air Lines",code:"LX",colorA:"#D81E5B",colorB:"#C1144A"},
  {name:"Austrian Airlines",code:"OS",colorA:"#DA291C",colorB:"#A71D1D"},
  {name:"AirBaltic",code:"BT",colorA:"#00A859",colorB:"#007A45"},
  {name:"Brussels Airlines",code:"SN",colorA:"#125B9E",colorB:"#0D4B84"},
  {name:"Eurowings",code:"EW",colorA:"#8A4BFF",colorB:"#6A29E8"},
  {name:"Discover Airlines",code:"4Y",colorA:"#3FA9F5",colorB:"#0B78D1"},
  {name:"Edelweiss Air",code:"WK",colorA:"#FF8C66",colorB:"#FF6A3C"},
  {name:"Lufthansa Cargo",code:"G0",colorA:"#0A63D6",colorB:"#0747A6"},
  {name:"Lufthansa CityLine",code:"CL",colorA:"#1E6FFF",colorB:"#0F4EDC"},
  {name:"Lufthansa City Airlines",code:"LC",colorA:"#1B6AE6",colorB:"#0B53B0"},
  {name:"Lufthansa Technik",code:"LT",colorA:"#6F7C8C",colorB:"#3F4B59"},
  {name:"Lufthansa Private Jet",code:"LP",colorA:"#B38B4B",colorB:"#8A6638"},
  {name:"Air Dolomiti",code:"EN",colorA:"#2B8F6F",colorB:"#1F6E55"},
  {name:"ITA Airways",code:"AZ",colorA:"#0066A1",colorB:"#004C7A"},
  {name:"Widerøe",code:"WF",colorA:"#2DAE4A",colorB:"#228A3A"},
  {name:"Norwegian Air Shuttle",code:"DY",colorA:"#E03A3E",colorB:"#B92B2C"},
  {name:"Finnair",code:"AY",colorA:"#1B2A43",colorB:"#0F1B2C"},
  {name:"SAS Scandinavian Airlines",code:"SK",colorA:"#0077C8",colorB:"#005B9E"},
  {name:"Condor",code:"DE",colorA:"#FFD23F",colorB:"#E6BF2F"},
  {name:"AeroLogic",code:"3S",colorA:"#7AA6E6",colorB:"#4B86C6"},
  {name:"SunExpress",code:"XQ",colorA:"#FF7A2D",colorB:"#E65A00"}
];

const DURATIONS = [
  {label:"1–2 часа", min:1, max:2},
  {label:"3–4 часа", min:3, max:4},
  {label:"5–6 часов", min:5, max:6},
  {label:"7–8 часов", min:7, max:8},
  {label:"9–10 часов", min:9, max:10},
  {label:"10+ часов", min:10}
];

let ROUTES = []; (function(){ let seq=100; const base=["EDDF","EGLL","LFPG","LEBL","LSZH","KJFK","EHAM","LOWW"]; AIRLINES.forEach((a,ai)=>{ for(let i=0;i<5;i++){ const from=base[(ai*2+i)%base.length]; const to=base[(ai*2+i+2)%base.length]; const dur=75 + (i*20) + (ai*6); ROUTES.push({ id:`${a.code}-${seq++}`, airline:a.name, airlineCode:a.code, fromICAO:from, toICAO:to, fromCity:'City-'+from, toCity:'City-'+to, durationMinutes:dur }); } }); })();

let FLEET = []; (function(){ AIRLINES.forEach((a,ai)=>{ const types=["A320","A321","B737","A220","A330"]; for(let i=1;i<=2;i++){ FLEET.push({ id:`${a.code}-AC${String(i).padStart(2,'0')}`, airline:a.name, type:types[(ai+i)%types.length], locationICAO:i===1?"EDDF":"EGLL", status:"idle", fuelMinutes:420 + i*60, turnaround:20 + i*5, reserveMargin:30 }); } }); })();

let PILOTS = [
  {id:"pilot_ivan",name:"Ivan Petrov",callSign:"IPET",verified:true,password:"ivanpass"},
  {id:"pilot_loui",name:"Loui Desulier",callSign:"FRENCH",verified:true,password:"louiSecret"}
];

let SESSION = { pilotId:null };
let CONFIRMED_FLIGHTS = []; // current pilot flights
let chosenAirline = null;
let chosenDurationIdx = null;
let filterCompany = '';
let PENDING_RESERVATION = null;

/* DOM refs */
const splash = document.getElementById('splash');
const splashContinueBtn = document.getElementById('splashContinue');
const airGrid = document.getElementById('airGrid');
const durationsMain = document.getElementById('durationsMain');
const sessionBadge = document.getElementById('sessionBadge');
const openGateBtn = document.getElementById('openGateBtn');
const logoutBtn = document.getElementById('logoutBtn');
const gateModal = document.getElementById('gateModal');
const instructionModal = document.getElementById('instructionModal');
const confirmModal = document.getElementById('confirmModal');
const loginCall = document.getElementById('loginCall');
const loginPass = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const airSearchMain = document.getElementById('airSearchMain');
const openInstructionBtn = document.getElementById('openInstructionBtn');
const closeInstruction = document.getElementById('closeInstruction');
const filterPanel = document.getElementById('filterPanel');
const filterCompanySelect = document.getElementById('filterCompany');
const filterDurations = document.getElementById('filterDurations');
const openFiltersFleet = document.getElementById('openFiltersFleet');
const generateBtn = document.getElementById('generateBtn');
const clearSelection = document.getElementById('clearSelection');
const selectedAir = document.getElementById('selectedAir');
const confirmDetailsEl = document.getElementById('confirmDetails');
const dynamicPages = document.getElementById('dynamicPages');

/* ============================
   UI helpers: modal, focus, ripple
   ============================ */
function modalShow(el){
  if(!el) return;
  el.style.display='flex';
  el.classList.add('showing');
  el.setAttribute('aria-hidden','false');
  const card = el.querySelector('.modal-card');
  if(card){
    card.style.transform = 'translateY(6px) scale(.992)';
    card.style.opacity = '0';
    requestAnimationFrame(()=>{ card.style.transform='none'; card.style.opacity='1'; });
  }
  document.body.classList.add('modal-open');
  trapFocus(el);
}
function modalHide(el){
  if(!el) return;
  const card = el.querySelector('.modal-card');
  if(card){
    card.style.transform='translateY(6px) scale(.992)';
    card.style.opacity='0';
  }
  el.setAttribute('aria-hidden','true');
  setTimeout(()=>{ el.style.display='none'; releaseFocus(); document.body.classList.remove('modal-open'); }, 220);
}
function flightsKey(pid){ return 'lh_flights_' + pid; }

/* Focus trap */
let lastFocusedBeforeModal = null;
function trapFocus(modalBackdrop){
  lastFocusedBeforeModal = document.activeElement;
  const focusable = modalBackdrop.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
  const first = focusable[0];
  const last = focusable[focusable.length-1];
  function keyHandler(e){
    if(e.key === 'Tab'){
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    if(e.key === 'Escape'){ e.preventDefault(); }
  }
  modalBackdrop._keyHandler = keyHandler;
  document.addEventListener('keydown', keyHandler);
  if(first) first.focus();
}
function releaseFocus(){
  const modalWithHandler = document.querySelectorAll('.modal-backdrop[style*="display:flex"]');
  modalWithHandler.forEach(m=>{ if(m._keyHandler) document.removeEventListener('keydown', m._keyHandler); delete m._keyHandler; });
  if(lastFocusedBeforeModal && lastFocusedBeforeModal.focus) lastFocusedBeforeModal.focus();
}

/* Ripple */
function attachRipple(scope=document){
  const els = scope.querySelectorAll('.btn, .airline, .time-item, .route-card, .fleet-card');
  els.forEach(el=>{
    if(el._rip) return; el._rip=true;
    el.addEventListener('pointerdown', ev=>{
      let r = el.querySelector('.ripple'); if(!r){ r=document.createElement('span'); r.className='ripple'; r.style.position='absolute'; r.style.borderRadius='50%'; r.style.pointerEvents='none'; r.style.background='rgba(255,255,255,0.9)'; el.prepend(r); }
      const rect=el.getBoundingClientRect(); const size=Math.max(rect.width,rect.height)*1.6;
      r.style.width=size+'px'; r.style.height=size+'px';
      r.style.left=(ev.clientX-rect.left-size/2)+'px'; r.style.top=(ev.clientY-rect.top-size/2)+'px';
      r.style.transform='scale(0)'; r.style.opacity='.28'; r.style.transition='transform 420ms cubic-bezier(.2,.9,.2,1), opacity 360ms';
      requestAnimationFrame(()=> r.style.transform='scale(1)');
      setTimeout(()=> r.style.opacity='0',420);
    }, {passive:true});
  });
}

/* ============================
   Initialization and rendering
   ============================ */
function initDurations(){
  durationsMain.innerHTML=''; filterDurations.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const btnMain = document.createElement('div'); btnMain.className='time-item'; btnMain.textContent = d.label;
    btnMain.style.padding='8px 10px'; btnMain.style.borderRadius='10px'; btnMain.style.border='1px solid rgba(255,255,255,0.04)'; btnMain.style.cursor='pointer';
    btnMain.addEventListener('click', ()=>{ chosenDurationIdx = chosenDurationIdx===i ? null : i; document.querySelectorAll('#durationsMain .time-item').forEach((el,idx)=>el.style.outline=chosenDurationIdx===idx?'2px solid rgba(255,190,60,0.18)':'none'); /* refresh routes if open */ if(currentPage==='routes') renderRoutesPage(); });
    durationsMain.appendChild(btnMain);

    const btnFilter = document.createElement('div'); btnFilter.className='time-item'; btnFilter.textContent = d.label;
    btnFilter.style.padding='8px 10px'; btnFilter.style.borderRadius='10px'; btnFilter.style.border='1px solid rgba(255,255,255,0.04)'; btnFilter.style.cursor='pointer';
    btnFilter.addEventListener('click', ()=>{ chosenDurationIdx = chosenDurationIdx===i ? null : i; document.querySelectorAll('#filterDurations .time-item').forEach((el,idx)=>el.style.outline=chosenDurationIdx===idx?'2px solid rgba(255,190,60,0.18)':'none'); if(currentPage==='routes') renderRoutesPage(); });
    filterDurations.appendChild(btnFilter);
  });
}

/* Render all airlines on main */
function renderAirlines(){
  airGrid.innerHTML='';
  const q = (airSearchMain.value||'').trim().toLowerCase();
  const list = AIRLINES.filter(a=>{ if(!q) return true; return a.name.toLowerCase().includes(q) || a.code.toLowerCase().includes(q); });
  list.forEach(a=>{
    const el=document.createElement('div'); el.className='airline'; el.tabIndex=0;
    el.innerHTML = `<div class="brand-dot" style="background:linear-gradient(180deg, ${a.colorA}, ${a.colorB});"></div>
      <div style="min-width:0"><div class="name">${a.name}</div><div class="meta">${a.code}</div></div>
      <div class="code-pill">${a.code}</div>`;
    el.addEventListener('click', ()=>{ chosenAirline = chosenAirline===a.name ? null : a.name; selectedAir.textContent = chosenAirline || 'Не выбрана'; document.querySelectorAll('.airline').forEach(node=>node.classList.toggle('selected', node===el)); });
    airGrid.appendChild(el);
  });
  attachRipple(airGrid);
}

/* Current page state */
let currentPage = 'home';

/* Tab activation */
function activatePage(id){
  currentPage = id;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.page===id));
  // show/hide home
  document.getElementById('page-home').style.display = id==='home' ? 'block' : 'none';
  // clear dynamicPages and render relevant
  dynamicPages.innerHTML = '';
  if(id==='routes'){ renderRoutesPage(); }
  if(id==='fleet'){ renderFleetPage(); }
  if(id==='flights'){ renderFlightsPage(); }
  if(id==='pilots'){ renderPilotsPage(); }
  attachRipple(document);
}
document.querySelectorAll('.tab').forEach(tab=>tab.addEventListener('click', ()=> activatePage(tab.dataset.page)));
activatePage('home');

/* ROUTES page */
function renderRoutesPage(){
  const container = document.createElement('section'); container.className='panel'; container.id='page-routes';
  container.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div style="min-width:0"><div style="font-weight:900">Направления</div><div style="color:var(--muted);margin-top:6px">Карточки маршрутов. Фильтр по авиакомпаниям и времени</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="localCompanyFilter" class="input-glass" style="min-width:220px">
          <option value="">Все авиакомпании</option>
        </select>
        <button id="closeRoutesBtn" class="btn btn-ghost" type="button">Закрыть</button>
      </div>
    </div>
    <div style="margin-top:12px" id="routesGrid" class="card-grid"></div>
  `;
  dynamicPages.appendChild(container);
  const localSelect = container.querySelector('#localCompanyFilter');
  AIRLINES.forEach(a=>{ const o=document.createElement('option'); o.value=a.name; o.textContent=`${a.name} (${a.code})`; localSelect.appendChild(o); });
  localSelect.addEventListener('change', ()=>{ filterCompany = localSelect.value; renderRoutesGrid(); });
  container.querySelector('#closeRoutesBtn').addEventListener('click', ()=>{ activatePage('home'); });
  renderRoutesGrid();
}
function renderRoutesGrid(){
  const grid = document.getElementById('routesGrid');
  if(!grid) return;
  grid.innerHTML = '';
  const qCompany = filterCompany || chosenAirline || '';
  const list = ROUTES.filter(r=>{
    if(qCompany && r.airline!==qCompany) return false;
    if(chosenDurationIdx!==null){
      const d=DURATIONS[chosenDurationIdx];
      if(d.max){ if(!(r.durationMinutes >= d.min*60 && r.durationMinutes <= d.max*60)) return false; } else { if(!(r.durationMinutes >= d.min*60)) return false; }
    }
    return true;
  });
  if(!list.length){ grid.innerHTML = '<div style="color:var(--muted)">Нет направлений по текущим фильтрам</div>'; return; }
  list.forEach(r=>{
    const node=document.createElement('div'); node.className='route-card';
    node.innerHTML = `<div class="title">${r.fromICAO} → ${r.toICAO} · ${r.airlineCode}</div><div class="meta">${r.fromCity} → ${r.toCity} · ${Math.round(r.durationMinutes/60)} ч · ${r.airline}</div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn btn-primary" data-id="${r.id}" type="button">Выбрать</button></div>`;
    grid.appendChild(node);
  });
  grid.querySelectorAll('button[data-id]').forEach(b=>b.addEventListener('click', ()=>{
    const id=b.dataset.id; const route = ROUTES.find(x=>x.id===id);
    if(!SESSION.pilotId){ modalShow(document.getElementById('gateModal')); return; }
    openConfirmFromRoute(route);
  }));
}

/* FLEET page (только на вкладке Fleet) */
function renderFleetPage(){
  const container = document.createElement('section'); container.className='panel'; container.id='page-fleet';
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:900">Флот</div><div style="color:var(--muted);margin-top:6px">Флот сгруппирован по авиакомпаниям</div></div><div><button id="closeFleetBtn" class="btn btn-ghost" type="button">Закрыть</button></div></div><div id="fleetGroups" style="margin-top:12px"></div>`;
  dynamicPages.appendChild(container);
  container.querySelector('#closeFleetBtn').addEventListener('click', ()=> activatePage('home'));
  const groups = container.querySelector('#fleetGroups');
  AIRLINES.forEach(a=>{
    const group = document.createElement('div'); group.style.marginBottom='12px';
    group.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div style="display:flex;align-items:center;gap:12px"><div style="width:14px;height:14px;border-radius:3px;background:linear-gradient(180deg, ${a.colorA}, ${a.colorB});box-shadow:0 6px 20px rgba(0,0,0,0.18)"></div><div style="font-weight:900">${a.name}</div></div>
      <div><button class="btn btn-ghost small" data-action="toggle" data-air="${a.name}" type="button">Показать флот</button></div>
    </div><div class="fleet-list" data-air="${a.name}" style="margin-top:8px;display:none"></div>`;
    groups.appendChild(group);
  });
  groups.querySelectorAll('button[data-action="toggle"]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const air = btn.dataset.air; const list = groups.querySelector(`.fleet-list[data-air="${air}"]`);
      if(list.style.display==='none'){ list.style.display='block'; list.innerHTML=''; const items = FLEET.filter(f=>f.airline===air);
        if(!items.length) list.innerHTML = `<div style="color:var(--muted)">Нет самолётов</div>`;
        items.forEach(f=>{
          const card = document.createElement('div'); card.className='fleet-card'; card.style.marginBottom='8px';
          card.innerHTML = `<div class="title">${f.id} · ${f.type}</div><div class="meta">${f.locationICAO} · Топливо: ${f.fuelMinutes} мин · Статус: ${f.status}</div>`;
          list.appendChild(card);
        });
        btn.textContent='Скрыть флот';
      } else { list.style.display='none'; btn.textContent='Показать флот'; }
      attachRipple(groups);
    });
  });
  attachRipple(groups);
}

/* FLIGHTS page: рейсы текущего пилота */
function renderFlightsPage(){
  const container = document.createElement('section'); container.className='panel'; container.id='page-flights';
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:900">Рейсы пилота</div><div style="color:var(--muted);margin-top:6px">Текущие и ранее подтверждённые рейсы</div></div><div><button id="closeFlightsBtn" class="btn btn-ghost" type="button">Закрыть</button></div></div><div id="flightsList" style="margin-top:12px"></div>`;
  dynamicPages.appendChild(container);
  container.querySelector('#closeFlightsBtn').addEventListener('click', ()=> activatePage('home'));
  renderFlightsList();
}
function renderFlightsList(){
  const listEl = document.getElementById('flightsList');
  listEl.innerHTML = '';
  if(!SESSION.pilotId){ listEl.innerHTML = '<div style="color:var(--muted)">Войдите, чтобы видеть ваши рейсы</div>'; return; }
  if(CONFIRMED_FLIGHTS.length===0){ listEl.innerHTML = '<div style="color:var(--muted)">Нет подтверждённых рейсов</div>'; return; }
  CONFIRMED_FLIGHTS.forEach((f, idx)=>{
    const row = document.createElement('div'); row.className='route-card';
    row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div class="title">${f.aircraftId} · ${f.fromICAO} → ${f.toICAO}</div><div class="meta">Пилот ${f.pilotCallsign} · ${Math.round(f.durationMinutes/60)} ч</div></div>
      <div style="display:flex;flex-direction:column;gap:8px"><button class="btn btn-secondary" data-action="view" data-idx="${idx}">Детали</button><div style="display:flex;gap:6px">${f.status==='inFlight'?`<button class="btn btn-primary" data-action="arrived" data-idx="${idx}">Прилетел</button>`:''}<button class="btn btn-ghost" data-action="cancel" data-idx="${idx}">Отменить</button></div></div></div>`;
    listEl.appendChild(row);
  });
  listEl.querySelectorAll('button[data-action]').forEach(b=>{
    const action=b.dataset.action, idx=Number(b.dataset.idx);
    b.addEventListener('click', ()=>{ const f=CONFIRMED_FLIGHTS[idx]; if(!f) return; if(action==='view') openFlightDetail(f, idx); if(action==='arrived') markFlightArrived(idx); if(action==='cancel') cancelFlight(idx); });
  });
  attachRipple(listEl);
}

/* PILOTS page: список пилотов + быстрый вход за пилота */
function renderPilotsPage(){
  const container = document.createElement('section'); container.className='panel'; container.id='page-pilots';
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:900">Пилоты</div><div style="color:var(--muted);margin-top:6px">Существующие пилоты — можно быстро войти за любого</div></div><div><button id="closePilotsBtn" class="btn btn-ghost" type="button">Закрыть</button></div></div><div id="pilotsList" style="margin-top:12px" class="card-grid"></div>`;
  dynamicPages.appendChild(container);
  container.querySelector('#closePilotsBtn').addEventListener('click', ()=> activatePage('home'));
  const list = container.querySelector('#pilotsList'); list.innerHTML='';
  PILOTS.forEach(p=>{
    const card = document.createElement('div'); card.className='route-card';
    card.innerHTML = `<div><div class="title">${p.name}</div><div class="meta">Позывной: ${p.callSign} · ${p.verified ? 'Проверен' : 'Непроверен'}</div></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button class="btn btn-primary quick-login" data-id="${p.id}">Войти как</button></div>`;
    list.appendChild(card);
  });
  list.querySelectorAll('.quick-login').forEach(b=> b.addEventListener('click', ()=>{ const pid=b.dataset.id; quickLoginAsPilot(pid); }));
  attachRipple(list);
}

/* Flight detail modal functions */
function openFlightDetail(flight, idx){
  const detailModal = document.getElementById('flightDetailModal');
  document.getElementById('detailTitle').textContent = `${flight.aircraftId} · ${flight.fromICAO}→${flight.toICAO}`;
  document.getElementById('detailStatus').textContent = flight.status || '';
  document.getElementById('detailBody').innerHTML = `
    <div>Пилот: <strong>${flight.pilotCallsign}</strong></div>
    <div style="margin-top:6px">Длительность: <strong>${flight.durationMinutes} мин</strong></div>
    <div style="margin-top:6px">Подтверждён: <strong>${new Date(flight.ts).toLocaleString()}</strong></div>
    <div style="margin-top:8px">Остаток топлива: <strong>${flight.fuelLeft || '—'} мин</strong></div>
    <div style="margin-top:6px">Turnaround: <strong>${flight.turnaround || '—'} мин</strong></div>`;
  detailModal.dataset.idx = idx;
  modalShow(detailModal);
}
document.getElementById('closeDetail').addEventListener('click', ()=> modalHide(document.getElementById('flightDetailModal')));
document.getElementById('btnArrived').addEventListener('click', ()=>{ const idx=Number(document.getElementById('flightDetailModal').dataset.idx); markFlightArrived(idx); modalHide(document.getElementById('flightDetailModal')); if(currentPage==='flights') renderFlightsList(); });
document.getElementById('btnCancelFlight').addEventListener('click', ()=>{ const idx=Number(document.getElementById('flightDetailModal').dataset.idx); cancelFlight(idx); modalHide(document.getElementById('flightDetailModal')); if(currentPage==='flights') renderFlightsList(); });

function markFlightArrived(idx){
  const f = CONFIRMED_FLIGHTS[idx]; if(!f) return; f.status='arrived'; f.arrivedAt = Date.now(); const ac = FLEET.find(a=>a.id===f.aircraftId); if(ac){ ac.status='idle'; delete ac.availableAt; } if(SESSION.pilotId) localStorage.setItem(flightsKey(SESSION.pilotId), JSON.stringify(CONFIRMED_FLIGHTS));
}
function cancelFlight(idx){
  const f = CONFIRMED_FLIGHTS[idx]; if(!f) return; const ac = FLEET.find(a=>a.id===f.aircraftId); if(ac){ ac.status='idle'; delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil; delete ac.availableAt; } CONFIRMED_FLIGHTS.splice(idx,1); if(SESSION.pilotId) localStorage.setItem(flightsKey(SESSION.pilotId), JSON.stringify(CONFIRMED_FLIGHTS));
}

/* Candidate aircraft & confirm */
function findCandidateAircraftForRoute(route){
  const dur = Number(route.durationMinutes) || 0;
  const can = ac => ac.status==='idle' && (ac.fuelMinutes >= dur + (ac.reserveMargin||30));
  let cand = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && can(ac));
  if(!cand.length) cand = FLEET.filter(can);
  cand.sort((a,b)=> (b.fuelMinutes||0) - (a.fuelMinutes||0));
  return cand[0] || null;
}
function openConfirmFromRoute(route){
  const pilot = PILOTS.find(x=>x.id===SESSION.pilotId) || { id:SESSION.pilotId, callSign:SESSION.pilotId };
  const candidate = findCandidateAircraftForRoute(route);
  if(!candidate){ alert('Нет подходящих самолётов с запасом топлива'); return; }
  candidate.status='reserved'; candidate.reservedBy = pilot.id; candidate.reservedToken = pilot.id+':'+Date.now()+':'+Math.random().toString(36).slice(2,6); candidate.reservedUntil = Date.now() + 120000;
  PENDING_RESERVATION = { token:candidate.reservedToken, aircraft:candidate, route, pilotId:pilot.id, expires:candidate.reservedUntil };
  confirmDetailsEl.textContent = `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${Math.round(route.durationMinutes/60)} ч · Пилот ${pilot.callSign}`;
  modalShow(document.getElementById('confirmModal'));
}

/* Confirm accept/cancel */
document.getElementById('confirmAccept').addEventListener('click', ()=>{
  if(!PENDING_RESERVATION){ modalHide(document.getElementById('confirmModal')); return; }
  const ac = FLEET.find(a=>a.reservedToken===PENDING_RESERVATION.token);
  if(!ac){ alert('Резервация потеряна'); modalHide(document.getElementById('confirmModal')); return; }
  const p = PILOTS.find(x=>x.id===PENDING_RESERVATION.pilotId) || { id:PENDING_RESERVATION.pilotId, callSign:PENDING_RESERVATION.pilotId };
  ac.fuelMinutes = Math.max(0, (ac.fuelMinutes||0) - Number(PENDING_RESERVATION.route.durationMinutes));
  ac.status = 'inFlight'; ac.availableAt = Date.now() + (PENDING_RESERVATION.route.durationMinutes||120)*60000 + (ac.turnaround||0)*60000;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;
  const flight = { id:'flt_'+Math.random().toString(36).slice(2,8), aircraftId:ac.id, airline:ac.airline, fromICAO:PENDING_RESERVATION.route.fromICAO, toICAO:PENDING_RESERVATION.route.toICAO, durationMinutes:PENDING_RESERVATION.route.durationMinutes, pilotId:p.id, pilotCallsign:p.callSign, ts:Date.now(), status:'inFlight', fuelLeft:ac.fuelMinutes, turnaround:ac.turnaround };
  CONFIRMED_FLIGHTS.unshift(flight);
  if(SESSION.pilotId) localStorage.setItem(flightsKey(SESSION.pilotId), JSON.stringify(CONFIRMED_FLIGHTS));
  PENDING_RESERVATION = null; modalHide(document.getElementById('confirmModal'));
  // refresh current views
  if(currentPage==='fleet') renderFleetPage();
  if(currentPage==='routes') renderRoutesPage();
  if(currentPage==='flights') renderFlightsList();
});
document.getElementById('confirmCancel').addEventListener('click', ()=>{
  if(PENDING_RESERVATION){ const token=PENDING_RESERVATION.token; FLEET.forEach(a=>{ if(a.reservedToken===token){ a.status='idle'; delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; } }); PENDING_RESERVATION=null; }
  modalHide(document.getElementById('confirmModal'));
});

/* Login */
btnLogin.addEventListener('click', ()=>{
  const cs = (loginCall.value||'').trim(); const pass = (loginPass.value||'').trim();
  if(!cs || !pass){ alert('Введите позывной и пароль'); return; }
  const p = PILOTS.find(x=>x.callSign.toLowerCase()===cs.toLowerCase());
  if(p && p.password===pass){ SESSION.pilotId = p.id; sessionBadge.textContent = `Вошёл ${p.callSign}`; } else { SESSION.pilotId = 'guest_'+cs.toLowerCase(); sessionBadge.textContent = `Вошёл ${SESSION.pilotId}`; }
  openGateBtn.style.display='none'; logoutBtn.style.display='inline-flex'; modalHide(document.getElementById('gateModal'));
  const stored = localStorage.getItem(flightsKey(SESSION.pilotId)); CONFIRMED_FLIGHTS = stored ? JSON.parse(stored) : [];
  modalShow(document.getElementById('instructionModal'));
});
logoutBtn.addEventListener('click', ()=>{ if(SESSION.pilotId) localStorage.setItem(flightsKey(SESSION.pilotId), JSON.stringify(CONFIRMED_FLIGHTS)); SESSION.pilotId=null; CONFIRMED_FLIGHTS=[]; sessionBadge.textContent='Неавторизован'; openGateBtn.style.display='inline-flex'; logoutBtn.style.display='none'; if(currentPage==='flights') renderFlightsList(); });

openGateBtn.addEventListener('click', ()=> modalShow(document.getElementById('gateModal')));
openInstructionBtn.addEventListener('click', ()=> modalShow(document.getElementById('instructionModal')));
closeInstruction.addEventListener('click', ()=> modalHide(document.getElementById('instructionModal')));

/* Filters panel open/close */
openFiltersFleet && openFiltersFleet.addEventListener('click', ()=>{ populateFilterCompanies(); modalShow(document.getElementById('filterPanel')); });
document.getElementById('applyFilters').addEventListener('click', ()=>{ filterCompany = filterCompanySelect.value; modalHide(document.getElementById('filterPanel')); if(currentPage==='routes') renderRoutesPage(); });
document.getElementById('resetFilters').addEventListener('click', ()=>{ filterCompany = ''; chosenDurationIdx = null; document.querySelectorAll('.time-item').forEach(x=>x.style.outline='none'); filterCompanySelect.value=''; modalHide(document.getElementById('filterPanel')); if(currentPage==='routes') renderRoutesPage(); });

function populateFilterCompanies(){
  filterCompanySelect.innerHTML = '<option value="">Все</option>';
  AIRLINES.forEach(a=>{ const o=document.createElement('option'); o.value=a.name; o.textContent=`${a.name} (${a.code})`; filterCompanySelect.appendChild(o); });
}

/* Generation helpers */
generateBtn.addEventListener('click', ()=>{
  if(!SESSION.pilotId){ modalShow(document.getElementById('gateModal')); return; }
  const pool = ROUTES.filter(r=>{ if(chosenAirline && r.airline!==chosenAirline) return false; if(chosenDurationIdx!==null){ const d=DURATIONS[chosenDurationIdx]; if(d.max){ if(!(r.durationMinutes >= d.min*60 && r.durationMinutes <= d.max*60)) return false; } else { if(!(r.durationMinutes >= d.min*60)) return false; } } return true; });
  if(!pool.length){ alert('Нет маршрутов по текущим фильтрам'); return; }
  const route = pool[Math.floor(Math.random()*pool.length)];
  openConfirmFromRoute(route);
});
clearSelection.addEventListener('click', ()=>{ chosenAirline=null; chosenDurationIdx=null; selectedAir.textContent='Не выбрана'; document.querySelectorAll('.time-item').forEach(x=>x.style.outline='none'); renderAirlines(); if(currentPage==='routes') renderRoutesPage(); });

airSearchMain.addEventListener('input', ()=> renderAirlines());

/* Utilities */
function flightsKey(pid){ return 'lh_flights_' + pid; }
function quickLoginAsPilot(pid){
  const p = PILOTS.find(x=>x.id===pid); if(!p) return;
  SESSION.pilotId = p.id; sessionBadge.textContent = `Вошёл ${p.callSign}`; openGateBtn.style.display='none'; logoutBtn.style.display='inline-flex';
  const stored = localStorage.getItem(flightsKey(SESSION.pilotId)); CONFIRMED_FLIGHTS = stored ? JSON.parse(stored) : [];
  // switch to flights tab
  activatePage('flights');
}

/* Maintenance loop */
setInterval(()=>{
  const now = Date.now();
  FLEET.forEach(ac=>{
    if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil <= now){ ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil; }
    if(ac.status==='inFlight' && ac.availableAt && ac.availableAt <= now){ ac.status='idle'; delete ac.availableAt; CONFIRMED_FLIGHTS.forEach(f=>{ if(f.aircraftId===ac.id && f.status==='inFlight'){ f.status='arrived'; f.arrivedAt = now; } }); if(SESSION.pilotId) localStorage.setItem(flightsKey(SESSION.pilotId), JSON.stringify(CONFIRMED_FLIGHTS)); }
  });
  // auto-refresh current pages only
  if(currentPage==='fleet') { /* nothing heavy: rerender */ }
  if(currentPage==='flights') renderFlightsList();
}, 3000);

/* Robust splash handler */
function continueFromSplash(){
  try{ if(splash) splash.style.display='none'; }catch(e){}
  setTimeout(()=> modalShow(document.getElementById('gateModal')), 60);
}
(function attachSplashHandler(){
  const btn = document.getElementById('splashContinue');
  if(!btn) return;
  btn.replaceWith(btn.cloneNode(true));
  const fresh = document.getElementById('splashContinue');
  fresh.addEventListener('click', continueFromSplash, { passive:true });
  fresh.onclick = continueFromSplash;
})();

/* Tabs hookup already added above */

/* Init */
function init(){
  initDurations();
  renderAirlines();
  populateFilterCompanies();
  attachRipple(document);
}
init();

/* Mutation observer for ripple on dynamic nodes */
const mo = new MutationObserver(()=> attachRipple(document));
mo.observe(document.body,{childList:true,subtree:true});
</script>
</body>
</html>
