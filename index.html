<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lufthansa Helper — polished + full features</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#03061a; --bg-2:#05283a; --text:#eaf4ff; --muted:rgba(234,244,255,0.68);
  --accent-yellow:#ffd54a; --accent-yellow-2:#ffbf3a; --glass-border: rgba(255,255,255,0.06);
  --primary-dark:#072022;
  font-family:Inter,system-ui,Arial,sans-serif; font-size:15px;
  --glass-noise: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="n"><feTurbulence baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/><feColorMatrix type="saturate" values="0"/><feBlend mode="overlay"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.08" fill="%23ffffff"/></svg>');
}
/* Reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  min-height:100vh;
  background: linear-gradient(160deg,var(--bg-1),var(--bg-2));
  color:var(--text);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}

/* App root */
.app-root{display:flex;justify-content:center;align-items:flex-start;padding:18px;min-height:100vh}

/* Hero / glass panels */
.container{width:100%;max-width:1280px}
.hero{
  margin-top:28px;border-radius:16px;padding:18px;position:relative;overflow:visible;
  background:
    linear-gradient(180deg, rgba(255,255,255,0.045), rgba(255,255,255,0.02)),
    linear-gradient(180deg, rgba(0,8,20,0.55), rgba(0,8,20,0.65));
  border: 1px solid var(--glass-border);
  box-shadow: 0 20px 60px rgba(2,8,18,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
  backdrop-filter: blur(10px) saturate(140%); -webkit-backdrop-filter: blur(10px) saturate(140%);
  isolation:isolate;
}
.hero::before{ content:''; position:absolute; inset:0; border-radius:16px; pointer-events:none; box-shadow: inset 0 1px 30px rgba(255,255,255,0.02), inset 0 -20px 60px rgba(0,0,0,0.3); }

/* Header / tabs / controls */
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.brand{display:flex;gap:12px;align-items:center;min-width:0}
.logo{width:60px;height:60px;border-radius:12px;background: linear-gradient(180deg,#062b34,#032029);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent-yellow);font-size:18px;box-shadow:0 6px 20px rgba(0,0,0,0.45)}
.title{font-weight:900}
.subtitle{font-size:13px;color:var(--muted)}

.tabs{display:flex;gap:10px;margin-top:14px;position:relative;flex-wrap:wrap}
.tab{padding:10px 16px;border-radius:12px;font-weight:800;color:var(--text);background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.02);cursor:pointer;transition:transform .12s,box-shadow .12s}
.tab.active{ transform:translateY(-4px); box-shadow: 0 18px 44px rgba(0,0,0,0.45)}
.liquid-underline{ position:absolute; height:9px; bottom:-12px; border-radius:8px; background: linear-gradient(90deg,var(--accent-yellow),#ffb84d); transition:left 220ms,width 220ms,opacity 220ms; box-shadow:0 12px 36px rgba(255,160,60,0.14); opacity:0; }

/* Controls */
.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:16px}
.search{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text);min-width:240px}
.durations{display:flex;gap:8px;flex-wrap:wrap}

/* Panels */
.panel{ padding:14px;border-radius:12px;margin-top:12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)), linear-gradient(180deg, rgba(3,7,18,0.70), rgba(3,7,18,0.72));
  border:1px solid rgba(255,255,255,0.06);
  box-shadow:0 30px 80px rgba(2,8,18,0.6);
  backdrop-filter: blur(6px) saturate(130%);
  position:relative;
  isolation:isolate;
}
.panel::after{ content:''; position:absolute; inset:0;border-radius:12px; pointer-events:none; background-image: var(--glass-noise); opacity:0.05; mix-blend-mode:overlay; }

/* Airline grid */
.airline-grid{ margin-top:14px; display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px; align-items:start; width:100%; min-width:0; max-height:520px; overflow:auto; padding:14px; border-radius:16px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.03); box-shadow: inset 0 1px 0 rgba(255,255,255,0.02); }
.airline{ position:relative; display:flex;gap:14px;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border:1px solid rgba(255,255,255,0.03);box-shadow: 0 12px 36px rgba(0,0,0,0.45);cursor:pointer;transition:transform .18s,box-shadow .18s,filter .18s;}
.airline:hover{ transform: translateY(-8px); box-shadow: 0 36px 90px rgba(0,0,0,0.6) }
.airline .dot{ width:16px;height:16px;border-radius:50%;flex:0 0 16px;border:2px solid rgba(255,255,255,0.06) }
.airline .meta{min-width:0}
.airline .name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.airline .code{font-size:12px;color:var(--muted)}

/* SPLASH */
.splash-back{ position:fixed; inset:0; z-index:11000; display:flex; align-items:center; justify-content:center; background: linear-gradient(160deg, rgba(1,6,18,0.96), rgba(2,8,22,0.97)); overflow:hidden; }
.splash-gradient{ position:absolute; left:-20%; top:-20%; width:140%; height:140%; border-radius:20%; filter: blur(64px) saturate(140%); mix-blend-mode:screen; opacity:0.95; background: radial-gradient(40% 40% at 18% 22%, rgba(255,200,90,0.14), transparent 12%), radial-gradient(30% 30% at 80% 74%, rgba(0,170,255,0.08), transparent 18%), linear-gradient(110deg, rgba(255,160,60,0.08), rgba(30,130,255,0.04)); animation: gradFloat 16s ease-in-out infinite; }
.splash-waves{ position:absolute; left:0; right:0; bottom:-6vh; height:46vh; z-index:11030; pointer-events:none; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="none" viewBox="0 0 1200 450"><defs><linearGradient id="lg" x1="0" x2="1"><stop offset="0" stop-color="%23ffd54a" stop-opacity="0.12"/><stop offset="1" stop-color="%2300aaff" stop-opacity="0.06"/></linearGradient></defs><path d="M0,200 C200,320 400,80 600,200 C800,320 1000,80 1200,200 L1200,450 L0,450 Z" fill="url(%23lg)"/></svg>') center bottom / cover no-repeat; filter: blur(6px) saturate(120%); transform: translateZ(0); animation: waveShift 10s ease-in-out infinite alternate; }

/* ---------- BUTTON STYLES ---------- */
.btn{ position:relative; display:inline-flex; align-items:center; justify-content:center; cursor:pointer; -webkit-tap-highlight-color: transparent; }
.center-cta button{ font-weight:900; padding:14px 28px; border-radius:12px; border:0; cursor:pointer; background: linear-gradient(180deg,var(--accent-yellow),var(--accent-yellow-2)); color:var(--primary-dark); position:relative; overflow:hidden; box-shadow: 0 20px 60px rgba(255,165,40,0.12); transition: transform .18s ease, box-shadow .18s ease; }
.btn-neutral{ padding:9px 12px; border-radius:12px; font-weight:800; color:var(--text); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid rgba(255,255,255,0.06); box-shadow: 0 10px 26px rgba(2,8,18,0.45); transition: transform .14s ease, box-shadow .14s ease, background .14s ease; }
.btn-primary{ padding:10px 14px; border-radius:14px; font-weight:900; color:var(--primary-dark); background: linear-gradient(180deg, var(--accent-yellow), var(--accent-yellow-2)); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 18px 48px rgba(255,165,40,0.12); transition: transform .14s ease, box-shadow .14s ease, filter .14s ease; }
.btn-ghost{ padding:8px 10px; border-radius:10px; font-weight:700; color:var(--muted); background: transparent; border: 1px dashed rgba(255,255,255,0.04); transition: color .12s, border-color .12s; }

/* focus (accessibility) */
button:focus{ outline: 3px solid rgba(255,210,80,0.14); outline-offset:3px; }

/* ripple & spinner */
.btn .ripple{ position:absolute; border-radius:50%; transform:scale(0); pointer-events:none; opacity:0.45; background:rgba(255,255,255,0.88); transition: transform 550ms cubic-bezier(.2,.9,.2,1), opacity 350ms ease; will-change: transform, opacity; mix-blend-mode: screen; }
.btn:active{ transform: translateY(1px) scale(0.998); transition: transform 80ms; }
.btn .btn-spinner{ display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; margin-right:10px; flex-shrink:0; }
.btn .btn-spinner svg{ width:18px;height:18px; display:block; animation: btn-spin 900ms linear infinite; transform-origin: center center; }
@keyframes btn-spin { from{ transform: rotate(0deg) } to{ transform: rotate(360deg) } }
.btn[aria-disabled="true"], .btn:disabled{ opacity: 0.48; cursor: not-allowed; transform: none; box-shadow: none; pointer-events: none; }

/* modal backdrop centered and layout fixed */
.modal-back{
  display:none;
  position:fixed;
  inset:0;
  z-index:12000;
  background:rgba(0,0,0,0.6);
  align-items:center;
  justify-content:center;
  padding:24px;
}

/* modal card */
.modal{
  width:420px;
  max-width:100%;
  border-radius:12px;
  padding:16px;
  background: linear-gradient(180deg, rgba(255,255,255,0.035), rgba(5,10,18,0.93));
  border:1px solid rgba(255,255,255,0.06);
  box-shadow:0 30px 80px rgba(0,0,0,0.6);
  backdrop-filter: blur(8px) saturate(120%);
}

/* small utility */
.kv{font-size:13px;color:var(--muted)}
.input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:var(--text)}
.row{display:flex;gap:8px;align-items:center;margin-top:10px}

/* responsive */
@media(max-width:900px){
  .center-block h2{ font-size:24px; }
  .panel{ padding:12px }
  .btn-primary{ padding:10px 12px; }
}
</style>
</head>
<body>
<div id="appRoot" class="app-root">
  <div class="container">
    <div id="appHero" class="hero">
      <div class="header">
        <div class="brand">
          <div class="logo">LH</div>
          <div>
            <div class="title">Lufthansa Helper</div>
            <div class="subtitle">усиленное LED · liquid glass · демонстрация</div>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <div id="sessionBadge" class="kv">Неавторизован</div>
          <button id="openGateBtn" class="btn-neutral btn">Вход</button>
          <button id="logoutBtn" class="btn-neutral btn" style="display:none">Выйти</button>
        </div>
      </div>

      <div class="tabs" id="tabsRow" style="margin-top:14px">
        <div class="tab active btn" data-target="panelGenerate" id="tabGen">Генерация</div>
        <div class="tab btn" data-target="panelRoutes" id="tabRoutes">Направления</div>
        <div class="tab btn" data-target="panelFleet" id="tabFleet">Флот</div>
        <div id="liquidUnderline" class="liquid-underline"></div>
      </div>

      <div class="controls">
        <input id="airSearch" class="search" placeholder="Поиск авиакомпании или кода" autocomplete="off" />
        <div style="display:flex;align-items:center;gap:10px">
          <strong class="kv">Время</strong>
          <div id="durations" class="durations"></div>
        </div>

        <div style="margin-left:auto;display:flex;gap:10px;align-items:center">
          <button id="clearBtn" class="btn-neutral btn">Сброс</button>
          <button id="genBtn" class="btn-primary btn">СГЕНЕРИРОВАТЬ</button>
        </div>
      </div>

      <div id="airGrid" class="airline-grid" aria-live="polite"></div>

      <div class="layout" style="display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:16px;min-width:0">
        <main>
          <section id="panelGenerate" class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Генерация</div>
              <div class="kv">Нажмите СГЕНЕРИРОВАТЬ для демонстрации</div>
            </div>
            <div id="generatedNote" style="margin-top:12px" class="kv">Выберите авиакомпанию и интервал времени</div>
          </section>

          <section id="panelRoutes" class="panel" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Направления</div>
              <div class="kv">Список маршрутов по фильтрам</div>
            </div>
            <div id="routesList" style="margin-top:12px"></div>
          </section>

          <section id="panelFleet" class="panel" style="display:none">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Флот</div>
              <div class="kv">Самолёты под фильтрами</div>
            </div>
            <div id="fleetList" style="margin-top:12px"></div>
          </section>
        </main>

        <aside>
          <div class="panel" style="padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Пилоты</div>
              <div class="kv">Demo</div>
            </div>
            <div style="margin-top:8px">
              <input id="pilotSearch" class="input" placeholder="Поиск пилота" />
            </div>
            <div id="pilotList" style="margin-top:8px"></div>
          </div>

          <div class="panel" style="margin-top:12px;padding:12px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Актуальные рейсы</div>
              <div class="kv">Сохранены в локальном хранилище</div>
            </div>
            <div id="currentFlights" class="kv" style="margin-top:8px;max-height:160px;overflow:auto">Нет текущих рейсов</div>
            <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:900">Журнал</div>
              <div><button id="openGate2" class="btn-ghost btn">Вход</button></div>
            </div>
            <div id="log" class="kv" style="margin-top:8px;max-height:320px;overflow:auto">Пусто</div>
          </div>
        </aside>
      </div>
    </div>
  </div>
</div>

<!-- Splash -->
<div id="splash" class="splash-back">
  <div class="splash-gradient g1"></div>
  <div class="splash-gradient g2"></div>
  <div class="splash-gradient g3"></div>
  <div class="splash-waves"></div>

  <div class="splash-center" role="dialog" aria-modal="true" aria-label="Welcome">
    <div class="center-block">
      <h2 id="splashTitle">Welcome to Lufthansa Group</h2>
      <div class="center-cta">
        <button id="splashContinue" class="btn">Дальше</button>
      </div>
    </div>
  </div>
</div>

<!-- Gate modal (центральный, обязательный пароль) -->
<div id="gateModal" class="modal-back" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Вход">
    <div style="font-weight:900">Вход в систему</div>
    <div class="small kv" style="margin-top:8px">Введите позывной и пароль. Кодовое слово: <strong>quickaccess2025</strong></div>

    <div class="row" style="margin-top:10px">
      <input id="loginCall" class="input" placeholder="Позывной (callSign)" autocomplete="username" />
    </div>
    <div class="row">
      <input id="loginPass" class="input" placeholder="Пароль или кодовое слово" type="password" autocomplete="current-password" />
    </div>

    <div class="row" style="align-items:center;margin-top:12px">
      <input id="tourAfterLogin" type="checkbox" checked />
      <label for="tourAfterLogin" class="small" style="margin-left:6px">Показать инструкцию после входа</label>
    </div>

    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:14px;align-items:center">
      <div style="display:flex;gap:8px">
        <button id="btnDemoQuick" class="btn-neutral btn" title="Быстрый вход (демо)">Быстрый вход</button>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnLogin" class="btn-primary btn">Войти</button>
      </div>
    </div>
  </div>
</div>

<!-- Tour -->
<div id="tour" class="modal-back" style="display:none;align-items:center;justify-content:center">
  <div class="modal" role="dialog" aria-modal="true">
    <div style="font-weight:900">Краткая инструкция</div>
    <div class="small kv" style="margin-top:8px">1) Выберите авиакомпанию; 2) Выберите интервал времени; 3) Нажмите СГЕНЕРИРОВАТЬ и подтвердите бронь.</div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="tourSkip" class="btn-neutral btn">Пропустить</button>
      <button id="tourDone" class="btn-primary btn">Готово</button>
    </div>
  </div>
</div>

<!-- Confirm -->
<div id="confirmModal" class="modal-back" style="display:none;">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Подтвердить бронь">
    <div style="font-weight:900">Подтвердить рейс</div>
    <div id="confirmDetails" class="kv" style="margin-top:8px"></div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="btn-neutral btn">Отменить</button>
      <button id="confirmAccept" class="btn-primary btn">Подтвердить</button>
    </div>
  </div>
</div>

<script>
/* ================= DATA & STATE ================= */
const CODEWORD = 'quickaccess2025';
const SESSION_KEY = 'lh_force_auth_v1';
const LOG_KEY = 'lh_fleet_log_v1';
const CURRENT_FLIGHTS_KEY = 'lh_current_flights_v1';

const DURATIONS = [
  {label:"1–2ч",min:60,max:120},{label:"2–3ч",min:120,max:180},{label:"3–4ч",min:180,max:240},
  {label:"5–6ч",min:300,max:360},{label:"6–7ч",min:360,max:420},{label:"7–8ч",min:420,max:480},
  {label:"8–9ч",min:480,max:540},{label:"9–10ч",min:540,max:600},{label:"10+ч",min:600,max:99999}
];

const AIRLINES = [
  {name:"Lufthansa",code:"LH",color:"#1E6FFF"},
  {name:"Lufthansa Cargo",code:"G0",color:"#0A63D6"},
  {name:"Eurowings",code:"EW",color:"#8A4BFF"},
  {name:"Condor",code:"DE",color:"#FFD200"},
  {name:"Swiss",code:"LX",color:"#D81E5B"},
  {name:"Austrian",code:"OS",color:"#DA291C"},
  {name:"Brussels",code:"SN",color:"#003399"},
  {name:"SunExpress",code:"SX",color:"#FF8A3D"}
];

function generateRoutesForAirlines(airlines){
  const out = [];
  const baseAirports = ["EDDF","EGLL","LFPG","LEBL","LSZH","KJFK","EHAM","EBBR","LIRF","LOWW","ENBR","EKCH","ESSA","LIMC"];
  let seq = 100;
  airlines.forEach((a, ai)=>{
    for(let i=0;i<5;i++){
      const from = baseAirports[(ai + i) % baseAirports.length];
      const to = baseAirports[(ai + i + 3) % baseAirports.length];
      const duration = 60 + (i*30) + (ai*15) + ((i%2)?20:0);
      const id = `${a.code}-${seq++}`;
      out.push({
        id,
        airline: a.name,
        airlineCode: a.code,
        fromICAO: from,
        toICAO: to,
        fromCity: `City-${from}`,
        toCity: `City-${to}`,
        durationMinutes: duration
      });
    }
  });
  return out;
}

const ROUTES = generateRoutesForAirlines(AIRLINES);

let FLEET = [
  {id:"LH-A320-01",airline:"Lufthansa",type:"A320",locationICAO:"EDDF",status:"idle",maxFlightMinutes:240,fuelMinutes:400,turnaround:35,reserveMargin:30},
  {id:"LX-A320-01",airline:"Swiss",type:"A320",locationICAO:"EDDF",status:"idle",maxFlightMinutes:300,fuelMinutes:420,turnaround:35,reserveMargin:30},
  {id:"DE-B767-01",airline:"Condor",type:"B767",locationICAO:"EDDF",status:"idle",maxFlightMinutes:720,fuelMinutes:800,turnaround:50,reserveMargin:60}
];

let PILOTS = [
  {id:"pilot_ivan",name:"Ivan Petrov",callSign:"IPET",verified:true,password:"ivanpass"},
  {id:"pilot_loui",name:"Loui Desulier",callSign:"FRENCH",verified:true,password:"louiSecret"}
];

let FLEET_LOG = loadFromStorage(LOG_KEY, []);
let CURRENT_FLIGHTS = loadFromStorage(CURRENT_FLIGHTS_KEY, []);

let PENDING_RESERVATION = null;
let SESSION = (function(){ try{ const s = sessionStorage.getItem(SESSION_KEY); return s?JSON.parse(s):{pilotId:null}; }catch(e){ return {pilotId:null}; } })();

let chosenAirline = null;
let chosenDuration = null;
let searchQuery = '';

/* DOM refs */
const splash = document.getElementById('splash');
const splashContinue = document.getElementById('splashContinue');
const airGrid = document.getElementById('airGrid');
const durWrap = document.getElementById('durations');
const airSearch = document.getElementById('airSearch');
const routesList = document.getElementById('routesList');
const fleetList = document.getElementById('fleetList');
const pilotListEl = document.getElementById('pilotList');
const pilotSearch = document.getElementById('pilotSearch');
const sessionBadge = document.getElementById('sessionBadge');
const openGateBtn = document.getElementById('openGateBtn');
const openGate2 = document.getElementById('openGate2');
const logoutBtn = document.getElementById('logoutBtn');
const gateModal = document.getElementById('gateModal');
const btnLogin = document.getElementById('btnLogin');
const btnDemoQuick = document.getElementById('btnDemoQuick');
const loginCall = document.getElementById('loginCall');
const loginPass = document.getElementById('loginPass');
const genBtn = document.getElementById('genBtn');
const tabElements = document.querySelectorAll('.tab');
const liquidUnderline = document.getElementById('liquidUnderline');
const currentFlightsEl = document.getElementById('currentFlights');

/* helpers */
function nowMs(){return Date.now();}
function saveToStorage(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(e){} }
function loadFromStorage(k, def){ try{ const s = localStorage.getItem(k); return s?JSON.parse(s):def; }catch(e){ return def; } }
function log(msg){ FLEET_LOG.unshift({ts:nowMs(),msg}); saveToStorage(LOG_KEY,FLEET_LOG); renderAssignLog(); }
function uid(prefix='id'){ return prefix+'_'+Math.random().toString(36).slice(2,9); }

/* ====== Render functions ====== */
function renderDurations(){ durWrap.innerHTML=''; DURATIONS.forEach((d,i)=>{ const b=document.createElement('div'); b.className='time-pill btn'; b.dataset.idx=i; b.innerHTML=`<div style="display:flex;align-items:center;gap:10px"><div style="width:12px;height:12px;border-radius:50%;background:linear-gradient(90deg,var(--accent-yellow),#ffbf4a)"></div><div><div class="label">${d.label}</div><div class="hint" style="font-size:12px;color:var(--muted)">Интервал</div></div></div>`; b.addEventListener('click', ()=>{ chosenDuration=(chosenDuration===i)?null:i; updateActiveUI(); renderLists(); }); if(chosenDuration===i) b.style.boxShadow='0 26px 64px rgba(255,175,40,0.28)'; durWrap.appendChild(b); }); }

function renderAirGrid(){ airGrid.innerHTML=''; const filtered=AIRLINES.filter(a=>{ if(!searchQuery) return true; const q=searchQuery.toLowerCase(); return a.name.toLowerCase().includes(q)||(a.code&&a.code.toLowerCase().includes(q)); }); filtered.forEach(a=>{ const card=document.createElement('div'); card.className='airline'; card.dataset.airline=a.name; card.innerHTML=`<div class="dot" style="background:${a.color}"></div><div class="meta"><div class="name">${a.name}</div><div class="code">${a.code}</div></div>`; card.addEventListener('click', ()=>{ chosenAirline=(chosenAirline===a.name)?null:a.name; updateActiveUI(); renderLists(); placeUnderline(document.querySelector('.tab.active')); }); airGrid.appendChild(card); }); updateActiveUI(); }

function renderRoutes(){ routesList.innerHTML=''; const list=ROUTES.filter(r=>{ if(chosenAirline&&r.airline!==chosenAirline) return false; if(chosenDuration!==null){ const d=DURATIONS[chosenDuration]; if(!(r.durationMinutes>=d.min&&r.durationMinutes<=d.max)) return false; } return true; }); if(!list.length){ routesList.innerHTML='<div class="kv">Нет направлений</div>'; return; } list.forEach(r=>{ const row=document.createElement('div'); row.className='route-item'; row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='10px'; row.style.borderRadius='10px'; row.style.marginTop='8px'; row.style.background='linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02))'; row.innerHTML=`<div><div style="font-weight:800">${r.fromICAO} → ${r.toICAO} · ${r.airlineCode}</div><div class="kv">${r.fromCity} → ${r.toCity}</div></div><div style="text-align:right"><div class="kv">${r.durationMinutes} мин</div><div style="margin-top:8px"><button class="btn-primary btn" data-route-id="${r.id}">Выбрать</button></div></div>`; routesList.appendChild(row); }); routesList.querySelectorAll('button[data-route-id]').forEach(b=>{ b.addEventListener('click', ()=>{ const id=b.getAttribute('data-route-id'); const route=ROUTES.find(x=>x.id===id); if(route) openConfirmFromRoute(route); }); }); }

function renderFleet(){ fleetList.innerHTML=''; const list=FLEET.filter(a=>{ if(chosenAirline&&a.airline!==chosenAirline) return false; if(chosenDuration!==null){ const d=DURATIONS[chosenDuration]; if(a.maxFlightMinutes<d.min) return false; } return true; }); if(!list.length){ fleetList.innerHTML='<div class="kv">Нет самолётов</div>'; return; } list.forEach(a=>{ const pct=Math.min(100,Math.round((a.fuelMinutes/Math.max(a.maxFlightMinutes,300))*100)); const div=document.createElement('div'); div.className='route-item'; div.style.display='flex'; div.style.justifyContent='space-between'; div.style.alignItems='center'; div.style.marginTop='8px'; div.innerHTML=`<div><div style="font-weight:800">${a.id}</div><div class="kv">${a.airline} · ${a.type} · ${a.locationICAO}</div></div><div class="kv">${pct}% · ${a.fuelMinutes} мин</div>`; fleetList.appendChild(div); }); }

function renderPilots(){ pilotListEl.innerHTML=''; const q=(pilotSearch.value||'').toLowerCase().trim(); PILOTS.filter(p=>!q||(p.name+' '+p.callSign).toLowerCase().includes(q)).forEach(p=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginTop='8px'; row.innerHTML=`<div><strong>${p.name}</strong><div class="kv">${p.callSign} ${p.verified? '· Verified':''}</div></div>`; const b=document.createElement('button'); b.className='btn-neutral btn'; b.textContent='Войти'; b.addEventListener('click',()=>{ loginCall.value=p.callSign||''; loginPass.value=''; showGateModal(); }); row.appendChild(b); pilotListEl.appendChild(row); }); }

function renderAssignLog(){ const el=document.getElementById('log'); el.innerHTML=''; if(!FLEET_LOG.length){ el.textContent='Пусто'; return; } FLEET_LOG.slice(-200).reverse().forEach(e=>{ const d=document.createElement('div'); d.className='kv'; d.style.marginTop='6px'; d.textContent=`${new Date(e.ts).toLocaleString()} — ${e.msg}`; el.appendChild(d); }); }

function renderCurrentFlights(){ currentFlightsEl.innerHTML=''; if(!CURRENT_FLIGHTS.length){ currentFlightsEl.textContent='Нет текущих рейсов'; return; } CURRENT_FLIGHTS.forEach(f=>{ const el=document.createElement('div'); el.className='kv'; el.style.marginTop='8px'; el.innerHTML=`<div style="font-weight:800">${f.aircraftId} · ${f.airline}</div><div class="kv">${f.fromICAO}→${f.toICAO} · ${f.durationMinutes} мин · Пилот ${f.pilotCallsign}</div>`; currentFlightsEl.appendChild(el); }); }

/* ====== Auth & session ====== */
function showGateModal(){ gateModal.style.display='flex'; gateModal.setAttribute('aria-hidden','false'); setTimeout(()=> loginCall.focus(),50); }
function hideGateModal(){ gateModal.style.display='none'; gateModal.setAttribute('aria-hidden','true'); }

btnLogin.addEventListener('click', async ()=> {
  const cs = (loginCall.value||'').trim();
  const pass = (loginPass.value||'').trim();
  if(!cs){ alert('Введите позывной'); loginCall.focus(); return; }
  if(!pass){ alert('Введите пароль или кодовое слово'); loginPass.focus(); return; }
  const p = PILOTS.find(x=> (x.callSign||'').toLowerCase() === cs.toLowerCase());
  if(!p){ alert('Пилот не найден'); return; }
  setButtonLoading(btnLogin, true, {label:'Вход...'});
  try{
    await new Promise(r=>setTimeout(r,700));
    if(pass === CODEWORD || pass === p.password){
      SESSION.pilotId = p.id; sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); renderSession();
      hideGateModal();
      if(document.getElementById('tourAfterLogin') && document.getElementById('tourAfterLogin').checked) openTour(0);
      renderCurrentFlights();
      log(`Пилот ${p.callSign} вошёл в систему`);
    } else {
      alert('Неверный пароль');
      loginPass.focus();
    }
  } finally {
    setButtonLoading(btnLogin, false);
  }
});

btnDemoQuick.addEventListener('click', ()=>{ loginPass.value = CODEWORD; if(!loginCall.value.trim()) loginCall.value = PILOTS[0].callSign; btnLogin.click(); });

openGateBtn.addEventListener('click', showGateModal);
openGate2.addEventListener('click', showGateModal);

logoutBtn.addEventListener('click', ()=>{ SESSION.pilotId = null; sessionStorage.removeItem(SESSION_KEY); renderSession(); showGateModal(); });

function renderSession(){ if(SESSION.pilotId){ const p = PILOTS.find(x=>x.id === SESSION.pilotId) || {}; sessionBadge.textContent = p.callSign ? `Вошёл ${p.callSign}` : 'Вошёл'; logoutBtn.style.display='inline-flex'; openGateBtn.style.display='none'; } else { sessionBadge.textContent='Неавторизован'; logoutBtn.style.display='none'; openGateBtn.style.display='inline-flex'; } }

/* ====== Splash handling ====== */
function openSplash(){ splash.style.display = 'flex'; document.body.classList.add('splash-open'); }
function hideSplash(){ splash.style.display = 'none'; document.body.classList.remove('splash-open'); }
splashContinue.addEventListener('click', ()=>{ splash.style.transition = 'opacity .45s ease, transform .45s ease'; splash.style.opacity = '0'; splash.style.transform = 'scale(.995)'; setTimeout(()=>{ hideSplash(); showGateModal(); },420); });

/* ====== Reservation flow ====== */
function findCandidateAircraftForRoute(route){
  const dur = Number(route.durationMinutes) || 0;
  const can = ac => ac.status==='idle' && (typeof ac.maxFlightMinutes!=='number' || ac.maxFlightMinutes >= dur) && (typeof ac.fuelMinutes==='number' && ac.fuelMinutes >= (dur + (ac.reserveMargin||30)));
  let cand = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && can(ac));
  if(!cand.length) cand = FLEET.filter(ac => can(ac));
  if(!cand.length) return null;
  cand.sort((a,b)=> (b.fuelMinutes||0) - (a.fuelMinutes||0));
  return cand[0];
}
function openConfirmFromRoute(route){
  const pilot = (SESSION.pilotId ? PILOTS.find(x=>x.id === SESSION.pilotId) : null);
  if(!pilot){ showGateModal(); return; }
  const candidate = findCandidateAircraftForRoute(route);
  if(!candidate){ alert('Нет подходящих самолётов с запасом топлива'); return; }
  candidate.status='reserved';
  candidate.reservedBy = pilot.id;
  candidate.reservedToken = pilot.id+':'+Date.now()+':'+Math.random().toString(36).slice(2,8);
  candidate.reservedUntil = nowMs() + 120000;
  PENDING_RESERVATION = { token: candidate.reservedToken, aircraft: candidate, route, pilotId: pilot.id, expires: candidate.reservedUntil };
  document.getElementById('confirmDetails').textContent = `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${route.durationMinutes} мин · Пилот ${pilot.callSign}`;
  document.getElementById('confirmModal').style.display = 'flex';
}
document.getElementById('confirmAccept').addEventListener('click', ()=> {
  if(!PENDING_RESERVATION){ document.getElementById('confirmModal').style.display='none'; return; }
  const ac = FLEET.find(a=>a.reservedToken === PENDING_RESERVATION.token);
  if(!ac){ alert('Резервация потеряна'); document.getElementById('confirmModal').style.display='none'; return; }
  const p = PILOTS.find(x=>x.id===PENDING_RESERVATION.pilotId);
  if(!(p && p.verified)){ alert('Пилот не верифицирован'); document.getElementById('confirmModal').style.display='none'; return; }
  ac.fuelMinutes = Math.max(0, (ac.fuelMinutes||0) - Number(PENDING_RESERVATION.route.durationMinutes));
  ac.status='inFlight';
  ac.availableAt = nowMs() + (PENDING_RESERVATION.route.durationMinutes||120)*60000 + (ac.turnaround||0)*60000;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;
  const flight = {
    id: uid('flt'),
    aircraftId: ac.id,
    airline: ac.airline,
    fromICAO: PENDING_RESERVATION.route.fromICAO,
    toICAO: PENDING_RESERVATION.route.toICAO,
    durationMinutes: PENDING_RESERVATION.route.durationMinutes,
    pilotId: p.id,
    pilotCallsign: p.callSign,
    ts: nowMs()
  };
  CURRENT_FLIGHTS.unshift(flight);
  saveToStorage(CURRENT_FLIGHTS_KEY, CURRENT_FLIGHTS);
  FLEET_LOG.unshift({ts: nowMs(), event:'assign_confirmed', msg:`Рейс подтверждён ${flight.aircraftId} ${flight.fromICAO}->${flight.toICAO} пилот ${flight.pilotCallsign}`});
  saveToStorage(LOG_KEY, FLEET_LOG);
  PENDING_RESERVATION = null;
  document.getElementById('confirmModal').style.display='none';
  renderLists();
  renderCurrentFlights();
  renderAssignLog();
  alert('Рейс подтверждён и сохранён в журнале');
});
document.getElementById('confirmCancel').addEventListener('click', ()=> {
  if(PENDING_RESERVATION){ const token = PENDING_RESERVATION.token; FLEET.forEach(a=>{ if(a.reservedToken === token){ a.status='idle'; delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; FLEET_LOG.unshift({ts:nowMs(), msg:`Бронь отменена ${a.id}`}); }}); PENDING_RESERVATION = null; }
  document.getElementById('confirmModal').style.display='none';
  renderLists();
  renderAssignLog();
});

/* periodic maintenance */
setInterval(()=>{ const now=nowMs(); FLEET.forEach(ac=>{ if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil<=now){ ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil; FLEET_LOG.unshift({ts:now,msg:`Резервация истекла ${ac.id}`}); } if(ac.status==='inFlight' && ac.availableAt && ac.availableAt<=now){ ac.status='idle'; delete ac.availableAt; FLEET_LOG.unshift({ts:now,msg:`Самолёт вернулся в сервис ${ac.id}`}); } }); saveToStorage(LOG_KEY, FLEET_LOG); renderAssignLog(); renderFleet(); },1500);

/* UI helpers & selection visuals */
function updateActiveUI(){ Array.from(airGrid.children).forEach(card=>{ const name = card.getAttribute('data-airline'); if(name === chosenAirline){ card.style.boxShadow = `0 36px 120px ${hexToRgba((AIRLINES.find(x=>x.name===name)||{color:'#ffbf3a'}).color,0.14)}`; } else { card.style.boxShadow = ''; } }); Array.from(durWrap.children).forEach((b,idx)=>{ if(idx===chosenDuration) b.style.boxShadow='0 26px 64px rgba(255,175,40,0.28)'; else b.style.boxShadow=''; }); }

function placeUnderline(tabEl){ if(!tabEl){ liquidUnderline.style.opacity='0'; return; } const parentRect = tabEl.parentElement.getBoundingClientRect(); const rect = tabEl.getBoundingClientRect(); liquidUnderline.style.left=(rect.left-parentRect.left)+'px'; liquidUnderline.style.width=rect.width+'px'; liquidUnderline.style.opacity='1'; }
tabElements.forEach(tab=>{ tab.addEventListener('click', ()=>{ tabElements.forEach(t=>t.classList.remove('active')); tab.classList.add('active'); const target=tab.getAttribute('data-target'); ['panelGenerate','panelRoutes','panelFleet'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.style.display=(id===target)?'block':'none'; }); genBtn.style.display=(target==='panelGenerate')?'inline-flex':'none'; requestAnimationFrame(()=>placeUnderline(tab)); }); });
window.addEventListener('resize', ()=>{ const active=document.querySelector('.tab.active'); if(active) placeUnderline(active); });

airSearch.addEventListener('input', e=>{ searchQuery=e.target.value.trim(); renderAirGrid(); updateActiveUI(); });
document.getElementById('clearBtn').addEventListener('click', ()=>{ searchQuery=''; airSearch.value=''; chosenAirline=null; chosenDuration=null; renderLists(); updateActiveUI(); });

genBtn.addEventListener('click', async () => {
  if(!SESSION.pilotId){ showGateModal(); return; }
  setButtonLoading(genBtn, true, {label:'Генерация...'});
  try{
    await new Promise(r=>setTimeout(r,1400));
    const pool=ROUTES.filter(r=>{ if(chosenAirline&&r.airline!==chosenAirline) return false; if(chosenDuration!==null){ const d=DURATIONS[chosenDuration]; if(!(r.durationMinutes>=d.min&&r.durationMinutes<=d.max)) return false; } return true; });
    if(!pool.length){ alert('Нет маршрутов по текущим фильтрам'); return; }
    const route=pool[Math.floor(Math.random()*pool.length)];
    openConfirmFromRoute(route);
  } finally {
    setButtonLoading(genBtn,false);
  }
});

/* render lists */
function renderLists(){ renderAirGrid(); renderDurations(); renderRoutes(); renderFleet(); renderPilots(); updateActiveUI(); renderAssignLog(); renderCurrentFlights(); }

/* util */
function hexToRgba(hex, a=1){ const h = hex.replace('#',''); const full = h.length===3?h.split('').map(c=>c+c).join(''):h; const num=parseInt(full,16); const r=(num>>16)&255,g=(num>>8)&255,b=num&255; return `rgba(${r}, ${g}, ${b}, ${a})`; }

/* tour */
const TOUR_STEPS = [{icon:'1', title:'Выбор авиакомпании', text:''},{icon:'2', title:'Выбор времени', text:''},{icon:'3', title:'Генерация и бронь', text:''}];
let tourIndex=0;
function openTour(startIndex=0){ tourIndex=startIndex||0; document.getElementById('tour').style.display='flex'; }
document.getElementById('tourDone').addEventListener('click', ()=>{ if(tourIndex<TOUR_STEPS.length-1){ tourIndex++; } else { document.getElementById('tour').style.display='none'; } });
document.getElementById('tourSkip').addEventListener('click', ()=>{ document.getElementById('tour').style.display='none'; });

/* init */
function init(){ renderLists(); const defaultTab=document.querySelector('.tab[data-target="panelGenerate"]'); if(defaultTab){ defaultTab.classList.add('active'); placeUnderline(defaultTab); } renderSession(); openSplash(); }
init();

/* ================= Button polish utilities (ripple, spinner, loading) ================= */
function createRippleEl(){ const r=document.createElement('span'); r.className='ripple'; r.style.width=r.style.height='8px'; r.style.left='0px'; r.style.top='0px'; return r; }
function attachRipple(btn){
  if(!btn) return;
  btn.classList.add('btn');
  btn.addEventListener('pointerdown', function(ev){
    if(btn.getAttribute('aria-disabled') === 'true' || btn.disabled) return;
    const rect = btn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height) * 1.4;
    let ripple = btn.querySelector('.ripple');
    if(!ripple){ ripple = createRippleEl(); btn.prepend(ripple); }
    ripple.style.width = ripple.style.height = size + 'px';
    const x = ev.clientX - rect.left - size/2;
    const y = ev.clientY - rect.top - size/2;
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    ripple.style.transform = 'scale(0)';
    ripple.style.opacity = '0.45';
    void ripple.offsetWidth;
    ripple.style.transform = 'scale(1)';
    ripple.style.transition = 'transform 550ms cubic-bezier(.2,.9,.2,1), opacity 420ms ease';
    setTimeout(()=> { ripple.style.opacity = '0'; }, 420);
  }, {passive:true});
}
function setButtonLoading(btn, isLoading, opts = {}){
  if(!btn) return;
  if(isLoading){
    btn.setAttribute('aria-disabled','true'); btn.disabled = true;
    if(!btn.querySelector('.btn-spinner')){
      const spinnerWrap = document.createElement('span'); spinnerWrap.className = 'btn-spinner';
      spinnerWrap.innerHTML = '<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="rgba(0,0,0,0.12)" stroke-width="3"/><path d="M22 12a10 10 0 0 1-10 10" stroke="rgba(0,0,0,0.36)" stroke-width="3" stroke-linecap="round"/></svg>';
      btn.insertBefore(spinnerWrap, btn.firstChild);
    }
    if(opts.label){
      if(!btn._origLabel) btn._origLabel = btn.querySelector('.btn-label') ? btn.querySelector('.btn-label').textContent : btn.textContent;
      let lab = btn.querySelector('.btn-label');
      if(!lab){ lab = document.createElement('span'); lab.className = 'btn-label'; btn.childNodes.forEach(n=>{ if(n.nodeType === Node.TEXT_NODE && n.textContent.trim()) n.remove(); }); btn.appendChild(lab); }
      lab.textContent = opts.label;
    }
  } else {
    btn.removeAttribute('aria-disabled'); btn.disabled = false;
    const spinner = btn.querySelector('.btn-spinner'); if(spinner) spinner.remove();
    if(btn._origLabel){ let lab = btn.querySelector('.btn-label'); if(lab) lab.textContent = btn._origLabel; else btn.textContent = btn._origLabel; delete btn._origLabel; }
  }
}
function enhanceAllButtons(scope=document){
  const sel = scope.querySelectorAll('.btn-primary, .btn-neutral, .btn-ghost, button.btn');
  sel.forEach(b=>{
    attachRipple(b);
    if(!b.querySelector('.btn-label')){
      const text = b.textContent.trim();
      b.textContent = '';
      const span = document.createElement('span'); span.className = 'btn-label'; span.textContent = text;
      b.appendChild(span);
    }
  });
}
if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', ()=> enhanceAllButtons(document)); } else { enhanceAllButtons(document); }

/* helper: render session/pilots/logs initially */
function renderSession(){ if(SESSION.pilotId){ const p = PILOTS.find(x=>x.id === SESSION.pilotId) || {}; sessionBadge.textContent = p.callSign ? `Вошёл ${p.callSign}` : 'Вошёл'; logoutBtn.style.display='inline-flex'; openGateBtn.style.display='none'; } else { sessionBadge.textContent='Неавторизован'; logoutBtn.style.display='none'; openGateBtn.style.display='inline-flex'; } }
renderPilots(); renderAssignLog(); renderCurrentFlights();

</script>
</body>
</html>
