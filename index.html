<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lufthansa Helper — Liquid Glass Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#041026; --bg-2:#06263a; --text:#eaf4ff; --muted:rgba(234,244,255,0.72);
  --accent:#ffd54a; --accent2:#ffbf3a; --glass-border:rgba(255,255,255,0.10);
  --panel-1:rgba(255,255,255,0.06); --panel-2:rgba(6,14,24,0.94); --panel-3:rgba(8,18,30,0.98);
  --glow-strong:0 30px 140px rgba(255,180,60,0.12), inset 0 1px 0 rgba(255,255,255,0.04);
  --shadow-deep:0 64px 200px rgba(2,8,18,0.66);
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  font-size:15px;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  min-height:100vh;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 10% 10%, rgba(10,30,60,0.36), transparent 35%),
    radial-gradient(700px 500px at 90% 0%, rgba(5,20,40,0.28), transparent 30%),
    linear-gradient(160deg,var(--bg-1),var(--bg-2));
  padding:20px;
}

/* Animations */
@keyframes planeFly {
  0%{ transform: translateX(-30%) translateY(0) rotate(-6deg); opacity:0 }
  10%{ opacity:1 }
  50%{ transform: translateX(40%) translateY(-6px) rotate(-2deg) }
  100%{ transform: translateX(120%) translateY(-10px) rotate(4deg); opacity:0 }
}
@keyframes cloudFloat {
  0%{ transform:translateX(-10%) }
  100%{ transform:translateX(110%) }
}
@keyframes popIn { from{ opacity:0; transform:translateY(6px) scale(.996) } to{ opacity:1; transform:none } }

/* Splash */
.splash{
  position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:16000;
  background:linear-gradient(180deg, rgba(0,6,18,0.96), rgba(2,14,30,0.99)); overflow:hidden;
}
.splash.hidden{ opacity:0; pointer-events:none; transform:translateY(-8px) scale(.996); transition:opacity .48s, transform .48s; }
.splash-center{ text-align:center; z-index:3; color:var(--text); animation:popIn .44s cubic-bezier(.2,.9,.2,1); }
.splash-center h2{ font-size:28px; margin-bottom:8px; font-weight:900 }
.splash-center .subtitle{ opacity:.9; margin-bottom:14px }
.splash-plane{
  position:absolute; left:-20%; top:18%; width:380px; max-width:40%; opacity:0;
  transform-origin:center;
  animation: planeFly 7s cubic-bezier(.2,.85,.2,1) 0.12s forwards;
  filter:drop-shadow(0 24px 60px rgba(2,8,18,0.5));
}
.splash-cloud{
  position:absolute; top:6%; left:-30%; width:520px; opacity:.18; filter:blur(8px);
  animation: cloudFloat 18s linear infinite;
}
.splash-cloud.s2{ top:40%; left:-45%; width:420px; opacity:.12; animation-duration:26s; }
.splash-cloud.s3{ top:68%; left:-60%; width:680px; opacity:.08; animation-duration:34s }

/* Modals */
.modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.56); z-index:18000; padding:20px; }
.modal.show{ display:flex }
.modal-card{
  width:min(760px,96%); border-radius:16px; padding:20px;
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.06));
  border:1px solid var(--glass-border); box-shadow:var(--glow-strong), var(--shadow-deep);
  backdrop-filter: blur(12px) saturate(160%); animation:popIn .28s ease;
}

/* Instruction modal specifics */
.instructions .step{ margin-top:12px; padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); border:1px solid rgba(255,255,255,0.03) }
.instructions .step h4{ margin-bottom:6px }

/* Shell */
.shell{ max-width:1280px; margin:24px auto; border-radius:18px; overflow:hidden; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border:1px solid rgba(255,255,255,0.02); box-shadow:var(--shadow-deep) }

/* Topbar */
.topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:16px 18px; border-bottom:1px solid rgba(255,255,255,0.02); position:sticky; top:0; z-index:40; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02)) }
.brand{ display:flex; gap:12px; align-items:center }
.logo{ width:64px; height:64px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-weight:900; color:var(--accent); background:linear-gradient(180deg,#072a36,#041822); box-shadow:0 18px 60px rgba(0,0,0,0.6) }
.title{ font-weight:900 }
.subtitle{ font-size:13px; color:var(--muted) }
.session{ display:flex; gap:8px; align-items:center }

/* Tabs */
.tabs{ display:flex; gap:8px; align-items:center; position:relative }
.tab{ padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); border:1px solid rgba(255,255,255,0.03); transition:transform .18s, box-shadow .18s }
.tab.active{ background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#06141e; transform:translateY(-4px); box-shadow:0 36px 120px rgba(255,170,40,0.12) }
.underline{ position:absolute; bottom:-10px; height:10px; border-radius:10px; background:linear-gradient(90deg,var(--accent),var(--accent2)); box-shadow:0 22px 80px rgba(255,170,40,0.12); transition:left .24s, width .24s, opacity .24s; opacity:0 }

/* Page layout */
.pagewrap{ padding:18px }
.page{ display:none; opacity:0; transform:translateY(16px) scale(.996); transition:opacity .36s, transform .36s }
.page.active{ display:block }
.page.enter{ opacity:1; transform:none }

/* Panels */
.panel{ padding:16px; border-radius:14px; margin-top:12px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); border:1px solid rgba(255,255,255,0.03); box-shadow:0 14px 42px rgba(0,0,0,0.42) }

/* Liquid glass inputs */
.input-glass{
  width:100%; padding:12px 14px; border-radius:12px; outline:none; color:var(--text);
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
  border:1px solid rgba(255,255,255,0.04);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.02), 0 10px 36px rgba(0,0,0,0.36);
  transition: transform .16s, box-shadow .16s, background .16s;
  backdrop-filter: blur(6px) saturate(140%);
}
.input-glass:focus{ transform:translateY(-3px); box-shadow:0 26px 80px rgba(0,0,0,0.48), 0 0 30px rgba(255,200,50,0.06) }

/* Buttons */
.btn{ padding:10px 14px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03)); color:var(--text); font-weight:800; cursor:pointer; transition:transform .14s, box-shadow .14s }
.btn:hover{ transform:translateY(-2px) }
.btn-primary{ background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#06141e; box-shadow:0 22px 90px rgba(255,170,40,0.12) }

/* Lists */
.list{ max-height:640px; overflow:auto; margin-top:12px; padding-right:6px }
.routes-row, .fleet-row, .confirmed-row{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px; border-radius:12px; margin-bottom:12px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03)); border:1px solid rgba(255,255,255,0.03) }
.routes-row .meta, .fleet-row .meta{ color:var(--muted) }

/* Current flight highlight */
.current-flight{ outline:2px solid rgba(30,111,255,0.14); box-shadow:0 40px 160px rgba(30,111,255,0.06) }

/* Flight detail panel (side) */
.detail-panel{ position:fixed; right:20px; top:110px; width:360px; max-width:90%; border-radius:14px; padding:16px; z-index:20000;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04)); border:1px solid rgba(255,255,255,0.03); box-shadow:0 40px 160px rgba(0,0,0,0.6); display:none }
.detail-panel.show{ display:block; animation:popIn .22s ease; }

/* Small screens adjustments */
@media(max-width:900px){
  .detail-panel{ position:static; width:100%; margin-top:12px }
}

/* ensure lists don't have infinite animations */
.routes-row, .fleet-row, .confirmed-row { animation: none !important; }

</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash" class="splash" aria-hidden="false">
  <svg class="splash-cloud" viewBox="0 0 1200 120" preserveAspectRatio="xMidYMid slice"><g fill="#fff"><ellipse cx="200" cy="40" rx="240" ry="36"/><ellipse cx="520" cy="30" rx="200" ry="28"/></g></svg>
  <svg class="splash-cloud s2" viewBox="0 0 1200 120" preserveAspectRatio="xMidYMid slice"><g fill="#fff"><ellipse cx="300" cy="50" rx="200" ry="30"/><ellipse cx="760" cy="20" rx="300" ry="40"/></g></svg>
  <svg class="splash-cloud s3" viewBox="0 0 1200 120" preserveAspectRatio="xMidYMid slice"><g fill="#fff"><ellipse cx="600" cy="60" rx="420" ry="48"/></g></svg>

  <!-- plane svg flying -->
  <svg class="splash-plane" viewBox="0 0 512 128" xmlns="http://www.w3.org/2000/svg">
    <g fill="#fff" opacity="0.96">
      <path d="M16 64c40-6 140-18 220-16 110 2 180 30 260 32l-18 8c-68-6-142-18-250-16-64 1-150 14-212 20-16 2-28-4-28-28z" fill="#ffffff" opacity="0.9"/>
      <path d="M64 80c36-6 120-18 200-18 84 0 160 24 240 28-40 16-140 36-240 36-78 0-168-18-200-28-10-3-12-6-0-18z" fill="#eaf4ff" opacity="0.7"/>
    </g>
  </svg>

  <div class="splash-center" role="dialog" aria-modal="true">
    <h2>Welcome to Lufthansa Group</h2>
    <div class="subtitle">liquid glass · tactile · demo</div>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
      <button id="splashContinue" class="btn btn-primary">Дальше</button>
    </div>
  </div>
</div>

<!-- GATE MODAL (LOGIN) -->
<div id="gateModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div style="font-weight:900; font-size:18px">Вход в систему</div>
    <div class="subtitle" style="margin-top:8px">Введите позывной и пароль</div>
    <div style="margin-top:12px">
      <input id="loginCall" class="input-glass" placeholder="Позывной (callSign)" autocomplete="username"/>
    </div>
    <div style="margin-top:10px">
      <input id="loginPass" class="input-glass" type="password" placeholder="Пароль" autocomplete="current-password"/>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
      <button id="btnLogin" class="btn btn-primary">Войти</button>
    </div>
  </div>
</div>

<!-- INSTRUCTION MODAL -->
<div id="instructionModal" class="modal" aria-hidden="true">
  <div class="modal-card instructions" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:18px">Инструкция — как работать</div>
      <div style="font-size:13px;color:var(--muted)">Анимированные подсказки</div>
    </div>

    <div class="step" style="margin-top:12px">
      <h4>1. Вход</h4>
      <div class="subtitle">Введи позывной и пароль — после входа откроется это окно инструкции.</div>
    </div>

    <div class="step">
      <h4>2. Фильтры и выбор</h4>
      <div class="subtitle">Поиск авиакомпании, выбор интервала времени (пилоты) и кнопка «СГЕНЕРИРОВАТЬ» — выберет рейс и откроет подтверждение.</div>
      <div style="margin-top:8px"><em>Анимация:</em> при выборе рейса — карточка мягко всплывает.</div>
    </div>

    <div class="step">
      <h4>3. Подтверждение рейса</h4>
      <div class="subtitle">После подтверждения рейса он сохранится в твоём аккаунте и появится на странице «Рейсы».</div>
      <div style="margin-top:8px"><em>Кнопки:</em> «Прилетел» — завершает рейс; «Отменить рейс» — отменяет подтверждение до вылета.</div>
    </div>

    <div class="step">
      <h4>4. Текущий рейс</h4>
      <div class="subtitle">Клик по актуальному рейсу открывает подробную карточку: ETA, остаток топлива, turnaround, история действий.</div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
      <button id="closeInstruction" class="btn">Закрыть</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL (used for reserve confirm) -->
<div id="confirmModal" class="modal" aria-hidden="true">
  <div class="modal-card" role="dialog" aria-modal="true">
    <div style="font-weight:900;font-size:18px">Подтвердить рейс</div>
    <div id="confirmDetails" class="subtitle" style="margin-top:8px"></div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:14px">
      <button id="confirmCancel" class="btn">Отменить</button>
      <button id="confirmAccept" class="btn btn-primary">Подтвердить</button>
    </div>
  </div>
</div>

<!-- APP SHELL -->
<div class="shell" role="application">
  <div class="topbar">
    <div class="brand">
      <div class="logo">LH</div>
      <div>
        <div class="title">Lufthansa Helper</div>
        <div class="subtitle">liquid glass · tactile · demo</div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-page="home">Главная</div>
      <div class="tab" data-page="routes">Направления</div>
      <div class="tab" data-page="fleet">Флот</div>
      <div class="tab" data-page="pilots">Пилоты</div>
      <div class="tab" data-page="flights">Рейсы</div>
      <div class="underline" id="underline"></div>
    </div>

    <div class="session">
      <div id="sessionBadge" class="subtitle">Неавторизован</div>
      <button id="openGateBtn" class="btn">Вход</button>
      <button id="logoutBtn" class="btn" style="display:none">Выйти</button>
    </div>
  </div>

  <div class="pagewrap">
    <!-- HOME -->
    <section id="page-home" class="page active enter">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Фильтры</div>
          <div class="subtitle">Выбор авиакомпании и интервала времени</div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px;align-items:center">
          <input id="airSearch" class="input-glass" placeholder="Поиск авиакомпании или кода"/>
          <button id="genBtn" class="btn btn-primary">СГЕНЕРИРОВАТЬ</button>
          <button id="openInstructionBtn" class="btn">Инструкция</button>
        </div>

        <div id="durations" class="time-pills" style="margin-top:12px"></div>
        <div id="airGrid" class="airline-grid" style="margin-top:12px"></div>
      </div>

      <div id="inlineTour" class="panel" aria-hidden="true" style="display:none; opacity:0; transform:translateY(8px); transition:opacity .26s, transform .26s; margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Краткая инструкция</div>
          <div class="subtitle">Появляется после входа</div>
        </div>
        <div class="subtitle" style="margin-top:10px">
          1) Вход; 2) Выбор авиакомпании; 3) СГЕНЕРИРОВАТЬ; 4) Подтвердить рейс; 5) Перейти на «Рейсы».
        </div>
      </div>
    </section>

    <!-- ROUTES -->
    <section id="page-routes" class="page">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Направления</div>
          <div class="subtitle">Список доступных маршрутов</div>
        </div>
        <div id="routesList" class="list" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- FLEET -->
    <section id="page-fleet" class="page">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Флот</div>
          <div class="subtitle">Самолёты и статус</div>
        </div>
        <div id="fleetList" class="list" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- PILOTS -->
    <section id="page-pilots" class="page">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Пилоты</div>
          <div class="subtitle">Demo</div>
        </div>
        <div id="pilotList" class="list" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- FLIGHTS (replaces journal) -->
    <section id="page-flights" class="page">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Рейсы</div>
          <div class="subtitle">Текущий и сохранённые рейсы пилота</div>
        </div>
        <div id="confirmedList" class="list" style="margin-top:12px"></div>
      </div>
    </section>
  </div>
</div>

<!-- Flight detail panel -->
<div id="flightDetail" class="detail-panel" role="dialog" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:900" id="detailTitle">Рейс</div>
    <div id="detailStatus" class="subtitle"></div>
  </div>
  <div id="detailBody" style="margin-top:10px" class="subtitle"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
    <button id="btnArrived" class="btn">Прилетел</button>
    <button id="btnCancelFlight" class="btn">Отменить рейс</button>
    <button id="closeDetail" class="btn btn-primary">Закрыть</button>
  </div>
</div>

<script>
/* =========================
   Data, state, utilities
   ========================= */
const CODEWORD = null; // removed visual mention on UI
const DURATIONS = [
  {label:"1–2ч",min:60,max:120},{label:"2–3ч",min:120,max:180},{label:"3–4ч",min:180,max:240},
  {label:"4–5ч",min:240,max:300},{label:"5–6ч",min:300,max:360}
];
const AIRLINES = [
  {name:"Lufthansa",code:"LH",color:"#1E6FFF"},
  {name:"Lufthansa Cargo",code:"G0",color:"#0A63D6"},
  {name:"Swiss",code:"LX",color:"#D81E5B"},
  {name:"Austrian",code:"OS",color:"#DA291C"},
  {name:"Eurowings",code:"EW",color:"#8A4BFF"}
];

let ROUTES = []; (function(){ let seq=100; const base=["EDDF","EGLL","LFPG","LEBL","LSZH","KJFK","EHAM"]; AIRLINES.forEach((a,ai)=>{ for(let i=0;i<6;i++){ const from=base[(ai*2+i)%base.length]; const to=base[(ai*2+i+2)%base.length]; const dur=80 + (i*25) + (ai*8); ROUTES.push({ id:`${a.code}-${seq++}`, airline:a.name, airlineCode:a.code, fromICAO:from, toICAO:to, fromCity:'City-'+from, toCity:'City-'+to, durationMinutes:dur }); } }); })();

let FLEET = []; (function(){ AIRLINES.forEach((a,ai)=>{ const types=["A320","A321","B737","A220"]; for(let i=1;i<=3;i++){ FLEET.push({ id:`${a.code}-AC${String(i).padStart(2,'0')}`, airline:a.name, type:types[(ai+i)%types.length], locationICAO: i===1 ? "EDDF" : (i===2 ? "EGLL" : "LSZH"), status:"idle", fuelMinutes:420 + i*70, turnaround:20 + i*5, reserveMargin:30 }); } }); })();

let PILOTS = [
  {id:"pilot_ivan",name:"Ivan Petrov",callSign:"IPET",verified:true,password:"ivanpass"},
  {id:"pilot_loui",name:"Loui Desulier",callSign:"FRENCH",verified:true,password:"louiSecret"}
];

let SESSION = { pilotId:null };
let PENDING_RESERVATION = null;
let chosenAirline = null;
let chosenDurationIdx = null;
let searchQuery = '';
let CONFIRMED_FLIGHTS = []; // in-memory, persisted per pilot

/* DOM */
const splash = document.getElementById('splash');
const splashContinue = document.getElementById('splashContinue');
const gateModal = document.getElementById('gateModal');
const instructionModal = document.getElementById('instructionModal');
const confirmModal = document.getElementById('confirmModal');
const sessionBadge = document.getElementById('sessionBadge');
const airSearch = document.getElementById('airSearch');
const airGrid = document.getElementById('airGrid');
const durationsEl = document.getElementById('durations');
const routesList = document.getElementById('routesList');
const fleetList = document.getElementById('fleetList');
const pilotList = document.getElementById('pilotList');
const confirmedList = document.getElementById('confirmedList');
const tabs = document.getElementById('tabs');
const underline = document.getElementById('underline');
const inlineTour = document.getElementById('inlineTour');

const flightDetail = document.getElementById('flightDetail');
const detailTitle = document.getElementById('detailTitle');
const detailStatus = document.getElementById('detailStatus');
const detailBody = document.getElementById('detailBody');
const btnArrived = document.getElementById('btnArrived');
const btnCancelFlight = document.getElementById('btnCancelFlight');
const closeDetail = document.getElementById('closeDetail');

/* Modal helpers */
function showModal(el){ el.classList.add('show'); el.style.display='flex'; el.setAttribute('aria-hidden','false'); }
function hideModal(el){ el.classList.remove('show'); el.style.display='none'; el.setAttribute('aria-hidden','true'); }

/* Persistence key */
function flightsKeyForPilot(pilotId){ return 'lh_flights_' + pilotId; }
function saveFlightsForPilot(pilotId, arr){ try{ localStorage.setItem(flightsKeyForPilot(pilotId), JSON.stringify(arr||[])); }catch(e){} }
function loadFlightsForPilot(pilotId){ try{ const v=localStorage.getItem(flightsKeyForPilot(pilotId)); return v?JSON.parse(v):[] }catch(e){ return [] } }

/* =========================
   Splash -> open gate
   ========================= */
splashContinue.addEventListener('click', ()=>{
  splash.classList.add('hidden');
  setTimeout(()=>{ splash.style.display='none'; showModal(gateModal); }, 520);
});

/* =========================
   Login logic (saves/loads flights)
   ========================= */
document.getElementById('btnLogin').addEventListener('click', ()=>{
  const cs = document.getElementById('loginCall').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if(!cs || !pass){ alert('Введите позывной и пароль'); return; }
  const p = PILOTS.find(x=>x.callSign.toLowerCase()===cs.toLowerCase());
  // allow login if matches stored pilot password
  if(p && p.password===pass){
    SESSION.pilotId = p.id;
  } else {
    // allow guest account: create a guest pilot id so we can persist per machine
    SESSION.pilotId = 'guest_' + cs.toLowerCase() + '_' + (new Date()).getTime();
  }
  renderSession();
  // load flights for this pilot from localStorage
  CONFIRMED_FLIGHTS = loadFlightsForPilot(SESSION.pilotId);
  hideModal(gateModal);
  // show inline instruction and instruction modal automatically
  inlineTour.style.display='block';
  requestAnimationFrame(()=>{ inlineTour.style.opacity='1'; inlineTour.style.transform='translateY(0)'; });
  // open instruction modal
  showModal(instructionModal);
});

document.getElementById('openGateBtn').addEventListener('click', ()=> showModal(gateModal));
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  // save then logout
  if(SESSION.pilotId) saveFlightsForPilot(SESSION.pilotId, CONFIRMED_FLIGHTS);
  SESSION.pilotId = null; CONFIRMED_FLIGHTS = []; renderSession(); activatePage('home'); showModal(gateModal);
});

/* close instruction */
document.getElementById('closeInstruction').addEventListener('click', ()=> hideModal(instructionModal));
document.getElementById('openInstructionBtn').addEventListener('click', ()=> showModal(instructionModal));

/* =========================
   Tabs navigation
   ========================= */
function activatePage(id){
  document.querySelectorAll('.page').forEach(p=>{
    p.classList.remove('active','enter');
    p.style.display='none';
    p.setAttribute('aria-hidden','true');
  });
  const el = document.getElementById('page-'+id);
  if(!el) return;
  el.style.display='block';
  el.setAttribute('aria-hidden','false');
  el.classList.add('active');

  switch(id){
    case 'home': renderDurations(); renderAirlines(); break;
    case 'routes': renderRoutes(); break;
    case 'fleet': renderFleet(); break;
    case 'pilots': renderPilots(); break;
    case 'flights': renderConfirmed(); break;
  }
  requestAnimationFrame(()=> el.classList.add('enter'));
}
function placeUnderline(el){
  const parentRect = tabs.getBoundingClientRect();
  const r = el.getBoundingClientRect();
  underline.style.left = (r.left - parentRect.left) + 'px';
  underline.style.width = r.width + 'px';
  underline.style.opacity = '1';
}
tabs.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active'); placeUnderline(tab);
    activatePage(tab.dataset.page);
  });
});
window.addEventListener('load', ()=>{ const active = tabs.querySelector('.tab.active') || tabs.querySelector('.tab[data-page="home"]'); if(active){ placeUnderline(active); activatePage(active.dataset.page); }});
window.addEventListener('resize', ()=>{ const a=tabs.querySelector('.tab.active'); if(a) placeUnderline(a); });

/* =========================
   Ripple helper (tactile)
   ========================= */
function attachRipple(scope=document){
  const els = scope.querySelectorAll('.btn, .pill, .airline');
  els.forEach(el=>{
    if(el._rip) return; el._rip=true;
    el.addEventListener('pointerdown', ev=>{
      let r = el.querySelector('.ripple'); if(!r){ r=document.createElement('span'); r.className='ripple'; r.style.position='absolute'; r.style.borderRadius='50%'; r.style.pointerEvents='none'; r.style.background='rgba(255,255,255,0.9)'; el.prepend(r); }
      const rect = el.getBoundingClientRect(); const size = Math.max(rect.width, rect.height)*1.6;
      r.style.width = size+'px'; r.style.height = size+'px';
      r.style.left = (ev.clientX-rect.left-size/2)+'px'; r.style.top = (ev.clientY-rect.top-size/2)+'px';
      r.style.transform = 'scale(0)'; r.style.opacity = '.36'; r.style.transition = 'transform 420ms cubic-bezier(.2,.9,.2,1), opacity 360ms';
      requestAnimationFrame(()=> r.style.transform='scale(1)');
      setTimeout(()=> r.style.opacity='0',420);
    }, {passive:true});
  });
}

/* =========================
   Renderers
   ========================= */
function renderSession(){
  if(SESSION.pilotId){
    const p = PILOTS.find(x=>x.id===SESSION.pilotId);
    sessionBadge.textContent = p ? `Вошёл ${p.callSign}` : `Вошёл ${SESSION.pilotId}`;
    document.getElementById('logoutBtn').style.display='inline-flex';
    document.getElementById('openGateBtn').style.display='none';
  } else {
    sessionBadge.textContent = 'Неавторизован';
    document.getElementById('logoutBtn').style.display='none';
    document.getElementById('openGateBtn').style.display='inline-flex';
  }
}

function renderDurations(){
  durationsEl.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const btn = document.createElement('div');
    btn.className = 'pill' + (chosenDurationIdx===i ? ' active' : '');
    btn.textContent = d.label;
    btn.style.cursor='pointer';
    btn.addEventListener('click', ()=>{ chosenDurationIdx = (chosenDurationIdx===i?null:i); renderDurations(); renderRoutes(); });
    durationsEl.appendChild(btn);
  });
  attachRipple(durationsEl);
}

function renderAirlines(){
  airGrid.innerHTML='';
  const filtered = AIRLINES.filter(a=>{ if(!searchQuery) return true; const q=searchQuery.toLowerCase(); return a.name.toLowerCase().includes(q) || a.code.toLowerCase().includes(q); });
  filtered.forEach(a=>{
    const card = document.createElement('div'); card.className='airline'; card.style.position='relative';
    if(chosenAirline===a.name) card.classList.add('selected');
    card.innerHTML = `<div style="width:18px;height:18px;border-radius:50%;background:${a.color}"></div>
      <div><div style="font-weight:900">${a.name}</div><div class="subtitle">${a.code}</div></div>
      <div class="led" aria-hidden="true"></div>`;
    card.addEventListener('click', ()=>{ chosenAirline = (chosenAirline===a.name?null:a.name); renderAirlines(); renderRoutes(); });
    airGrid.appendChild(card);
  });
  attachRipple(airGrid);
}

function renderRoutes(){
  routesList.innerHTML='';
  const list = ROUTES.filter(r=>{
    if(chosenAirline && r.airline!==chosenAirline) return false;
    if(chosenDurationIdx!==null){ const d=DURATIONS[chosenDurationIdx]; if(!(r.durationMinutes>=d.min && r.durationMinutes<=d.max)) return false; }
    return true;
  });
  if(!list.length){ routesList.innerHTML = '<div class="subtitle">Нет направлений по текущим фильтрам</div>'; return; }
  list.forEach(r=>{
    const row = document.createElement('div'); row.className='routes-row';
    row.innerHTML = `<div>
      <div style="font-weight:900">${r.fromICAO} → ${r.toICAO} · ${r.airlineCode}</div>
      <div class="meta">${r.fromCity} → ${r.toCity}</div>
    </div>
    <div style="text-align:right">
      <div class="meta">${r.durationMinutes} мин</div>
      <div style="margin-top:8px"><button class="btn btn-primary" data-id="${r.id}">Выбрать</button></div>
    </div>`;
    routesList.appendChild(row);
  });
  routesList.querySelectorAll('button[data-id]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const r = ROUTES.find(x=>x.id===b.dataset.id);
      if(!SESSION.pilotId){ showModal(gateModal); return; }
      openConfirmFromRoute(r);
    });
  });
  attachRipple(routesList);
}

function renderFleet(){
  fleetList.innerHTML='';
  FLEET.forEach(f=>{
    const row = document.createElement('div'); row.className='fleet-row';
    row.innerHTML = `<div style="font-weight:900">${f.id}</div><div class="meta">${f.airline} · ${f.type} · ${f.fuelMinutes} мин · ${f.locationICAO} · ${f.status}</div>`;
    fleetList.appendChild(row);
  });
}

function renderPilots(){
  pilotList.innerHTML='';
  PILOTS.forEach(p=>{
    const row = document.createElement('div'); row.className='routes-row';
    row.innerHTML = `<div><div style="font-weight:900">${p.name}</div><div class="meta">${p.callSign} ${p.verified? '· Verified' : ''}</div></div><div><button class="btn">Войти</button></div>`;
    row.querySelector('button').addEventListener('click', ()=>{ document.getElementById('loginCall').value = p.callSign; document.getElementById('loginPass').value=''; showModal(gateModal); });
    pilotList.appendChild(row);
  });
  attachRipple(pilotList);
}

/* Renders confirmed flights for current pilot (saved in CONFIRMED_FLIGHTS) */
function renderConfirmed(){
  confirmedList.innerHTML='';
  if(!SESSION.pilotId){ confirmedList.innerHTML = '<div class="subtitle">Войдите, чтобы видеть ваши рейсы</div>'; return; }
  if(CONFIRMED_FLIGHTS.length===0){ confirmedList.innerHTML = '<div class="subtitle">Нет подтверждённых рейсов</div>'; return; }

  CONFIRMED_FLIGHTS.forEach((f, idx)=>{
    const row = document.createElement('div'); row.className='confirmed-row';
    // mark current flight if status is inFlight
    if(f.status === 'inFlight') row.classList.add('current-flight');
    row.innerHTML = `<div style="min-width:0">
      <div style="font-weight:900">${f.aircraftId} · ${f.fromICAO} → ${f.toICAO}</div>
      <div class="meta">Пилот ${f.pilotCallsign} · ${f.durationMinutes} мин · ${new Date(f.ts).toLocaleString()}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
      <div>
        ${f.status === 'inFlight' ? '<button class="btn" data-action="view" data-idx="'+idx+'">Детали</button>' : '<button class="btn" data-action="view" data-idx="'+idx+'">Открыть</button>'}
      </div>
      <div style="margin-top:6px">
        ${f.status === 'inFlight' ? '<button class="btn btn-primary" data-action="arrived" data-idx="'+idx+'">Прилетел</button>' : ''}
        <button class="btn" data-action="cancel" data-idx="'+idx+'">Отменить</button>
      </div>
    </div>`;
    confirmedList.appendChild(row);
  });

  // attach actions
  confirmedList.querySelectorAll('button[data-action]').forEach(b=>{
    const action = b.dataset.action;
    const idx = Number(b.dataset.idx);
    b.addEventListener('click', ()=> {
      const flight = CONFIRMED_FLIGHTS[idx];
      if(!flight) return;
      if(action === 'view') openFlightDetail(flight, idx);
      else if(action === 'arrived') markFlightArrived(idx);
      else if(action === 'cancel') cancelFlight(idx);
    });
  });
  attachRipple(confirmedList);
}

/* =========================
   Reservation & Confirm flow
   ========================= */
function findCandidateAircraftForRoute(route){
  const dur = Number(route.durationMinutes) || 0;
  const can = ac => ac.status==='idle' && (ac.fuelMinutes >= dur + (ac.reserveMargin || 30));
  let cand = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && can(ac));
  if(!cand.length) cand = FLEET.filter(can);
  cand.sort((a,b)=> (b.fuelMinutes||0) - (a.fuelMinutes||0));
  return cand[0] || null;
}

function openConfirmFromRoute(route){
  const pilot = PILOTS.find(x=>x.id===SESSION.pilotId) || { id:SESSION.pilotId, callSign:SESSION.pilotId };
  const candidate = findCandidateAircraftForRoute(route);
  if(!candidate){ alert('Нет подходящих самолётов с запасом топлива'); return; }

  candidate.status='reserved';
  candidate.reservedBy = pilot.id;
  candidate.reservedToken = pilot.id + ':' + Date.now() + ':' + Math.random().toString(36).slice(2,6);
  candidate.reservedUntil = Date.now() + 120000;

  PENDING_RESERVATION = { token:candidate.reservedToken, aircraft:candidate, route, pilotId:pilot.id, expires:candidate.reservedUntil };

  document.getElementById('confirmDetails').textContent =
    `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${route.durationMinutes} мин · Пилот ${pilot.callSign}`;
  showModal(confirmModal);
}

document.getElementById('confirmAccept').addEventListener('click', ()=>{
  if(!PENDING_RESERVATION){ hideModal(confirmModal); return; }
  const ac = FLEET.find(a=>a.reservedToken===PENDING_RESERVATION.token);
  if(!ac){ alert('Резервация потеряна'); hideModal(confirmModal); return; }
  const p = PILOTS.find(x=>x.id===PENDING_RESERVATION.pilotId) || { id:PENDING_RESERVATION.pilotId, callSign:PENDING_RESERVATION.pilotId };

  ac.fuelMinutes = Math.max(0, (ac.fuelMinutes||0) - Number(PENDING_RESERVATION.route.durationMinutes));
  ac.status = 'inFlight';
  ac.availableAt = Date.now() + (PENDING_RESERVATION.route.durationMinutes||120)*60000 + (ac.turnaround||0)*60000;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;

  const flight = {
    id: 'flt_' + Math.random().toString(36).slice(2,8),
    aircraftId: ac.id,
    airline: ac.airline,
    fromICAO: PENDING_RESERVATION.route.fromICAO,
    toICAO: PENDING_RESERVATION.route.toICAO,
    durationMinutes: PENDING_RESERVATION.route.durationMinutes,
    pilotId: p.id,
    pilotCallsign: p.callSign,
    ts: Date.now(),
    status: 'inFlight',
    fuelLeft: ac.fuelMinutes,
    turnaround: ac.turnaround
  };
  CONFIRMED_FLIGHTS.unshift(flight);
  // persist for pilot
  if(SESSION.pilotId) saveFlightsForPilot(SESSION.pilotId, CONFIRMED_FLIGHTS);

  PENDING_RESERVATION = null;
  renderFleet(); renderRoutes(); hideModal(confirmModal);

  // go to flights tab and show details
  const tab = tabs.querySelector('.tab[data-page="flights"]');
  if(tab){ tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); placeUnderline(tab); }
  activatePage('flights');
});

/* Cancel reservation before confirm */
document.getElementById('confirmCancel').addEventListener('click', ()=>{
  if(PENDING_RESERVATION){
    const token = PENDING_RESERVATION.token;
    FLEET.forEach(a=>{ if(a.reservedToken===token){ a.status='idle'; delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; } });
    PENDING_RESERVATION = null;
  }
  hideModal(confirmModal);
});

/* =========================
   Flight actions: view, arrived, cancel
   ========================= */
function openFlightDetail(flight, idx){
  detailTitle.textContent = `${flight.aircraftId} · ${flight.fromICAO}→${flight.toICAO}`;
  detailStatus.textContent = flight.status || '';
  detailBody.innerHTML = `
    <div>Пилот: <strong>${flight.pilotCallsign}</strong></div>
    <div style="margin-top:6px">Длительность: <strong>${flight.durationMinutes} мин</strong></div>
    <div style="margin-top:6px">Подтвержено: <strong>${new Date(flight.ts).toLocaleString()}</strong></div>
    <div style="margin-top:8px">Остаток топлива у самолёта: <strong>${flight.fuelLeft || '—'} мин</strong></div>
    <div style="margin-top:8px">Turnaround: <strong>${flight.turnaround || '—'} мин</strong></div>
  `;
  flightDetail.dataset.idx = idx;
  flightDetail.classList.add('show');
  flightDetail.style.display='block';
}

closeDetail.addEventListener('click', ()=>{
  flightDetail.classList.remove('show'); flightDetail.style.display='none';
});

btnArrived.addEventListener('click', ()=>{
  const idx = Number(flightDetail.dataset.idx);
  markFlightArrived(idx);
  flightDetail.classList.remove('show'); flightDetail.style.display='none';
});

btnCancelFlight.addEventListener('click', ()=>{
  const idx = Number(flightDetail.dataset.idx);
  cancelFlight(idx);
  flightDetail.classList.remove('show'); flightDetail.style.display='none';
});

function markFlightArrived(idx){
  const f = CONFIRMED_FLIGHTS[idx];
  if(!f) return;
  f.status = 'arrived';
  f.arrivedAt = Date.now();
  // update corresponding aircraft if exists
  const ac = FLEET.find(a=>a.id===f.aircraftId);
  if(ac){ ac.status='idle'; delete ac.availableAt; }
  // persist
  if(SESSION.pilotId) saveFlightsForPilot(SESSION.pilotId, CONFIRMED_FLIGHTS);
  renderConfirmed();
  renderFleet();
}

function cancelFlight(idx){
  const f = CONFIRMED_FLIGHTS[idx];
  if(!f) return;
  // release aircraft if reserved/inFlight
  const ac = FLEET.find(a=>a.id===f.aircraftId);
  if(ac){ ac.status='idle'; delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil; delete ac.availableAt; }
  CONFIRMED_FLIGHTS.splice(idx,1);
  if(SESSION.pilotId) saveFlightsForPilot(SESSION.pilotId, CONFIRMED_FLIGHTS);
  renderConfirmed();
  renderFleet();
}

/* =========================
   Generate button behavior
   ========================= */
document.getElementById('genBtn').addEventListener('click', ()=>{
  if(!SESSION.pilotId){ showModal(gateModal); return; }
  const pool = ROUTES.filter(r=>{
    if(chosenAirline && r.airline!==chosenAirline) return false;
    if(chosenDurationIdx!==null){ const d = DURATIONS[chosenDurationIdx]; if(!(r.durationMinutes>=d.min && r.durationMinutes<=d.max)) return false; }
    return true;
  });
  if(!pool.length){ alert('Нет маршрутов по текущим фильтрам'); return; }
  const route = pool[Math.floor(Math.random()*pool.length)];
  openConfirmFromRoute(route);
});

/* Search */
airSearch.addEventListener('input', ()=>{ searchQuery = airSearch.value.trim(); renderAirlines(); });

/* Maintenance loop for reservations and flight returns */
setInterval(()=>{
  const now = Date.now();
  FLEET.forEach(ac=>{
    if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil <= now){
      ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
    }
    if(ac.status==='inFlight' && ac.availableAt && ac.availableAt <= now){
      ac.status='idle'; delete ac.availableAt;
      // update flights that were inFlight to arrived automatically (optional)
      CONFIRMED_FLIGHTS.forEach(f=>{ if(f.aircraftId===ac.id && f.status==='inFlight'){ f.status='arrived'; f.arrivedAt = now; } });
      if(SESSION.pilotId) saveFlightsForPilot(SESSION.pilotId, CONFIRMED_FLIGHTS);
    }
  });
  renderFleet();
}, 2500);

/* =========================
   Init
   ========================= */
function init(){
  renderSession(); renderDurations(); renderAirlines(); renderRoutes(); renderFleet(); renderPilots();
  // If logged in earlier (persist session), we can try to load saved pilot flights — simple heuristic: not implemented automatic session restore here
  attachRipple(document);
  activatePage('home');
}
init();

/* restore flights when pilot logs in - attach listener to login modal close via existing login handler above */
/* Also, when SESSION changes on login we already load flights in login handler */

/* ensure chips and buttons get ripples on dynamic content */
const observer = new MutationObserver(()=> attachRipple(document));
observer.observe(document.body, { childList:true, subtree:true });

</script>
</body>
</html>
