<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lufthansa Helper — responsive + LED</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-top:#041426; --bg-bot:#072b3a;
  --text:#eaf4ff; --muted:#9fc0d8;
  --accent:#ffd54a; --accent-2:#ffb84a;
  font-family: Inter, system-ui, Roboto, Arial, sans-serif;
  font-size:15px;
}
/* Reset / base */
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  margin:0;padding:16px;
  background: linear-gradient(180deg,var(--bg-top),var(--bg-bot));
  color:var(--text); -webkit-font-smoothing:antialiased;
  display:flex;justify-content:center;align-items:flex-start;
  min-width:0;
}
.container{width:100%;max-width:1200px;padding:6px}
.card{border-radius:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(6px)}
.header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(90deg,#06384a,#073a4f)}
.brand{display:flex;gap:12px;align-items:center;min-width:0}
.logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(180deg,#073842,#043430);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);font-size:16px;flex:0 0 auto}
.title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.subtitle{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tabs{display:flex;gap:8px;margin-bottom:12px;position:relative;flex-wrap:wrap}
.tab{padding:8px 12px;border-radius:10px;background:transparent;color:var(--text);font-weight:700;cursor:pointer;transition:transform .14s}
.tab.active{ transform:translateY(-3px) }
.liquid-underline{ position:absolute; height:6px; bottom:-8px; border-radius:6px; background: linear-gradient(90deg,#ffd54a,#ffb84d); transition:left 260ms,width 260ms; box-shadow:0 8px 28px rgba(255,170,60,0.12); }
.filter-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.pill{--pad-y:7px; --pad-x:10px; position:relative; display:inline-flex;align-items:center;gap:8px;padding:var(--pad-y) var(--pad-x); border-radius:999px; cursor:pointer; user-select:none; border:1px solid rgba(255,255,255,0.04); background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:var(--text); font-weight:800; font-size:13px; transition: transform 140ms,box-shadow 160ms; white-space:nowrap; max-width:260px; text-overflow:ellipsis; overflow:hidden;}
.pill.small{padding:6px 8px;font-size:12px; max-width:180px}
.pill.active{ box-shadow:0 18px 44px rgba(0,0,0,0.45); transform:translateY(-3px); }
.pill .airline-dot{ width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:8px;flex:0 0 10px}

/* LED backlight */
.pill .led{ position:absolute; left:50%; top:50%; width:180%; height:86%; transform:translate(-50%,-50%) scale(0.98); border-radius:999px; z-index:0; pointer-events:none; filter: blur(28px) saturate(140%); opacity:0; transition:opacity .18s, transform .2s; mix-blend-mode:screen; }
.pill .led-rim{ position:absolute; inset:0; border-radius:999px; z-index:0; pointer-events:none; box-shadow: 0 0 60px rgba(255,255,255,0.03) inset; opacity:0.06; }
.pill:hover .led{ opacity:0.28; transform:translate(-50%,-50%) scale(1.04); }
.pill.active .led{ opacity:0.44; transform:translate(-50%,-50%) scale(1.02); animation: none; }

/* Layout responsive */
.layout{display:grid;grid-template-columns:1fr minmax(300px,380px);gap:14px;margin-top:12px;min-width:0}
@media(max-width:1000px){ .layout{grid-template-columns:1fr} }

/* lists */
.route-list{margin-top:12px;display:flex;flex-direction:column;gap:10px;min-width:0}
.route-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);cursor:pointer;min-width:0}
.route-item > div{min-width:0}
.route-title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.kv{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);min-width:0}

/* fuel meter */
.fuel-meter{width:170px;display:flex;flex-direction:column;gap:6px;align-items:flex-end}
.fuel-bar-wrap{width:100%;height:12px;background:rgba(255,255,255,0.04);border-radius:999px;overflow:hidden;border:1px solid rgba(0,0,0,0.2)}
.fuel-bar{height:100%;width:0%;background:linear-gradient(90deg,#3bd27f,#7ee7a9);transition:width 360ms ease}
.fuel-chip{font-weight:800;padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);font-size:12px;color:var(--text);display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(255,255,255,0.03)}
.fuel-low{background:linear-gradient(90deg,#ff6b6b,#ff8a6b);color:#220a0a}
.fuel-warn{background:linear-gradient(90deg,#ffcf66,#ffb86b);color:#2a1700}
.fuel-good{background:linear-gradient(90deg,#7ee7a9,#3bd27f);color:#042022}

/* fleet filters */
.fleet-filters{display:flex;flex-direction:column;gap:10px;margin-top:12px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);min-width:0}
.fleet-filters .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;min-width:0}

/* prevent horizontal overflow from long text */
*{word-break:break-word}
</style>
</head>
<body>
<div class="container">
  <header class="header card" role="banner">
    <div class="brand">
      <div class="logo">LH</div>
      <div style="min-width:0">
        <div class="title">Lufthansa Helper</div>
        <div class="subtitle">Responsive + LED</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <div id="sessionBadge" class="kv">Неавторизован</div>
      <button id="logoutBtn" class="pill" style="display:none">Выйти</button>
      <button id="openGateBtn" class="pill" style="background:linear-gradient(180deg,#fff0b8,#ffd96a);color:#04202a;border:0">Войти</button>
    </div>
  </header>

  <div class="layout">
    <main>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;min-width:0">
          <div style="min-width:0">
            <div style="font-weight:900">Рабочая область</div>
            <div class="kv">Пиллы не уезжают, LED подсветка добавлена</div>
          </div>
        </div>

        <div class="tabs" style="margin-top:12px">
          <div id="tabGenerate" class="tab active">Генерация</div>
          <div id="tabRoutes" class="tab">Направления</div>
          <div id="tabFleet" class="tab">Флот</div>
          <div class="liquid-underline" id="liquidUnderline" style="left:0;width:0"></div>
        </div>

        <div id="topControls" class="filter-row" style="margin-top:8px;min-width:0">
          <div style="display:flex;align-items:center;gap:8px;min-width:0">
            <div style="font-weight:800;flex:0 0 auto">Авиакомпании</div>
            <div id="airlines" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;max-width:calc(100vw - 420px);min-width:0"></div>
          </div>

          <div style="display:flex;align-items:center;gap:8px;margin-left:6px;min-width:0">
            <div style="font-weight:800;flex:0 0 auto">Время полёта</div>
            <div id="durations" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;min-width:0"></div>
          </div>

          <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
            <div class="kv">Пилот: <strong id="pilotName">—</strong></div>
            <button id="genBtn" class="pill" style="background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#062323;border:0">Сгенерировать</button>
          </div>
        </div>

        <div id="generatorNote" class="kv" style="margin-top:10px">Выберите авиакомпанию и интервал времени</div>

        <div id="pendingReservationBlock" class="card" style="display:none;margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Рейс готов к подтверждению</div>
            <div class="kv small" id="pendingTimer">Бронь</div>
          </div>
          <div id="pendingInfo" class="kv" style="margin-top:8px"></div>
          <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:8px">
            <button id="cancelPendingBtn" class="pill">Отменить бронь</button>
            <button id="confirmPendingBtn" class="pill" style="background:linear-gradient(90deg,#ffe58a,#ffd54a);color:#04202a;border:0">Подтвердить рейс</button>
          </div>
        </div>

        <div id="confirmedSection" class="card" style="display:none;margin-top:12px;padding:10px"></div>

        <div id="panelRoutes" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Направления</div>
            <div class="kv">Время полёта подсвечено сверху</div>
          </div>
          <div id="routesList" class="route-list"></div>
        </div>

        <div id="panelFleet" style="margin-top:12px;display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Флот</div>
            <div class="kv">Фильтруйте по авиакомпании и по интервалу</div>
          </div>

          <div class="fleet-filters">
            <div class="row">
              <div style="font-weight:800">Авиакомпания</div>
              <div id="fleetAirlines" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;min-width:0"></div>
              <button id="fleetAirAll" class="pill small" style="margin-left:auto">Все</button>
            </div>
            <div class="row">
              <div style="font-weight:800">Время полёта</div>
              <div id="fleetDurations" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;min-width:0"></div>
              <button id="fleetDurAll" class="pill small" style="margin-left:auto">Любое</button>
            </div>
          </div>

          <div id="fleetList" style="margin-top:12px"></div>
        </div>

      </div>
    </main>

    <aside style="min-width:0">
      <div class="card" style="padding:12px;min-width:0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Пилоты</div>
          <div class="kv small">Demo</div>
        </div>
        <div style="margin-top:8px"><input id="pilotSearch" class="input" placeholder="Поиск" /></div>
        <div id="pilotList" style="margin-top:8px"></div>
      </div>

      <div class="card" style="margin-top:12px;padding:12px;min-width:0">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Журнал</div>
          <div><button id="showGate" class="pill">Открыть вход</button></div>
        </div>
        <div id="assignLog" style="margin-top:8px;max-height:320px;overflow:auto"></div>
      </div>
    </aside>
  </div>
</div>

<!-- modal simplified -->
<div id="gateModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999">
  <div class="card" style="width:420px;padding:16px">
    <div style="font-weight:900">Вход</div>
    <div class="kv" style="margin-top:8px">Позывной и пароль</div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <input id="loginCall" class="input" placeholder="Позывной" />
      <input id="loginPass" class="input" type="password" placeholder="Пароль" />
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="btnLoginPilot" class="pill" style="background:linear-gradient(180deg,#fff0b8,#ffd96a);color:#04202a;border:0">Войти</button>
      <button id="btnCloseGate" class="pill">Закрыть</button>
    </div>
  </div>
</div>

<div id="confirmModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:9999">
  <div class="card" style="width:520px;padding:14px">
    <div style="font-weight:900">Подтвердить рейс</div>
    <div id="confirmDetails" class="kv" style="margin-top:8px"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="pill">Отменить бронь</button>
      <button id="confirmAccept" class="pill" style="background:linear-gradient(90deg,#ffe58a,#ffd54a);color:#04202a;border:0">Подтвердить</button>
    </div>
  </div>
</div>

<script>
/* ================= DATA & STATE (condensed demo) ================= */
const CODEWORD='quickaccess2025';
const SESSION_KEY='lh_helper_resp_led';
const CURRENT_FLIGHT_PREFIX='current_flight:';

const AIRLINES = [
  {name:"Swiss International Air Lines",code:"LX",color:"#D81E5B"},
  {name:"Austrian Airlines",code:"OS",color:"#DA291C"},
  {name:"AirBaltic",code:"BT",color:"#00A99D"},
  {name:"Brussels Airlines",code:"SN",color:"#003399"},
  {name:"Eurowings",code:"EW",color:"#8A4BFF"},
  {name:"Discover Airlines",code:"DH",color:"#F07F2A"},
  {name:"Edelweiss Air",code:"WK",color:"#FF7BAC"},
  {name:"Lufthansa Cargo",code:"G0",color:"#1E6FFF"},
  {name:"Lufthansa CityLine",code:"CL",color:"#2D6DE6"},
  {name:"Lufthansa City Airlines",code:"LC",color:"#2D6DE6"},
  {name:"Lufthansa Technik",code:"LT",color:"#2D6DE6"},
  {name:"Air Dolomiti",code:"EN",color:"#00A1DE"},
  {name:"Lufthansa Private Jet",code:"PJ",color:"#2D6DE6"},
  {name:"ITA Airways",code:"AZ",color:"#0067B1"},
  {name:"Widerøe",code:"WF",color:"#00A651"},
  {name:"Norwegian Airlines",code:"DY",color:"#BA0C2F"},
  {name:"Finnair",code:"AY",color:"#003366"},
  {name:"SAS Scandinavian Airlines",code:"SK",color:"#003A63"},
  {name:"Condor",code:"DE",color:"#FFD200"},
  {name:"AeroLogic",code:"3S",color:"#8A8D8F"},
  {name:"SunExpress",code:"SX",color:"#FF8A3D"},
  {name:"Lufthansa",code:"LH",color:"#1E6FFF"}
];

const DURATIONS = [
  {label:"1–2ч",min:60,max:120},
  {label:"2–3ч",min:120,max:180},
  {label:"3–4ч",min:180,max:240},
  {label:"5–6ч",min:300,max:360},
  {label:"6–7ч",min:360,max:420},
  {label:"7–8ч",min:420,max:480},
  {label:"8–9ч",min:480,max:540},
  {label:"9–10ч",min:540,max:600},
  {label:"10+ч",min:600,max:99999}
];

const ROUTES = [
  {airline:"Lufthansa",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Oslo",toICAO:"ENGM",durationMinutes:120},
  {airline:"Swiss International Air Lines",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Zurich",toICAO:"LSZH",durationMinutes:60},
  {airline:"SunExpress",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Antalya",toICAO:"LTAI",durationMinutes:180},
  {airline:"Eurowings",fromCity:"Munich",fromICAO:"EDDM",toCity:"Zurich",toICAO:"LSZH",durationMinutes:60},
  {airline:"ITA Airways",fromCity:"Munich",fromICAO:"EDDM",toCity:"Rome",toICAO:"LIRF",durationMinutes:90},
  {airline:"Condor",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"New York",toICAO:"KJFK",durationMinutes:480}
];

let FLEET = [
  {id:'LH-A320-01',airline:'Lufthansa',type:'A320',seats:180,turnaround:40,status:'idle',locationICAO:'EDDF',maxFlightMinutes:240,fuelMinutes:400,reserveMargin:30},
  {id:'LX-A320-01',airline:'Swiss International Air Lines',type:'A320',seats:180,turnaround:35,status:'idle',locationICAO:'EDDF',maxFlightMinutes:300,fuelMinutes:420,reserveMargin:30},
  {id:'OS-A321-01',airline:'Austrian Airlines',type:'A321',seats:200,turnaround:38,status:'idle',locationICAO:'LOWW',maxFlightMinutes:300,fuelMinutes:350,reserveMargin:30},
  {id:'DE-B767-01',airline:'Condor',type:'B767',seats:250,turnaround:50,status:'idle',locationICAO:'EDDF',maxFlightMinutes:720,fuelMinutes:800,reserveMargin:60},
  {id:'AZ-A320-01',airline:'ITA Airways',type:'A320',seats:180,turnaround:35,status:'idle',locationICAO:'EDDM',maxFlightMinutes:300,fuelMinutes:320,reserveMargin:30}
];

let PILOTS = [
  {id:'pilot_loui',name:'Loui Desulier',callSign:'FRENCH',verified:true,password:'louiSecret'},
  {id:'pilot_ivan',name:'Ivan Petrov',callSign:'IPET',verified:true}
];

let FLEET_LOG = [];
let PENDING_RESERVATION = null;
let SESSION = (function(){ try{ const s=sessionStorage.getItem(SESSION_KEY); return s?JSON.parse(s):{pilotId:null}; }catch(e){return {pilotId:null}; } })();

let fleetFilterAirline = 'all';
let fleetFilterDuration = 'all';
window.chosenDur = null;

/* helpers */
function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function nowMs(){return Date.now();}
function uid(p='id'){return p+'_'+Math.random().toString(36).slice(2,9);}
function persistCurrentFlight(pilotId,obj){ try{ localStorage.setItem(CURRENT_FLIGHT_PREFIX + (pilotId||'anon'), JSON.stringify(obj)); }catch(e){} }

/* UI Refs */
const airlinesWrap = document.getElementById('airlines');
const durationsWrap = document.getElementById('durations');
const pilotNameEl = document.getElementById('pilotName');
const pilotListEl = document.getElementById('pilotList');
const pilotSearch = document.getElementById('pilotSearch');
const assignLog = document.getElementById('assignLog');
const routesList = document.getElementById('routesList');
const fleetList = document.getElementById('fleetList');
const fleetAirlinesWrap = document.getElementById('fleetAirlines');
const fleetDurationsWrap = document.getElementById('fleetDurations');
const fleetAirAllBtn = document.getElementById('fleetAirAll');
const fleetDurAllBtn = document.getElementById('fleetDurAll');
const genBtn = document.getElementById('genBtn');
const pendingBlockEl = document.getElementById('pendingReservationBlock');
const pendingInfoEl = document.getElementById('pendingInfo');
const pendingTimerEl = document.getElementById('pendingTimer');
const confirmDetails = document.getElementById('confirmDetails');
const confirmedSection = document.getElementById('confirmedSection');

/* renderers */

/* Top airline pills with LED */
function renderAirlinePills(){
  airlinesWrap.innerHTML='';
  AIRLINES.forEach(a=>{
    const btn = document.createElement('button');
    btn.className='pill';
    btn.setAttribute('data-airline', a.name);
    // led behind pill
    const led = document.createElement('div'); led.className='led';
    led.style.background = `radial-gradient(60% 60% at 50% 40%, ${a.color}CC 0%, ${a.color}99 8%, transparent 46%)`;
    const rim = document.createElement('div'); rim.className='led-rim';
    // label (on top)
    const label = document.createElement('span'); label.style.zIndex=2; label.style.position='relative';
    label.innerHTML = `<span class="airline-dot" style="background:${a.color}"></span>${esc(a.name)}`;
    btn.appendChild(led); btn.appendChild(rim); btn.appendChild(label);

    btn.addEventListener('click', ()=>{
      const was = btn.classList.contains('active');
      Array.from(airlinesWrap.children).forEach(n=>n.classList.remove('active'));
      if(!was) btn.classList.add('active');
      renderRoutesPane();
    });
    airlinesWrap.appendChild(btn);
  });
}

/* Top durations (shared) */
function renderTopDurations(){
  durationsWrap.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const btn=document.createElement('button'); btn.className='pill small'; btn.setAttribute('data-dur',i); btn.textContent=d.label;
    btn.addEventListener('click', ()=>{
      const was = btn.classList.contains('active');
      Array.from(durationsWrap.children).forEach(n=>n.classList.remove('active'));
      if(!was){ btn.classList.add('active'); window.chosenDur = i; } else { window.chosenDur = null; }
      renderRoutesPane(); renderFleetList();
    });
    durationsWrap.appendChild(btn);
  });
}

/* fleet filters */
function renderFleetAirlinePills(){
  fleetAirlinesWrap.innerHTML='';
  const allBtn = document.createElement('button'); allBtn.className='pill small'; allBtn.textContent='Все';
  allBtn.addEventListener('click', ()=>{ fleetFilterAirline='all'; updateFleetFilterUI(); renderFleetList(); });
  fleetAirlinesWrap.appendChild(allBtn);
  AIRLINES.forEach(a=>{
    const b=document.createElement('button'); b.className='pill small'; b.setAttribute('data-airline',a.name);
    b.innerHTML = `<span class="airline-dot" style="background:${a.color}"></span>${esc(a.name)}`;
    b.addEventListener('click', ()=>{ fleetFilterAirline = a.name; updateFleetFilterUI(); renderFleetList(); });
    fleetAirlinesWrap.appendChild(b);
  });
}
function renderFleetDurations(){
  fleetDurationsWrap.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const btn=document.createElement('button'); btn.className='pill small'; btn.setAttribute('data-dur',i); btn.textContent=d.label;
    btn.addEventListener('click', ()=>{ fleetFilterDuration = i; updateFleetFilterUI(); renderFleetList(); });
    fleetDurationsWrap.appendChild(btn);
  });
}
function updateFleetFilterUI(){
  Array.from(fleetAirlinesWrap.children).forEach(n=>{ n.classList.remove('active'); const dat=n.getAttribute('data-airline'); if((!dat && fleetFilterAirline==='all') || dat===fleetFilterAirline) n.classList.add('active'); });
  Array.from(fleetDurationsWrap.children).forEach(n=>{ n.classList.remove('active'); if(String(n.getAttribute('data-dur'))===String(fleetFilterDuration)) n.classList.add('active'); });
}

/* pilots/list/log */
function renderPilots(){
  pilotListEl.innerHTML='';
  const q=(pilotSearch.value||'').toLowerCase().trim();
  PILOTS.filter(p=>!q || (p.name+' '+p.callSign).toLowerCase().includes(q)).forEach(p=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginTop='8px';
    row.innerHTML = `<div><strong>${esc(p.name)}</strong><div class="kv">${esc(p.callSign)} ${p.verified? '· Verified':''}</div></div>`;
    const btn=document.createElement('button'); btn.className='pill'; btn.textContent='Войти';
    btn.addEventListener('click', ()=> { document.getElementById('loginCall').value = p.callSign || ''; document.getElementById('loginPass').value=''; showGate(); });
    row.appendChild(btn);
    pilotListEl.appendChild(row);
  });
}
function renderAssignLog(){ assignLog.innerHTML=''; if(!FLEET_LOG.length){ assignLog.innerHTML='<div class="kv">Пусто</div>'; return; } FLEET_LOG.slice(-200).reverse().forEach(e=>{ const el=document.createElement('div'); el.className='kv'; el.style.marginTop='6px'; el.textContent = `${new Date(e.ts).toLocaleString()} — ${e.event}${e.aircraft? ' ' + e.aircraft: ''}${e.route? ' ' + e.route: ''}`; assignLog.appendChild(el); }); }

/* fleet filter logic and render */
function fleetFilterApplies(a){
  if(fleetFilterAirline !== 'all' && a.airline !== fleetFilterAirline) return false;
  const durIdx = (fleetFilterDuration === 'all') ? null : Number(fleetFilterDuration);
  const topDurIdx = (window.chosenDur === null) ? null : Number(window.chosenDur);
  const effective = durIdx !== null ? durIdx : (topDurIdx !== null ? topDurIdx : null);
  if(effective !== null){
    const d = DURATIONS[effective];
    if(typeof a.maxFlightMinutes === 'number' && a.maxFlightMinutes < d.min) return false;
  }
  return true;
}
function fuelColorClass(percent){ if(percent<=25) return 'fuel-low'; if(percent<=50) return 'fuel-warn'; return 'fuel-good'; }
function renderFleetList(){
  fleetList.innerHTML='';
  const visible = FLEET.filter(a => fleetFilterApplies(a));
  if(!visible.length){ fleetList.innerHTML = '<div class="kv">Нет самолётов по текущим фильтрам</div>'; return; }
  visible.forEach(a=>{
    const airlineObj = AIRLINES.find(x=>x.name===a.airline) || {color:'#999'};
    const nominal = Math.max(a.maxFlightMinutes || 300, 300);
    const percent = Math.min(100, Math.round((a.fuelMinutes/nominal)*100));
    const cls = fuelColorClass(percent);
    const el = document.createElement('div'); el.className='route-item';
    el.innerHTML = `<div style="display:flex;gap:12px;align-items:center;min-width:0"><div style="width:10px;height:10px;border-radius:50%;background:${airlineObj.color}"></div><div style="min-width:0"><div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(a.id)}</div><div class="kv">${esc(a.airline)} · ${esc(a.type)} · ${esc(a.locationICAO)}</div></div></div><div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px"><div class="fuel-meter" data-aircraft="${esc(a.id)}"><div class="fuel-bar-wrap"><div class="fuel-bar" style="width:${percent}%;background:${percent<=25? 'linear-gradient(90deg,#ff6b6b,#ff8a6b)':(percent<=50? 'linear-gradient(90deg,#ffcf66,#ffb86b)':'linear-gradient(90deg,#7ee7a9,#3bd27f)') }"></div></div><div style="display:flex;gap:8px;align-items:center"><div class="kv">${percent}%</div><div class="fuel-chip ${cls}">${a.fuelMinutes} мин</div></div></div></div>`;
    fleetList.appendChild(el);
  });
}

/* routes render (filters: top airline & top duration) */
function renderRoutesPane(){
  routesList.innerHTML='';
  const activeAirEl = Array.from(airlinesWrap.children).find(c=>c.classList.contains('active'));
  const fa = activeAirEl ? activeAirEl.getAttribute('data-airline') : 'all';
  const fd = (window.chosenDur === null) ? 'all' : String(window.chosenDur);
  const list = ROUTES.filter(r=>{
    if(fa && fa!=='all' && r.airline !== fa) return false;
    if(fd!=='all'){ const range = DURATIONS[Number(fd)]; if(!(r.durationMinutes>=range.min && r.durationMinutes<=range.max)) return false; }
    return true;
  });
  if(!list.length){ routesList.innerHTML = '<div class="kv">Нет направлений</div>'; return; }
  list.forEach(r=>{
    const div=document.createElement('div'); div.className='route-item';
    div.innerHTML = `<div style="min-width:0"><div class="route-title">${esc(r.fromICAO)} → ${esc(r.toICAO)} <span class="kv">(${r.durationMinutes} мин)</span></div><div class="kv">${esc(r.fromCity)} → ${esc(r.toCity)} · ${esc(r.airline)}</div></div><div class="kv">${getDurationLabelForMinutes(r.durationMinutes)}</div>`;
    div.addEventListener('click', ()=> openConfirmFromRoute(r));
    routesList.appendChild(div);
  });
}
function getDurationLabelForMinutes(mins){ for(const d of DURATIONS){ if(mins>=d.min && mins<=d.max) return d.label; } return '—'; }

/* selection / reserve / confirm (kept simple) */
function findCandidateAircraftForRoute(route){
  const duration = Number(route.durationMinutes) || 0;
  const canDo = ac => ac.status==='idle' && (typeof ac.maxFlightMinutes!=='number' || ac.maxFlightMinutes >= duration) && (typeof ac.fuelMinutes==='number' && ac.fuelMinutes >= (duration + (ac.reserveMargin||30)));
  let c = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && canDo(ac));
  if(!c.length) c = FLEET.filter(ac=>canDo(ac));
  if(!c.length) return null;
  c.sort((a,b)=> (b.fuelMinutes||0) - (a.fuelMinutes||0));
  return c[0];
}
function reserveAircraft(ac, ownerId, ttlMs=120000){
  if(ac.status==='inFlight') return {ok:false,reason:'inflight'};
  if(ac.status==='reserved') return {ok:false,reason:'already_reserved'};
  ac.status='reserved'; ac.reservedBy=ownerId; ac.reservedToken = ownerId+':'+Date.now()+':'+Math.random().toString(36).slice(2,8); ac.reservedUntil = nowMs()+ttlMs;
  FLEET_LOG.push({ts:nowMs(),event:'reserved',aircraft:ac.id});
  renderAssignLog(); renderFleetList();
  return {ok:true,token:ac.reservedToken,expires:ac.reservedUntil};
}
function confirmReservation(token,route,pilotId){
  const ac = FLEET.find(a=>a.reservedToken===token); if(!ac) return {ok:false,reason:'no_res'};
  const p = PILOTS.find(x=>x.id===pilotId); if(!(p && p.verified)) return {ok:false,reason:'pilot_not_verified'};
  const now=nowMs(); ac.fuelMinutes = Math.max(0, (ac.fuelMinutes||0) - Number(route.durationMinutes)); ac.status='inFlight'; ac.availableAt = now + (route.durationMinutes||120)*60000 + (ac.turnaround||0)*60000; ac.nextLocation = route.toICAO;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;
  FLEET_LOG.push({ts:now,event:'assign_confirmed',aircraft:ac.id,route:`${route.fromICAO}->${route.toICAO}`});
  renderAssignLog(); renderFleetList();
  const current = { flightId:uid('flt'), aircraftId:ac.id, airline:ac.airline, route, pilotId:p.id, pilotName:p.name, confirmedAt:now, etaMs:(route.durationMinutes||120)*60000 };
  persistCurrentFlight(p.id,current);
  renderCurrentFlight(); renderConfirmedSection(ac,route,p.id);
  return {ok:true,ac,current};
}
function releaseReservationByToken(token){ if(!token) return false; let found=false; FLEET.forEach(a=>{ if(a.reservedToken && a.reservedToken===token){ a.status='idle'; delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; FLEET_LOG.push({ts:nowMs(),event:'reservation_cancelled',aircraft:a.id}); found=true; } }); renderAssignLog(); renderFleetList(); return found; }

/* route->confirm flow */
function openConfirmFromRoute(route){
  const chosenPilot = choosePilotForAssignment(); if(!chosenPilot){ alert('Войдите'); showGate(); return; }
  const candidate = findCandidateAircraftForRoute(route); if(!candidate){ alert('Нет подходящих самолётов с запасом топлива'); return; }
  const r = reserveAircraft(candidate, chosenPilot.id); if(!r.ok){ alert('Ошибка резерва'); return; }
  PENDING_RESERVATION = { token: r.token, aircraftId: candidate.id, aircraft: candidate, route, pilotId: chosenPilot.id, expires: r.expires || (nowMs()+120000) };
  pendingBlockEl.style.display='block'; pendingInfoEl.textContent = `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${route.durationMinutes} мин · fuel:${candidate.fuelMinutes} мин`;
  updatePendingTimer(); openConfirmModalForPending();
  if(window._pendingInterval) clearInterval(window._pendingInterval);
  window._pendingInterval = setInterval(()=>{ if(!PENDING_RESERVATION){ clearInterval(window._pendingInterval); window._pendingInterval=null; pendingBlockEl.style.display='none'; return;} if(nowMs() > (PENDING_RESERVATION.expires||0)){ releaseReservationByToken(PENDING_RESERVATION.token); PENDING_RESERVATION=null; pendingBlockEl.style.display='none'; clearInterval(window._pendingInterval); window._pendingInterval=null; } else updatePendingTimer(); },800);
}
function openConfirmModalForPending(){ if(!PENDING_RESERVATION) return; const {aircraft,route,pilotId}=PENDING_RESERVATION; const p = PILOTS.find(x=>x.id===pilotId)||{}; confirmDetails.innerHTML = `<div><strong>${esc(route.fromICAO)} → ${esc(route.toICAO)}</strong><div class="kv">${esc(route.fromCity)} → ${esc(route.toCity)} · ${route.durationMinutes} мин</div></div><div class="kv">Aircraft: ${esc(aircraft.id)} · fuel:${aircraft.fuelMinutes} мин</div><div class="kv">Pilot: ${esc(p.name||'—')} (${esc(p.callSign||'—')})</div>`; document.getElementById('confirmModal').style.display='flex'; }
function acceptPendingReservation(){ if(!PENDING_RESERVATION) return; const {token,route,pilotId} = PENDING_RESERVATION; const res = confirmReservation(token,route,pilotId); if(!res.ok){ alert('Не удалось подтвердить'); return; } PENDING_RESERVATION=null; pendingBlockEl.style.display='none'; document.getElementById('confirmModal').style.display='none'; if(window._pendingInterval){ clearInterval(window._pendingInterval); window._pendingInterval=null; } }
function cancelPendingReservation(){ if(!PENDING_RESERVATION) return; const tok = PENDING_RESERVATION.token; const released = releaseReservationByToken(tok); if(!released){ const a = FLEET.find(x=>x.id===PENDING_RESERVATION.aircraftId); if(a){ a.status='idle'; delete a.reservedToken; delete a.reservedBy; delete a.reservedUntil; FLEET_LOG.push({ts:nowMs(),event:'reservation_force_released',aircraft:a.id}); } } PENDING_RESERVATION=null; pendingBlockEl.style.display='none'; document.getElementById('confirmModal').style.display='none'; if(window._pendingInterval){ clearInterval(window._pendingInterval); window._pendingInterval=null; } renderAssignLog(); renderFleetList(); }
function updatePendingTimer(){ if(!PENDING_RESERVATION){ pendingTimerEl.textContent=''; return; } const left = Math.max(0, Math.ceil(((PENDING_RESERVATION.expires||0)-nowMs())/1000)); pendingTimerEl.textContent = `Бронь действует ${left}s`; }

/* auth */
function choosePilotForAssignment(){ if(SESSION.pilotId){ const p = PILOTS.find(x=>x.id===SESSION.pilotId); if(p) return p; } return null; }
function generateCreatePending(){ const chosenPilot = choosePilotForAssignment(); if(!chosenPilot){ alert('Войдите'); showGate(); return; } const activeAirEl = Array.from(airlinesWrap.children).find(c=>c.classList.contains('active')); const fa = activeAirEl ? activeAirEl.getAttribute('data-airline') : 'all'; const fd = (window.chosenDur===null)?'all':String(window.chosenDur); let pool = ROUTES.filter(r=>{ if(fa && fa!=='all' && r.airline !== fa) return false; if(fd!=='all'){ const range = DURATIONS[Number(fd)]; if(!(r.durationMinutes>=range.min && r.durationMinutes<=range.max)) return false; } return true; }); if(!pool.length){ alert('Нет маршрутов по выбранным фильтрам'); return; } const route = pool[Math.floor(Math.random()*pool.length)]; const candidate = findCandidateAircraftForRoute(route); if(!candidate){ alert('Нет подходящих самолётов'); return; } const r = reserveAircraft(candidate, chosenPilot.id); if(!r.ok){ alert('Ошибка резерва'); return; } PENDING_RESERVATION = { token: r.token, aircraftId: candidate.id, aircraft: candidate, route, pilotId: chosenPilot.id, expires: r.expires || (nowMs()+120000) }; pendingBlockEl.style.display='block'; pendingInfoEl.textContent = `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${route.durationMinutes} мин · fuel:${candidate.fuelMinutes} мин`; updatePendingTimer(); openConfirmModalForPending(); }

/* misc UI wiring */
document.getElementById('btnLoginPilot').addEventListener('click', ()=>{ const cs=document.getElementById('loginCall').value.trim(); const pass=document.getElementById('loginPass').value.trim(); if(!cs){ alert('Введите позывной'); return;} const p = PILOTS.find(x=> (x.callSign||'').toLowerCase()===cs.toLowerCase()); if(!p){ alert('Пилот не найден'); return; } if(pass===CODEWORD || (p.password && pass===p.password)){ SESSION.pilotId = p.id; sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); renderAll(); document.getElementById('gateModal').style.display='none'; } else alert('Неверный пароль'); });
document.getElementById('btnCloseGate').addEventListener('click', ()=> document.getElementById('gateModal').style.display='none');
document.getElementById('showGate').addEventListener('click', ()=> document.getElementById('gateModal').style.display='flex');
document.getElementById('confirmAccept')?.addEventListener('click', acceptPendingReservation);
document.getElementById('confirmCancel')?.addEventListener('click', cancelPendingReservation);
document.getElementById('confirmPendingBtn')?.addEventListener('click', acceptPendingReservation);
document.getElementById('cancelPendingBtn')?.addEventListener('click', cancelPendingReservation);
document.getElementById('openGateBtn').addEventListener('click', ()=> document.getElementById('gateModal').style.display='flex');
document.getElementById('logoutBtn').addEventListener('click', ()=>{ SESSION.pilotId=null; sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); renderAll(); document.getElementById('gateModal').style.display='flex'; });

document.getElementById('genBtn').addEventListener('click', ()=> { if(!SESSION.pilotId){ alert('Войдите'); document.getElementById('gateModal').style.display='flex'; return; } generateCreatePending(); });
document.getElementById('cancelPendingBtn').addEventListener('click', cancelPendingReservation);
pilotSearch.addEventListener('input', renderPilots);

/* tabs */
const tabGenerate = document.getElementById('tabGenerate'), tabRoutes = document.getElementById('tabRoutes'), tabFleet = document.getElementById('tabFleet');
tabGenerate.addEventListener('click', ()=> switchTab('generate'));
tabRoutes.addEventListener('click', ()=> switchTab('routes'));
tabFleet.addEventListener('click', ()=> switchTab('fleet'));
function moveUnderlineTo(el){ const parentRect = el.parentElement.getBoundingClientRect(); const rect = el.getBoundingClientRect(); const u = document.getElementById('liquidUnderline'); u.style.left = (rect.left - parentRect.left) + 'px'; u.style.width = rect.width + 'px'; }
function switchTab(name){ tabGenerate.classList.toggle('active', name==='generate'); tabRoutes.classList.toggle('active', name==='routes'); tabFleet.classList.toggle('active', name==='fleet'); document.getElementById('panelRoutes').style.display = (name==='routes') ? 'block' : 'none'; document.getElementById('panelFleet').style.display = (name==='fleet') ? 'block' : 'none'; genBtn.style.display = (name==='generate') ? 'inline-flex' : 'none'; moveUnderlineTo(name==='generate'?tabGenerate:(name==='routes'?tabRoutes:tabFleet)); }

/* current flight/confirmed */
function renderConfirmedSection(ac,route,pilotId){ if(!confirmedSection) return; confirmedSection.style.display='block'; confirmedSection.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:900">${esc(ac.airline)} · ${esc(route.fromICAO)}→${esc(route.toICAO)}</div><div class="kv">${esc(route.fromCity)} → ${esc(route.toCity)}</div></div><div class="kv">Aircraft: ${esc(ac.id)} · ETA: ${new Date(Date.now() + (route.durationMinutes||0)*60000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</div></div>`; }
function renderCurrentFlight(){ if(!SESSION.pilotId){ pilotNameEl.textContent='—'; sessionBadge.textContent='Неавторизован'; document.getElementById('logoutBtn').style.display='none'; return;} const p = PILOTS.find(x=>x.id===SESSION.pilotId)||{}; pilotNameEl.textContent=p.name||'—'; sessionBadge.textContent = p.callSign ? `Вошёл ${p.callSign}` : 'Вошёл'; document.getElementById('logoutBtn').style.display='inline-flex'; const cur = JSON.parse(localStorage.getItem(CURRENT_FLIGHT_PREFIX + (p.id||'anon'))||'null'); if(cur) renderConfirmedSection({id:cur.aircraftId,airline:cur.airline}, cur.route, cur.pilotId); }

/* periodic: expiry + arrivals */
setInterval(()=>{ const now = nowMs(); FLEET.forEach(ac=>{ if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil <= now){ ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil; FLEET_LOG.push({ts:now,event:'reservation_expired',aircraft:ac.id}); } if(ac.status==='inFlight' && ac.availableAt && ac.availableAt <= now){ ac.status='idle'; if(ac.nextLocation) ac.locationICAO = ac.nextLocation; delete ac.availableAt; delete ac.nextLocation; FLEET_LOG.push({ts:now,event:'aircraft_available',aircraft:ac.id,location:ac.locationICAO}); } }); renderAssignLog(); renderFleetList(); },1500);

/* Initial render */
function renderAll(){
  renderAirlinePills(); renderTopDurations(); renderPilots(); renderAssignLog(); renderFleetAirlinePills(); renderFleetDurations(); updateFleetFilterUI(); renderFleetList(); renderRoutesPane(); renderCurrentFlight(); setTimeout(()=> moveUnderlineTo(document.getElementById('tabGenerate')),80);
}
renderAll();

/* fleet reset buttons */
fleetAirAllBtn.addEventListener('click', ()=>{ fleetFilterAirline='all'; updateFleetFilterUI(); renderFleetList(); });
fleetDurAllBtn.addEventListener('click', ()=>{ fleetFilterDuration='all'; updateFleetFilterUI(); renderFleetList(); });

/* expose quick helper (debug) */
window.__setDur = idx => { Array.from(durationsWrap.children).forEach(n=>n.classList.remove('active')); if(typeof idx==='number'){ durationsWrap.children[idx]?.classList.add('active'); window.chosenDur = idx; } else window.chosenDur=null; renderRoutesPane(); renderFleetList(); };
</script>
</body>
</html>
