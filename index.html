<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lufthansa Helper — tabs + assistant-trigger version</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#041528; --bg-2:#073044; --accent:#ffd54a; --accent-2:#ffb84d;
  --muted:#98bcd6; --text:#eaf4ff; --card:#062b3a;
  --ok:#bff2be; --radius:12px; --shadow:0 20px 60px rgba(2,8,20,0.55);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:var(--text);padding:20px}
.container{max-width:1200px;margin:0 auto}
.header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;background:linear-gradient(90deg,rgba(6,44,65,0.95),rgba(7,56,88,0.95));box-shadow:var(--shadow)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#063a59,#012938);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:900}
.title{font-weight:800}
.hright{display:flex;gap:10px;align-items:center}
.version{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:10px;font-weight:700;color:var(--muted)}
.small-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:var(--text);cursor:pointer}
.layout{display:grid;grid-template-columns:1fr 380px;gap:16px;margin-top:16px}
@media(max-width:980px){.layout{grid-template-columns:1fr}}
.card{background:linear-gradient(180deg,#062b3a,#042e33);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;font-weight:700}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#04202a;transform:translateY(-2px)}
.kv{font-size:13px;color:var(--muted)}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#04202a}
.list{display:flex;flex-direction:column;gap:10px}
.item{padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.02);cursor:default}
.modal-back{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(2,8,20,0.6),rgba(2,8,20,0.9));z-index:9999}
.modal{background:linear-gradient(180deg,#083044,#042b32);padding:18px;border-radius:12px;width:min(820px,96%);border:1px solid rgba(255,255,255,0.03)}
.small{font-size:13px;color:var(--muted)}
.current{background:linear-gradient(180deg,#022f2a,#032930);padding:12px;border-radius:10px;margin-top:12px}
.note{font-size:13px;color:var(--muted);margin-top:8px}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <div class="brand">
      <div class="logo">LH</div>
      <div>
        <div class="title">Lufthansa Helper</div>
        <div class="small">Routes · Fleet · Generate</div>
      </div>
    </div>
    <div class="hright">
      <div id="verLabel" class="version">v0</div>
      <button id="assistantNotify" class="small-btn" title="Нажми после сообщения ассистенту">Сообщить ассистенту</button>
      <button id="openAboutBtn" class="small-btn">О нас</button>
      <div id="sessionInfo" class="kv">Неавторизован</div>
    </div>
  </header>

  <div class="layout">
    <main>
      <div class="card">
        <div class="tabs" id="tabsRow">
          <div class="tab" data-tab="about" id="tab-about">О нас</div>
          <div class="tab active" data-tab="generate" id="tab-generate">Генерация</div>
          <div class="tab" data-tab="routes" id="tab-routes">Направления</div>
          <div class="tab" data-tab="fleet" id="tab-fleet">Флот</div>
          <div class="tab" data-tab="pilots" id="tab-pilots">Пилоты</div>
        </div>

        <section id="pane-about" style="display:none">
          <h3>О нас</h3>
          <p class="note">Lufthansa Helper — демонстрационная панель для управления рейсами. Доступны локальные сохранения, сохранение текущего рейса в браузере и очистка при смене аккаунта.</p>
        </section>

        <section id="pane-generate" style="display:block">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Генерация рейса</strong><div class="note">Только верифицированные пилоты</div></div>
            <div id="signedUser" class="kv">—</div>
          </div>

          <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
            <div id="airlines" style="display:flex;gap:8px;flex-wrap:wrap"></div>
            <select id="routeSort" class="input">
              <option value="none">Без сортировки</option>
              <option value="airline">По авиакомпании</option>
              <option value="duration">По времени в полёте</option>
            </select>
            <button id="genBtn" class="btn btn-primary">Сгенерировать</button>
            <button id="resetBtn" class="btn">Сброс</button>
          </div>

          <div id="resultArea" style="margin-top:12px;display:none"></div>
          <div id="confirmedSection" style="margin-top:12px"></div>
          <div id="currentFlightWrap"></div>
        </section>

        <section id="pane-routes" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Направления</strong><div class="note">Кликабельные карточки, откройте подробности</div></div>
            <div style="display:flex;gap:8px">
              <select id="filterAirline" class="input"><option value="all">Все</option></select>
              <select id="filterHub" class="input"><option value="all">Хабы</option></select>
            </div>
          </div>
          <div id="routesList" class="list" style="margin-top:12px"></div>
        </section>

        <section id="pane-fleet" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Флот</strong><div class="note">Статус самолётов</div></div>
            <div style="display:flex;gap:8px">
              <select id="filterFleetAirline" class="input"><option value="all">Все</option></select>
              <select id="filterFleetStatus" class="input"><option value="all">Все статусы</option><option value="idle">idle</option><option value="reserved">reserved</option><option value="inFlight">inFlight</option></select>
            </div>
          </div>
          <div id="fleetList" class="list" style="margin-top:12px"></div>
        </section>

        <section id="pane-pilots" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Пилоты</strong></div>
            <div><input id="pilotSearch" class="input" placeholder="Поиск"/></div>
          </div>
          <div id="pilotList" class="list" style="margin-top:12px"></div>
        </section>
      </div>
    </main>

    <aside>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Журнал</strong><div class="note">Недавние события</div></div>
          <div><button id="openGate" class="small-btn">Войти</button></div>
        </div>
        <div id="assignLog" class="list" style="margin-top:12px"></div>

        <div style="margin-top:12px">
          <div class="note">Webhook (опционально): при каждом сообщении ассистенту можешь вызвать URL чтобы автоматически инкрементировать версию. Пример запроса см. в комментариях к коду.</div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- Gate modal -->
<div id="gate" class="modal-back" style="display:none">
  <div class="modal">
    <h3>Вход</h3>
    <div class="note">Вход: позывной + пароль или кодовое слово</div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <input id="loginCall" class="input" placeholder="Позывной"/>
      <input id="loginPass" class="input" placeholder="Пароль" type="password"/>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="btnLoginPilot" class="btn btn-primary">Войти</button>
    </div>
  </div>
</div>

<!-- Route modal -->
<div id="routeModal" class="modal-back" style="display:none">
  <div class="modal">
    <h3 id="routeTitle">Маршрут</h3>
    <div id="routeBody" class="note" style="margin-top:8px"></div>
    <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
      <button id="routeUse" class="btn btn-primary">Сгенерировать этот маршрут</button>
      <button id="routeClose" class="btn">Закрыть</button>
    </div>
  </div>
</div>

<script>
/* ================= DATA ================= */
const CODEWORD='quickaccess2025';
const SESSION_KEY='demo_session_v2';
const CURRENT_FLIGHT_PREFIX='current_flight:';
const VERSION_KEY='lh_version_v1';

const AIRLINES=[ {name:"Lufthansa",hubs:["EDDF","EDDM"]},{name:"Eurowings",hubs:["EDDF","EDDM"]},{name:"SunExpress",hubs:["EDDF","EDDM"]} ];
const ROUTES=[
  {airline:"Lufthansa",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Oslo",toICAO:"ENGM",durationMinutes:120},
  {airline:"Lufthansa",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Amsterdam",toICAO:"EHAM",durationMinutes:70},
  {airline:"SunExpress",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Antalya",toICAO:"LTAI",durationMinutes:180},
  {airline:"Eurowings",fromCity:"Munich",fromICAO:"EDDM",toCity:"Zurich",toICAO:"LSZH",durationMinutes:60}
];
const FLEET=[
  {id:'LH-A320-01',airline:'Lufthansa',type:'A320',seats:180,turnaround:40,status:'idle',locationICAO:'EDDF'},
  {id:'EW-A320-01',airline:'Eurowings',type:'A320',seats:180,turnaround:40,status:'idle',locationICAO:'EDDM'},
  {id:'SX-B737-01',airline:'SunExpress',type:'737-800',seats:189,turnaround:35,status:'idle',locationICAO:'EDDF'}
];

let PILOTS=[
  {id:'pilot_loui',name:'Loui Desulier',callSign:'French',verified:true,password:'louiSecret'},
  {id:'pilot_ivan',name:'Ivan Petrov',callSign:'IPET',verified:true},
  {id:'pilot_anna',name:'Anna Müller',callSign:'AMUL',verified:false}
];

let FLEET_LOG=[];

let SESSION=(function(){ try{ const s=sessionStorage.getItem(SESSION_KEY); return s?JSON.parse(s):{pilotId:null,isAdmin:false}; }catch(e){return {pilotId:null,isAdmin:false}; } })();

/* ================= helpers ================= */
function uid(p='id'){return p+'_'+Math.random().toString(36).slice(2,9);}
function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function nowMs(){return Date.now();}
function saveSession(){ try{ sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); }catch(e){} }
function getCFKey(pid){ return CURRENT_FLIGHT_PREFIX + (pid||'anon'); }

/* version helpers */
function readVersion(){ try{ let v=parseInt(localStorage.getItem(VERSION_KEY)||'0',10); if(isNaN(v)) v=0; return v; }catch(e){return 0;} }
function bumpVersion(){ try{ let v=readVersion(); v++; localStorage.setItem(VERSION_KEY,String(v)); renderVersion(); return v;}catch(e){return null;} }
function renderVersion(){ document.getElementById('verLabel').textContent = 'v' + readVersion(); }

/* ================= UI refs ================= */
const tabs = document.querySelectorAll('.tab');
const panes = { about: document.getElementById('pane-about'), generate: document.getElementById('pane-generate'), routes: document.getElementById('pane-routes'), fleet: document.getElementById('pane-fleet'), pilots: document.getElementById('pane-pilots') };

const verLabel = document.getElementById('verLabel');
const assistantNotify = document.getElementById('assistantNotify');
const openAboutBtn = document.getElementById('openAboutBtn');

const airlinesWrap = document.getElementById('airlines');
const routeSort = document.getElementById('routeSort');
const genBtn = document.getElementById('genBtn');
const resetBtn = document.getElementById('resetBtn');
const resultArea = document.getElementById('resultArea');
const confirmedSection = document.getElementById('confirmedSection');
const currentFlightWrap = document.getElementById('currentFlightWrap');

const filterAirline = document.getElementById('filterAirline');
const filterHub = document.getElementById('filterHub');
const routesList = document.getElementById('routesList');

const filterFleetAirline = document.getElementById('filterFleetAirline');
const filterFleetStatus = document.getElementById('filterFleetStatus');
const fleetList = document.getElementById('fleetList');

const pilotList = document.getElementById('pilotList');
const pilotSearch = document.getElementById('pilotSearch');

const assignLog = document.getElementById('assignLog');
const sessionInfo = document.getElementById('sessionInfo');
const signedUser = document.getElementById('signedUser');

const gateModal = document.getElementById('gate');
const loginCall = document.getElementById('loginCall');
const loginPass = document.getElementById('loginPass');
const btnLoginPilot = document.getElementById('btnLoginPilot');
const openGateBtn = document.getElementById('openGate');

const routeModal = document.getElementById('routeModal');
const routeTitle = document.getElementById('routeTitle');
const routeBody = document.getElementById('routeBody');
const routeClose = document.getElementById('routeClose');
const routeUse = document.getElementById('routeUse');

let chosenAirIndex = null, chosenDur = null, lastReservation = null;

/* ================= render helpers ================= */
function renderSessionInfo(){
  const p = PILOTS.find(x=>x.id===SESSION.pilotId);
  signedUser.textContent = p ? `${p.name} (${p.callSign})` : '—';
  sessionInfo.textContent = SESSION.isAdmin ? 'Admin session' : (p ? `Вошёл как ${p.callSign}` : 'Неавторизован');
}

function renderAirlines(){
  airlinesWrap.innerHTML='';
  const sorted = AIRLINES.slice().sort((a,b)=>a.name.localeCompare(b.name,'ru'));
  sorted.forEach(a=>{
    const b=document.createElement('button'); b.className='small-btn'; b.textContent=a.name;
    b.addEventListener('click', ()=> {
      chosenAirIndex = AIRLINES.findIndex(x=>x.name===a.name);
      Array.from(airlinesWrap.children).forEach(n=>n.classList.remove('active'));
      b.classList.add('active');
      bumpVersion();
    });
    airlinesWrap.appendChild(b);
  });
}

function renderRoutes(){
  // filter + sort
  routesList.innerHTML='';
  const fa = filterAirline.value||'all'; const fh = filterHub.value||'all';
  let list = ROUTES.filter(r=> { if(fa!=='all' && r.airline!==fa) return false; if(fh!=='all' && r.fromICAO!==fh && r.toICAO!==fh) return false; return true; });
  const sort = routeSort.value;
  if(sort==='airline') list.sort((a,b)=>a.airline.localeCompare(b.airline,'ru'));
  if(sort==='duration') list.sort((a,b)=>a.durationMinutes - b.durationMinutes);
  if(!list.length){ routesList.innerHTML='<div class="kv">Нет направлений</div>'; return; }
  list.forEach(r=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div><strong>${esc(r.airline)}</strong><div class="small">${esc(r.fromICAO)} (${esc(r.fromCity)}) → ${esc(r.toICAO)} (${esc(r.toCity)})</div></div><div class="small"><strong>${r.durationMinutes} мин</strong></div>`;
    el.addEventListener('click', ()=> openRouteModal(r));
    routesList.appendChild(el);
  });
}

function renderFleet(){
  fleetList.innerHTML='';
  const fa = filterFleetAirline.value||'all'; const fs = filterFleetStatus.value||'all';
  const list = FLEET.filter(a=> { if(fa!=='all' && a.airline!==fa) return false; if(fs!=='all' && a.status!==fs) return false; return true; });
  if(!list.length){ fleetList.innerHTML='<div class="kv">Нет самолётов</div>'; return; }
  list.forEach(a=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div><strong>${esc(a.id)}</strong><div class="small">${esc(a.airline)} · ${esc(a.type)} · ${a.seats} кресел · ${esc(a.locationICAO)}</div></div><div class="small">${esc(a.status)}</div>`;
    fleetList.appendChild(el);
  });
}

function renderPilots(){
  pilotList.innerHTML='';
  const q=(pilotSearch.value||'').toLowerCase().trim();
  const list = PILOTS.filter(p=> { if(!q) return true; return (p.name+' '+p.callSign).toLowerCase().includes(q); });
  if(!list.length){ pilotList.innerHTML='<div class="kv">Пилотов нет</div>'; return; }
  list.forEach(p=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div><strong>${esc(p.name)}</strong><div class="small">${esc(p.callSign)} · ${p.verified? 'Verified':'Not verified'}</div></div>`;
    const btn=document.createElement('button'); btn.className='small-btn'; btn.textContent='Войти';
    btn.addEventListener('click', ()=> signInAsPilot(p.id));
    el.appendChild(btn);
    pilotList.appendChild(el);
  });
}

function renderAssignLog(){
  assignLog.innerHTML='';
  if(!FLEET_LOG.length){ assignLog.innerHTML='<div class="kv">Пусто</div>'; return; }
  FLEET_LOG.slice(-40).reverse().forEach(e=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML=`<div class="small">${new Date(e.ts).toLocaleString()}</div><div class="small">${esc(e.event)} ${esc(e.aircraft||'')} ${esc(e.route||'')}</div>`;
    assignLog.appendChild(el);
  });
}

/* current flight persistence */
function persistCurrentFlight(pilotId, obj){ try{ localStorage.setItem(getCFKey(pilotId), JSON.stringify(obj)); }catch(e){} }
function loadCurrentFlight(pilotId){ try{ const v=localStorage.getItem(getCFKey(pilotId)); return v?JSON.parse(v):null; }catch(e){return null;} }
function clearCurrentFlight(pilotId){ try{ localStorage.removeItem(getCFKey(pilotId)); }catch(e){} }

let cIntervals={};
function renderCurrentFlight(){
  currentFlightWrap.innerHTML='';
  if(!SESSION.pilotId) return;
  const cur = loadCurrentFlight(SESSION.pilotId);
  if(!cur) return;
  const el=document.createElement('div'); el.className='current';
  const etaDate=new Date(cur.confirmedAt + (cur.etaMs||0));
  const left=Math.max(0, Math.floor(((cur.confirmedAt + cur.etaMs) - Date.now())/1000));
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between"><div><strong>Текущий рейс</strong><div class="small">${esc(cur.airline)} ${esc(cur.route.fromICAO)}→${esc(cur.route.toICAO)}</div></div><div class="small">ETA: ${esc(etaDate.toLocaleString())}</div></div>
    <div style="margin-top:8px" class="small">Flight ID: <strong>${esc(cur.flightId)}</strong></div>
    <div class="small">Aircraft: <strong>${esc(cur.aircraftId)}</strong> · ${esc(cur.aircraftType)} · Seats: ${esc(cur.seats)} · Turnaround: ${esc(cur.turnaround||'—')}</div>
    <div class="small">Pilot: <strong>${esc(cur.pilotName)} (${esc(cur.pilotCall)})</strong></div>
    <div class="small" style="margin-top:8px">Reserved token: <span style="word-break:break-all">${esc(cur.reservedToken||'—')}</span></div>
    <div class="small" style="margin-top:8px">Time left: <strong id="left_${esc(cur.flightId)}">${left}</strong> s</div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px"><button id="mark_${esc(cur.flightId)}" class="btn btn-primary">Отметить долетел</button><button id="clear_${esc(cur.flightId)}" class="btn">Удалить</button></div>
  `;
  currentFlightWrap.appendChild(el);

  if(cIntervals[cur.flightId]) clearInterval(cIntervals[cur.flightId]);
  cIntervals[cur.flightId]=setInterval(()=>{
    const nowc = loadCurrentFlight(SESSION.pilotId);
    if(!nowc){ clearInterval(cIntervals[cur.flightId]); renderCurrentFlight(); return; }
    const leftNow = Math.max(0, Math.floor(((nowc.confirmedAt + nowc.etaMs)-Date.now())/1000));
    const elLeft = document.getElementById('left_'+nowc.flightId);
    if(elLeft) elLeft.textContent = leftNow;
    if(leftNow<=0){ clearInterval(cIntervals[cur.flightId]); renderCurrentFlight(); }
  },1000);

  document.getElementById('mark_'+cur.flightId).addEventListener('click', ()=>{
    if(!confirm('Отметить как долетел?')) return;
    FLEET_LOG.push({ts:nowMs(),event:'pilot_arrived',aircraft:cur.aircraftId,route:`${cur.route.fromICAO}->${cur.route.toICAO}`,pilotId:cur.pilotId});
    clearCurrentFlight(SESSION.pilotId);
    renderAssignLog(); renderCurrentFlight(); bumpVersion();
    alert('Рейс отмечен как завершённый у вас в браузере');
  });
  document.getElementById('clear_'+cur.flightId).addEventListener('click', ()=>{
    if(!confirm('Удалить запись?')) return;
    clearCurrentFlight(SESSION.pilotId); renderCurrentFlight(); bumpVersion();
  });
}

/* =============== reservation / confirm =============== */
function reserveAircraft(ac, ownerId, ttlMs=120000){
  if(ac.status==='inFlight') return {ok:false,reason:'inflight'};
  if(ac.status==='reserved') return {ok:false,reason:'already_reserved'};
  ac.status='reserved'; ac.reservedBy=ownerId; ac.reservedToken = ownerId+':'+Date.now()+':'+Math.random().toString(36).slice(2,8); ac.reservedUntil = nowMs()+ttlMs;
  FLEET_LOG.push({ts:nowMs(),event:'reserved',aircraft:ac.id});
  renderAssignLog(); renderFleet();
  return {ok:true,token:ac.reservedToken};
}
function cancelReservationByToken(token){
  const ac = FLEET.find(a=>a.reservedToken===token); if(!ac) return false;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil; ac.status='idle';
  FLEET_LOG.push({ts:nowMs(),event:'reservation_cancelled',aircraft:ac.id});
  renderAssignLog(); renderFleet(); return true;
}
function confirmReservation(token, route, pilotId){
  const ac = FLEET.find(a=>a.reservedToken===token); if(!ac) return {ok:false,reason:'no_res'};
  if(ac.reservedToken !== token) return {ok:false,reason:'token_mismatch'};
  if(!SESSION.isAdmin){
    const eff = pilotId || SESSION.pilotId; if(!eff) return {ok:false,reason:'no_pilot'};
    const p = PILOTS.find(x=>x.id===eff); if(!(p && p.verified)) return {ok:false,reason:'pilot_not_verified'};
    pilotId = eff;
  }
  const now = nowMs(); const durMs = (Number(route.durationMinutes)||120)*60*1000;
  ac.status='inFlight'; ac.availableAt = now + durMs + (ac.turnaround||0)*60*1000; ac.nextLocation = route.toICAO;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;
  FLEET_LOG.push({ts:now,event:'assign_confirmed',aircraft:ac.id,route:`${route.fromICAO}->${route.toICAO}`,durationMin:route.durationMinutes});
  renderAssignLog(); renderFleet();
  const pilot = PILOTS.find(p=>p.id===pilotId);
  const current = {
    flightId: uid('flt'),
    aircraftId: ac.id,
    aircraftType: ac.type,
    seats: ac.seats,
    turnaround: ac.turnaround,
    airline: ac.airline,
    route,
    pilotId,
    pilotName: pilot?pilot.name:'',
    pilotCall: pilot?pilot.callSign:'',
    confirmedAt: now,
    etaMs: durMs,
    reservedToken: token
  };
  persistCurrentFlight(pilotId, current);
  renderCurrentFlight(); bumpVersion();
  return {ok:true,ac};
}

/* =============== generate =============== */
function canCreate(){ if(SESSION.isAdmin) return true; if(!SESSION.pilotId) return false; const p=PILOTS.find(x=>x.id===SESSION.pilotId); return !!(p && p.verified); }

function generateFlight(fromRoute=null){
  if(!canCreate()){ alert('Только верифицированный пилот или админ.'); return; }
  let pool = ROUTES.slice();
  const sort = routeSort.value; if(sort==='airline') pool.sort((a,b)=>a.airline.localeCompare(b.airline,'ru')); if(sort==='duration') pool.sort((a,b)=>a.durationMinutes-b.durationMinutes);
  if(fromRoute) pool=[fromRoute]; else {
    if(chosenAirIndex!==null){ const ch=AIRLINES[chosenAirIndex].name; pool = pool.filter(r=>r.airline.toLowerCase()===ch.toLowerCase()); if(!pool.length) pool = ROUTES.slice(); }
  }
  const route = pool[Math.floor(Math.random()*pool.length)];
  let candidates = FLEET.filter(ac=> (ac.locationICAO||'').toUpperCase()===(route.fromICAO||'').toUpperCase() && ac.status==='idle');
  if(!candidates.length) { resultArea.style.display='block'; resultArea.innerHTML='<div class="kv">Нет idle самолётов</div>'; return; }
  candidates.sort((a,b)=>Math.abs(a.seats-180)-Math.abs(b.seats-180)); const candidate=candidates[0];
  const res = reserveAircraft(candidate, SESSION.pilotId || 'user_anonymous');
  if(!res.ok){ alert('Не удалось зарезервировать: '+res.reason); return; }
  lastReservation = {route,aircraftId:candidate.id,token:res.token,reservedAt:nowMs()};
  renderReservationCard(lastReservation);
  bumpVersion();
}

/* reservation card rendering */
function renderReservationCard(gen){
  if(!gen){ resultArea.style.display='none'; resultArea.innerHTML=''; return; }
  const ac = FLEET.find(a=>a.id===gen.aircraftId);
  const route = gen.route;
  resultArea.style.display='block';
  let pilotOpt = '<option value="">Не назначать</option>';
  if(SESSION.isAdmin) PILOTS.forEach(p=>pilotOpt += `<option value="${p.id}">${esc(p.name)} (${esc(p.callSign)}) ${p.verified? '·V':''}</option>`);
  else if(SESSION.pilotId){ const p=PILOTS.find(x=>x.id===SESSION.pilotId); if(p) pilotOpt += `<option value="${p.id}">${esc(p.name)} (${esc(p.callSign)})</option>`; }
  resultArea.innerHTML = `
    <div class="item" style="align-items:center">
      <div>
        <div style="font-weight:800">${esc(ac.id)} · ${esc(ac.airline)} · ${esc(ac.type)}</div>
        <div class="small">${esc(route.fromICAO)} → ${esc(route.toICAO)} · ${route.durationMinutes} мин</div>
        <div class="small">Token: <span style="word-break:break-all">${esc(gen.token)}</span></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <select id="selectPilot" class="input">${pilotOpt}</select>
        <div style="display:flex;gap:8px"><button id="confirmBtn" class="btn btn-primary">Подтвердить</button><button id="cancelBtn" class="btn">Отменить</button></div>
      </div>
    </div>
  `;
  document.getElementById('confirmBtn').addEventListener('click', ()=>{
    const sel=document.getElementById('selectPilot').value||null;
    const r = confirmReservation(gen.token, gen.route, sel);
    if(!r.ok){ alert('Не удалось: '+r.reason); } else { lastReservation=null; renderReservationCard(null); }
  });
  document.getElementById('cancelBtn').addEventListener('click', ()=>{ cancelReservationByToken(gen.token); lastReservation=null; renderReservationCard(null); });
}

/* =============== route modal =============== */
let routeInModal=null;
function openRouteModal(route){ routeInModal=route; routeTitle.textContent=`${route.airline} • ${route.fromICAO}→${route.toICAO}`; routeBody.innerHTML=`<div class="small">Duration: <strong>${route.durationMinutes} мин</strong></div><div class="note">Нажмите «Сгенерировать этот маршрут» чтобы использовать его.</div>`; routeModal.style.display='flex'; }
routeClose.addEventListener('click', ()=>{ routeModal.style.display='none'; routeInModal=null; });
routeUse.addEventListener('click', ()=>{ if(routeInModal) { generateFlight(routeInModal); routeModal.style.display='none'; routeInModal=null; } });

/* =============== gate / auth / clear previous flights =============== */
function wipePrev(prev){
  if(!prev) return;
  try{ clearCurrentFlight(prev); FLEET.forEach(a=>{ if(a.reservedBy===prev){ delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; a.status='idle'; FLEET_LOG.push({ts:nowMs(),event:'cleared_prev',aircraft:a.id,prev}); } }); renderFleet(); renderAssignLog(); }catch(e){console.warn(e);}
}

openGateBtn.addEventListener('click', ()=>{ gateModal.style.display='flex'; });
btnLoginPilot.addEventListener('click', ()=>{
  const cs=(loginCall.value||'').trim(), pass=(loginPass.value||'').trim();
  if(!cs){ alert('Введите позывной'); return; }
  const p=PILOTS.find(x=> (x.callSign||'').toLowerCase()===cs.toLowerCase());
  if(!p){ alert('Пилот не найден'); return; }
  const pp=p.password||'';
  if(pass===CODEWORD || (pp && pass===pp)){
    const prev=SESSION.pilotId;
    SESSION.pilotId=p.id; SESSION.isAdmin=false; saveSession();
    if(prev && prev!==p.id) wipePrev(prev);
    renderSessionInfo(); renderPilots(); renderRoutes(); renderFleet(); renderAssignLog(); renderCurrentFlight();
    gateModal.style.display='none';
    // show About tab first after login
    activateTab('about'); bumpVersion();
    return;
  }
  alert('Неверный пароль');
});

/* sign in from pilot list */
function signInAsPilot(pid){
  const prev=SESSION.pilotId;
  SESSION.pilotId=pid; SESSION.isAdmin=false; saveSession();
  if(prev && prev!==pid) wipePrev(prev);
  renderSessionInfo(); renderPilots(); renderRoutes(); renderFleet(); renderAssignLog(); renderCurrentFlight();
  activateTab('about'); bumpVersion();
}

/* ================= tab switching ================= */
function activateTab(name){
  tabs.forEach(t=> t.classList.toggle('active', t.getAttribute('data-tab')===name));
  for(const k in panes) panes[k].style.display = (k===name)?'block':'none';
}
tabs.forEach(t=> t.addEventListener('click', ()=> { const key=t.getAttribute('data-tab'); activateTab(key); bumpVersion(); }));

/* ================= assistant notify (manual trigger) and webhook example ================= */
assistantNotify.addEventListener('click', ()=> { 
  // Ручной триггер: нажми после того, как отправил сообщение ассистенту — версия увеличится.
  bumpVersion();
  alert('Версия обновлена вручную (отправлено уведомление ассистенту)');
});

/* Webhook / automatic integration (пример)
   Если ты можешь сделать внешний вызов при каждом сообщении ассистенту, то пусть тот вызов сделает POST на этот URL:
   https://<твoй-сервер>/lh-bump
   А сервер в ответ выполнит простой fetch к странице (или вызовет API), чтобы увеличить версию на клиенте.
   На чисто статическом GitHub Pages это невозможно без сервера; поэтому пример оставлен как подсказка.
*/

/* ================= misc bindings & init ================= */
routeSort.addEventListener('change', ()=>{ renderRoutes(); bumpVersion(); });
filterAirline.addEventListener('change', ()=>{ renderRoutes(); });
filterHub.addEventListener('change', ()=>{ renderRoutes(); });
filterFleetAirline.addEventListener('change', ()=>{ renderFleet(); });
filterFleetStatus.addEventListener('change', ()=>{ renderFleet(); });
pilotSearch.addEventListener('input', ()=>{ renderPilots(); });

document.getElementById('openAboutBtn').addEventListener('click', ()=>{ activateTab('about'); aboutModalHide(); bumpVersion(); });

/* helper to hide any top-level about (we show About pane instead) */
function aboutModalHide(){ const am=document.getElementById('pane-about'); if(am) { /* pane already visible */ }}

/* version render initially */
renderVersion();

/* ================= init render ================= */
function init(){
  renderAirlines(); renderRoutes(); renderFleet(); renderPilots(); renderAssignLog(); renderSessionInfo(); renderCurrentFlight();
  // show gate for login if not logged
  if(!SESSION.pilotId && !SESSION.isAdmin){ gateModal.style.display='none'; /* gate opened by button; to require login on load, set to 'flex' */ }
  // user requested: About should be first visible AFTER login; keep generate visible pre-login
  activateTab('generate');
}
init();

/* Expose debug */
window._lh = {PILOTS,ROUTES,AIRLINES,FLEET,bumpVersion,readVersion,activateTab};
</script>
</body>
</html>
