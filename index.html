<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lufthansa Group Virtual — Smooth UI, Routes, Fleet, Generate</title>
<meta name="color-scheme" content="dark light">
<style>
:root{
  --bg-1:#041528; --bg-2:#073044; --accent:#ffd54a; --accent-2:#ffb84d;
  --muted:#99bcd6; --text:#eaf4ff; --card:#072033; --glass:rgba(255,255,255,0.03);
  --ok:#bff2be; --warn:#fff0b8; --danger:#ff7a59; --shadow-lg:0 30px 80px rgba(2,8,20,0.6);
  --radius:14px; --smooth:280ms cubic-bezier(.2,.9,.2,1);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter,system-ui,Roboto,Helvetica,Arial,sans-serif;
  background:
    radial-gradient(800px 400px at 10% 10%, rgba(255,255,255,0.02), transparent),
    linear-gradient(180deg,var(--bg-1),var(--bg-2));
  color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  padding:28px; display:flex;justify-content:center;align-items:flex-start;
}

/* Container */
.wrap{width:100%;max-width:1200px}
.header{
  display:flex;align-items:center;justify-content:space-between;padding:18px;border-radius:16px;
  background:linear-gradient(90deg,rgba(5,45,70,0.95),rgba(6,58,89,0.95));
  box-shadow:var(--shadow-lg); border:1px solid rgba(255,255,255,0.03);
  transform:translateY(0); transition:transform var(--smooth);
}
.brand{display:flex;gap:16px;align-items:center}
.logo{
  width:62px;height:62px;border-radius:12px;background:linear-gradient(180deg,#063a59,#012938);
  display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:900;font-size:20px;
  box-shadow:0 8px 24px rgba(2,8,20,0.5);
}
.titleMain{margin:0;font-size:18px}
.small{font-size:13px;color:var(--muted)}

/* Top nav */
.top-controls{display:flex;gap:10px;align-items:center}
.nav-tabs{display:flex;gap:8px;margin-top:14px}
.tab-btn{
  padding:8px 14px;border-radius:12px;border:0;background:rgba(255,255,255,0.02);color:var(--muted);cursor:pointer;font-weight:700;
  transition:all var(--smooth);
}
.tab-btn.active{
  background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#04202a; box-shadow:0 8px 30px rgba(255,180,60,0.12);
  transform:translateY(-3px);
}

/* Layout grid */
.main{
  margin-top:18px; display:grid; grid-template-columns: 1fr 440px; gap:18px;
}
@media(max-width:1050px){ .main{ grid-template-columns:1fr } }

/* Card */
.card{
  padding:16px;border-radius:var(--radius); background:
  linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  border:1px solid rgba(255,255,255,0.03); box-shadow:0 8px 30px rgba(2,8,20,0.45);
}
.section-title{margin:0;font-weight:800;color:var(--accent);font-size:18px}

/* Inputs / buttons */
.input{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);width:100%;transition:box-shadow var(--smooth),transform var(--smooth)}
.input:focus{outline:none;box-shadow:0 6px 22px rgba(2,8,20,0.6);transform:translateY(-2px)}
.row{display:flex;gap:10px;align-items:center}
.btn{
  padding:9px 14px;border-radius:10px;border:0;background:transparent;color:var(--text);cursor:pointer;font-weight:800;transition:transform var(--smooth),box-shadow var(--smooth);
  box-shadow:0 6px 18px rgba(2,8,20,0.35)
}
.btn:active{transform:translateY(1px)}
.btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#04202a}
.btn-ghost{border:1px solid rgba(255,255,255,0.04);background:transparent}

/* Lists */
.list{display:flex;flex-direction:column;gap:12px;margin-top:12px}
.item{
  border-radius:12px;padding:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);display:flex;align-items:center;justify-content:space-between;
  border:1px solid rgba(255,255,255,0.02); transition:transform var(--smooth),box-shadow var(--smooth),background var(--smooth);
}
.item:hover{transform:translateY(-6px); box-shadow:0 18px 50px rgba(2,8,20,0.5); background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
.meta{color:var(--muted);font-size:13px}
.badge{padding:6px 10px;border-radius:999px;font-weight:800}
.status-idle{background:linear-gradient(90deg,#0d4b47,#0b6b5f);color:var(--ok)}
.status-inflight{background:linear-gradient(90deg,#5a2b2b,#7a3c3c);color:#ffd0c2}
.status-reserved{background:linear-gradient(90deg,#5a3a9e,#7b61d0);color:#f7ecff}

/* Reservation / current flight */
.current-flight{
  margin-top:12px;padding:14px;border-radius:14px;background:linear-gradient(180deg,#043a33,#032e2f);border:1px solid rgba(255,255,255,0.04);
  animation:fadeIn 320ms ease;
}
@keyframes fadeIn{ from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

/* Gate (always top) */
#gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(2,8,20,0.6),rgba(2,8,20,0.88));z-index:9999}
#gateCard{width:min(680px,94%);border-radius:14px;padding:20px;background:linear-gradient(180deg,#072033,#042f44);border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 90px rgba(2,8,20,0.8)}
.small-muted{font-size:13px;color:var(--muted)}

/* Smooth transitions for showing/hiding sections */
.section{opacity:0;transform:translateY(8px);transition:opacity 320ms ease,transform 320ms ease;display:none}
.section.active{display:block;opacity:1;transform:none}

/* small helper */
.kv{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <div class="logo">LH</div>
      <div>
        <h1 class="titleMain">Lufthansa Group Virtual</h1>
        <div class="small">Routes · Fleet · Generate — smooth UI</div>
      </div>
    </div>

    <div class="top-controls">
      <div id="sessionInfo" class="small-muted">Неавторизован</div>
      <div style="width:12px"></div>
      <div id="navTabs" class="nav-tabs">
        <button class="tab-btn active" data-tab="generate" id="tab-generate">Генерация рейса</button>
        <button class="tab-btn" data-tab="routes" id="tab-routes">Направления</button>
        <button class="tab-btn" data-tab="fleet" id="tab-fleet">Флот</button>
      </div>
    </div>
  </header>

  <div class="main" style="margin-top:18px">
    <!-- left column -->
    <div>
      <!-- Generate section -->
      <div id="sec-generate" class="section active card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 class="section-title">Генерация рейса</h2>
          <div class="kv">Только верифицированные пилоты</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:12px;align-items:center">
          <div style="flex:1">
            <div style="padding:12px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)">
              <h3 style="margin:0 0 8px 0">Настройки</h3>
              <div style="display:flex;gap:10px;align-items:center">
                <div id="airlines" style="display:flex;gap:8px;flex-wrap:wrap"></div>
              </div>
              <div style="margin-top:10px" id="durations" ></div>

              <div style="display:flex;gap:10px;margin-top:12px;align-items:center">
                <button id="btn-gen" class="btn btn-primary">Сгенерировать и зарезервировать</button>
                <button id="btn-demo" class="btn btn-ghost">Быстро: SunExpress</button>
                <button id="btn-reset" class="btn btn-ghost">Сброс</button>
                <div style="flex:1"></div>
                <div class="kv">Вошёл: <strong id="signedUser">—</strong></div>
              </div>
            </div>

            <div id="resultArea" style="margin-top:14px;display:none" class="card"></div>

            <div id="confirmedSection" style="margin-top:12px"></div>

            <div id="currentFlightWrap" style="margin-top:12px"></div>
          </div>
        </div>
      </div>

      <!-- Routes section -->
      <div id="sec-routes" class="section card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 class="section-title">Направления</h2>
          <div class="kv">Фильтр по авиакомпании и хабу</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <select id="filterAirline" class="input" style="width:220px"><option value="all">Все авиакомпании</option></select>
          <select id="filterHub" class="input" style="width:140px"><option value="all">Все хабы</option></select>
          <button id="refreshRoutes" class="btn btn-ghost">Обновить</button>
        </div>

        <div id="routesList" class="list" style="margin-top:12px"></div>
      </div>

      <!-- Fleet section -->
      <div id="sec-fleet" class="section card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h2 class="section-title">Флот</h2>
          <div class="kv">Статус самолётов и фильтры</div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <select id="filterFleetAirline" class="input" style="width:220px"><option value="all">Все авиакомпании</option></select>
          <select id="filterFleetStatus" class="input" style="width:160px"><option value="all">Все статусы</option><option value="idle">idle</option><option value="reserved">reserved</option><option value="inFlight">inFlight</option></select>
          <button id="refreshFleet" class="btn btn-ghost">Обновить</button>
        </div>

        <div id="fleetList" class="list" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- right column -->
    <aside>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:900">Пилоты</div>
            <div class="kv">Просмотр; авторизация через Gate</div>
          </div>
          <div>
            <button id="btn-export" class="btn btn-ghost">Экспорт</button>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <input id="pilotSearch" class="input" placeholder="Поиск по имени/позывному" />
          <select id="pilotBaseFilter" class="input" style="width:140px"><option value="all">Все базы</option></select>
        </div>

        <div id="pilotList" class="list" style="margin-top:12px"></div>
        <div id="pilotEmpty" class="kv" style="margin-top:8px">Пилотов ещё нет</div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Журнал назначений</div>
          <div class="kv">in-memory</div>
        </div>
        <div id="assignLog" class="list" style="margin-top:12px"></div>
      </div>
    </aside>
  </div>
</div>

<!-- Gate (always shown on load) -->
<div id="gate" aria-hidden="false">
  <div id="gateCard" role="dialog" aria-modal="true">
    <h2 style="margin:0 0 8px 0">Вход в Lufthansa Helper</h2>
    <div class="kv">Вход обязателен. Используйте позывной + пароль пилота или кодовое слово.</div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="rolePilot" class="tab-btn active">Пилот</button>
      <button id="roleAdmin" class="tab-btn">Админ</button>
    </div>

    <div id="loginPilot" style="margin-top:12px">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="loginCall" class="input" placeholder="Позывной (call sign)"/>
        <input id="loginPass" class="input" placeholder="Пароль пилота или кодовое слово" type="password"/>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnLoginPilot" class="btn btn-primary">Войти как пилот</button>
        <div style="flex:1"></div>
        <div class="kv">Кодовое слово: <strong id="codewordLabel">quickaccess2025</strong></div>
      </div>
    </div>

    <div id="loginAdmin" style="display:none;margin-top:12px">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="adminUser" class="input" placeholder="Admin user (demo: admin)"/>
        <input id="adminPass" class="input" placeholder="Пароль" type="password"/>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btnLoginAdmin" class="btn btn-primary">Войти как админ</button>
        <button id="btnBackToPilot" class="btn btn-ghost">Назад</button>
      </div>
      <div class="kv" style="margin-top:8px">Demo пароль: <strong style="color:var(--accent)">admin123</strong></div>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG / DATA ================= */
const CODEWORD = 'quickaccess2025'; // quick login
const SESSION_KEY = 'demo_session_v2';
const CURRENT_FLIGHT_PREFIX = 'current_flight:'; // localStorage key prefix

const AIRLINES = [
  { name: "Lufthansa", hubs: ["EDDF","EDDM"] },
  { name: "Eurowings", hubs: ["EDDF","EDDM"] },
  { name: "SunExpress", hubs: ["EDDF","EDDM"] }
];
const ROUTES = [
  { airline: "Lufthansa", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Oslo", toICAO:"ENGM", durationMinutes:120 },
  { airline: "Lufthansa", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Amsterdam", toICAO:"EHAM", durationMinutes:70 },
  { airline: "SunExpress", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Antalya", toICAO:"LTAI", durationMinutes:180 },
  { airline: "Eurowings", fromCity:"Munich", fromICAO:"EDDM", toCity:"Zurich", toICAO:"LSZH", durationMinutes:60 }
];
const FLEET = [
  { id:'LH-A320-01', airline:'Lufthansa', type:'A320', seats:180, turnaround:40, status:'idle', locationICAO:'EDDF' },
  { id:'EW-A320-01', airline:'Eurowings', type:'A320', seats:180, turnaround:40, status:'idle', locationICAO:'EDDM' },
  { id:'SX-B737-01', airline:'SunExpress', type:'737-800', seats:189, turnaround:35, status:'idle', locationICAO:'EDDF' }
];
let PILOTS = [
  { id: 'pilot_loui', name: 'Loui Desulier', callSign: 'French', rank: '', baseICAO: '', createdAt: Date.now(), verified: true, password: 'louiSecret' },
  { id: 'pilot_ivan', name:'Ivan Petrov', callSign:'IPET', rank:'ATPL', baseICAO:'EDDF', createdAt: Date.now(), verified:true, password: '' },
  { id: 'pilot_anna', name:'Anna Müller', callSign:'AMUL', rank:'CPL', baseICAO:'EDDM', createdAt: Date.now(), verified:false }
];

let FLEET_LOG = [];
let SESSION = (function(){ try{ const s = sessionStorage.getItem(SESSION_KEY); return s ? JSON.parse(s) : { pilotId:null, isAdmin:false }; }catch(e){ return { pilotId:null, isAdmin:false }; } })();

/* ================= HELPERS ================= */
function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
function nowMs(){ return Date.now(); }
function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function saveSession(){ try{ sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); }catch(e){} }
function getCurrentFlightKey(pilotId){ return CURRENT_FLIGHT_PREFIX + (pilotId||'anon'); }

/* ================= UI REFS ================= */
const tabs = document.querySelectorAll('.tab-btn');
const secGenerate = document.getElementById('sec-generate');
const secRoutes = document.getElementById('sec-routes');
const secFleet = document.getElementById('sec-fleet');

const airlinesWrap = document.getElementById('airlines');
const durationsWrap = document.getElementById('durations');
const btnGen = document.getElementById('btn-gen');
const btnDemo = document.getElementById('btn-demo');
const btnReset = document.getElementById('btn-reset');
const resultArea = document.getElementById('resultArea');
const confirmedSection = document.getElementById('confirmedSection');
const currentFlightWrap = document.getElementById('currentFlightWrap');

const pilotList = document.getElementById('pilotList');
const pilotEmpty = document.getElementById('pilotEmpty');
const pilotSearch = document.getElementById('pilotSearch');
const pilotBaseFilter = document.getElementById('pilotBaseFilter');

const assignLog = document.getElementById('assignLog');
const sessionInfo = document.getElementById('sessionInfo');
const signedUser = document.getElementById('signedUser');

const filterAirline = document.getElementById('filterAirline');
const filterHub = document.getElementById('filterHub');
const routesList = document.getElementById('routesList');
const refreshRoutes = document.getElementById('refreshRoutes');

const filterFleetAirline = document.getElementById('filterFleetAirline');
const filterFleetStatus = document.getElementById('filterFleetStatus');
const fleetList = document.getElementById('fleetList');
const refreshFleet = document.getElementById('refreshFleet');

/* Gate refs */
const gate = document.getElementById('gate');
const rolePilotBtn = document.getElementById('rolePilot');
const roleAdminBtn = document.getElementById('roleAdmin');
const loginPilotBlock = document.getElementById('loginPilot');
const loginAdminBlock = document.getElementById('loginAdmin');
const loginCall = document.getElementById('loginCall');
const loginPass = document.getElementById('loginPass');
const btnLoginPilot = document.getElementById('btnLoginPilot');
const btnLoginAdmin = document.getElementById('btnLoginAdmin');
const btnBackToPilot = document.getElementById('btnBackToPilot');

/* ================= RENDER HELPERS ================= */
function renderTabs(){
  tabs.forEach(t=>t.addEventListener('click', ()=> {
    tabs.forEach(b=>b.classList.remove('active'));
    t.classList.add('active');
    const key = t.getAttribute('data-tab');
    secGenerate.classList.toggle('active', key==='generate');
    secRoutes.classList.toggle('active', key==='routes');
    secFleet.classList.toggle('active', key==='fleet');
  }));
}
const DURATIONS = [
  {label:"1–2ч",min:60,max:120},
  {label:"3–4ч",min:180,max:240},
  {label:"5–6ч",min:300,max:360},
  {label:"7–8ч",min:420,max:480}
];
let chosenAirIndex = null, chosenDur = null, lastReservation = null;

function renderDurations(){
  durationsWrap.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const b = document.createElement('button'); b.className='tab-btn'; b.textContent=d.label;
    b.style.borderRadius='10px'; b.addEventListener('click', ()=>{ chosenDur = i; Array.from(durationsWrap.children).forEach((n,idx)=> n.classList.toggle('active', idx===i)); });
    durationsWrap.appendChild(b);
  });
}
function renderAirlines(){
  airlinesWrap.innerHTML='';
  AIRLINES.forEach((a,idx)=>{
    const b = document.createElement('button'); b.className='tab-btn'; b.textContent = a.name;
    b.style.borderRadius='10px';
    b.addEventListener('click', ()=> { chosenAirIndex = idx; Array.from(airlinesWrap.children).forEach((n,i)=> n.classList.toggle('active', i===idx)); });
    airlinesWrap.appendChild(b);
  });
}

/* Pilots list */
function renderBaseFilter(){
  const bases = Array.from(new Set(PILOTS.map(p=>p.baseICAO).filter(Boolean)));
  pilotBaseFilter.innerHTML = '<option value="all">Все базы</option>';
  bases.forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; pilotBaseFilter.appendChild(o); });
}
function renderPilots(){
  pilotList.innerHTML='';
  const q = (pilotSearch.value||'').trim().toLowerCase();
  const base = pilotBaseFilter.value;
  const list = PILOTS.filter(p=>{
    if(q){ const s=(p.name+' '+p.callSign).toLowerCase(); if(!s.includes(q)) return false; }
    if(base !== 'all' && base) if(p.baseICAO !== base) return false;
    return true;
  });
  pilotEmpty.style.display = list.length ? 'none' : 'block';
  list.forEach(p=>{
    const row = document.createElement('div'); row.className='item';
    row.innerHTML = `<div><strong>${esc(p.name)}</strong><div class="meta">${esc(p.callSign)} · ${esc(p.rank||'—')} · ${esc(p.baseICAO||'—')}</div></div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
    const signBtn = document.createElement('button'); signBtn.className='btn btn-ghost'; signBtn.textContent = (SESSION.pilotId===p.id)?'Вы вошли':'Войти';
    signBtn.disabled = (SESSION.pilotId===p.id);
    signBtn.addEventListener('click', ()=> signInAsPilot(p.id));
    right.appendChild(signBtn);
    if(SESSION.isAdmin){
      const vbtn = document.createElement('button'); vbtn.className='btn btn-ghost'; vbtn.textContent = p.verified ? 'Unverify' : 'Verify';
      vbtn.addEventListener('click', ()=> { p.verified = !p.verified; renderPilots(); });
      right.appendChild(vbtn);
    }
    row.appendChild(right);
    pilotList.appendChild(row);
  });
}

/* Routes */
function renderFilterOptions(){
  filterAirline.innerHTML = '<option value="all">Все авиакомпании</option>';
  filterFleetAirline.innerHTML = '<option value="all">Все авиакомпании</option>';
  AIRLINES.forEach(a=>{
    const o = document.createElement('option'); o.value = a.name; o.textContent = a.name; filterAirline.appendChild(o);
    const o2 = document.createElement('option'); o2.value = a.name; o2.textContent = a.name; filterFleetAirline.appendChild(o2);
  });
  const hubs = Array.from(new Set(AIRLINES.flatMap(a=>a.hubs)));
  filterHub.innerHTML = '<option value="all">Все хабы</option>';
  hubs.forEach(h=>{ const o=document.createElement('option'); o.value=h; o.textContent=h; filterHub.appendChild(o); });
}
function renderRoutes(){
  routesList.innerHTML='';
  const fa = filterAirline.value; const fh = filterHub.value;
  const list = ROUTES.filter(r=> { if(fa!=='all' && fa && r.airline !== fa) return false; if(fh!=='all' && fh && r.fromICAO!==fh && r.toICAO!==fh) return false; return true; });
  if(!list.length){ routesList.innerHTML = '<div class="kv">Нет направлений</div>'; return; }
  list.forEach(r=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div><strong>${esc(r.airline)}</strong><div class="meta">${esc(r.fromICAO)} (${esc(r.fromCity)}) → ${esc(r.toICAO)} (${esc(r.toCity)}) · ${r.durationMinutes} мин</div></div>`;
    routesList.appendChild(it);
  });
}

/* Fleet */
function renderFleet(){
  fleetList.innerHTML='';
  const fa = filterFleetAirline.value; const fs = filterFleetStatus.value;
  const list = FLEET.filter(a=> { if(fa!=='all' && fa && a.airline !== fa) return false; if(fs!=='all' && fs && a.status !== fs) return false; return true; });
  if(!list.length){ fleetList.innerHTML = '<div class="kv">Нет самолётов</div>'; return; }
  list.forEach(a=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div><strong>${esc(a.id)}</strong><div class="meta">${esc(a.airline)} · ${esc(a.type)} · ${a.seats} кресел · ${esc(a.locationICAO)}</div></div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
    const status = document.createElement('div'); status.className='badge';
    if(a.status==='idle'){ status.classList.add('status-idle'); status.textContent='idle'; }
    else if(a.status==='inFlight'){ status.classList.add('status-inflight'); status.textContent='inFlight'; }
    else { status.classList.add('status-reserved'); status.textContent='reserved'; }
    right.appendChild(status);
    it.appendChild(right);
    fleetList.appendChild(it);
  });
}

/* Assign log */
function renderAssignLog(){
  assignLog.innerHTML = '';
  if(!FLEET_LOG.length){ assignLog.innerHTML = '<div class="kv">Пока пусто</div>'; return; }
  FLEET_LOG.slice(-50).reverse().forEach(e=>{
    const it = document.createElement('div'); it.className='item';
    it.innerHTML = `<div><div class="meta">${new Date(e.ts).toLocaleString()}</div><div style="margin-top:6px">${esc(e.event)} ${esc(e.aircraft||'')} ${esc(e.route||'')}</div></div>`;
    assignLog.appendChild(it);
  });
}

/* ================= Reservation / Confirmation ================= */
function reserveAircraft(ac, ownerId, ttlMs = 120*1000){
  if(ac.status === 'inFlight') return { ok:false, reason:'inflight' };
  if(ac.status === 'reserved') return { ok:false, reason:'already_reserved' };
  ac.status = 'reserved'; ac.reservedBy = ownerId;
  ac.reservedToken = ownerId + ':' + Date.now() + ':' + Math.random().toString(36).slice(2,8);
  ac.reservedUntil = nowMs() + ttlMs;
  FLEET_LOG.push({ ts: nowMs(), event:'reserved', aircraft: ac.id });
  renderAssignLog(); renderFleet();
  return { ok:true, token: ac.reservedToken };
}
function cancelReservationByToken(token){
  const ac = FLEET.find(a=>a.reservedToken === token);
  if(!ac) return false;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil; ac.status = 'idle';
  FLEET_LOG.push({ ts: nowMs(), event:'reservation_expired', aircraft: ac.id });
  renderAssignLog(); renderFleet();
  return true;
}
function confirmReservation(token, route, pilotId){
  const ac = FLEET.find(a=>a.reservedToken === token);
  if(!ac) return { ok:false, reason:'no_reservation' };
  if(ac.reservedToken !== token) return { ok:false, reason:'token_mismatch' };

  if(!SESSION.isAdmin){
    const effectivePilotId = pilotId || SESSION.pilotId;
    if(!effectivePilotId) return { ok:false, reason:'no_pilot_assigned' };
    const p = PILOTS.find(x=>x.id===effectivePilotId);
    if(!(p && p.verified === true)) return { ok:false, reason:'pilot_not_verified' };
    pilotId = effectivePilotId;
  }

  const now = nowMs(); const durationMs = (Number(route.durationMinutes) || 120) * 60 * 1000;
  ac.status = 'inFlight'; ac.availableAt = now + durationMs + (ac.turnaround||0)*60*1000; ac.nextLocation = route.toICAO;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
  FLEET_LOG.push({ ts: now, event:'assign_confirmed', aircraft: ac.id, route: `${route.fromICAO}->${route.toICAO}`, durationMin: route.durationMinutes });
  renderAssignLog(); renderFleet();

  if(pilotId) recordPilotAssignment(pilotId, ac.id, route);

  // create "current flight" object and persist locally for this pilot
  const current = {
    flightId: uid('flt'),
    aircraftId: ac.id,
    airline: ac.airline,
    route,
    pilotId,
    confirmedAt: now,
    etaMs: durationMs
  };
  persistCurrentFlight(pilotId, current);
  renderCurrentFlight(); // show current flight to user
  renderConfirmedFlight(ac, route, pilotId);
  return { ok:true, aircraft: ac };
}

/* generateFlight */
function canCreateFlight(){ if(SESSION.isAdmin) return true; if(!SESSION.pilotId) return false; const p = PILOTS.find(x=>x.id===SESSION.pilotId); return !!(p && p.verified === true); }
function generateFlight(){
  if(!canCreateFlight()){ alert('Только верифицированный пилот или админ может создать рейс.'); return; }
  if(chosenAirIndex===null){ alert('Выберите авиакомпанию'); return; }
  let pool = ROUTES.filter(r=> r.airline.toLowerCase() === AIRLINES[chosenAirIndex].name.toLowerCase());
  if(pool.length === 0){
    const hubs = AIRLINES[chosenAirIndex].hubs.map(h=>h.toUpperCase());
    pool = ROUTES.filter(r => hubs.includes((r.fromICAO||'').toUpperCase()));
  }
  if(pool.length===0){ resultArea.style.display='block'; resultArea.innerHTML = `<div class="kv">Нет маршрутов</div>`; return; }
  if(typeof chosenDur === 'number'){
    const interval = DURATIONS[chosenDur];
    const filtered = pool.filter(r => Number.isFinite(r.durationMinutes) && r.durationMinutes >= interval.min && r.durationMinutes <= interval.max);
    if(filtered.length>0) pool = filtered;
  }
  const route = pool[Math.floor(Math.random()*pool.length)];
  let candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle' && ac.airline && ac.airline.toLowerCase() === AIRLINES[chosenAirIndex].name.toLowerCase());
  if(candidates.length === 0) candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle');
  if(candidates.length === 0){ resultArea.style.display='block'; resultArea.innerHTML = `<div class="kv">Нет idle самолётов в хабе ${esc(route.fromICAO)}</div>`; return; }
  candidates.sort((a,b)=> Math.abs(a.seats - 180) - Math.abs(b.seats - 180));
  const candidate = candidates[0];
  const res = reserveAircraft(candidate, SESSION.pilotId || 'user_anonymous');
  if(!res.ok){ alert('Не удалось зарезервировать: ' + res.reason); return; }
  lastReservation = { route, aircraftId: candidate.id, token: res.token, reservedAt: nowMs() };
  renderReservationCard(lastReservation);
}

/* reservation card */
function renderReservationCard(gen){
  if(!gen){ resultArea.style.display='none'; resultArea.innerHTML=''; return; }
  const ac = FLEET.find(a=>a.id===gen.aircraftId);
  const route = gen.route;
  resultArea.style.display='block';
  let pilotOptions = '<option value="">Не назначать</option>';
  if(SESSION.isAdmin){
    PILOTS.forEach(p => pilotOptions += `<option value="${p.id}">${esc(p.name)} (${esc(p.callSign)}) ${p.verified===true? '· Verified':''}</option>`);
  } else {
    if(SESSION.pilotId){
      const p = PILOTS.find(x=>x.id===SESSION.pilotId);
      if(p) pilotOptions += `<option value="${p.id}">${esc(p.name)} (${esc(p.callSign)})</option>`;
    }
  }
  resultArea.innerHTML = `
    <div class="item" style="align-items:center">
      <div>
        <div style="font-weight:900">Резерв создан</div>
        <div class="meta">${esc(ac.id)} · ${esc(ac.airline)} — ${esc(route.fromICAO)}→${esc(route.toICAO)} · ${route.durationMinutes} мин</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="selectPilot" class="input" style="min-width:180px">${pilotOptions}</select>
        <button id="confirmReserveBtn" class="btn btn-primary">Подтвердить</button>
        <button id="cancelReserveBtn" class="btn btn-ghost">Отменить</button>
      </div>
    </div>
  `;
  document.getElementById('confirmReserveBtn').addEventListener('click', ()=>{
    const selected = document.getElementById('selectPilot').value || null;
    const res = confirmReservation(gen.token, gen.route, selected);
    if(!res.ok){
      if(res.reason === 'pilot_not_verified') alert('Пилот не верифицирован.');
      else if(res.reason === 'no_pilot_assigned') alert('Нужен назначенный пилот.');
      else alert('Не удалось подтвердить: ' + res.reason);
    } else { lastReservation = null; renderReservationCard(null); }
  });
  document.getElementById('cancelReserveBtn').addEventListener('click', ()=>{
    cancelReservationByToken(gen.token); lastReservation = null; renderReservationCard(null);
  });
}

/* confirmed flight UI */
function renderConfirmedFlight(ac, route, pilotId){
  const pilot = pilotId ? PILOTS.find(p=>p.id===pilotId) : null;
  const flightMs = (Number(route.durationMinutes)||120) * 60 * 1000;
  const eta = new Date(Date.now() + flightMs).toLocaleString();
  const card = document.createElement('div'); card.className='item';
  card.innerHTML = `
    <div>
      <div style="font-weight:900;color:var(--ok)">Рейс подтверждён</div>
      <div class="meta">${esc(ac.id)} · ${esc(ac.airline)} · ${esc(route.fromICAO)}→${esc(route.toICAO)}</div>
      <div class="meta" style="margin-top:6px">ETA: ${esc(eta)}</div>
    </div>
  `;
  confirmedSection.innerHTML = ''; confirmedSection.appendChild(card);
}

/* ================= Current flight persistence (per-user) ================= */
function persistCurrentFlight(pilotId, current){
  try{ localStorage.setItem(getCurrentFlightKey(pilotId), JSON.stringify(current)); }catch(e){}
}
function clearCurrentFlight(pilotId){ try{ localStorage.removeItem(getCurrentFlightKey(pilotId)); }catch(e){} }
function loadCurrentFlight(pilotId){
  try{ const raw = localStorage.getItem(getCurrentFlightKey(pilotId)); return raw ? JSON.parse(raw) : null; }catch(e){ return null; }
}
function renderCurrentFlight(){
  currentFlightWrap.innerHTML = '';
  if(!SESSION.pilotId) return;
  const cur = loadCurrentFlight(SESSION.pilotId);
  if(!cur){ return; }
  const el = document.createElement('div'); el.className='current-flight';
  const etaDate = new Date(cur.confirmedAt + (cur.etaMs||0));
  el.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:900">Текущий рейс</div>
        <div class="meta">${esc(cur.airline)} · ${esc(cur.route.fromICAO)}→${esc(cur.route.toICAO)}</div>
      </div>
      <div class="meta">ETA: ${esc(etaDate.toLocaleString())}</div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <button id="btnMarkArrived" class="btn btn-primary">Отметить долетел</button>
      <button id="btnClearFlight" class="btn btn-ghost">Удалить запись</button>
    </div>
  `;
  currentFlightWrap.appendChild(el);
  document.getElementById('btnMarkArrived').addEventListener('click', ()=>{
    // user marks arrived: remove local storage entry
    if(!confirm('Отметить рейс как завершённый?')) return;
    // optionally record in logs
    FLEET_LOG.push({ ts: nowMs(), event: 'pilot_arrived', aircraft: cur.aircraftId, route: `${cur.route.fromICAO}->${cur.route.toICAO}`, pilotId: cur.pilotId });
    clearCurrentFlight(SESSION.pilotId);
    renderAssignLog(); renderCurrentFlight(); alert('Рейс отмечен как завершённый у вас в браузере');
  });
  document.getElementById('btnClearFlight').addEventListener('click', ()=>{
    if(!confirm('Удалить текущую запись рейса?')) return;
    clearCurrentFlight(SESSION.pilotId);
    renderCurrentFlight();
  });
}

/* Record pilot assignment (log) */
function recordPilotAssignment(pilotId, aircraftId, route){
  FLEET_LOG.push({ ts: nowMs(), event:'pilot_assigned', pilotId, aircraft: aircraftId, route: `${route.fromICAO}->${route.toICAO}` });
  renderAssignLog();
}

/* background expiry for reservations / flights */
setInterval(()=>{
  const now = nowMs();
  let changed=false;
  FLEET.forEach(ac=>{
    if(ac.status === 'reserved' && ac.reservedUntil && ac.reservedUntil <= now){
      ac.status = 'idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
      FLEET_LOG.push({ ts: now, event:'reservation_expired', aircraft: ac.id }); changed=true;
    }
    if(ac.status === 'inFlight' && ac.availableAt && ac.availableAt <= now){
      ac.status = 'idle'; if(ac.nextLocation) ac.locationICAO = ac.nextLocation; delete ac.availableAt; delete ac.nextLocation;
      FLEET_LOG.push({ ts: now, event:'available', aircraft: ac.id, location: ac.locationICAO }); changed=true;
    }
  });
  if(changed){ renderAssignLog(); renderFleet(); renderPilots(); }
}, 1500);

/* ================= Gate (auth) ================= */
/* ====== Robust Gate bindings (replaces previous fragile handlers) ====== */
(function setupGateHandlers(){
  try {
    // safe refs (may be null if DOM changed)
    const rolePilotBtn = document.getElementById('rolePilot');
    const roleAdminBtn = document.getElementById('roleAdmin');
    const loginPilotBlock = document.getElementById('loginPilot');
    const loginAdminBlock = document.getElementById('loginAdmin');
    const loginCall = document.getElementById('loginCall');
    const loginPass = document.getElementById('loginPass');
    const btnLoginPilot = document.getElementById('btnLoginPilot');
    const btnLoginAdmin = document.getElementById('btnLoginAdmin');
    const btnBackToPilot = document.getElementById('btnBackToPilot');

    function safeAdd(el, ev, fn){
      if(!el) return console.warn('Gate: missing element for', ev);
      el.addEventListener(ev, fn);
    }

    safeAdd(rolePilotBtn, 'click', ()=> {
      rolePilotBtn.classList && rolePilotBtn.classList.add('active');
      roleAdminBtn && roleAdminBtn.classList.remove('active');
      if(loginPilotBlock) loginPilotBlock.style.display = 'block';
      if(loginAdminBlock) loginAdminBlock.style.display = 'none';
    });

    safeAdd(roleAdminBtn, 'click', ()=> {
      roleAdminBtn.classList && roleAdminBtn.classList.add('active');
      rolePilotBtn && rolePilotBtn.classList.remove('active');
      if(loginAdminBlock) loginAdminBlock.style.display = 'block';
      if(loginPilotBlock) loginPilotBlock.style.display = 'none';
    });

    safeAdd(btnLoginPilot, 'click', ()=>{
      try{
        const cs = (loginCall && loginCall.value || '').trim();
        const pass = (loginPass && loginPass.value || '').trim();
        if(!cs){ alert('Введите позывной'); return; }
        const p = PILOTS.find(x=> (x.callSign||'').toLowerCase() === cs.toLowerCase());
        if(!p){ alert('Пилот не найден. Регистрация отключена.'); return; }
        const pilotPassword = p.password || '';
        if(pass === CODEWORD || (pilotPassword && pass === pilotPassword)){
          SESSION.pilotId = p.id; SESSION.isAdmin = false; saveSession(); renderSessionInfo(); renderPilots(); renderFleet(); renderRoutes(); renderCurrentFlight();
          gate.style.display = 'none';
          return;
        }
        alert('Неверный пароль или кодовое слово');
      }catch(err){
        console.error('Gate pilot login handler error', err);
        alert('Ошибка при входе. Откройте консоль для деталей.');
      }
    });

    safeAdd(btnLoginAdmin, 'click', ()=>{
      try{
        const user = (document.getElementById('adminUser') && document.getElementById('adminUser').value || '').trim();
        const pass = (document.getElementById('adminPass') && document.getElementById('adminPass').value || '').trim();
        if(user === 'admin' && pass === 'admin123'){
          SESSION.pilotId = null; SESSION.isAdmin = true; saveSession(); renderSessionInfo(); renderPilots(); renderFleet(); renderRoutes();
          gate.style.display = 'none';
        } else alert('Неверные учётные данные');
      }catch(err){
        console.error('Gate admin login handler error', err);
        alert('Ошибка при входе админа. Откройте консоль для деталей.');
      }
    });

    safeAdd(btnBackToPilot, 'click', ()=> { rolePilotBtn && rolePilotBtn.click(); });

    // ensure gate visible on load (your requirement) but do not lock UI by throwing errors
    gate.style.display = 'flex';
  } catch(e){
    console.error('setupGateHandlers fatal', e);
    // keep gate visible so user can still attempt manual actions
    try { gate.style.display = 'flex'; }catch(_){}
  }
})();

btnLoginAdmin.addEventListener('click', ()=>{
  const user = (document.getElementById('adminUser').value||'').trim(); const pass = (document.getElementById('adminPass').value||'').trim();
  if(user === 'admin' && pass === 'admin123'){
    SESSION.pilotId = null; SESSION.isAdmin = true; saveSession(); renderSessionInfo(); renderPilots(); renderFleet(); renderRoutes(); gate.style.display = 'none';
  } else alert('Неверные учётные данные');
});
btnBackToPilot && btnBackToPilot.addEventListener('click', ()=>{ rolePilotBtn.click(); });

/* ================= Init UI bindings ================= */
function initUI(){
  renderTabs();
  renderDurations();
  renderAirlines();
  renderBaseFilter();
  renderPilots();
  renderFilterOptions();
  renderRoutes();
  renderFleet();
  renderAssignLog();
  renderCurrentFlight();
  // always show gate on load per request:
  gate.style.display = 'flex';
  // handlers
  btnGen.addEventListener('click', ()=>{ if(lastReservation && lastReservation.token){ if(!confirm('У вас есть активный резерв. Создать новый?')) return; cancelReservationByToken(lastReservation.token); lastReservation=null; renderReservationCard(null); } generateFlight(); });
  btnDemo.addEventListener('click', ()=>{ const idx = AIRLINES.findIndex(a=>a.name==='SunExpress'); if(idx>=0) chosenAirIndex = idx; generateFlight(); });
  btnReset.addEventListener('click', ()=>{ chosenAirIndex=null; chosenDur=null; resultArea.innerHTML=''; resultArea.style.display='none'; confirmedSection.innerHTML=''; lastReservation=null; });
  pilotSearch.addEventListener('input', renderPilots);
  pilotBaseFilter.addEventListener('change', renderPilots);
  filterAirline.addEventListener('change', renderRoutes);
  filterHub.addEventListener('change', renderRoutes);
  refreshRoutes.addEventListener('click', renderRoutes);
  filterFleetAirline.addEventListener('change', renderFleet);
  filterFleetStatus.addEventListener('change', renderFleet);
  refreshFleet.addEventListener('click', renderFleet);
}
initUI();

/* Expose debug */
window._demo = { PILOTS, ROUTES, AIRLINES, FLEET, CODEWORD, renderCurrentFlight };
</script>
</body>
</html>

