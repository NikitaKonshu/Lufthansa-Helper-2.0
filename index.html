<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lufthansa Helper — Liquid Glass Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#041026; --bg-2:#06263a; --text:#eaf4ff; --muted:rgba(234,244,255,0.72);
  --accent:#ffd54a; --accent2:#ffbf3a; --brand:#1E6FFF; --glass-border:rgba(255,255,255,0.10);
  --panel-1:rgba(255,255,255,0.08); --panel-2:rgba(6,14,24,0.94); --panel-3:rgba(8,18,30,0.98);
  --glow-strong:0 30px 140px rgba(255,180,60,0.12), inset 0 1px 0 rgba(255,255,255,0.04);
  --shadow-deep:0 64px 200px rgba(2,8,18,0.66);
  --shadow-card:0 28px 80px rgba(0,0,0,0.55);
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  font-size:15px;
}

/* ---------- Global ---------- */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  min-height:100vh;
  color:var(--text);
  background:
    radial-gradient(900px 600px at 10% 10%, rgba(10,30,60,0.32), transparent 35%),
    radial-gradient(700px 500px at 90% 0%, rgba(5,20,40,0.28), transparent 30%),
    linear-gradient(160deg,var(--bg-1),var(--bg-2));
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  padding:20px;
}

/* Nice entrance keyframes */
@keyframes popIn {
  from { transform: translateY(6px) scale(.996); opacity:0 }
  60% { transform: translateY(-4px) scale(1.01); opacity:1 }
  to { transform: translateY(0) scale(1) }
}
@keyframes glowPulse {
  0% { box-shadow: 0 8px 28px rgba(0,0,0,0.32) }
  50% { box-shadow: 0 26px 80px rgba(0,0,0,0.42) }
  100% { box-shadow: 0 8px 28px rgba(0,0,0,0.32) }
}

/* ---------- Splash ---------- */
.splash{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:16000;
  background:linear-gradient(180deg, rgba(0,6,18,0.96), rgba(2,14,30,0.99)); transition:opacity .52s, transform .52s}
.splash.hidden{opacity:0; transform:translateY(-8px) scale(.998); pointer-events:none}
.splash-center{text-align:center;z-index:2}
.splash-center h2{font-size:28px;letter-spacing:.2px;margin-bottom:8px}
.splash-center .subtitle{opacity:.88;margin-bottom:14px}

/* ---------- Modals ---------- */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.56);z-index:18000;padding:20px;transition:opacity .22s, transform .22s}
.modal.show{display:flex;opacity:1;transform:none}
.modal-card{
  width:min(720px,94%);border-radius:16px;padding:22px;
  background:linear-gradient(180deg,var(--panel-1),var(--panel-3));
  border:1px solid var(--glass-border);
  box-shadow:var(--glow-strong), var(--shadow-deep);
  backdrop-filter:blur(14px) saturate(170%);
  animation:popIn .28s cubic-bezier(.2,.9,.2,1);
}

/* ---------- Shell ---------- */
.shell{max-width:1280px;margin:24px auto;border-radius:18px;overflow:hidden;
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.06));
  border:1px solid var(--glass-border); box-shadow:var(--shadow-deep);}

/* panel glow helper */
.panel{
  padding:18px;border-radius:14px;margin-top:14px;
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.06));
  border:1px solid rgba(255,255,255,0.04);
  position:relative; overflow:visible; transition:transform .28s, box-shadow .28s;
}
.panel::after{
  content:""; position:absolute; inset:auto -18px -18px -18px; border-radius:18px; pointer-events:none;
  box-shadow:0 28px 120px rgba(0,0,0,0.46), 0 12px 40px rgba(0,0,0,0.32);
  opacity:.06;
}

/* ---------- Topbar & Tabs ---------- */
.topbar{
  display:flex;align-items:center;justify-content:space-between;padding:16px 18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
  border-bottom:1px solid rgba(255,255,255,0.02); position:sticky;top:0;z-index:30;
}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:68px;height:68px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);background:linear-gradient(180deg,#072a36,#041822);box-shadow:0 18px 60px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.03)}
.title{font-weight:900;font-size:18px}
.subtitle{font-size:13px;color:var(--muted)}
.session{display:flex;align-items:center;gap:10px}
.tabs{display:flex;gap:8px;align-items:center;position:relative}
.tab{
  padding:12px 16px;border-radius:14px;font-weight:800;cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);
  transition:transform .22s, box-shadow .22s, background .22s;
  transform-origin:center;
}
.tab:hover{ transform:translateY(-4px); box-shadow:0 18px 60px rgba(0,0,0,0.48) }
.tab.active{ background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#06141e; transform:translateY(-6px) scale(1.02); box-shadow:0 40px 140px rgba(255,170,40,0.14) }
.underline{position:absolute;bottom:-10px;height:10px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 22px 80px rgba(255,170,40,0.12);transition:left .24s, width .24s, opacity .24s;opacity:0}

/* ---------- Pages ---------- */
.pagewrap{padding:20px}
.page{display:none;opacity:0;transform:translateY(18px) scale(.996);transition:opacity .42s cubic-bezier(.2,.9,.2,1),transform .42s cubic-bezier(.2,.9,.2,1)}
.page.active{display:block}
.page.enter{opacity:1;transform:translateY(0) scale(1)}

/* animated entry for lists */
.list{max-height:640px;overflow:auto;margin-top:12px;padding-right:6px}
.grid{display:grid;grid-template-columns:1fr 460px;gap:18px;margin-top:18px}

/* ---------- Airline grid ---------- */
.airline-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;padding:12px;border-radius:14px}
.airline{
  display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.025), rgba(0,0,0,0.04));
  border:1px solid rgba(255,255,255,0.03); transition:transform .22s, box-shadow .22s;
}
.airline:hover{transform:translateY(-6px);box-shadow:0 36px 120px rgba(0,0,0,0.48)}
.airline.selected{outline:2px solid rgba(255,210,70,0.48);box-shadow:0 50px 150px rgba(255,180,60,0.18)}
.led{position:absolute;right:12px;top:12px;width:12px;height:12px;border-radius:50%;background:linear-gradient(180deg,var(--accent),var(--accent2));box-shadow:0 0 28px rgba(255,180,60,0.65)}

/* ---------- Pills ---------- */
.time-pills{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.pill{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));font-weight:800;cursor:pointer;transition:transform .18s, box-shadow .18s}
.pill:hover{transform:translateY(-3px)}
.pill.active{outline:2px solid rgba(255,210,70,0.45);box-shadow:0 26px 76px rgba(255,180,60,0.14)}

/* ---------- Buttons ---------- */
.btn{position:relative;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));color:var(--text);font-weight:800;cursor:pointer;transition:transform .18s, box-shadow .18s, filter .12s}
.btn:hover{transform:translateY(-3px)}
.btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#06141e;box-shadow:0 30px 120px rgba(255,170,40,0.16);border-color:rgba(0,0,0,0.04)}

/* prevent infinite animations in lists (explicitly none) */
.airline, .panel, .list, .grid, .airline-grid, #routesList > div, #fleetList > div { animation: none !important; }

/* responsive */
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
  .airline-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
  .logo{width:52px;height:52px}
}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash" class="splash" aria-modal="true">
  <div class="splash-center">
    <h2>Welcome to Lufthansa Group</h2>
    <div class="subtitle">Демо интерфейс</div>
    <button id="splashContinue" class="btn btn-primary">Дальше</button>
  </div>
</div>

<!-- Gate modal -->
<div id="gateModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div style="font-weight:900">Вход в систему</div>
    <div class="subtitle" style="margin-top:8px">Введите позывной и пароль. Кодовое слово: <strong>quickaccess2025</strong></div>
    <div style="margin-top:10px"><input id="loginCall" class="search" placeholder="Позывной (callSign)"></div>
    <div style="margin-top:8px"><input id="loginPass" class="search" type="password" placeholder="Пароль или кодовое слово"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="btnLogin" class="btn btn-primary">Войти</button>
    </div>
  </div>
</div>

<!-- Confirm modal (same) -->
<div id="confirmModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div style="font-weight:900">Подтвердить рейс</div>
    <div id="confirmDetails" class="subtitle" style="margin-top:8px"></div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="btn">Отменить</button>
      <button id="confirmAccept" class="btn btn-primary">Подтвердить</button>
    </div>
  </div>
</div>

<!-- Shell -->
<div class="shell">
  <div class="topbar">
    <div class="brand">
      <div class="logo">LH</div>
      <div>
        <div class="title">Lufthansa Helper</div>
        <div class="subtitle">liquid glass · tactile · demo</div>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-page="home">Главная</div>
      <div class="tab" data-page="routes">Направления</div>
      <div class="tab" data-page="fleet">Флот</div>
      <div class="tab" data-page="pilots">Пилоты</div>
      <div class="tab" data-page="confirmed">Подтверждение рейса</div>
      <div class="underline" id="underline"></div>
    </div>

    <div class="session">
      <div id="sessionBadge" class="subtitle">Неавторизован</div>
      <button id="openGateBtn" class="btn">Вход</button>
      <button id="logoutBtn" class="btn" style="display:none">Выйти</button>
    </div>
  </div>

  <div class="pagewrap">
    <!-- Home -->
    <section id="page-home" class="page active enter">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Фильтры</div>
          <div class="subtitle">Выбор авиакомпании и интервала времени</div>
        </div>
        <div class="controls" style="margin-top:12px">
          <input id="airSearch" class="search" placeholder="Поиск авиакомпании или кода">
          <button id="genBtn" class="btn btn-primary">СГЕНЕРИРОВАТЬ</button>
        </div>
        <div id="durations" class="time-pills"></div>
        <div id="airGrid" class="airline-grid"></div>
      </div>

      <div class="panel" id="inlineTour" aria-hidden="true" style="margin-top:14px;display:none;opacity:0;transform:translateY(8px);transition:opacity .26s, transform .26s">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Краткая инструкция</div>
          <div class="subtitle">Появляется после входа</div>
        </div>
        <div class="subtitle" style="margin-top:10px">
          1) Введите позывной и пароль; 2) Выберите авиакомпанию и интервал времени; 3) Нажмите «СГЕНЕРИРОВАТЬ»; 4) Подтвердите рейс.
        </div>
      </div>
    </section>

    <!-- Routes -->
    <section id="page-routes" class="page">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Направления</div>
          <div class="subtitle">Список доступных маршрутов</div>
        </div>
        <div id="routesList" class="list"></div>
      </div>
    </section>

    <!-- Fleet -->
    <section id="page-fleet" class="page">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Флот</div>
          <div class="subtitle">Самолёты и статус</div>
        </div>
        <div id="fleetList" class="list"></div>
      </div>
    </section>

    <!-- Pilots -->
    <section id="page-pilots" class="page">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Пилоты</div>
          <div class="subtitle">Demo</div>
        </div>
        <div id="pilotList" class="list"></div>
      </div>
    </section>

    <!-- Confirmed (replaces journal) -->
    <section id="page-confirmed" class="page">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:900">Подтверждённые рейсы</div>
          <div class="subtitle">Текущий и недавно подтверждённые рейсы</div>
        </div>
        <div id="confirmedList" class="list"></div>
      </div>
    </section>
  </div>
</div>

<script>
/* ===== Data & state ===== */
const CODEWORD = 'quickaccess2025';
const DURATIONS = [
  {label:"1–2ч",min:60,max:120},{label:"2–3ч",min:120,max:180},{label:"3–4ч",min:180,max:240},
  {label:"4–5ч",min:240,max:300},{label:"5–6ч",min:300,max:360},{label:"6–7ч",min:360,max:420},{label:"7–8ч",min:420,max:480}
];
const AIRLINES = [
  {name:"Lufthansa",code:"LH",color:"#1E6FFF"},
  {name:"Lufthansa Cargo",code:"G0",color:"#0A63D6"},
  {name:"Swiss",code:"LX",color:"#D81E5B"},
  {name:"Austrian",code:"OS",color:"#DA291C"},
  {name:"Eurowings",code:"EW",color:"#8A4BFF"},
  {name:"Condor",code:"DE",color:"#FFD200"},
  {name:"Brussels",code:"SN",color:"#003399"},
  {name:"SunExpress",code:"SX",color:"#FF8A3D"}
];

let ROUTES = [];
(function(){
  let seq=100;
  const base=["EDDF","EGLL","LFPG","LEBL","LSZH","KJFK","EHAM","EBBR","LIRF","LOWW","ESSA","EKCH","EDDM"];
  AIRLINES.forEach((a,ai)=>{
    for(let i=0;i<6;i++){
      const from=base[(ai*2+i)%base.length];
      const to=base[(ai*2+i+3)%base.length];
      const dur=80 + (i*30) + (ai*10);
      ROUTES.push({
        id:`${a.code}-${seq++}`, airline:a.name, airlineCode:a.code,
        fromICAO:from, toICAO:to,
        fromCity:'City-'+from, toCity:'City-'+to,
        durationMinutes:dur
      });
    }
  });
})();

let FLEET = [];
(function(){
  AIRLINES.forEach((a,ai)=>{
    const types=["A320","A321","B737","A220","E190"];
    for(let i=1;i<=3;i++){
      FLEET.push({
        id:`${a.code}-AC${String(i).padStart(2,'0')}`,
        airline:a.name, type:types[(ai+i)%types.length],
        locationICAO: i===1 ? "EDDF" : (i===2 ? "EGLL" : "LSZH"),
        status:"idle", fuelMinutes:420 + i*80, turnaround:30 + i*5, reserveMargin:30
      });
    }
  });
})();

let PILOTS = [
  {id:"pilot_ivan",name:"Ivan Petrov",callSign:"IPET",verified:true,password:"ivanpass"},
  {id:"pilot_loui",name:"Loui Desulier",callSign:"FRENCH",verified:true,password:"louiSecret"}
];

let SESSION = {pilotId:null};
let FLEET_LOG = [];
let CURRENT_FLIGHTS = []; // all active/in-progress
let CONFIRMED_FLIGHTS = []; // persisted confirmed flights to show on "Подтверждение рейса"

let chosenAirline = null;
let chosenDurationIdx = null;
let searchQuery = '';
let PENDING_RESERVATION = null;
let appReady = false;

/* ===== DOM ===== */
const splash = document.getElementById('splash');
const splashContinue = document.getElementById('splashContinue');
const gateModal = document.getElementById('gateModal');
const confirmModal = document.getElementById('confirmModal');
const sessionBadge = document.getElementById('sessionBadge');
const airSearch = document.getElementById('airSearch');
const airGrid = document.getElementById('airGrid');
const durationsEl = document.getElementById('durations');
const routesList = document.getElementById('routesList');
const fleetList = document.getElementById('fleetList');
const pilotList = document.getElementById('pilotList');
const confirmedList = document.getElementById('confirmedList');
const tabs = document.getElementById('tabs');
const underline = document.getElementById('underline');

/* ===== Utils ===== */
function nowMs(){ return Date.now(); }
function showModal(el){ el.classList.add('show'); el.style.display='flex'; el.setAttribute('aria-hidden','false'); }
function hideModal(el){ el.classList.remove('show'); el.style.display='none'; el.setAttribute('aria-hidden','true'); }
function pushLog(msg){ FLEET_LOG.unshift({ts:nowMs(), msg}); }

/* ===== Splash ===== */
splashContinue.addEventListener('click', ()=>{
  splash.classList.add('hidden');
  setTimeout(()=>{ splash.style.display='none'; appReady=true; showModal(gateModal); }, 520);
});

/* ===== Login ===== */
document.getElementById('btnLogin').addEventListener('click', ()=>{
  const cs=document.getElementById('loginCall').value.trim();
  const pass=document.getElementById('loginPass').value.trim();
  if(!cs||!pass){ alert('Введите позывной и пароль'); return; }
  const p = PILOTS.find(x=>x.callSign.toLowerCase()===cs.toLowerCase());
  if(pass===CODEWORD || (p && p.password===pass)){
    SESSION.pilotId = p ? p.id : 'guest_'+Date.now();
    renderSession();
    hideModal(gateModal);
    document.getElementById('inlineTour').style.display='block';
    requestAnimationFrame(()=>{ document.getElementById('inlineTour').style.opacity='1'; document.getElementById('inlineTour').style.transform='translateY(0)'; });
  } else { alert('Неверный пароль'); }
});
document.getElementById('openGateBtn').addEventListener('click', ()=>{ if(appReady) showModal(gateModal); });
document.getElementById('logoutBtn').addEventListener('click', ()=>{ SESSION.pilotId=null; renderSession(); showModal(gateModal); });

/* ===== Tabs navigation & robust re-render ===== */
function activatePage(id){
  document.querySelectorAll('.page').forEach(p=>{
    p.classList.remove('active','enter');
    p.style.display='none';
    p.setAttribute('aria-hidden','true');
  });
  const el = document.getElementById('page-'+id);
  if(!el) return;
  el.style.display='block';
  el.setAttribute('aria-hidden','false');
  el.classList.add('active');

  switch(id){
    case 'home': renderDurations(); renderAirlines(); break;
    case 'routes': renderRoutes(); break;
    case 'fleet': renderFleet(); break;
    case 'pilots': renderPilots(); break;
    case 'confirmed': renderConfirmed(); break;
  }
  requestAnimationFrame(()=>{ el.classList.add('enter'); });
}

function placeUnderline(tabEl){
  const parent = tabs.getBoundingClientRect();
  const r = tabEl.getBoundingClientRect();
  underline.style.left = (r.left - parent.left) + 'px';
  underline.style.width = r.width + 'px';
  underline.style.opacity = '1';
}

tabs.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    placeUnderline(tab);
    activatePage(tab.dataset.page);
  }, {passive:true});
});

window.addEventListener('load', ()=>{
  const active = tabs.querySelector('.tab.active') || tabs.querySelector('.tab[data-page="home"]');
  if(active){ placeUnderline(active); activatePage(active.dataset.page); }
});
window.addEventListener('resize', ()=>{ const a=tabs.querySelector('.tab.active'); if(a) placeUnderline(a); });

/* ===== Ripple (tactile) ===== */
function attachRipple(scope=document){
  const els = scope.querySelectorAll('.btn, .airline, .pill');
  els.forEach(el=>{
    if(el._rip) return; el._rip=true;
    el.addEventListener('pointerdown', ev=>{
      let r = el.querySelector('.ripple'); if(!r){ r=document.createElement('span'); r.className='ripple'; el.prepend(r); }
      const rect = el.getBoundingClientRect(); const size = Math.max(rect.width, rect.height)*1.6;
      r.style.width=size+'px'; r.style.height=size+'px';
      r.style.left=(ev.clientX-rect.left-size/2)+'px'; r.style.top=(ev.clientY-rect.top-size/2)+'px';
      r.style.transform='scale(0)'; r.style.opacity='.36';
      requestAnimationFrame(()=>{ r.style.transition='transform 420ms cubic-bezier(.2,.9,.2,1), opacity 360ms'; r.style.transform='scale(1)'; });
      setTimeout(()=> r.style.opacity='0',420);
    }, {passive:true});
  });
}

/* ===== Render durations & airlines ===== */
function renderDurations(){
  durationsEl.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const btn=document.createElement('div'); btn.className='pill'+(chosenDurationIdx===i?' active':''); btn.textContent=d.label;
    btn.addEventListener('click', ()=>{ chosenDurationIdx=(chosenDurationIdx===i?null:i); renderDurations(); renderRoutes(); });
    durationsEl.appendChild(btn);
  });
  attachRipple(durationsEl);
}

function renderAirlines(){
  airGrid.innerHTML='';
  const filtered = AIRLINES.filter(a=>{
    if(!searchQuery) return true;
    const q=searchQuery.toLowerCase(); return a.name.toLowerCase().includes(q)||a.code.toLowerCase().includes(q);
  });
  filtered.forEach(a=>{
    const card=document.createElement('div'); card.className='airline'+(chosenAirline===a.name?' selected':'');
    card.innerHTML = `<div style="width:18px;height:18px;border-radius:50%;background:${a.color}"></div>
      <div><div style="font-weight:900">${a.name}</div><div class="subtitle">${a.code}</div></div>
      <div class="led" aria-hidden="true"></div>`;
    card.addEventListener('click', ()=>{ chosenAirline=(chosenAirline===a.name?null:a.name); renderAirlines(); renderRoutes(); });
    airGrid.appendChild(card);
  });
  attachRipple(airGrid);
}

/* ===== Routes rendering (no infinite animation) ===== */
function renderRoutes(){
  routesList.innerHTML='';
  const list = ROUTES.filter(r=>{
    if(chosenAirline && r.airline!==chosenAirline) return false;
    if(chosenDurationIdx!==null){ const d=DURATIONS[chosenDurationIdx]; if(!(r.durationMinutes>=d.min&&r.durationMinutes<=d.max)) return false; }
    return true;
  });
  if(!list.length){ routesList.innerHTML='<div class="subtitle">Нет направлений по текущим фильтрам</div>'; return; }
  list.forEach(r=>{
    const row=document.createElement('div');
    row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.03));';
    row.innerHTML = `<div><div style="font-weight:900">${r.fromICAO} → ${r.toICAO} · ${r.airlineCode}</div><div class="subtitle">${r.fromCity} → ${r.toCity}</div></div>
      <div style="text-align:right"><div class="subtitle">${r.durationMinutes} мин</div><div style="margin-top:8px"><button class="btn btn-primary" data-id="${r.id}">Выбрать</button></div></div>`;
    routesList.appendChild(row);
  });
  routesList.querySelectorAll('button[data-id]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const r = ROUTES.find(x=>x.id===b.dataset.id);
      if(!SESSION.pilotId){ showModal(gateModal); return; }
      openConfirmFromRoute(r);
    });
  });
  attachRipple(routesList);
}

/* ===== Fleet rendering (no infinite animation) ===== */
function renderFleet(){
  fleetList.innerHTML='';
  FLEET.forEach(f=>{
    const row=document.createElement('div');
    row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.03));';
    row.innerHTML = `<div style="font-weight:900">${f.id}</div><div class="subtitle">${f.airline} · ${f.type} · ${f.fuelMinutes} мин · ${f.locationICAO} · ${f.status}</div>`;
    fleetList.appendChild(row);
  });
}

/* ===== Pilots & confirmed list ===== */
function renderPilots(){
  pilotList.innerHTML='';
  PILOTS.forEach(p=>{
    const row=document.createElement('div');
    row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.03));';
    row.innerHTML = `<div><div style="font-weight:900">${p.name}</div><div class="subtitle">${p.callSign} ${p.verified?'· Verified':''}</div></div><button class="btn">Войти</button>`;
    row.querySelector('button').addEventListener('click', ()=>{ document.getElementById('loginCall').value=p.callSign; document.getElementById('loginPass').value=''; showModal(gateModal); });
    pilotList.appendChild(row);
  });
  attachRipple(pilotList);
}

function renderConfirmed(){
  confirmedList.innerHTML='';
  if(!CONFIRMED_FLIGHTS.length){ confirmedList.innerHTML='<div class="subtitle">Нет подтверждённых рейсов</div>'; return; }
  CONFIRMED_FLIGHTS.forEach(f=>{
    const el=document.createElement('div');
    el.style.cssText='padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.04));';
    el.innerHTML = `<div style="font-weight:900">${f.aircraftId} · ${f.fromICAO} → ${f.toICAO}</div>
      <div class="subtitle">Пилот ${f.pilotCallsign} · ${f.durationMinutes} мин · Подтвержено ${new Date(f.ts).toLocaleString()}</div>`;
    confirmedList.appendChild(el);
  });
}

/* ===== Session UI ===== */
function renderSession(){
  if(SESSION.pilotId){
    const p=PILOTS.find(x=>x.id===SESSION.pilotId);
    sessionBadge.textContent = p ? `Вошёл ${p.callSign}` : 'Вошёл';
    document.getElementById('logoutBtn').style.display='inline-flex';
    document.getElementById('openGateBtn').style.display='none';
  } else {
    sessionBadge.textContent = 'Неавторизован';
    document.getElementById('logoutBtn').style.display='none';
    document.getElementById('openGateBtn').style.display='inline-flex';
  }
}

/* ===== Find candidate aircraft and open confirm ===== */
function findCandidateAircraftForRoute(route){
  const dur = Number(route.durationMinutes)||0;
  const can = ac => ac.status==='idle' && (ac.fuelMinutes >= dur + (ac.reserveMargin||30));
  let cand = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && can(ac));
  if(!cand.length) cand = FLEET.filter(can);
  cand.sort((a,b)=> (b.fuelMinutes||0) - (a.fuelMinutes||0));
  return cand[0]||null;
}

function openConfirmFromRoute(route){
  const p = PILOTS.find(x=>x.id===SESSION.pilotId);
  const candidate = findCandidateAircraftForRoute(route);
  if(!candidate){ alert('Нет подходящих самолётов с запасом топлива'); return; }

  candidate.status='reserved';
  candidate.reservedBy = p.id;
  candidate.reservedToken = p.id+':'+Date.now()+':'+Math.random().toString(36).slice(2,6);
  candidate.reservedUntil = nowMs() + 120000;

  PENDING_RESERVATION = { token:candidate.reservedToken, aircraft:candidate, route, pilotId:p.id, expires:candidate.reservedUntil };

  document.getElementById('confirmDetails').textContent =
    `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${route.durationMinutes} мин · Пилот ${p.callSign}`;
  showModal(confirmModal);
}

/* ===== Confirm accept: now redirects to confirmed page and shows flight ===== */
document.getElementById('confirmAccept').addEventListener('click', ()=>{
  if(!PENDING_RESERVATION){ hideModal(confirmModal); return; }
  const ac = FLEET.find(a=>a.reservedToken===PENDING_RESERVATION.token);
  if(!ac){ alert('Резервация потеряна'); hideModal(confirmModal); return; }
  const p = PILOTS.find(x=>x.id===PENDING_RESERVATION.pilotId);
  if(!(p && p.verified)){ alert('Пилот не верифицирован'); hideModal(confirmModal); return; }

  ac.fuelMinutes = Math.max(0, (ac.fuelMinutes||0) - Number(PENDING_RESERVATION.route.durationMinutes));
  ac.status='inFlight';
  ac.availableAt = nowMs() + (PENDING_RESERVATION.route.durationMinutes||120)*60000 + (ac.turnaround||0)*60000;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;

  const flight = {
    id: 'flt_'+Math.random().toString(36).slice(2,8),
    aircraftId: ac.id, airline: ac.airline,
    fromICAO: PENDING_RESERVATION.route.fromICAO, toICAO: PENDING_RESERVATION.route.toICAO,
    durationMinutes: PENDING_RESERVATION.route.durationMinutes, pilotId: p.id, pilotCallsign: p.callSign, ts: nowMs()
  };
  CURRENT_FLIGHTS.unshift(flight);
  CONFIRMED_FLIGHTS.unshift(flight);
  pushLog(`Рейс подтверждён ${flight.aircraftId} ${flight.fromICAO}->${flight.toICAO} пилот ${flight.pilotCallsign}`);

  PENDING_RESERVATION=null;
  renderFleet(); renderRoutes(); hideModal(confirmModal);

  // Переброс на страницу подтверждений и показать новый рейс
  const tab = tabs.querySelector('.tab[data-page="confirmed"]');
  if(tab){ tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); placeUnderline(tab); }
  activatePage('confirmed');
});

/* ===== Cancel reservation ===== */
document.getElementById('confirmCancel').addEventListener('click', ()=>{
  if(PENDING_RESERVATION){
    const token = PENDING_RESERVATION.token;
    FLEET.forEach(a=>{ if(a.reservedToken===token){ a.status='idle'; delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; } });
    pushLog('Бронь отменена');
    PENDING_RESERVATION=null;
  }
  hideModal(confirmModal); renderFleet();
});

/* ===== Generate button ===== */
document.getElementById('genBtn').addEventListener('click', ()=>{
  if(!SESSION.pilotId){ showModal(gateModal); return; }
  const pool = ROUTES.filter(r=>{
    if(chosenAirline && r.airline!==chosenAirline) return false;
    if(chosenDurationIdx!==null){ const d=DURATIONS[chosenDurationIdx]; if(!(r.durationMinutes>=d.min&&r.durationMinutes<=d.max)) return false; }
    return true;
  });
  if(!pool.length){ alert('Нет маршрутов по текущим фильтрам'); return; }
  const route = pool[Math.floor(Math.random()*pool.length)];
  openConfirmFromRoute(route);
});

/* ===== Search ===== */
airSearch.addEventListener('input', ()=>{ searchQuery = airSearch.value.trim(); renderAirlines(); });

/* ===== Maintenance loop (reservation expiry & returning) ===== */
setInterval(()=>{
  const now=nowMs();
  FLEET.forEach(ac=>{
    if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil<=now){
      ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil; pushLog(`Резервация истекла ${ac.id}`);
    }
    if(ac.status==='inFlight' && ac.availableAt && ac.availableAt<=now){
      ac.status='idle'; delete ac.availableAt; pushLog(`Самолёт вернулся в сервис ${ac.id}`);
    }
  });
  renderFleet();
}, 2000);

/* ===== Init ===== */
function init(){
  renderSession(); renderDurations(); renderAirlines(); renderRoutes(); renderFleet(); renderPilots(); renderConfirmed();
  attachRipple(document);
  // initial page
  activatePage('home');
}
init();
</script>
</body>
</html>
