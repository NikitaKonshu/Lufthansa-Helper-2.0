<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LOT Portal v147</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* === THEME VARIABLES (LOT BLUE & LIGHT) === */
        :root {
            --lh-blue: #05164d; /* Dark Blue similar to LOT branding */
            --lh-gold: #ffb81c; /* Accent color */
            
            --bg-body: #f0f2f5; 
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-blur: blur(20px);
            
            --text-main: #000000;
            --text-sec: #666666;
            --header-bg: rgba(240, 242, 245, 0.9);
            
            --radius-card: 24px;
            --radius-btn: 22px; 
            
            --nav-h: 80px;
            --shadow: 0 4px 25px rgba(0,0,0,0.06);
        }

        /* === GLOBAL RESET === */
        html, body {
            width: 100%; height: 100%;
            overflow-x: hidden; position: relative;
            touch-action: pan-y; margin: 0; padding: 0;
            box-sizing: border-box; -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main);
            padding-top: 0; padding-bottom: 140px; 
        }
        .hidden { display: none !important; }

        /* === BUTTONS & ANIMATIONS === */
        button { font-family: 'Inter', sans-serif; border: none; cursor: pointer; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }

        .btn-primary {
            width: 100%; padding: 18px;
            background: linear-gradient(135deg, var(--lh-gold) 0%, #e6a619 100%);
            color: #000; font-weight: 800; font-size: 1.05rem;
            border-radius: var(--radius-btn);
            box-shadow: 0 4px 15px rgba(255, 184, 28, 0.25);
        }
        .btn-primary:active { transform: scale(0.96); }
        
        .btn-map-action {
            padding: 6px 12px;
            background: var(--lh-blue); color: #fff; border-radius: 6px;
            font-weight: 700; font-size: 0.75rem;
            white-space: nowrap;
        }
        .btn-map-action:active { transform: scale(0.95); }

        .btn-filter {
            background: var(--glass-bg); 
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 8px 16px; border-radius: 20px;
            font-weight: 700; font-size: 0.85rem;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .btn-filter:active { transform: scale(0.95); }

        .btn-float { 
            position: fixed; bottom: 130px; right: 25px; width: 64px; height: 64px; 
            border-radius: 50%; background: var(--lh-blue); color: #fff; 
            box-shadow: 0 15px 40px rgba(5, 22, 77, 0.4); 
            display: flex; align-items: center; justify-content: center; font-size: 1.8rem; z-index: 1800; 
        }
        .btn-float:active { transform: scale(0.9); }

        .segment-control { display: flex; background: rgba(128,128,128,0.1); padding: 5px; border-radius: 18px; margin-bottom: 24px; }
        .seg-btn { flex: 1; padding: 12px; border-radius: 14px; font-weight: 700; color: var(--text-sec); transition: 0.3s; }
        .seg-btn.active { background: var(--glass-bg); color: var(--text-main); box-shadow: 0 2px 10px rgba(0,0,0,0.08); }

        /* === INTRO === */
        #intro { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; transition: opacity 1s ease; }
        .intro-container { position: relative; z-index: 2; text-align: center; }
        .intro-text-main { font-size: 3rem; font-weight: 800; color: #fff; letter-spacing: -2px; opacity: 0; transform: scale(1.1); filter: blur(10px); animation: cinematicReveal 2s ease-out forwards; }
        .intro-text-sub { font-size: 0.9rem; font-weight: 500; color: var(--lh-gold); letter-spacing: 6px; text-transform: uppercase; margin-top: 15px; opacity: 0; transform: translateY(20px); animation: cinematicSub 1.5s ease-out 0.8s forwards; }
        .intro-glow { position: absolute; width: 300px; height: 300px; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); top: 50%; left: 50%; transform: translate(-50%, -50%); pointer-events: none; opacity: 0; animation: glowPulse 3s ease forwards; }
        @keyframes cinematicReveal { to { opacity: 1; transform: scale(1); filter: blur(0); } }
        @keyframes cinematicSub { to { opacity: 1; transform: translateY(0); } }
        @keyframes glowPulse { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        /* === LOADER === */
        #flight-loader {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(20px);
            z-index: 6000; display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: 0.3s;
        }
        #flight-loader.active { opacity: 1; visibility: visible; }
        .loader-txt { color: #fff; font-family: 'JetBrains Mono'; font-size: 1.2rem; margin-top: 20px; text-align: center; }
        .loader-spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--lh-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* === HEADER === */
        header { 
            position: fixed; top: 0; left: 0; width: 100%; height: 70px; 
            background: var(--header-bg); backdrop-filter: blur(20px); 
            z-index: 2000; display: flex; justify-content: center; align-items: center; 
            padding: 0 20px; border-bottom: 1px solid var(--glass-border); 
        }
        .brand { 
            font-weight: 900; font-size: 1rem; letter-spacing: -0.2px; text-transform: uppercase; 
            text-align: center; color: var(--lh-blue);
        }
        .header-spacer { height: 90px; width: 100%; }

        /* === CARDS === */
        .container { max-width: 800px; margin: 0 auto; padding: 0 20px; }
        .anim-item, .ticket, .crew-card, .news-item, .card {
            background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); box-shadow: var(--shadow); border-radius: var(--radius-card);
            position: relative; transform-origin: top center; will-change: transform, opacity; color: var(--text-main);
            opacity: 1; transform: none;
        }
        .anim-item { padding: 24px; margin-bottom: 20px; }

        /* Ticket & Tear */
        .ticket { padding: 0 !important; display: flex; overflow: hidden; cursor: pointer; margin-bottom: 16px; transition: transform 0.2s; }
        .ticket:active { transform: scale(0.98); }
        .ticket.ticket-tearing { overflow: visible !important; background: transparent !important; border: none !important; box-shadow: none !important; backdrop-filter: none !important; transform: none !important; pointer-events: none; }
        .ticket-tearing .ticket-l { animation: tearLeft 1.5s ease-in forwards; transform-origin: center right; border-right: 2px dashed var(--glass-border); }
        .ticket-tearing .ticket-r { animation: tearRight 1.5s ease-in forwards; transform-origin: center left; border-left: none; }
        @keyframes tearLeft { to { transform: translate(-50px, 150px) rotate(-20deg); opacity: 0; } }
        @keyframes tearRight { to { transform: translate(50px, 150px) rotate(20deg); opacity: 0; } }
        
        .ticket-l { flex: 1; padding: 22px; background: var(--glass-bg); backdrop-filter: blur(15px); border-top-left-radius: var(--radius-card); border-bottom-left-radius: var(--radius-card); }
        .ticket-r { width: 85px; background: var(--lh-gold); display: flex; flex-direction: column; align-items: center; justify-content: center; border-top-right-radius: var(--radius-card); border-bottom-right-radius: var(--radius-card); }
        .route-path { display: flex; justify-content: space-between; align-items: center; margin: 12px 0; }
        .ap { font-size: 1.7rem; font-weight: 900; letter-spacing: -0.5px; color: var(--text-main); }
        .ap-lbl { font-size: 0.7rem; color: var(--text-sec); font-weight: 600; text-transform: uppercase; }
        .al-tag { font-size: 0.8rem; font-weight: 700; color: var(--lh-blue); }

        /* Pilot */
        .pilot-header { display: flex; align-items: center; gap: 20px; margin-bottom: 24px; }
        .pilot-av { width: 70px; height: 70px; border-radius: 50%; background: var(--lh-blue); color: #fff; display: flex; align-items: center; justify-content: center; font-size: 1.6rem; font-weight: 800; border: 3px solid var(--lh-gold); flex-shrink: 0; }
        .pilot-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: rgba(128,128,128,0.08); padding: 18px; border-radius: 20px; }
        .stat-box { text-align: center; }
        .stat-lbl { font-size: 0.65rem; color: var(--text-sec); font-weight: 700; text-transform: uppercase; }
        .stat-val { font-size: 1.3rem; font-weight: 800; font-family: 'JetBrains Mono'; color: var(--text-main); }
        .pilot-details { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .pd-row label { display: block; font-size: 0.65rem; font-weight: 700; color: var(--text-sec); text-transform: uppercase; margin-bottom: 5px; }
        .pd-row span { font-size: 0.95rem; font-weight: 600; color: var(--text-main); }

        /* Nav */
        .nav-dock { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 450px; height: var(--nav-h); background: rgba(255,255,255,0.9); backdrop-filter: blur(30px); border-radius: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); z-index: 1900; display: flex; justify-content: space-evenly; align-items: center; border: 1px solid var(--glass-border); }
        .nav-btn { background: none; border: none; color: var(--text-sec); display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: 0.3s; }
        .nav-btn i { font-style: normal; font-size: 1.8rem; margin-bottom: 4px; transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .nav-btn span { font-size: 0.7rem; font-weight: 600; }
        .nav-btn.active { color: var(--lh-blue); } 
        .nav-btn.active i { transform: translateY(-8px) scale(1.1); }
        .tab-view { display: none; opacity: 0; transition: opacity 0.3s; } .tab-view.active { display: block; opacity: 1; }

        /* UI Helpers */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .title { font-size: 2rem; font-weight: 900; letter-spacing: -0.5px; }
        .ios-input { width: 100%; padding: 14px; background: rgba(0,0,0,0.05); border: none; border-radius: 14px; margin-bottom: 12px; font-size: 1rem; color: var(--text-main); text-align: center; font-weight: 600; transition: 0.3s; }

        /* === MODALS (ANIMATED) === */
        .modal-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); 
            z-index: 5000; align-items: flex-end; justify-content: center;
            opacity: 0; 
        }
        .modal-overlay.open { 
            display: flex; 
            animation: fadeIn 0.4s ease forwards; 
        }
        
        .modal-body { 
            width: 100%; max-width: 550px; background: var(--glass-bg); 
            border-radius: 32px 32px 0 0; padding: 35px; 
            max-height: 85vh; overflow-y: auto; 
            border-top: 1px solid var(--glass-border); 
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2); 
            transform: translateY(100%); 
            animation: slideUp 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; 
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        @media(min-width: 768px) { 
            .modal-overlay { align-items: center; }
            .modal-body { border-radius: 32px; animation: popIn 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; } 
        }
        @keyframes popIn { 
            0% { transform: scale(0.95); opacity: 0; } 
            100% { transform: scale(1); opacity: 1; } 
        }

        /* Map */
        #map-wrap { height: 450px; border-radius: var(--radius-card); overflow: hidden; position: relative; border: 1px solid var(--glass-border); z-index: 10; }
        .map-filter-btn { position: absolute; top: 15px; right: 15px; z-index: 1000; }
        
        /* Map Popup (Scrollable) */
        .leaflet-popup-content-wrapper { background: var(--bg-body); color: var(--text-main); border-radius: 14px; font-family: 'Inter', sans-serif; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 280px !important; }
        .map-popup-header { padding: 12px 15px; background: rgba(5, 22, 77, 0.05); border-bottom: 1px solid rgba(0,0,0,0.1); }
        .map-popup-header b { font-size: 1rem; color: var(--lh-blue); display: block; }
        .map-scroll-container { max-height: 220px; overflow-y: auto; padding: 0 15px; }
        .map-scroll-container::-webkit-scrollbar { width: 4px; }
        .map-scroll-container::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .map-flight-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .map-flight-item:last-child { border-bottom: none; }
        .map-flight-info { font-size: 0.85rem; line-height: 1.3; }
        .map-flight-dest { font-weight: 700; color: var(--lh-blue); }

        /* OFP */
        .efb-body { background: #121212; color: #fff; padding: 0; overflow: hidden; border: 1px solid #333; }
        .ofp-header { background: #1c1c1e; padding: 20px; border-bottom: 2px dashed #333; display: flex; justify-content: space-between; align-items: center; }
        .ofp-title { font-family: 'JetBrains Mono', monospace; font-weight: 700; letter-spacing: 1px; color: #888; }
        .ofp-status { background: var(--lh-gold); color: #000; font-weight: 800; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        .ofp-content { padding: 25px; }
        .ofp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .ofp-box { background: #222; padding: 15px; border-radius: 12px; border: 1px solid #333; }
        .ofp-lbl { font-size: 0.65rem; color: #777; font-weight: 600; font-family: 'JetBrains Mono'; display: block; margin-bottom: 5px; }
        .ofp-val { font-size: 1.1rem; color: #fff; font-weight: 700; font-family: 'JetBrains Mono'; }
        .ofp-actions { padding: 0 25px 25px; }
        .btn-ofp { background: #fff; color: #000; }
        
        .chip { padding: 12px 20px; background: rgba(0,0,0,0.05); border-radius: 16px; font-size: 0.9rem; font-weight: 700; color: var(--text-sec); cursor: pointer; flex-grow: 1; text-align: center; transition: 0.2s; margin: 4px; display: inline-block; }
        .chip.active { background: var(--lh-blue); color: #fff; }
    </style>
</head>
<body>

<div id="intro">
    <div class="intro-glow"></div>
    <div class="intro-container">
        <div class="intro-text-main">LOT POLISH</div>
        <div class="intro-text-sub">AIRLINES SYSTEM</div>
    </div>
</div>

<div id="flight-loader">
    <div class="loader-spinner"></div>
    <div class="loader-txt" id="loader-msg">INITIALIZING...</div>
</div>

<header>
    <div class="brand">LOT Polish Airlines</div>
</header>

<div class="nav-dock hidden" id="nav">
    <button class="nav-btn active" onclick="app.nav('dash')"><i>üè†</i><span>Home</span></button>
    <button class="nav-btn" onclick="app.nav('routes')"><i>üé´</i><span>Flights</span></button>
    <button class="nav-btn" onclick="app.nav('fleet')"><i>‚úàÔ∏è</i><span>Hangar</span></button>
    <button class="nav-btn" onclick="app.nav('map')"><i>üó∫Ô∏è</i><span>Map</span></button>
    <button class="nav-btn" onclick="app.nav('crew')"><i>üë®‚Äç‚úàÔ∏è</i><span>Crew</span></button>
</div>

<div id="login-modal" class="modal-overlay open" style="z-index: 8000; background:#000;">
    <div class="modal-body" style="text-align: center; background:var(--bg-body); border:none; padding:30px;">
        <h2 class="title" style="margin-bottom:10px;">Captain Login</h2>
        <p style="color:var(--text-sec); margin-bottom:20px; font-size:0.9rem;">Secure access required.</p>
        <input type="text" id="travel-id" class="ios-input" placeholder="Travel ID (e.g. LOT001)">
        <input type="password" id="travel-pass" class="ios-input" placeholder="Password">
        <button class="btn-primary" onclick="app.login()">Initialize</button>
        <p id="login-err" style="color:#ef4444; margin-top:15px; font-weight:700; font-size:0.9rem;"></p>
    </div>
</div>

<div class="container hidden" id="app">

    <div id="view-dash" class="tab-view active">
        <div class="header-spacer"></div>
        <div id="pilot-profile-card"></div>
        
        <div class="anim-item">
            <h3 style="margin-bottom:8px; font-weight:800; font-size:1.4rem;">Daily Assignment</h3>
            <p style="font-size:0.9rem; color:var(--text-sec); margin-bottom:20px;">Schedule resets 00:00 UTC.</p>
            <div id="daily-content" style="font-size:1.4rem; font-weight:800; margin-bottom:20px;">Loading...</div>
            <button class="btn-primary" onclick="app.prep(app.dailyIdx)">Flight Briefing</button>
        </div>

        <div id="flight-card" class="anim-item hidden" style="border: 3px solid var(--lh-gold);">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span style="font-weight:800; color:var(--lh-gold);">LIVE</span>
                <span id="af-timer" style="font-family:'JetBrains Mono'; font-weight:800;">00:00:00</span>
            </div>
            <h2 id="af-route" style="font-size:2.2rem; font-weight:900;">DEP - ARR</h2>
            <p id="af-ac" style="color:var(--text-sec); font-family:'JetBrains Mono'; margin-bottom:20px;">A320</p>
            <div style="height:8px; background:var(--bg-body); border-radius:4px; overflow:hidden;">
                <div id="af-bar" style="height:100%; width:0%; background:var(--lh-gold); transition: width 1s linear;"></div>
            </div>
            <button class="btn-primary" style="background:transparent; border:2px solid rgba(128,128,128,0.2); margin-top:25px; color:var(--text-main);" onclick="app.cancel()">Cancel Flight</button>
        </div>
    </div>

    <div id="view-routes" class="tab-view">
        <div class="header-spacer"></div>
        <div class="section-header">
            <div class="title">Departures</div>
            <button class="btn-filter" onclick="app.openFilter('routes')">Filter <span>‚ñº</span></button>
        </div>
        <div id="routes-list"></div>
        <button class="btn-float" onclick="app.openGenerator()">üé≤</button>
    </div>

    <div id="view-fleet" class="tab-view">
        <div class="header-spacer"></div>
        <div class="section-header">
            <div class="title">Hangar</div>
            <button class="btn-filter" onclick="app.openFilter('fleet')">Filter <span>‚ñº</span></button>
        </div>
        <div id="fleet-list"></div>
    </div>

    <div id="view-map" class="tab-view">
        <div class="header-spacer"></div>
        <div class="section-header">
            <div class="title">Network</div>
        </div>
        <div class="anim-item" style="padding:0; overflow:hidden;">
            <div id="map-wrap">
                <button class="btn-filter map-filter-btn" onclick="app.openFilter('map')">Filter List ‚ñº</button>
                <div id="map-c" style="width:100%; height:100%;"></div>
            </div>
        </div>
    </div>

    <div id="view-crew" class="tab-view">
        <div class="header-spacer"></div>
        <div class="section-header">
            <div class="title">Crew & Ops</div>
        </div>
        <div class="segment-control">
            <button id="seg-roster" class="seg-btn active" onclick="app.crewTab('roster')">Roster</button>
            <button id="seg-news" class="seg-btn" onclick="app.crewTab('news')">News Ops</button>
        </div>
        
        <div id="crew-roster-view"></div>
        <div id="crew-news-view" class="hidden"></div>
    </div>

</div>

<div id="gen-modal" class="modal-overlay">
    <div class="modal-body">
        <h3 style="margin-bottom:20px; font-weight:800; font-size:1.5rem;">Flight Generator</h3>
        <div class="gen-section">
            <label class="gen-lbl">Duration</label>
            <div class="gen-chips" id="gen-time">
                <div class="chip active" onclick="app.setGen('time', 'ALL', this)">Any</div>
                <div class="chip" onclick="app.setGen('time', 'SHORT', this)">Short (<3h)</div>
                <div class="chip" onclick="app.setGen('time', 'MEDIUM', this)">Medium (3-8h)</div>
                <div class="chip" onclick="app.setGen('time', 'LONG', this)">Long (>8h)</div>
            </div>
        </div>
        <div class="gen-section">
            <label class="gen-lbl">Airline</label>
            <div class="gen-chips" id="gen-al"></div>
        </div>
        <button class="btn-primary" onclick="app.generateSmart()">Generate</button>
        <button class="btn-primary" style="margin-top:15px; background:transparent; color:var(--text-main); border:2px solid var(--border);" onclick="app.closeM()">Cancel</button>
    </div>
</div>

<div id="filter-modal" class="modal-overlay">
    <div class="modal-body">
        <h3 id="filter-title" style="margin-bottom:20px; font-weight:800;">Select Filter</h3>
        <div id="filter-container" style="display:flex; flex-wrap:wrap;"></div>
        <button class="btn-primary" style="margin-top:20px; background:transparent; color:var(--text-main); border:2px solid var(--border);" onclick="app.closeM()">Close</button>
    </div>
</div>

<div id="pilot-view-modal" class="modal-overlay">
    <div class="modal-body">
        <div id="pv-content"></div>
        <button class="btn-primary" style="margin-top:20px; background:transparent; color:var(--text-main); border:2px solid var(--border);" onclick="app.closeM()">Close</button>
    </div>
</div>

<div id="news-read-modal" class="modal-overlay">
    <div class="modal-body">
        <span id="nr-tag" class="news-tag" style="font-size:0.9rem; margin-bottom:10px;"></span>
        <h2 id="nr-title" style="margin-bottom:20px; line-height:1.3; font-size:1.8rem; font-weight:800;"></h2>
        <p id="nr-body" style="font-size:1.1rem; line-height:1.7; color:var(--text-sec);"></p>
        <button class="btn-primary" style="margin-top:30px; background:transparent; color:var(--text-main); border:2px solid var(--border);" onclick="app.closeM()">Close</button>
    </div>
</div>

<div id="efb-modal" class="modal-overlay">
    <div class="modal-body efb-body">
        <div class="ofp-header">
            <span class="ofp-title">LOT // FLIGHT RELEASE</span>
            <span class="ofp-status">READY</span>
        </div>
        <div class="ofp-content">
            <div class="ofp-grid">
                <div class="ofp-box"><span class="ofp-lbl">CALLSIGN</span><span class="ofp-val" id="br-cs"></span></div>
                <div class="ofp-box"><span class="ofp-lbl">AIRCRAFT</span><span class="ofp-val" id="br-ac"></span></div>
                <div class="ofp-box"><span class="ofp-lbl">ORIGIN</span><span class="ofp-val" id="br-dep"></span></div>
                <div class="ofp-box"><span class="ofp-lbl">DESTINATION</span><span class="ofp-val" id="br-arr"></span></div>
                <div class="ofp-box"><span class="ofp-lbl">FUEL REQ</span><span class="ofp-val" id="br-fuel"></span></div>
                <div class="ofp-box"><span class="ofp-lbl">EST TIME</span><span class="ofp-val" id="br-time"></span></div>
                <div class="ofp-box"><span class="ofp-lbl">PAX</span><span class="ofp-val" id="br-pax"></span></div>
                <div class="ofp-box"><span class="ofp-lbl">GATE</span><span class="ofp-val" id="br-gate"></span></div>
            </div>
            <div class="ofp-actions">
                <button class="btn-primary btn-ofp" onclick="app.accept()">ACCEPT FLIGHT PLAN</button>
                <button class="btn-primary" style="background:transparent; color:#fff; border:1px solid #444; margin-top:10px;" onclick="app.closeM()">DISCARD</button>
            </div>
        </div>
    </div>
</div>

<script>
    const DB = {
        PILOTS: [
            { id: "LOT001", pwd: "1234", name: "Capt. Mueller", rank: "Captain", base: "EDDF", callsign: "GHOST", platform: "Discord" },
            { id: "LOT002", pwd: "1234", name: "F.O. Weber", rank: "First Officer", base: "EDDM", callsign: "SPEEDBIRD", platform: "Telegram" },
            { id: "LOT003", pwd: "1234", name: "S.O. Schmidt", rank: "Second Officer", base: "LSZH", callsign: "ALPINE", platform: "VK" }
        ],
        ROUTES: [
            { al: "LOT", code: "LO", d: "EDDF", a: "EGLL", t: 1.5, ac: "A320neo", fuel: "5.8t" },
            { al: "Swiss", code: "LX", d: "LSZH", a: "KJFK", t: 8.8, ac: "A330-300", fuel: "105.0t" },
            { al: "Austrian", code: "OS", d: "LOWW", a: "VTBS", t: 10.0, ac: "B777-200", fuel: "130.0t" },
            { al: "Eurowings", code: "EW", d: "EDDL", a: "LEPA", t: 2.2, ac: "A320", fuel: "8.5t" },
            { al: "Condor", code: "DE", d: "EDDF", a: "CUN", t: 11.5, ac: "A330neo", fuel: "85.0t" },
            { al: "Air Dolomiti", code: "EN", d: "EDDM", a: "LIPZ", t: 0.8, ac: "E195", fuel: "4.0t" },
            { al: "Brussels", code: "SN", d: "EBBR", a: "GOSS", t: 6.5, ac: "A330", fuel: "50.0t" },
            { al: "Discover", code: "4Y", d: "EDDF", a: "VTAA", t: 10.5, ac: "A330-300", fuel: "90.0t" },
            { al: "Edelweiss", code: "WK", d: "LSZH", a: "MLE", t: 9.5, ac: "A340-300", fuel: "100.0t" },
            { al: "Croatia", code: "OU", d: "LDZA", a: "EDDF", t: 1.5, ac: "A319", fuel: "6.0t" },
            { al: "LOT", code: "LO", d: "EPWA", a: "KJFK", t: 9.0, ac: "B787-9", fuel: "80.0t" },
            { al: "Luxair", code: "LG", d: "ELLX", a: "LPPR", t: 2.5, ac: "B737-8", fuel: "10.0t" },
            { al: "TAP", code: "TP", d: "LPPT", a: "SBGL", t: 10.0, ac: "A330neo", fuel: "95.0t" }
        ],
        FLEET: [
            { t: "Airbus A320neo", op: "LOT", r: "6,300km", spd: "M0.82", mtow: "79t" },
            { t: "Boeing 747-8", op: "LOT", r: "14,800km", spd: "M0.86", mtow: "447t" },
            { t: "Airbus A330-300", op: "Swiss", r: "11,750km", spd: "M0.86", mtow: "242t" },
            { t: "Embraer 195", op: "Air Dolomiti", r: "4,200km", spd: "M0.78", mtow: "52t" },
            { t: "Boeing 777-200", op: "Austrian", r: "13,650km", spd: "M0.84", mtow: "297t" }
        ],
        COORDS: { "EDDF":[50.03,8.56], "EGLL":[51.47,-0.45], "KJFK":[40.64,-73.77], "EDDM":[48.35,11.77], "LSZH":[47.45,8.55], "LOWW":[48.11,16.56], "VTBS":[13.69,100.75], "EDDL":[51.28,6.76], "LEPA":[39.55,2.73], "CUN":[21.04,-86.87], "LIPZ":[45.50,12.35], "EBBR":[50.90,4.48], "MLE":[4.19,73.52], "LDZA":[45.74,16.06], "LPPT":[38.77,-9.13] },
        GATES: ["A10", "Z50", "E05", "G08", "K14", "B22", "C15"],
        NEWS: [
            { t: "Network Update", d: "Added TAP, SAS, Finnair.", body: "We have expanded the network with new routes from TAP, SAS, Finnair and ITA. Please update your charts accordingly.", tag: "UPDATE" },
            { t: "Winter Operations", d: "De-icing mandatory.", body: "Severe winter conditions in Munich and Zurich. De-icing is mandatory for all departures. Expect delays of 15-20 minutes.", tag: "ALERT" }
        ]
    };

    const app = {
        user: null, active: null, temp: null, map: null, dailyIdx: 0,
        filters: { al: 'ALL' },
        gen: { time: 'ALL', al: 'ALL' },
        stats: { h: 0, l: 0 },

        init: function() {
            // Updated LocalStorage Key for new version
            const s = JSON.parse(localStorage.getItem('lot_stats_v147'));
            if(s) this.stats = s;
            const f = JSON.parse(localStorage.getItem('lot_flight'));
            if(f) { this.active = f; this.timer(); }

            const today = new Date().toDateString();
            let hash = 0;
            for(let i=0; i<today.length; i++) hash = today.charCodeAt(i) + ((hash << 5) - hash);
            this.dailyIdx = Math.abs(hash) % DB.ROUTES.length;

            setTimeout(() => {
                const intro = document.getElementById('intro');
                intro.style.opacity = '0';
                setTimeout(() => intro.classList.add('hidden'), 1000);
            }, 3000);

            let ticking = false;
            window.addEventListener('scroll', () => {
                if (!ticking) { window.requestAnimationFrame(() => { this.onScroll(); ticking = false; }); ticking = true; }
            });

            this.renderR(); this.renderF(); this.dailyUI();
        },

        onScroll: function() {
            const targets = document.querySelectorAll('.anim-item, .ticket, .crew-card, .news-item');
            const limit = 110; 
            targets.forEach(el => {
                if(el.offsetParent === null) return;
                const rect = el.getBoundingClientRect();
                if(rect.top < limit && rect.top > -200) {
                    const dist = limit - rect.top;
                    const pct = Math.min(dist / 120, 1);
                    el.style.transform = `scale(${1 - pct * 0.1}) translateY(${dist * 0.5}px)`;
                    el.style.opacity = 1 - (pct * 1.5);
                } else {
                    el.style.transform = 'scale(1) translateY(0)';
                    el.style.opacity = 1;
                }
            });
        },

        login: function() {
            const u = document.getElementById('travel-id').value.toUpperCase();
            const p = document.getElementById('travel-pass').value;
            const pilot = DB.PILOTS.find(x => x.id === u && x.pwd === p);
            if(pilot) {
                this.user = pilot;
                document.getElementById('login-modal').classList.remove('open');
                setTimeout(() => {
                    document.getElementById('nav').classList.remove('hidden');
                    const appC = document.getElementById('app');
                    appC.classList.remove('hidden');
                    this.profile();
                    this.renderC();
                }, 300);
            } else document.getElementById('login-err').innerText = "Access Denied";
        },

        profile: function() {
            document.getElementById('pilot-profile-card').className = 'anim-item';
            document.getElementById('pilot-profile-card').innerHTML = `
                <div class="pilot-header">
                    <div class="pilot-av">${this.user.name[0]}</div>
                    <div><h2 style="font-weight:800;">${this.user.name}</h2><p style="color:var(--text-sec); font-size:0.9rem;">${this.user.rank} ‚Ä¢ ${this.user.base}</p></div>
                </div>
                <div class="pilot-stat-grid">
                    <div class="stat-box"><div class="stat-lbl">HOURS</div><div class="stat-val">${Math.floor(this.stats.h)}</div></div>
                    <div class="stat-box"><div class="stat-lbl">LOGGED</div><div class="stat-val">${this.stats.l}</div></div>
                </div>
                <div class="pilot-details">
                    <div class="pd-row"><label>CALLSIGN</label><span>${this.user.callsign}</span></div>
                    <div class="pd-row"><label>TRAVEL ID</label><span>${this.user.id}</span></div>
                    <div class="pd-row"><label>PLATFORM</label><span>${this.user.platform}</span></div>
                    <div class="pd-row"><label>STATUS</label><span style="color:#15803d">Active</span></div>
                </div>`;
        },

        renderR: function() {
            const l = document.getElementById('routes-list'); l.innerHTML = '';
            DB.ROUTES.forEach((r, i) => {
                if(this.filters.al !== 'ALL' && r.al !== this.filters.al) return;
                l.innerHTML += `
                <div class="ticket anim-item" onclick="app.prep(${i}, event)">
                    <div class="ticket-l">
                        <div class="al-tag">${r.al}</div>
                        <div class="route-path">
                            <div><div class="ap">${r.d}</div><div class="ap-lbl">DEP</div></div>
                            <div style="color:var(--text-sec);">‚úà</div>
                            <div style="text-align:right;"><div class="ap">${r.a}</div><div class="ap-lbl">ARR</div></div>
                        </div>
                        <div style="font-size:0.8rem; color:var(--text-sec);">${r.ac}</div>
                    </div>
                    <div class="ticket-r"><div style="font-family:'JetBrains Mono'; font-weight:700; font-size:0.9rem;">${r.t}h</div></div>
                </div>`;
            });
        },
        
        renderF: function(f='ALL') {
            const l = document.getElementById('fleet-list'); l.innerHTML = '';
            DB.FLEET.forEach(x => {
                if(f !== 'ALL' && x.op !== f) return;
                l.innerHTML += `
                <div class="anim-item">
                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid rgba(0,0,0,0.05); padding-bottom:10px;">
                        <span style="font-weight:700;">${x.t}</span>
                        <span style="font-size:0.7rem; font-weight:700; background:var(--lh-blue); color:#fff; padding:3px 8px; border-radius:6px;">${x.op}</span>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                        <div><div class="stat-lbl">Range</div><div style="font-size:0.9rem; font-weight:600;">${x.r}</div></div>
                        <div><div class="stat-lbl">Speed</div><div style="font-size:0.9rem; font-weight:600;">${x.spd}</div></div>
                        <div><div class="stat-lbl">MTOW</div><div style="font-size:0.9rem; font-weight:600;">${x.mtow}</div></div>
                    </div>
                </div>`;
            });
        },

        renderC: function() {
            if(!this.user) return;
            const rosterContainer = document.getElementById('crew-roster-view');
            rosterContainer.innerHTML = '';
            DB.PILOTS.forEach(p => {
                if(p.id === this.user.id) return;
                rosterContainer.innerHTML += `
                <div class="crew-card anim-item" onclick="app.viewPilot('${p.id}')">
                    <div style="width:40px; height:40px; border-radius:50%; background:#eee; display:flex; align-items:center; justify-content:center; font-weight:700;">${p.name[0]}</div>
                    <div><div style="font-weight:700;">${p.name}</div><div style="font-size:0.8rem; color:var(--text-sec);">${p.rank}</div></div>
                </div>`;
            });

            const newsContainer = document.getElementById('crew-news-view');
            newsContainer.innerHTML = '';
            DB.NEWS.forEach((news, i) => {
                newsContainer.innerHTML += `
                <div class="news-item anim-item" onclick="app.readNews(${i})">
                    <div>
                        <span class="news-tag">${news.tag}</span>
                        <h4 style="margin:5px 0;">${news.t}</h4>
                        <p style="font-size:0.9rem; color:var(--text-sec);">${news.d}</p>
                    </div>
                </div>`;
            });
        },

        nav: function(id) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.querySelectorAll('.tab-view').forEach(v => { 
                v.classList.remove('active'); 
            });
            const tgt = document.getElementById('view-'+id);
            tgt.classList.add('active');
            
            document.querySelectorAll('.anim-item, .ticket, .crew-card, .news-item').forEach(el => {
                el.style.transform = 'none';
                el.style.opacity = '1';
            });
            
            this.onScroll();
            if(id === 'map') this.initMap();
        },

        crewTab: function(t) {
            document.getElementById('seg-roster').classList.toggle('active', t==='roster');
            document.getElementById('seg-news').classList.toggle('active', t==='news');
            document.getElementById('crew-roster-view').classList.toggle('hidden', t!=='roster');
            document.getElementById('crew-news-view').classList.toggle('hidden', t!=='news');
            
            document.querySelectorAll('.crew-card, .news-item').forEach(el => {
                el.style.transform = 'none';
                el.style.opacity = '1';
            });
            this.onScroll();
        },

        viewPilot: function(id) {
            const p = DB.PILOTS.find(x => x.id === id);
            if(!p) return;
            document.getElementById('pv-content').innerHTML = `
                <div class="pilot-header">
                    <div class="pilot-av">${p.name[0]}</div>
                    <div><h2 style="font-weight:800;">${p.name}</h2><p>${p.rank} ‚Ä¢ ${p.base}</p></div>
                </div>
                <div class="pilot-details">
                    <div class="pd-row"><label>CALLSIGN</label><span>${p.callsign}</span></div>
                    <div class="pd-row"><label>TRAVEL ID</label><span>${p.id}</span></div>
                    <div class="pd-row"><label>PLATFORM</label><span>${p.platform}</span></div>
                    <div class="pd-row"><label>STATUS</label><span style="color:#15803d">Active</span></div>
                </div>`;
            this.openM('pilot-view-modal');
        },
        readNews: function(i) {
            const n = DB.NEWS[i];
            document.getElementById('nr-tag').innerText = n.tag;
            document.getElementById('nr-title').innerText = n.t;
            document.getElementById('nr-body').innerText = n.body;
            this.openM('news-read-modal');
        },

        dailyUI: function() { const r = DB.ROUTES[this.dailyIdx]; document.getElementById('daily-content').innerText = `${r.d} ‚ûù ${r.a} (${r.ac})`; },
        
        prep: function(i, event) {
            if(this.active) { alert("Flight in progress"); return; }
            if(event && event.currentTarget) event.currentTarget.classList.add('ticket-tearing'); 

            setTimeout(() => {
                const loader = document.getElementById('flight-loader');
                const txt = document.getElementById('loader-msg');
                loader.classList.add('active');
                
                txt.innerText = "INITIALIZING FMS...";
                setTimeout(() => txt.innerText = "LOADING ROUTE...", 800);
                setTimeout(() => txt.innerText = "CALCULATING FUEL...", 1600);
                
                setTimeout(() => {
                    loader.classList.remove('active');
                    const r = DB.ROUTES[i];
                    // UPDATED FLIGHT NUMBER GEN TO 'LO'
                    this.temp = { ...r, n: 'LO'+Math.floor(Math.random()*900+100), gate: DB.GATES[Math.floor(Math.random()*DB.GATES.length)] };
                    document.getElementById('br-cs').innerText = this.temp.n; document.getElementById('br-ac').innerText = r.ac;
                    document.getElementById('br-dep').innerText = r.d; document.getElementById('br-arr').innerText = r.a;
                    document.getElementById('br-fuel').innerText = r.fuel; document.getElementById('br-time').innerText = r.t + ' H';
                    document.getElementById('br-pax').innerText = Math.floor(Math.random()*100+50); document.getElementById('br-gate').innerText = this.temp.gate;
                    this.openM('efb-modal');
                    if(event && event.currentTarget) event.currentTarget.classList.remove('ticket-tearing');
                }, 2500);
            }, event ? 1000 : 100);
        },
        
        accept: function() {
            this.active = { ...this.temp, start: Date.now(), dur: this.temp.t * 3600 * 1000 };
            localStorage.setItem('lot_flight', JSON.stringify(this.active));
            this.closeM(); this.timer(); this.nav('dash');
        },
        timer: function() {
            document.getElementById('flight-card').classList.remove('hidden');
            document.getElementById('af-route').innerText = `${this.active.d} - ${this.active.a}`;
            document.getElementById('af-ac').innerText = `${this.active.ac} ‚Ä¢ ${this.active.n}`;
            this.tmr = setInterval(() => {
                const el = Date.now() - this.active.start;
                const pct = Math.min((el / this.active.dur)*100, 100);
                document.getElementById('af-bar').style.width = pct + "%";
                if(pct >= 100) this.finish();
                else {
                    const rem = this.active.dur - el;
                    const h = Math.floor(rem/3600000);
                    const m = Math.floor((rem%3600000)/60000);
                    document.getElementById('af-timer').innerText = `${h}h ${m}m LEFT`;
                }
            }, 1000);
        },
        finish: function() {
            clearInterval(this.tmr); alert("Flight Complete.");
            this.stats.h += this.active.t; this.stats.l += 1;
            localStorage.setItem('lot_stats_v147', JSON.stringify(this.stats));
            this.active = null; localStorage.removeItem('lot_flight');
            document.getElementById('flight-card').classList.add('hidden');
            this.profile();
        },
        cancel: function() { if(confirm("Cancel?")) { clearInterval(this.tmr); this.active = null; localStorage.removeItem('lot_flight'); document.getElementById('flight-card').classList.add('hidden'); } },
        
        openFilter: function(type) {
            const c = document.getElementById('filter-container');
            let data = [];
            if(type === 'routes') { data = ['ALL', ...new Set(DB.ROUTES.map(r => r.al))]; c.innerHTML = data.map(x => `<div class="chip ${this.filters.al === x ? 'active' : ''}" onclick="app.applyFilter('routes', '${x}')">${x}</div>`).join(''); }
            else if (type === 'fleet') { data = ['ALL', ...new Set(DB.FLEET.map(f => f.op))]; c.innerHTML = data.map(x => `<div class="chip" onclick="app.applyFilter('fleet', '${x}')">${x}</div>`).join(''); }
            else if (type === 'map') { data = ['ALL', ...new Set(DB.ROUTES.map(r => r.al))]; c.innerHTML = data.map(x => `<div class="chip" onclick="app.applyFilter('map', '${x}')">${x}</div>`).join(''); }
            this.openM('filter-modal');
        },
        applyFilter: function(t, v) { this.closeM(); if(t === 'routes') { this.filters.al = v; this.renderR(); } if(t === 'fleet') { this.renderF(v); } if(t === 'map') { this.filters.al = v; this.drawLines(v); } },
        
        openGenerator: function() { const c = document.getElementById('gen-al'); const als = ['ALL', ...new Set(DB.ROUTES.map(r => r.al))]; c.innerHTML = als.map(x => `<div class="chip ${this.gen.al === x ? 'active' : ''}" onclick="app.setGen('al', '${x}', this)">${x}</div>`).join(''); this.openM('gen-modal'); },
        setGen: function(cat, val, btn) { this.gen[cat] = val; btn.parentNode.querySelectorAll('.chip').forEach(c => c.classList.remove('active')); btn.classList.add('active'); },
        generateSmart: function() {
            let matches = DB.ROUTES.filter(r => { if(this.gen.al !== 'ALL' && r.al !== this.gen.al) return false; if(this.gen.time === 'SHORT' && r.t > 3) return false; if(this.gen.time === 'MEDIUM' && (r.t < 3 || r.t > 8)) return false; if(this.gen.time === 'LONG' && r.t < 8) return false; return true; });
            if(matches.length > 0) { const idx = DB.ROUTES.indexOf(matches[Math.floor(Math.random() * matches.length)]); this.closeM(); this.prep(idx); } else { alert("No routes match."); }
        },
        
        initMap: function() { 
            setTimeout(() => { 
                if(!this.map) { 
                    this.map = L.map('map-c').setView([48.5, 10], 5); 
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO', subdomains: 'abcd', maxZoom: 19 }).addTo(this.map); 
                    this.drawLines('ALL'); 
                } 
                this.map.invalidateSize(); 
            }, 100); 
        },
        drawLines: function(filter) { 
            this.map.eachLayer(layer => { if(layer instanceof L.Polyline || layer instanceof L.CircleMarker) this.map.removeLayer(layer); });
            let airports = {};
            DB.ROUTES.forEach((r, idx) => { 
                if(filter !== 'ALL' && r.al !== filter) return; 
                const c1 = DB.COORDS[r.d]; const c2 = DB.COORDS[r.a]; 
                if(c1 && c2) { 
                    L.polyline([c1, c2], { color: '#05164d', weight: 2, opacity: 0.6 }).addTo(this.map); 
                    if(!airports[r.d]) airports[r.d] = { c: c1, routes: [] };
                    airports[r.d].routes.push({ ...r, idx: idx });
                } 
            });
            for(const [apCode, data] of Object.entries(airports)) {
                const marker = L.circleMarker(data.c, { radius: 6, fillColor: '#05164d', color: '#fff', weight: 2, opacity: 1, fillOpacity: 1 }).addTo(this.map);
                let html = `<div class="map-popup-header"><b>${apCode} Departures</b><span style="font-size:0.7rem;">${data.routes.length} Available Routes</span></div>`;
                html += `<div class="map-scroll-container">`;
                data.routes.forEach(route => {
                    html += `<div class="map-flight-item"><div class="map-flight-info"><div class="map-flight-dest">${route.a} <span style="font-weight:400; color:#666;">(${route.al})</span></div><div style="font-size:0.75rem; color:#888;">${route.ac} ‚Ä¢ ${route.t}h</div></div><button class="btn-map-action" onclick="app.prep(${route.idx})">Fly</button></div>`;
                });
                html += `</div>`;
                marker.bindPopup(html);
            }
        },

        openM: function(id) { document.getElementById(id).classList.add('open'); },
        closeM: function() { document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open')); }
    };
    window.onload = () => app.init();
</script>
</body>
</html>
