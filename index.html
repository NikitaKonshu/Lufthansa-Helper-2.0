<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lufthansa Group Virtual — Routes / Fleet / Generate</title>
<meta name="color-scheme" content="dark light">
<style>
:root{
  --bg-1:#041528; --bg-2:#073044; --accent:#ffd700; --muted:#9fb6d6; --text:#eaf4ff;
  --card:#072033; --glass:rgba(255,255,255,0.03); --radius:12px; --shadow:0 14px 40px rgba(2,8,20,0.6);
  --ok:#bff2be; --warn:#fff0b8; --danger:#ff7a59; --transition:220ms cubic-bezier(.2,.9,.2,1);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:Inter,system-ui,Roboto,Arial,Helvetica,sans-serif;
  background: radial-gradient(1200px 600px at 10% 10%, rgba(255,255,255,0.02), transparent), linear-gradient(180deg,var(--bg-1),var(--bg-2));
  color:var(--text); padding:20px; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  display:flex; justify-content:center; align-items:flex-start;
}

/* Layout */
.wrap{width:100%;max-width:1200px;margin-top:18px}
.header{display:flex;justify-content:space-between;align-items:center;padding:18px;border-radius:14px;background:linear-gradient(90deg,rgba(4,36,54,0.92),rgba(6,58,89,0.92));box-shadow:var(--shadow);border:1px solid rgba(255,255,255,0.02)}
.brand{display:flex;gap:14px;align-items:center}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#063a59,#012938);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:900;font-size:18px}
.titleMain{margin:0;font-size:18px}
.small{font-size:13px;color:var(--muted)}

/* Nav */
.top-nav{display:flex;gap:8px;margin-top:12px;align-items:center}
.tab-btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text);cursor:pointer}
.tab-btn.active{background:linear-gradient(90deg,var(--accent),#ffb84d);color:#04202a;font-weight:800}

/* Content */
.card{padding:14px;border-radius:12px;background:linear-gradient(180deg,var(--card),#043044);box-shadow:0 10px 28px rgba(2,8,20,0.55);border:1px solid rgba(255,255,255,0.02)}
.grid{display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:14px}
@media(max-width:1000px){.grid{grid-template-columns:1fr}}
.section-title{font-weight:800;color:var(--accent);margin:0;font-size:18px}
.input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);color:var(--text)}
.row{display:flex;gap:10px;align-items:center}
.btn{padding:9px 14px;border-radius:10px;border:0;background:transparent;color:var(--text);cursor:pointer;font-weight:700}
.btn-primary{background:linear-gradient(180deg,var(--accent),#ffb84d);color:#04202a}
.btn-ghost{border:1px solid rgba(255,255,255,0.04);background:transparent}
.small-muted{font-size:13px;color:var(--muted)}
.list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
.row-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.02)}
.badge{padding:6px 8px;border-radius:8px;font-weight:800}
.verified{background:#083b22;color:var(--ok)}
.not-verified{background:#3b2b2a;color:#ffd0c2}
.log{margin-top:10px;padding:12px;border-radius:10px;background:linear-gradient(180deg,#021923,#062733);border:1px solid rgba(255,255,255,0.03);max-height:240px;overflow:auto}
.card-section{display:none}
.card-section.active{display:block}
.filter-row{display:flex;gap:8px;align-items:center;margin-top:8px}

/* Gate */
#gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(2,8,20,0.6),rgba(2,8,20,0.8));z-index:9999}
#gateCard{width:min(720px,92%);border-radius:14px;padding:20px;background:linear-gradient(180deg,#072033,#042f44);border:1px solid rgba(255,255,255,0.04);box-shadow:0 30px 80px rgba(2,8,20,0.8)}
</style>
</head>
<body>
<div class="wrap">
  <header class="header">
    <div class="brand">
      <div class="logo">LH</div>
      <div>
        <h1 class="titleMain">Lufthansa Group Virtual</h1>
        <div class="small">Routes · Fleet · Generate</div>
      </div>
    </div>
    <div style="display:flex;gap:12px;align-items:center">
      <div id="sessionInfo" class="small-muted">Неавторизован</div>
      <button id="toggleAdmin" class="btn btn-ghost">Включить admin</button>
    </div>
  </header>

  <div class="top-nav">
    <button class="tab-btn active" data-tab="generate" id="tabGenerate">Генерация рейса</button>
    <button class="tab-btn" data-tab="routes" id="tabRoutes">Направления</button>
    <button class="tab-btn" data-tab="fleet" id="tabFleet">Флот</button>
  </div>

  <main class="card" id="mainCard" style="margin-top:12px;">
    <!-- GENERATE SECTION -->
    <section id="section-generate" class="card-section active">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 class="section-title">Генерация рейса</h2>
        <div class="small-muted">Создавать рейсы могут только верифицированные пилоты</div>
      </div>
      <div class="grid" style="margin-top:12px">
        <div>
          <div style="padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent)">
            <h3 style="margin:0">Авиакомпания</h3>
            <div id="airlines" style="margin-top:10px"></div>

            <h3 style="margin-top:14px">Длительность</h3>
            <div id="durations" style="margin-top:10px;display:flex;gap:8px"></div>

            <div style="display:flex;gap:10px;align-items:center;margin-top:14px">
              <button id="genBtn" class="btn btn-primary">Сгенерировать и зарезервировать</button>
              <button id="demoBtn" class="btn btn-ghost">Быстро: SunExpress</button>
              <button id="resetBtn" class="btn btn-ghost">Сброс</button>
              <div style="flex:1"></div>
              <div class="small-muted">Вошёл: <strong id="signedUser">—</strong></div>
            </div>

            <div id="resultArea" style="margin-top:12px;display:none"></div>
          </div>

          <div id="confirmedSection"></div>
        </div>

        <aside>
          <div style="padding:12px;border-radius:10px;background:linear-gradient(180deg,#041f2a,#03222a);border:1px solid rgba(255,255,255,0.03)">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div><div style="font-weight:900">Пилоты</div><div class="small-muted" style="margin-top:6px">Список; редактирование отключено</div></div>
            </div>

            <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
              <input id="pilotSearch" class="input" placeholder="Поиск по имени/позывному"/>
              <select id="pilotBaseFilter" class="input" style="width:140px"><option value="all">Все базы</option></select>
            </div>

            <div id="pilotList" class="list" style="margin-top:12px"></div>
            <div id="pilotEmpty" class="small-muted" style="margin-top:8px">Пилотов ещё нет</div>

            <div class="small-muted" style="margin-top:12px">Регистрация выполняется через код — данные вшиты в файл.</div>
          </div>

          <div style="margin-top:14px;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid rgba(255,255,255,0.03)">
            <div style="font-weight:900">Журнал назначений</div>
            <div id="assignLog" class="log" style="margin-top:10px">Пока пусто</div>
          </div>
        </aside>
      </div>
    </section>

    <!-- ROUTES SECTION -->
    <section id="section-routes" class="card-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 class="section-title">Направления</h2>
        <div class="small-muted">Список маршрутов; фильтр по авиакомпании / хабу</div>
      </div>

      <div style="margin-top:12px; display:flex; gap:12px; align-items:center">
        <select id="filterAirline" class="input" style="width:220px"><option value="all">Все авиакомпании</option></select>
        <select id="filterHub" class="input" style="width:140px"><option value="all">Все хабы</option></select>
        <button id="refreshRoutes" class="btn btn-ghost">Обновить список</button>
      </div>

      <div id="routesList" class="list" style="margin-top:12px"></div>
    </section>

    <!-- FLEET SECTION -->
    <section id="section-fleet" class="card-section">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 class="section-title">Флот</h2>
        <div class="small-muted">Статус самолётов и фильтры</div>
      </div>

      <div style="margin-top:12px; display:flex; gap:12px; align-items:center">
        <select id="filterFleetAirline" class="input" style="width:220px"><option value="all">Все авиакомпании</option></select>
        <select id="filterFleetStatus" class="input" style="width:160px"><option value="all">Все статусы</option><option value="idle">idle</option><option value="reserved">reserved</option><option value="inFlight">inFlight</option></select>
        <button id="refreshFleet" class="btn btn-ghost">Обновить флот</button>
      </div>

      <div id="fleetList" class="list" style="margin-top:12px"></div>
    </section>

  </main>
</div>

<!-- LOGIN GATE (always shown) -->
<div id="gate" aria-hidden="false">
  <div id="gateCard" role="dialog" aria-modal="true">
    <h2>Вход в Lufthansa Helper</h2>
    <p class="small-muted">Вход обязателен: пилот или администратор.</p>

    <div style="display:flex;gap:8px;margin-bottom:10px">
      <button id="rolePilot" class="tab-btn active">Пилот</button>
      <button id="roleAdmin" class="tab-btn">Админ</button>
    </div>

    <div id="loginPilot">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="loginCall" class="input" placeholder="Позывной (call sign)" />
        <input id="loginPass" class="input" placeholder="Пароль пилота или кодовое слово" type="password" />
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnLoginPilot" class="btn btn-primary">Войти как пилот</button>
      </div>
      <div class="small-muted" style="margin-top:8px">Быстрая авторизация — кодовое слово.</div>
    </div>

    <div id="loginAdmin" style="display:none">
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <input id="adminUser" class="input" placeholder="Admin user (demo: admin)" />
        <input id="adminPass" class="input" placeholder="Пароль" type="password" />
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnLoginAdmin" class="btn btn-primary">Войти как админ</button>
      </div>
      <div class="small-muted" style="margin-top:8px">Demo-пароль: <strong style="color:var(--accent)">admin123</strong></div>
    </div>
  </div>
</div>

<script>
/* ---------------- Data ---------------- */
const CODEWORD = 'quickaccess2025';
const ROUTES = [
  { airline: "Lufthansa", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Oslo", toICAO:"ENGM", durationMinutes:120 },
  { airline: "Lufthansa", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Amsterdam", toICAO:"EHAM", durationMinutes:70 },
  { airline: "SunExpress", fromCity:"Frankfurt", fromICAO:"EDDF", toCity:"Antalya", toICAO:"LTAI", durationMinutes:180 },
  { airline: "Eurowings", fromCity:"Munich", fromICAO:"EDDM", toCity:"Zurich", toICAO:"LSZH", durationMinutes:60 }
];
const AIRLINES = [
  { name: "Lufthansa", hubs: ["EDDF","EDDM"] },
  { name: "Eurowings", hubs: ["EDDF","EDDM"] },
  { name: "SunExpress", hubs: ["EDDF","EDDM"] }
];
const FLEET = [
  { id:'LH-A320-01', airline:'Lufthansa', type:'A320', seats:180, turnaround:40, status:'idle', locationICAO:'EDDF' },
  { id:'EW-A320-01', airline:'Eurowings', type:'A320', seats:180, turnaround:40, status:'idle', locationICAO:'EDDM' },
  { id:'SX-B737-01', airline:'SunExpress', type:'737-800', seats:189, turnaround:35, status:'idle', locationICAO:'EDDF' }
];

/* Pilots in-code */
let PILOTS = [
  { id: 'pilot_loui', name: 'Loui Desulier', callSign: 'French', rank: '', baseICAO: '', createdAt: Date.now(), verified: true, password: 'louiSecret' },
  { id: 'pilot_ivan', name:'Ivan Petrov', callSign:'IPET', rank:'ATPL', baseICAO:'EDDF', createdAt: Date.now(), verified:true, password: '' },
  { id: 'pilot_anna', name:'Anna Müller', callSign:'AMUL', rank:'CPL', baseICAO:'EDDM', createdAt: Date.now(), verified:false }
];

let FLEET_LOG = [];
const SESSION_KEY = 'demo_session_v2';
let SESSION = (function(){ try{ const s = sessionStorage.getItem(SESSION_KEY); return s ? JSON.parse(s) : { pilotId:null, isAdmin:false }; }catch(e){ return { pilotId:null, isAdmin:false }; }})();

/* Helpers */
function uid(p='id'){ return p + '_' + Math.random().toString(36).slice(2,9); }
function nowMs(){ return Date.now(); }
function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* UI refs */
const tabs = document.querySelectorAll('.tab-btn');
const sections = { generate: document.getElementById('section-generate'), routes: document.getElementById('section-routes'), fleet: document.getElementById('section-fleet') };
const tabGenerate = document.getElementById('tabGenerate'), tabRoutes = document.getElementById('tabRoutes'), tabFleet = document.getElementById('tabFleet');

/* GEN UI refs */
const airlinesWrap = document.getElementById('airlines'), durationsWrap = document.getElementById('durations');
const genBtn = document.getElementById('genBtn'), demoBtn = document.getElementById('demoBtn'), resetBtn = document.getElementById('resetBtn');
const resultArea = document.getElementById('resultArea'), confirmedSection = document.getElementById('confirmedSection');
const pilotListEl = document.getElementById('pilotList'), pilotEmpty = document.getElementById('pilotEmpty'), pilotSearch = document.getElementById('pilotSearch'), pilotBaseFilter = document.getElementById('pilotBaseFilter');
const assignLogEl = document.getElementById('assignLog'), sessionInfo = document.getElementById('sessionInfo'), signedUser = document.getElementById('signedUser'), toggleAdmin = document.getElementById('toggleAdmin');

let chosenAirIndex = null, chosenDur = null, lastReservation = null;

/* ROUTES UI refs */
const filterAirline = document.getElementById('filterAirline'), filterHub = document.getElementById('filterHub'), refreshRoutes = document.getElementById('refreshRoutes'), routesList = document.getElementById('routesList');

/* FLEET UI refs */
const filterFleetAirline = document.getElementById('filterFleetAirline'), filterFleetStatus = document.getElementById('filterFleetStatus'), refreshFleet = document.getElementById('refreshFleet'), fleetList = document.getElementById('fleetList');

/* ----- Tabs switching ----- */
tabs.forEach(btn=>{
  btn.addEventListener('click', ()=> {
    tabs.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const t = btn.dataset.tab;
    Object.keys(sections).forEach(k=> sections[k].classList.remove('active'));
    sections[t].classList.add('active');
  });
});

/* ----- Render durations & airlines ----- */
const DURATIONS_UI = [
  {label:"1–2ч",min:60,max:120},
  {label:"3–4ч",min:180,max:240},
  {label:"5–6ч",min:300,max:360},
  {label:"7–8ч",min:420,max:480}
];
function renderDurations(){
  durationsWrap.innerHTML='';
  DURATIONS_UI.forEach((d,i)=>{
    const b=document.createElement('button'); b.className='btn btn-ghost'; b.textContent=d.label;
    b.addEventListener('click', ()=>{ chosenDur=i; Array.from(durationsWrap.children).forEach((n,idx)=> n.classList.toggle('selected', idx===i)); });
    durationsWrap.appendChild(b);
  });
}
function renderAirlines(){
  airlinesWrap.innerHTML='';
  AIRLINES.forEach((a,idx)=>{
    const b=document.createElement('button'); b.className='btn btn-ghost'; b.textContent=a.name;
    b.addEventListener('click', ()=> { chosenAirIndex = idx; Array.from(airlinesWrap.children).forEach((n,i)=> n.classList.toggle('selected', i===idx)); });
    airlinesWrap.appendChild(b);
  });
}

/* ----- Pilots list (view only) ----- */
function renderBaseFilter(){
  const bases = Array.from(new Set(PILOTS.map(p=>p.baseICAO).filter(Boolean)));
  pilotBaseFilter.innerHTML = '<option value="all">Все базы</option>';
  bases.forEach(b=>{ const o=document.createElement('option'); o.value=b; o.textContent=b; pilotBaseFilter.appendChild(o); });
}
function renderPilots(){
  pilotListEl.innerHTML='';
  const q=(pilotSearch.value||'').trim().toLowerCase();
  const baseFilter = pilotBaseFilter.value;
  const list = PILOTS.filter(p=>{
    if(q){ const s=(p.name+' '+p.callSign).toLowerCase(); if(!s.includes(q)) return false; }
    if(baseFilter!=='all' && baseFilter){ if(p.baseICAO !== baseFilter) return false; }
    return true;
  });
  if(list.length===0) pilotEmpty.style.display='block'; else pilotEmpty.style.display='none';
  list.forEach(p=>{
    const row=document.createElement('div'); row.className='row-item';
    row.innerHTML = `<div><strong>${esc(p.name)}</strong> <span style="color:var(--muted)">(${esc(p.callSign)})</span><div style="color:var(--muted);font-size:13px">${esc(p.rank||'—')} · ${esc(p.baseICAO||'—')}</div></div>`;
    const right = document.createElement('div');
    right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
    const btnSign = document.createElement('button'); btnSign.className='btn btn-ghost'; btnSign.textContent = (SESSION.pilotId === p.id)?'Вы вошли':'Войти как пилот';
    btnSign.disabled = (SESSION.pilotId === p.id);
    btnSign.addEventListener('click', ()=> { signInAsPilot(p.id); });
    right.appendChild(btnSign);
    if(SESSION.isAdmin){
      const ver = document.createElement('button'); ver.className='btn btn-ghost'; ver.textContent = p.verified? 'Unverify':'Mark Verified';
      ver.addEventListener('click', ()=>{ p.verified = p.verified?false:true; renderPilots(); });
      right.appendChild(ver);
    }
    row.appendChild(right);
    pilotListEl.appendChild(row);
  });
}

/* ----- Routes list ----- */
function renderFilterOptions(){
  filterAirline.innerHTML = '<option value="all">Все авиакомпании</option>';
  filterFleetAirline.innerHTML = '<option value="all">Все авиакомпании</option>';
  AIRLINES.forEach(a=>{
    const o = document.createElement('option'); o.value=a.name; o.textContent=a.name;
    filterAirline.appendChild(o);
    const o2 = document.createElement('option'); o2.value=a.name; o2.textContent=a.name;
    filterFleetAirline.appendChild(o2);
  });
  // hubs
  const hubs = Array.from(new Set(AIRLINES.flatMap(a=>a.hubs)));
  filterHub.innerHTML = '<option value="all">Все хабы</option>';
  hubs.forEach(h => { const o = document.createElement('option'); o.value=h; o.textContent=h; filterHub.appendChild(o); });
}
function renderRoutes(){
  routesList.innerHTML='';
  const fA = filterAirline.value;
  const fH = filterHub.value;
  const list = ROUTES.filter(r=>{
    if(fA !== 'all' && fA) if(r.airline !== fA) return false;
    if(fH !== 'all' && fH) if(r.fromICAO !== fH && r.toICAO !== fH) return false;
    return true;
  });
  if(list.length===0){ routesList.innerHTML = '<div class="small-muted">Нет направлений</div>'; return; }
  list.forEach(r=>{
    const item = document.createElement('div'); item.className='row-item';
    item.innerHTML = `<div><strong>${esc(r.airline)}</strong><div style="color:var(--muted);font-size:13px">${esc(r.fromICAO)} (${esc(r.fromCity)}) → ${esc(r.toICAO)} (${esc(r.toCity)}) · ${r.durationMinutes} мин</div></div>`;
    routesList.appendChild(item);
  });
}

/* ----- Fleet list ----- */
function renderFleet(){
  fleetList.innerHTML='';
  const fA = filterFleetAirline.value;
  const fS = filterFleetStatus.value;
  const list = FLEET.filter(a=>{
    if(fA !== 'all' && fA) if(a.airline !== fA) return false;
    if(fS !== 'all' && fS) if(a.status !== fS) return false;
    return true;
  });
  if(list.length===0){ fleetList.innerHTML = '<div class="small-muted">Нет самолётов</div>'; return; }
  list.forEach(a=>{
    const item = document.createElement('div'); item.className='row-item';
    item.innerHTML = `<div><strong>${esc(a.id)}</strong><div style="color:var(--muted);font-size:13px">${esc(a.airline)} · ${esc(a.type)} · ${a.seats} кресел · ${esc(a.locationICAO)}</div></div>`;
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';
    const status = document.createElement('div'); status.className='badge'; status.textContent = a.status;
    status.style.background = a.status==='idle' ? '#093b3d' : (a.status==='inFlight' ? '#5a2b2b' : '#5a3a9e');
    right.appendChild(status);
    item.appendChild(right);
    fleetList.appendChild(item);
  });
}

/* ----- Reservation / generation (same as before, simplified) ----- */
function reserveAircraft(ac, ownerId, ttlMs = 120*1000){
  if(ac.status === 'inFlight') return { ok:false, reason:'inflight' };
  if(ac.status === 'reserved') return { ok:false, reason:'already_reserved' };
  ac.status = 'reserved'; ac.reservedBy = ownerId;
  ac.reservedToken = ownerId + ':' + Date.now() + ':' + Math.random().toString(36).slice(2,8);
  ac.reservedUntil = nowMs() + ttlMs;
  FLEET_LOG.push({ts: nowMs(), event:'reserved', aircraft: ac.id}); renderAssignLog();
  return { ok:true, token: ac.reservedToken };
}
function cancelReservationByToken(token){
  const ac = FLEET.find(a=>a.reservedToken === token);
  if(!ac) return false;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil; ac.status = 'idle';
  FLEET_LOG.push({ ts: nowMs(), event:'reservation_expired', aircraft: ac.id }); renderAssignLog();
  renderFleet();
  return true;
}
function confirmReservation(token, route, pilotId){
  const ac = FLEET.find(a=>a.reservedToken === token);
  if(!ac) return { ok:false, reason:'no_reservation' };
  if(ac.reservedToken !== token) return { ok:false, reason:'token_mismatch' };

  if(!SESSION.isAdmin){
    const effectivePilotId = pilotId || SESSION.pilotId;
    if(!effectivePilotId) return { ok:false, reason:'no_pilot_assigned' };
    const p = PILOTS.find(x=>x.id===effectivePilotId);
    if(!(p && p.verified === true)) return { ok:false, reason:'pilot_not_verified' };
    pilotId = effectivePilotId;
  }

  const now = nowMs(); const durationMs = (Number(route.durationMinutes) || 120) * 60 * 1000;
  ac.status = 'inFlight'; ac.availableAt = now + durationMs + (ac.turnaround||0)*60*1000; ac.nextLocation = route.toICAO;
  delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
  FLEET_LOG.push({ ts: now, event:'assign_confirmed', aircraft: ac.id, route: `${route.fromICAO}->${route.toICAO}`, durationMin: route.durationMinutes }); renderAssignLog();
  renderFleet();
  if(pilotId) recordPilotAssignment(pilotId, ac.id, route);
  renderConfirmedFlight(ac, route, pilotId);
  return { ok:true, aircraft: ac };
}

/* generateFlight */
function canCreateFlight(){
  if(SESSION.isAdmin) return true;
  if(!SESSION.pilotId) return false;
  const p = PILOTS.find(x=>x.id===SESSION.pilotId);
  return !!(p && p.verified === true);
}
function generateFlight(){
  if(!canCreateFlight()){ alert('Только верифицированный пилот или админ может создать рейс.'); return; }
  if(chosenAirIndex===null){ alert('Выберите авиакомпанию'); return; }
  let pool = ROUTES.filter(r=> r.airline.toLowerCase() === AIRLINES[chosenAirIndex].name.toLowerCase());
  if(pool.length === 0){
    const hubs = AIRLINES[chosenAirIndex].hubs.map(h=>h.toUpperCase());
    pool = ROUTES.filter(r => hubs.includes((r.fromICAO||'').toUpperCase()));
  }
  if(pool.length===0){ resultArea.style.display='block'; resultArea.innerHTML = `<div class="small-muted">Нет маршрутов</div>`; return; }
  if(typeof chosenDur === 'number'){
    const interval = DURATIONS_UI[chosenDur];
    const filtered = pool.filter(r => Number.isFinite(r.durationMinutes) && r.durationMinutes >= interval.min && r.durationMinutes <= interval.max);
    if(filtered.length>0) pool = filtered;
  }
  const route = pool[Math.floor(Math.random()*pool.length)];
  let candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle' && ac.airline && ac.airline.toLowerCase() === AIRLINES[chosenAirIndex].name.toLowerCase());
  if(candidates.length === 0) candidates = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status === 'idle');
  if(candidates.length === 0){ resultArea.style.display='block'; resultArea.innerHTML = `<div class="small-muted">Нет idle самолётов в хабе ${esc(route.fromICAO)}</div>`; return; }
  candidates.sort((a,b)=> Math.abs(a.seats - 180) - Math.abs(b.seats - 180));
  const candidate = candidates[0];
  const res = reserveAircraft(candidate, SESSION.pilotId || 'user_anonymous');
  if(!res.ok){ alert('Не удалось зарезервировать: ' + res.reason); return; }
  lastReservation = { route, aircraftId: candidate.id, token: res.token, reservedAt: nowMs() };
  renderReservationCard(lastReservation);
}

/* reservation card */
function renderReservationCard(gen){
  if(!gen){ resultArea.style.display='none'; resultArea.innerHTML=''; return; }
  const ac = FLEET.find(a=>a.id===gen.aircraftId);
  const route = gen.route;
  resultArea.style.display='block';
  let pilotOptions = '<option value="">Не назначать</option>';
  if(SESSION.isAdmin){
    PILOTS.forEach(p => pilotOptions += `<option value="${p.id}">${esc(p.name)} (${esc(p.callSign)}) ${p.verified===true? '· Verified':''}</option>`);
  } else {
    if(SESSION.pilotId){
      const p = PILOTS.find(x=>x.id===SESSION.pilotId);
      if(p) pilotOptions += `<option value="${p.id}">${esc(p.name)} (${esc(p.callSign)})</option>`;
    }
  }
  resultArea.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center" class="notice">
      <div><strong>Резерв создан:</strong> ${esc(ac.id)} · ${esc(ac.airline)} — ${esc(route.fromICAO)}→${esc(route.toICAO)} (${route.durationMinutes} мин)</div>
      <div class="small-muted">Резерв истечёт через 120s</div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
      <label class="small-muted">Назначить пилота</label>
      <select id="selectPilot" class="input" style="min-width:160px">${pilotOptions}</select>
      <button id="confirmReserveBtn" class="btn btn-primary">Подтвердить полёт</button>
      <button id="cancelReserveBtn" class="btn btn-ghost">Отменить резерв</button>
    </div>
  `;
  document.getElementById('confirmReserveBtn').addEventListener('click', ()=>{
    const selected = document.getElementById('selectPilot').value || null;
    const res = confirmReservation(gen.token, gen.route, selected);
    if(!res.ok){
      if(res.reason === 'pilot_not_verified') alert('Пилот не верифицирован.');
      else if(res.reason === 'no_pilot_assigned') alert('Нужен назначенный пилот.');
      else alert('Не удалось подтвердить: ' + res.reason);
    } else { lastReservation = null; renderReservationCard(null); }
  });
  document.getElementById('cancelReserveBtn').addEventListener('click', ()=>{
    cancelReservationByToken(gen.token); lastReservation = null; renderReservationCard(null);
  });
}

/* confirmed flight UI */
function renderConfirmedFlight(ac, route, pilotId){
  const pilot = pilotId ? PILOTS.find(p=>p.id===pilotId) : null;
  const flightMs = (Number(route.durationMinutes)||120) * 60 * 1000;
  const eta = new Date(Date.now() + flightMs).toLocaleString();
  const card = document.createElement('div'); card.className='card';
  card.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;color:var(--ok)">Рейс подтверждён</div>
      <div class="small-muted">${esc(ac.id)} · ${esc(ac.airline)}</div>
    </div>
    <div style="margin-top:8px" class="small-muted">Откуда: ${esc(route.fromICAO)} · Куда: ${esc(route.toICAO)} · ETA: ${esc(eta)}</div>
    <div style="margin-top:6px" class="small-muted">Пилот: ${pilot ? esc(pilot.name) + ' (' + esc(pilot.callSign) + ')' : 'Не назначен'}</div>
  `;
  confirmedSection.innerHTML=''; confirmedSection.appendChild(card);
}

/* record log */
function recordPilotAssignment(pilotId, aircraftId, route){
  const e = { ts: nowMs(), pilotId, aircraftId, route: `${route.fromICAO}->${route.toICAO}`, durationMin: route.durationMinutes };
  FLEET_LOG.push(Object.assign({}, e, { event:'pilot_assigned' })); renderAssignLog();
}
function renderAssignLog(){
  const items = FLEET_LOG.slice(-200).reverse();
  if(items.length === 0){ assignLogEl.textContent = 'Пока пусто'; return; }
  assignLogEl.innerHTML = items.map(it=>{
    const t = new Date(it.ts).toLocaleTimeString();
    if(it.event === 'pilot_assigned') return `${t} — pilot_assigned ${it.pilotId} → ${it.aircraftId} ${it.route}`;
    if(it.event === 'assign_confirmed') return `${t} — confirmed ${it.aircraft} ${it.route} (${it.durationMin||'n/a'} min)`;
    if(it.event === 'reservation_expired') return `${t} — reservation_expired ${it.aircraft}`;
    if(it.event === 'available') return `${t} — available ${it.aircraft} @ ${it.location}`;
    return `${t} — ${it.event || JSON.stringify(it)}`;
  }).map(s=>`<div style="margin-bottom:6px">${esc(s)}</div>`).join('');
}

/* background expiry */
setInterval(()=>{
  const now = nowMs();
  let changed=false;
  FLEET.forEach(ac=>{
    if(ac.status === 'reserved' && ac.reservedUntil && ac.reservedUntil <= now){
      ac.status = 'idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
      FLEET_LOG.push({ ts: now, event:'reservation_expired', aircraft: ac.id }); changed=true;
    }
    if(ac.status === 'inFlight' && ac.availableAt && ac.availableAt <= now){
      ac.status = 'idle'; if(ac.nextLocation) ac.locationICAO = ac.nextLocation; delete ac.availableAt; delete ac.nextLocation;
      FLEET_LOG.push({ ts: now, event:'available', aircraft: ac.id, location: ac.locationICAO }); changed=true;
    }
  });
  if(changed){ renderAssignLog(); renderFleet(); renderPilots(); }
}, 1000);

/* ----- Gate (auth) ----- */
const gateEl = document.getElementById('gate');
const rolePilot = document.getElementById('rolePilot'), roleAdmin = document.getElementById('roleAdmin');
const loginPilot = document.getElementById('loginPilot'), loginAdmin = document.getElementById('loginAdmin');
const loginCall = document.getElementById('loginCall'), loginPass = document.getElementById('loginPass');
const btnLoginPilot = document.getElementById('btnLoginPilot'), btnLoginAdmin = document.getElementById('btnLoginAdmin');

rolePilot.addEventListener('click', ()=>{ rolePilot.classList.add('active'); roleAdmin.classList.remove('active'); loginPilot.style.display='block'; loginAdmin.style.display='none'; });
roleAdmin.addEventListener('click', ()=>{ roleAdmin.classList.add('active'); rolePilot.classList.remove('active'); loginPilot.style.display='none'; loginAdmin.style.display='block'; });

btnLoginPilot.addEventListener('click', ()=>{
  const cs = loginCall.value.trim(); const pass = loginPass.value || '';
  if(!cs){ alert('Введите позывной'); return; }
  const p = PILOTS.find(x=> x.callSign.toLowerCase() === cs.toLowerCase());
  if(!p){ alert('Пилот не найден. Регистрация отключена.'); return; }
  const pilotPassword = p.password || '';
  if(pass === CODEWORD || (pilotPassword && pass === pilotPassword)){
    SESSION.pilotId = p.id; SESSION.isAdmin = false; sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); renderSessionInfo(); renderPilots(); renderFleet(); renderRoutes(); gateEl.style.display='none';
    return;
  }
  alert('Неверный пароль или кодовое слово');
});

btnLoginAdmin.addEventListener('click', ()=>{
  const user = document.getElementById('adminUser').value.trim(); const pass = document.getElementById('adminPass').value;
  if(user === 'admin' && pass === 'admin123'){
    SESSION.pilotId = null; SESSION.isAdmin = true; sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); renderSessionInfo(); renderPilots(); renderFleet(); renderRoutes(); gateEl.style.display='none';
  } else alert('Неверные учётные данные');
});

/* ----- Session helpers ----- */
function renderSessionInfo(){
  const p = PILOTS.find(x=>x.id===SESSION.pilotId);
  signedUser.textContent = p ? `${p.name} (${p.callSign})` : '—';
  sessionInfo.textContent = SESSION.isAdmin ? 'Admin session' : (p ? `Вошёл как ${p.callSign}` : 'Неавторизован');
}
function signInAsPilot(pilotId){ SESSION.pilotId = pilotId; SESSION.isAdmin = false; sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); renderSessionInfo(); gateEl.style.display='none'; }
function signOutPilot(){ SESSION.pilotId = null; SESSION.isAdmin = false; sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); renderSessionInfo(); gateEl.style.display='flex'; }

/* ----- UI handlers ----- */
genBtn.addEventListener('click', ()=>{ if(lastReservation && lastReservation.token){ if(!confirm('У вас есть активный резерв. Создать новый?')) return; cancelReservationByToken(lastReservation.token); lastReservation=null; renderReservationCard(null); } generateFlight(); });
demoBtn.addEventListener('click', ()=>{ const idx = AIRLINES.findIndex(a=>a.name==='SunExpress'); if(idx>=0) chosenAirIndex = idx; generateFlight(); });
resetBtn.addEventListener('click', ()=>{ chosenAirIndex=null; chosenDur=null; resultArea.innerHTML=''; resultArea.style.display='none'; confirmedSection.innerHTML=''; lastReservation=null; });

pilotSearch.addEventListener('input', renderPilots);
pilotBaseFilter.addEventListener('change', renderPilots);
toggleAdmin.addEventListener('click', ()=>{ SESSION.isAdmin = !SESSION.isAdmin; sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); renderSessionInfo(); renderPilots(); });

filterAirline.addEventListener('change', renderRoutes);
filterHub.addEventListener('change', renderRoutes);
refreshRoutes.addEventListener('click', renderRoutes);

filterFleetAirline.addEventListener('change', renderFleet);
filterFleetStatus.addEventListener('change', renderFleet);
refreshFleet.addEventListener('click', renderFleet);

/* ----- Init render ----- */
function initAll(){
  renderDurations(); renderAirlines(); renderPilots(); renderBaseFilter(); renderAssignLog();
  renderFilterOptions(); renderRoutes(); renderFleet(); renderSessionInfo();
  gateEl.style.display = 'flex'; // always show gate on load (per request)
}
initAll();

/* Expose debug */
window._demo = { PILOTS, ROUTES, AIRLINES, FLEET, renderAll: initAll, CODEWORD };
</script>
</body>
</html>
