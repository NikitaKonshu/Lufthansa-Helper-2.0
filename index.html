<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lufthansa Helper — Directions + Fleet search (fixed)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg-top:#041426; --bg-bot:#072b3a;
  --text:#eaf4ff; --muted:#9fc0d8;
  --accent:#ffd54a; --accent-2:#ffb84a;
  font-family: Inter, system-ui, Roboto, Arial, sans-serif;
  font-size:15px;
}

/* Reset + layout */
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  margin:0;padding:20px;
  background: linear-gradient(180deg,var(--bg-top),var(--bg-bot));
  color:var(--text); -webkit-font-smoothing:antialiased;
  display:flex;justify-content:center;align-items:flex-start;
}
.container{width:100%;max-width:1180px}

/* Card */
.card{border-radius:14px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(8px);box-shadow:0 18px 48px rgba(2,8,20,0.5)}

/* Header */
.header{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:14px;background:linear-gradient(90deg,#06384a,#073a4f)}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#073842,#043430);display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);font-size:18px}
.title{font-weight:800}
.subtitle{font-size:12px;color:var(--muted)}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:12px;position:relative}
.tab{padding:10px 14px;border-radius:12px;background:transparent;color:var(--text);font-weight:700;cursor:pointer;transition:transform .18s,color .18s}
.tab.active{ transform:translateY(-4px) }

/* underline */
.tabs .liquid-underline{ position:absolute; height:6px; bottom:-8px; border-radius:6px; background: linear-gradient(90deg,#ffd54a,#ffb84d); transition:left 300ms cubic-bezier(.2,.9,.2,1), width 300ms; box-shadow:0 8px 28px rgba(255,170,60,0.12); }

/* pills + overlays */
.filter-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.pill{
  --pad-y:8px; --pad-x:12px;
  position:relative;
  display:inline-flex;align-items:center;gap:10px;padding:var(--pad-y) var(--pad-x);
  border-radius:999px; cursor:pointer; user-select:none; border:1px solid rgba(255,255,255,0.06);
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
  color:var(--text); font-weight:800; font-size:14px;
  transition: transform 160ms, box-shadow 220ms, background 220ms;
  overflow:visible;
}

/* LED backdrop */
.pill .led {
  position:absolute;
  left:50%; top:50%;
  width:160%; height:88%;
  transform:translate(-50%,-50%) scale(0.98);
  border-radius:999px;
  z-index:0;
  pointer-events:none;
  filter: blur(30px) saturate(160%);
  opacity:0.14;
  transition: opacity 200ms ease, transform 200ms ease;
}
.pill .led-rim{
  position:absolute; inset:0; border-radius:999px; z-index:0; pointer-events:none;
  box-shadow: 0 0 60px rgba(255,255,255,0.03) inset;
  mix-blend-mode: screen; opacity:0.12;
}
/* pulsing highlight */
@keyframes ledPulse { 0%{opacity:0.30;transform:translate(-50%,-50%) scale(1)}50%{opacity:0.46;transform:translate(-50%,-50%) scale(1.04)}100%{opacity:0.30;transform:translate(-50%,-50%) scale(1)} }
.pill.active .led{ opacity:0.36; transform:translate(-50%,-50%) scale(1.02); animation: ledPulse 2400ms ease-in-out infinite; }
.pill:hover .led{ opacity:0.28; transform:translate(-50%,-50%) scale(1.06); }

/* label above glow */
.pill .pill-label{ position:relative; z-index:2; display:inline-flex;align-items:center;gap:8px }

/* airline dot */
.airline-dot{ width:10px; height:10px; border-radius:50%; display:inline-block; flex:0 0 10px; }

/* buttons */
.action-btn{ position:relative; overflow:hidden; display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; border:0; font-weight:800; cursor:pointer; min-width:140px; box-shadow:0 20px 60px rgba(2,8,20,0.45); transition:transform 160ms,box-shadow 160ms,filter 220ms;}
.action-cancel{ background: linear-gradient(180deg, rgba(6,22,30,0.9), rgba(3,12,18,0.85)); color: #eaf4ff; }
.action-confirm{ background: linear-gradient(90deg, #ffe58a, #ffd54a 60%); color:#04202a; }

/* Arrived button */
.btn-arrived{ display:inline-flex; align-items:center; justify-content:center; padding:8px 12px; border-radius:10px; font-weight:800; cursor:pointer; background: linear-gradient(90deg,#7ee7a9,#3bd27f); color:#042022; border:0; box-shadow:0 12px 46px rgba(20,150,80,0.18); }

/* Panels layout */
.layout{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:14px}
@media(max-width:1000px){ .layout{grid-template-columns:1fr} }

/* route list */
.route-list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.route-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);cursor:pointer;gap:12px}
.route-left{display:flex;flex-direction:column;gap:6px}
.route-title{font-weight:800;font-size:16px;color:#eaf4ff}
.route-sub{font-size:13px;color:var(--muted)}
.route-meta{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
.airline-pill{display:inline-flex;align-items:center;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--text);font-weight:800;font-size:13px;border:1px solid rgba(255,255,255,0.03)}
.duration-tag{font-size:13px;color:var(--muted);background:rgba(255,255,255,0.02);padding:4px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}

/* confirmed */
.confirmed{margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(200,245,194,0.04), rgba(0,0,0,0.02));border-left:4px solid #c8f5c2}
.confirmed .big{font-weight:900;font-size:16px;color:#04202a}
.confirmed .muted{font-size:13px;color:var(--muted)}

/* modals */
.modal-back{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:9999;opacity:1}
.modal{width:min(720px,94%);padding:18px;border-radius:12px;background:linear-gradient(180deg,#062b31,#04222a);border:1px solid rgba(255,255,255,0.03);box-shadow:0 40px 160px rgba(2,8,20,0.7)}
.modal h3{margin:0;color:var(--accent);font-weight:800}

/* utilities */
.kv{font-size:13px;color:var(--muted)}
.input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
.small{font-size:13px}
.hidden{display:none}
.sr-only{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
.form-row{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
<div class="container">
  <header class="header card">
    <div class="brand">
      <div class="logo">LH</div>
      <div>
        <div class="title">Lufthansa Helper</div>
        <div class="subtitle small">Directions + Fleet search</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <div id="sessionBadge" class="kv small">Неавторизован</div>
      <button id="logoutBtn" class="pill" style="display:none">Выйти</button>
      <button id="openGateBtn" class="pill" style="background:linear-gradient(180deg,#fff0b8,#ffd96a);color:#04202a;border:0">Войти</button>
    </div>
  </header>

  <div class="layout">
    <main>
      <div class="main-card card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:900">Рабочая область</div>
            <div class="kv">Вкладка Направления теперь позволяет выбирать рейс и проходить подтверждение как в Генерации; Флот — расширенный поиск</div>
          </div>
        </div>

        <div class="tabs" style="margin-top:12px">
          <div id="tabGenerate" class="tab active">Генерация</div>
          <div id="tabRoutes" class="tab">Направления</div>
          <div id="tabFleet" class="tab">Флот</div>
          <div class="liquid-underline" id="liquidUnderline" style="left:0;width:0"></div>
        </div>

        <!-- Generator controls (existing) -->
        <div id="generatorControls" style="display:flex;align-items:center;gap:12px;margin-top:6px" class="filter-row">
          <div style="display:flex;align-items:center;gap:8px">
            <div style="font-weight:800;margin-right:6px">Авиакомпании</div>
            <div id="airlines" style="display:flex;gap:8px;align-items:center"></div>
          </div>

          <div style="display:flex;align-items:center;gap:8px;margin-left:12px">
            <div style="font-weight:800;margin-right:6px">Время</div>
            <div id="durations" style="display:flex;gap:8px;align-items:center"></div>
          </div>

          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <div id="pilotBadge" class="pilot-chip">Пилот: <strong id="pilotName">—</strong></div>
            <button id="genBtn" class="pill" style="background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#062323;border:0">Сгенерировать</button>
          </div>
        </div>

        <div style="margin-top:12px" id="generatorNote" class="kv">Нажми "Сгенерировать" — система создаст бронь; затем подтверди или отмени.</div>

        <!-- Pending block (reused) -->
        <div id="pendingReservationBlock" class="card" style="display:none;margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Рейс готов к подтверждению</div>
            <div class="kv small" id="pendingTimer">Бронь действует 120s</div>
          </div>
          <div id="pendingInfo" class="kv small" style="margin-top:8px"></div>
          <div style="display:flex;justify-content:flex-end;margin-top:12px">
            <div style="display:flex;gap:8px">
              <button id="cancelPendingBtn" class="action-btn action-cancel">Отменить бронь</button>
              <button id="confirmPendingBtn" class="action-btn action-confirm">Подтвердить рейс</button>
            </div>
          </div>
        </div>

        <!-- Confirmed result -->
        <div id="confirmedSection" class="confirmed hidden" style="display:none"></div>

        <!-- Panel: Routes (выбор рейсов без генерации) -->
        <div id="panelRoutes" class="panel hidden" style="margin-top:14px;display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div style="font-weight:800">Направления</div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="filterAirline" class="input"><option value="all">Все авиакомпании</option></select>
              <select id="filterHub" class="input"><option value="all">Все хабы</option></select>
              <select id="filterDuration" class="input"><option value="all">Все длительности</option><option value="0">1–2ч</option><option value="1">3–4ч</option><option value="2">5–6ч</option><option value="3">7–8ч</option></select>
            </div>
          </div>

          <div id="routesList" class="route-list" style="margin-top:12px"></div>
          <div class="kv small" style="margin-top:8px">Клик по рейсу откроет окно подтверждения. В Directions генерация не запускается — только выбор из списка.</div>
        </div>

        <!-- Panel: Fleet (расширенный поиск по хабу и max flight minutes) -->
        <div id="panelFleet" class="panel hidden" style="margin-top:14px;display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div style="font-weight:800">Флот — расширенный поиск</div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="filterFleetAirline" class="input"><option value="all">Все</option></select>
              <select id="filterFleetHub" class="input"><option value="any">Все хабы</option></select>
              <input id="filterFleetMaxFlight" class="input" placeholder="Макс длит. рейса (мин)" style="width:160px" />
              <select id="filterFleetStatus" class="input"><option value="all">Все статусы</option><option value="idle">idle</option><option value="reserved">reserved</option><option value="inFlight">inFlight</option></select>
            </div>
          </div>
          <div id="fleetList" style="margin-top:12px"></div>
          <div class="kv small" style="margin-top:8px">Поиск фильтрует самолёты по их location hub и по допустимой длительности полёта (maxFlightMinutes).</div>
        </div>

      </div>
    </main>

    <aside>
      <div class="sidebar-card card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Пилоты</div>
          <div class="kv small">Demo</div>
        </div>
        <div style="margin-top:8px"><input id="pilotSearch" class="input" placeholder="Поиск" /></div>
        <div id="pilotList" style="margin-top:8px"></div>
        <div class="kv small" style="margin-top:8px">Переключение между аккаунтами запрещено при активной сессии.</div>
      </div>

      <div class="sidebar-card card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Журнал</div>
          <div><button id="showGate" class="pill">Открыть вход</button></div>
        </div>
        <div id="assignLog" style="margin-top:8px"></div>
      </div>
    </aside>
  </div>
</div>

<!-- Login modal -->
<div id="gateModal" class="modal-back" style="display:none">
  <div class="modal">
    <h3>Вход</h3>
    <div class="kv small" style="margin-top:8px">Введите позывной и пароль или используйте кодовое слово</div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <input id="loginCall" class="input" placeholder="Позывной" />
      <input id="loginPass" class="input" placeholder="Пароль или кодовое слово" type="password" />
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="btnLoginPilot" class="pill" style="background:linear-gradient(180deg,#fff0b8,#ffd96a);color:#04202a;border:0">Войти</button>
      <button id="btnCloseGate" class="pill">Закрыть</button>
    </div>
    <div class="kv small" style="margin-top:8px">Кодовое слово: <strong>quickaccess2025</strong></div>
  </div>
</div>

<!-- Confirm modal (используется для Routes selection и pending confirm) -->
<div id="confirmModal" class="modal-back" style="display:none">
  <div class="modal">
    <h3>Подтвердить рейс</h3>
    <div class="kv small" style="margin-top:8px">Проверьте детали и подтвердите или отмените бронь.</div>
    <div id="confirmDetails" style="margin-top:12px;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border:1px solid rgba(255,255,255,0.03)"></div>
    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px">
      <button id="confirmCancel" class="pill">Отменить бронь</button>
      <button id="confirmAccept" class="pill" style="background:linear-gradient(90deg,#ffe58a,#ffd54a);color:#04202a;border:0">Подтвердить рейс</button>
    </div>
  </div>
</div>

<!-- Route modal (view-only) -->
<div id="routeModal" class="modal-back" style="display:none">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><div id="routeTitle" style="font-weight:900"></div><div id="routeSub" class="kv small" style="margin-top:6px"></div></div>
      <div id="routeDur" class="kv small"></div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:12px">
      <button id="routeCloseBtn" class="pill">Закрыть</button>
    </div>
  </div>
</div>

<script>
/* ================= DATA & STATE ================= */
const CODEWORD='quickaccess2025';
const SESSION_KEY='lh_dirs_fleet_v1';
const CURRENT_FLIGHT_PREFIX='current_flight:';

/* Airlines */
const AIRLINES=[
  {name:"Lufthansa",hubs:["EDDF","EDDM","EDDH"],color:"#1E6FFF",icao:"LH"},
  {name:"Eurowings",hubs:["EDDF","EDDM"],color:"#8A4BFF",icao:"EW"},
  {name:"SunExpress",hubs:["EDDF","EDDM"],color:"#FF8A3D",icao:"SX"}
];

/* ROUTES (example expanded) */
const ROUTES=(function(){
  const base = [
    {airline:"Lufthansa",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Oslo",toICAO:"ENGM",durationMinutes:120},
    {airline:"Lufthansa",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Amsterdam",toICAO:"EHAM",durationMinutes:70},
    {airline:"SunExpress",fromCity:"Frankfurt",fromICAO:"EDDF",toCity:"Antalya",toICAO:"LTAI",durationMinutes:180},
    {airline:"Eurowings",fromCity:"Munich",fromICAO:"EDDM",toCity:"Zurich",toICAO:"LSZH",durationMinutes:60},
    {airline:"Lufthansa",fromCity:"Munich",fromICAO:"EDDM",toCity:"Berlin",toICAO:"EDDB",durationMinutes:50}
  ];
  const expanded=[];
  for(let i=0;i<220;i++){
    base.forEach((r,idx)=>{
      const c = Object.assign({}, r);
      c.id = `route_${idx}_${i}`;
      if(i>0) c.toCity = `${r.toCity} ${i}`;
      expanded.push(c);
    });
  }
  return expanded;
})();

/* FLEET with maxFlightMinutes property for filtering */
const FLEET=[
  {id:'LH-A320-01',airline:'Lufthansa',type:'A320',seats:180,turnaround:40,status:'idle',locationICAO:'EDDF',maxFlightMinutes:240},
  {id:'EW-A320-01',airline:'Eurowings',type:'A320',seats:180,turnaround:40,status:'idle',locationICAO:'EDDM',maxFlightMinutes:180},
  {id:'SX-B737-01',airline:'SunExpress',type:'737-800',seats:189,turnaround:35,status:'idle',locationICAO:'EDDF',maxFlightMinutes:300}
];

/* Pilots */
let PILOTS=[
  {id:'pilot_loui',name:'Loui Desulier',callSign:'FRENCH',verified:true,password:'louiSecret'},
  {id:'pilot_ivan',name:'Ivan Petrov',callSign:'IPET',verified:true},
  {id:'pilot_anna',name:'Anna Müller',callSign:'AMUL',verified:false}
];

/* State */
let FLEET_LOG=[];
let PENDING_RESERVATION = null;
let SESSION=(function(){ try{ const s=sessionStorage.getItem(SESSION_KEY); return s?JSON.parse(s):{pilotId:null}; }catch(e){return {pilotId:null}; } })();
const DURATIONS=[
  {label:"1–2ч",min:60,max:120},
  {label:"3–4ч",min:180,max:240},
  {label:"5–6ч",min:300,max:360},
  {label:"7–8ч",min:420,max:480}
];
let chosenDur=null;

/* ================= HELPERS ================= */
function uid(p='id'){return p+'_'+Math.random().toString(36).slice(2,9);}
function nowMs(){return Date.now();}
function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
function saveSession(){ try{ sessionStorage.setItem(SESSION_KEY, JSON.stringify(SESSION)); }catch(e){} }
function getCFKey(pid){ return CURRENT_FLIGHT_PREFIX + (pid||'anon'); }
function persistCurrentFlight(pilotId,obj){ try{ localStorage.setItem(getCFKey(pilotId), JSON.stringify(obj)); }catch(e){} }
function loadCurrentFlight(pilotId){ try{ const v=localStorage.getItem(getCFKey(pilotId)); return v?JSON.parse(v):null;}catch(e){return null;} }
function clearCurrentFlight(pilotId){ try{ localStorage.removeItem(getCFKey(pilotId)); }catch(e){} }

/* ================= UI REFS ================= */
const airlinesWrap=document.getElementById('airlines');
const durationsWrap=document.getElementById('durations');
const pilotNameEl=document.getElementById('pilotName');
const pilotListEl=document.getElementById('pilotList');
const pilotSearch=document.getElementById('pilotSearch');
const assignLog=document.getElementById('assignLog');

const confirmedSection = document.getElementById('confirmedSection');

const filterAirline=document.getElementById('filterAirline');
const filterHub=document.getElementById('filterHub');
const filterDuration=document.getElementById('filterDuration');
const routesList=document.getElementById('routesList');

const filterFleetAirline=document.getElementById('filterFleetAirline');
const filterFleetHub=document.getElementById('filterFleetHub');
const filterFleetMaxFlight=document.getElementById('filterFleetMaxFlight');
const filterFleetStatus=document.getElementById('filterFleetStatus');
const fleetList=document.getElementById('fleetList');

const gateModal=document.getElementById('gateModal');
const openGateBtn=document.getElementById('openGateBtn');
const btnCloseGate=document.getElementById('btnCloseGate');
const btnLoginPilot=document.getElementById('btnLoginPilot') || document.getElementById('btnLoginPilot');
const logoutBtn=document.getElementById('logoutBtn');
const sessionBadge=document.getElementById('sessionBadge');

const tabGenerate=document.getElementById('tabGenerate');
const tabRoutes=document.getElementById('tabRoutes');
const tabFleet=document.getElementById('tabFleet');

const confirmModal=document.getElementById('confirmModal');
const confirmDetails=document.getElementById('confirmDetails');

const routeModal=document.getElementById('routeModal');
const routeTitleEl=document.getElementById('routeTitle');
const routeSubEl=document.getElementById('routeSub');
const routeDurEl=document.getElementById('routeDur');

const genBtn = document.getElementById('genBtn');

const pendingBlock = document.getElementById('pendingReservationBlock');
const pendingInfo = document.getElementById('pendingInfo');
const pendingTimer = document.getElementById('pendingTimer');

const liquidUnderline = document.getElementById('liquidUnderline');
const generatorControls = document.getElementById('generatorControls');

/* ================= RENDER & LOGIC ================= */

/* readable text color for contrast */
function readableTextColor(hex){
  if(!hex) return '#ffffff';
  const h = hex.replace('#','');
  const r = parseInt(h.substring(0,2),16);
  const g = parseInt(h.substring(2,4),16);
  const b = parseInt(h.substring(4,6),16);
  const lum = 0.2126 * r + 0.7152 * g + 0.0722 * b;
  return lum > 160 ? '#062323' : '#ffffff';
}

/* ---------- AIRLINE PILLS (LED) ---------- */
function renderAirlinePills(){
  airlinesWrap.innerHTML='';
  AIRLINES.forEach(a=>{
    const btn=document.createElement('button');
    btn.className='pill';
    btn.setAttribute('data-airline', a.name);

    const led = document.createElement('div'); led.className='led';
    led.style.background = `radial-gradient(60% 60% at 50% 40%, ${a.color}CC 0%, ${a.color}99 8%, ${a.color}55 22%, transparent 46%), ${a.color}33`;
    led.style.opacity = '0.12';
    btn.appendChild(led);

    const rim = document.createElement('div'); rim.className='led-rim';
    rim.style.boxShadow = `0 0 60px ${a.color}AA, 0 0 140px ${a.color}66`;
    rim.style.opacity = '0.08';
    btn.appendChild(rim);

    const label = document.createElement('span'); label.className='pill-label';
    label.innerHTML = `<span class="airline-dot" style="background:${a.color}"></span><span style="font-weight:800">${esc(a.name)}</span>`;
    label.style.color = '#ffffff';
    label.style.zIndex = 2;
    btn.appendChild(label);

    btn.addEventListener('click', ()=>{
      const wasActive = btn.classList.contains('active');
      Array.from(airlinesWrap.children).forEach(n=>{
        n.classList.remove('active');
        const chLed = n.querySelector('.led'); const chRim = n.querySelector('.led-rim'); const lab = n.querySelector('.pill-label');
        if(chLed){ chLed.style.opacity = '0.12'; chLed.style.transform='translate(-50%,-50%) scale(0.98)'; }
        if(chRim) chRim.style.opacity = '0.08';
        if(lab) lab.style.color = '#ffffff';
      });
      if(!wasActive){
        btn.classList.add('active');
        led.style.opacity = '0.46';
        rim.style.opacity = '0.44';
        label.style.color = readableTextColor(a.color);
        if(filterAirline) filterAirline.value = a.name;
      } else {
        if(filterAirline) filterAirline.value = 'all';
      }
      renderRoutesPane();
    });

    btn.addEventListener('mouseenter', ()=> {
      if(!btn.classList.contains('active')){ led.style.opacity = '0.28'; rim.style.opacity = '0.24'; }
      btn.style.transform = 'translateY(-3px)';
      btn.style.boxShadow = `0 28px 120px ${a.color}33`;
    });
    btn.addEventListener('mouseleave', ()=> {
      if(!btn.classList.contains('active')){ led.style.opacity = '0.12'; rim.style.opacity = '0.08'; }
      btn.style.transform = '';
      btn.style.boxShadow = '';
    });

    airlinesWrap.appendChild(btn);
  });
}

/* ---------- DURATION PILLS ---------- */
function renderDurationPills(){
  durationsWrap.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const btn=document.createElement('button');
    btn.className='pill';
    btn.setAttribute('data-dur', i);
    btn.innerHTML = `<span class="pill-label">${d.label}</span>`;
    btn.addEventListener('click', ()=>{
      const wasActive = btn.classList.contains('active');
      Array.from(durationsWrap.children).forEach(n=>n.classList.remove('active'));
      if(!wasActive){ btn.classList.add('active'); chosenDur = i; if(filterDuration) filterDuration.value = i; } else { chosenDur=null; if(filterDuration) filterDuration.value='all'; }
      renderRoutesPane();
    });
    durationsWrap.appendChild(btn);
  });
}

/* ---------- PILOTS, LOG ---------- */
function renderPilots(){
  pilotListEl.innerHTML='';
  const q=(pilotSearch.value||'').toLowerCase().trim();
  const list = PILOTS.filter(p=> !q || (p.name+' '+p.callSign).toLowerCase().includes(q));
  list.forEach(p=>{
    const row=document.createElement('div'); row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginTop='8px';
    row.innerHTML = `<div><strong>${esc(p.name)}</strong><div class="kv small">${esc(p.callSign)} ${p.verified? '· Verified':''}</div></div>`;
    const btn=document.createElement('button');
    btn.className='pill';
    btn.textContent='Войти';
    btn.addEventListener('click', ()=> { document.getElementById('loginCall').value = p.callSign || ''; showGate(); });
    row.appendChild(btn);
    pilotListEl.appendChild(row);
  });
}
function renderAssignLog(){
  assignLog.innerHTML='';
  if(!FLEET_LOG.length){ assignLog.innerHTML='<div class="kv small">Пусто</div>'; return; }
  FLEET_LOG.slice(-200).reverse().forEach(e=>{
    const el=document.createElement('div'); el.className='kv small'; el.style.marginTop='6px';
    el.textContent = `${new Date(e.ts).toLocaleString()} — ${e.event}${e.aircraft? ' ' + e.aircraft : ''}${e.route? ' ' + e.route : ''}`;
    assignLog.appendChild(el);
  });
}

/* ---------- FLEET RENDER + SEARCH (по хабу и maxFlightMinutes) ---------- */
function renderFleetList(){
  fleetList.innerHTML='';
  const fa = filterFleetAirline && filterFleetAirline.value || 'all';
  const hub = filterFleetHub && filterFleetHub.value || 'any';
  const maxFlightStr = filterFleetMaxFlight && filterFleetMaxFlight.value && filterFleetMaxFlight.value.trim();
  const maxFlight = maxFlightStr ? Number(maxFlightStr) : null;
  const fs = filterFleetStatus && filterFleetStatus.value || 'all';

  const list = FLEET.filter(a=>{
    if(fa!=='all' && a.airline !== fa) return false;
    if(hub && hub!=='any' && a.locationICAO !== hub) return false;
    if(fs!=='all' && a.status !== fs) return false;
    if(maxFlight && (typeof a.maxFlightMinutes === 'number') && a.maxFlightMinutes < maxFlight) return false;
    return true;
  });

  if(!list.length){ fleetList.innerHTML='<div class="kv small">Нет самолётов по критериям</div>'; return; }

  list.forEach(a=>{
    const airlineObj = AIRLINES.find(x=>x.name===a.airline) || {color:'#ffd54a'};
    const el=document.createElement('div'); el.className='fleet-item';
    el.style.padding='10px'; el.style.borderRadius='10px'; el.style.marginTop='8px'; el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center';
    el.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style="width:10px;height:10px;border-radius:50%;background:${airlineObj.color}"></div><div><strong>${esc(a.id)}</strong><div class="kv small">${esc(a.airline)} · ${esc(a.type)} · ${a.seats} мест · ${esc(a.locationICAO)}</div><div class="kv small">maxFlight ${a.maxFlightMinutes} мин</div></div></div><div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px"><div class="kv small">${esc(a.status)}</div><div><button class="pill btn-mark-arrived" data-aircraft="${esc(a.id)}" style="background:linear-gradient(90deg,#7ee7a9,#3bd27f);color:#042022;border:0;padding:6px 8px">Прилетел</button></div></div>`;
    fleetList.appendChild(el);

    const btnArr = el.querySelector('.btn-mark-arrived');
    if(btnArr){
      btnArr.addEventListener('click', ()=> {
        const pilotKeys = Object.keys(localStorage).filter(k=>k.startsWith(CURRENT_FLIGHT_PREFIX));
        let route = {fromICAO:'',toICAO:a.locationICAO,durationMinutes:0};
        let pilotId = null;
        for(const k of pilotKeys){
          try{
            const cur = JSON.parse(localStorage.getItem(k));
            if(cur && cur.aircraftId === a.id){ route = cur.route || route; pilotId = cur.pilotId || null; break; }
          }catch(e){}
        }
        markArrival(a.id, pilotId, route);
      });
    }
  });
}

/* ---------- ROUTES (выбор рейса в Directions) ---------- */
function renderRoutesPane(){
  routesList.innerHTML='';
  const fa = filterAirline && filterAirline.value || 'all';
  const fh = filterHub && filterHub.value || 'all';
  const fd = filterDuration && filterDuration.value || 'all';
  let list = ROUTES.filter(r=>{
    if(fa!=='all' && r.airline !== fa) return false;
    if(fh!=='all' && r.fromICAO !== fh && r.toICAO !== fh) return false;
    if(fd!=='all'){ const range=DURATIONS[Number(fd)]; if(!(r.durationMinutes>=range.min && r.durationMinutes<=range.max)) return false; }
    return true;
  });
  if(!list.length){ routesList.innerHTML='<div class="kv small">Нет направлений</div>'; return; }
  list.slice(0,800).forEach(r=>{
    const row=document.createElement('div'); row.className='route-item';
    const airlineObj = AIRLINES.find(a=>a.name===r.airline) || {color:'#ffd54a'};
    row.innerHTML = `
      <div class="route-left">
        <div class="route-title">${esc(r.fromICAO)} → ${esc(r.toICAO)}</div>
        <div class="route-sub">${esc(r.fromCity)} → ${esc(r.toCity)}</div>
      </div>
      <div class="route-meta">
        <div class="airline-pill" style="border-color:rgba(255,255,255,0.03);background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005))">
          <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${airlineObj.color};margin-right:8px"></span>
          ${esc(r.airline)}
        </div>
        <div class="duration-tag">${r.durationMinutes} мин</div>
      </div>
    `;
    // click in Routes: open confirmation flow (reserve candidate aircraft then show confirm modal)
    row.addEventListener('click', ()=> {
      openConfirmFromRoute(r);
    });
    routesList.appendChild(row);
  });
}

/* ---------- RESERVATION / CONFIRM / RELEASE (shared flow) ---------- */
function reserveAircraft(ac, ownerId, ttlMs=120000){
  if(ac.status==='inFlight') return {ok:false,reason:'inflight'};
  if(ac.status==='reserved') return {ok:false,reason:'already_reserved'};
  ac.status='reserved'; ac.reservedBy=ownerId;
  ac.reservedToken = ownerId+':'+Date.now()+':'+Math.random().toString(36).slice(2,8);
  ac.reservedUntil = nowMs()+ttlMs;
  FLEET_LOG.push({ts:nowMs(),event:'reserved',aircraft:ac.id});
  renderAssignLog(); renderFleetList();
  return {ok:true,token:ac.reservedToken,expires:ac.reservedUntil};
}

function confirmReservation(token,route,pilotId){
  const ac = FLEET.find(a=>a.reservedToken===token);
  if(!ac) return {ok:false,reason:'no_res'};
  const p = PILOTS.find(x=>x.id===pilotId);
  if(!(p && p.verified)) return {ok:false,reason:'pilot_not_verified'};
  const now=nowMs(); const durMs = (Number(route.durationMinutes)||120)*60*1000;
  ac.status='inFlight'; ac.availableAt = now + durMs + (ac.turnaround||0)*60*1000; ac.nextLocation = route.toICAO;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;
  FLEET_LOG.push({ts:now,event:'assign_confirmed',aircraft:ac.id,route:`${route.fromICAO}->${route.toICAO}`});
  renderAssignLog(); renderFleetList();
  const current = {
    flightId: uid('flt'),
    aircraftId: ac.id,
    aircraftType: ac.type,
    seats: ac.seats,
    airline: ac.airline,
    route,
    pilotId: p.id,
    pilotName: p.name,
    pilotCall: p.callSign,
    confirmedAt: now,
    etaMs: durMs
  };
  persistCurrentFlight(p.id,current);
  renderCurrentFlight();
  renderConfirmedSection(ac,route,p.id);
  return {ok:true,ac,current};
}

function releaseReservationByToken(token){
  if(!token) return false;
  let found=false;
  FLEET.forEach(a=>{
    if(a.reservedToken && a.reservedToken === token){
      a.status='idle';
      delete a.reservedBy;
      delete a.reservedToken;
      delete a.reservedUntil;
      FLEET_LOG.push({ts: nowMs(), event:'reservation_cancelled', aircraft: a.id});
      found=true;
    }
  });
  renderAssignLog(); renderFleetList();
  return found;
}

/* ---------- ROUTES -> CONFIRM FLOW (no generation) ---------- */
function openConfirmFromRoute(route){
  // find idle candidate aircraft at route.fromICAO first, otherwise any idle
  let candidates = FLEET.filter(ac=> (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status==='idle' && (!ac.maxFlightMinutes || ac.maxFlightMinutes >= route.durationMinutes));
  if(!candidates.length) candidates = FLEET.filter(ac=>ac.status==='idle' && (!ac.maxFlightMinutes || ac.maxFlightMinutes >= route.durationMinutes));
  if(!candidates.length){
    alert('Нет подходящих свободных самолётов для этого направления (учтён maxFlightMinutes).');
    return;
  }
  candidates.sort((a,b)=> Math.abs(a.seats-180)-Math.abs(b.seats-180));
  const candidate = candidates[0];

  const chosenPilot = choosePilotForAssignment();
  if(!chosenPilot){ alert('Пожалуйста, войдите — пилот назначается автоматически.'); showGate(); return; }

  const r = reserveAircraft(candidate, chosenPilot.id);
  if(!r.ok){ alert('Ошибка резерва: '+r.reason); return; }

  PENDING_RESERVATION = { token: r.token, aircraftId: candidate.id, aircraft: candidate, route, pilotId: chosenPilot.id, expires: r.expires || (nowMs()+120000), via:'routes' };
  pendingBlock.style.display = 'block';
  pendingInfo.textContent = `${candidate.id} · ${candidate.airline} · ${route.fromICAO} → ${route.toICAO} · ${route.durationMinutes} мин`;
  updatePendingTimer();
  openConfirmModalForPending();

  if(window._routesPendingInterval) clearInterval(window._routesPendingInterval);
  window._routesPendingInterval = setInterval(()=>{
    if(!PENDING_RESERVATION) { clearInterval(window._routesPendingInterval); window._routesPendingInterval=null; pendingBlock.style.display='none'; return; }
    if(nowMs() > (PENDING_RESERVATION.expires||0)){
      releaseReservationByToken(PENDING_RESERVATION.token);
      PENDING_RESERVATION = null;
      pendingBlock.style.display='none';
      clearInterval(window._routesPendingInterval); window._routesPendingInterval=null;
    } else updatePendingTimer();
  }, 800);
}

/* modal confirm content (shared) */
function openConfirmModalForPending(){
  if(!PENDING_RESERVATION) return;
  const {aircraft, route, pilotId} = PENDING_RESERVATION;
  const p = PILOTS.find(x=>x.id===pilotId) || {};
  confirmDetails.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${esc(route.fromICAO)} → ${esc(route.toICAO)}</strong><div class="kv small">${esc(route.fromCity)} → ${esc(route.toCity)} · ${route.durationMinutes} мин</div></div>
      <div class="kv small">${esc(route.airline)}</div>
    </div>
    <div style="margin-top:8px" class="kv small">Aircraft: ${esc(aircraft.id)} · ${esc(aircraft.type)} · ${aircraft.seats} seats · maxFlight ${aircraft.maxFlightMinutes || '—'} мин</div>
    <div style="margin-top:8px" class="kv small">Pilot: ${esc(p.name||'—')} (${esc(p.callSign||'—')})</div>
  `;
  confirmModal.style.display = 'flex';
}

/* accept/cancel */
function acceptPendingReservation(){
  if(!PENDING_RESERVATION) return;
  const {token, route, pilotId} = PENDING_RESERVATION;
  const res = confirmReservation(token, route, pilotId);
  if(!res.ok){ alert('Не удалось подтвердить: '+(res.reason||'')); return; }
  PENDING_RESERVATION = null;
  pendingBlock.style.display = 'none';
  confirmModal.style.display = 'none';
  if(window._routesPendingInterval){ clearInterval(window._routesPendingInterval); window._routesPendingInterval=null; }
}
function cancelPendingReservation(){
  if(!PENDING_RESERVATION) return;
  const tok = PENDING_RESERVATION.token;
  const released = releaseReservationByToken(tok);
  if(!released){
    const a = FLEET.find(x=>x.id===PENDING_RESERVATION.aircraftId);
    if(a && a.status==='reserved'){ a.status='idle'; delete a.reservedToken; delete a.reservedBy; delete a.reservedUntil; FLEET_LOG.push({ts:nowMs(),event:'reservation_force_released',aircraft:a.id}); }
  }
  PENDING_RESERVATION = null;
  pendingBlock.style.display = 'none';
  confirmModal.style.display = 'none';
  if(window._routesPendingInterval){ clearInterval(window._routesPendingInterval); window._routesPendingInterval=null; }
  renderAssignLog(); renderFleetList();
}

/* update pending timer */
function updatePendingTimer(){
  if(!PENDING_RESERVATION){ pendingTimer.textContent=''; return; }
  const left = Math.max(0, Math.ceil(((PENDING_RESERVATION.expires||0)-nowMs())/1000));
  pendingTimer.textContent = `Бронь действует ${left}s`;
}

/* render confirmed UI same as generation flow */
function renderConfirmedSection(ac,route,pilotId){
  if(!confirmedSection) return;
  confirmedSection.style.display = 'block';
  confirmedSection.classList.remove('hidden');
  const airlineObj = AIRLINES.find(a=>a.name===ac.airline) || {color:'#ffd54a'};
  confirmedSection.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div class="big">${esc(ac.airline)} · ${esc(route.fromICAO)}→${esc(route.toICAO)}</div>
        <div class="kv small" style="margin-top:6px">${esc(route.fromCity)} → ${esc(route.toCity)}</div>
      </div>
      <div style="text-align:right;display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div style="font-weight:900;color:${airlineObj.color}">${esc(ac.id)}</div>
        <div class="kv small">ETA: <strong style="font-weight:800">${new Date(Date.now() + (route.durationMinutes||120)*60*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</strong></div>
        <button id="btnArrived" class="btn-arrived">Прилетел</button>
      </div>
    </div>
  `;
  const btn = document.getElementById('btnArrived');
  if(btn){
    btn.addEventListener('click', ()=> {
      markArrival(ac.id, pilotId, route);
    });
  }
}

/* mark arrival */
function markArrival(aircraftId, pilotId, route){
  const ac = FLEET.find(x=> x.id === aircraftId);
  if(!ac) return alert('Самолёт не найден');
  ac.status = 'idle';
  if(route && route.toICAO) ac.locationICAO = route.toICAO;
  delete ac.availableAt;
  delete ac.nextLocation;
  FLEET_LOG.push({ ts: nowMs(), event: 'arrived', aircraft: ac.id, route: `${route.fromICAO || ''}->${route.toICAO || ''}`, pilot: pilotId });
  if(pilotId) clearCurrentFlight(pilotId);
  if(confirmedSection){ confirmedSection.style.display='none'; confirmedSection.classList.add('hidden'); confirmedSection.innerHTML=''; }
  renderAssignLog(); renderFleetList();
  alert(`Рейс ${ac.id} помечен как прилетевший`);
}

/* ---------- AUTH, GENERATE (kept) ---------- */
function choosePilotForAssignment(){
  if(SESSION.pilotId){
    const p=PILOTS.find(x=>x.id===SESSION.pilotId); if(p) return p;
  }
  return null;
}
function generateCreatePending(){
  const chosenPilot = choosePilotForAssignment();
  if(!chosenPilot){ alert('Пожалуйста, войдите — пилот назначается автоматически.'); showGate(); return; }

  let pool = ROUTES.slice();
  const activeAir = Array.from(airlinesWrap.children).find(c=>c.classList.contains('active'));
  if(activeAir) pool = pool.filter(r=> r.airline === (activeAir.textContent||'').trim());
  if(chosenDur !== null){ const range=DURATIONS[chosenDur]; pool = pool.filter(r=> r.durationMinutes >= range.min && r.durationMinutes <= range.max); }
  if(!pool.length){ alert('Нет маршрутов по выбранным фильтрам'); return; }

  const route = pool[Math.floor(Math.random()*pool.length)];
  let candidates = FLEET.filter(ac=> (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && ac.status==='idle' && (!ac.maxFlightMinutes || ac.maxFlightMinutes >= route.durationMinutes));
  if(!candidates.length) candidates = FLEET.filter(ac=>ac.status==='idle' && (!ac.maxFlightMinutes || ac.maxFlightMinutes >= route.durationMinutes));
  if(!candidates.length){ alert('Нет свободных самолётов'); return; }
  candidates.sort((a,b)=> Math.abs(a.seats-180)-Math.abs(b.seats-180));
  const candidate = candidates[0];
  const r = reserveAircraft(candidate, chosenPilot.id);
  if(!r.ok){ alert('Ошибка резерва: '+r.reason); return; }

  PENDING_RESERVATION = { token: r.token, aircraftId: candidate.id, aircraft: candidate, route, pilotId: chosenPilot.id, expires: r.expires || (nowMs()+120000), via:'generate' };
  pendingBlock.style.display = 'block';
  pendingInfo.textContent = `${candidate.id} · ${candidate.airline} · ${route.fromICAO} → ${route.toICAO} · ${route.durationMinutes} мин`;
  updatePendingTimer();

  if(window._routesPendingInterval) clearInterval(window._routesPendingInterval);
  window._routesPendingInterval = setInterval(()=>{
    if(!PENDING_RESERVATION){ clearInterval(window._routesPendingInterval); window._routesPendingInterval=null; pendingBlock.style.display='none'; return; }
    if(nowMs() > (PENDING_RESERVATION.expires||0)){
      releaseReservationByToken(PENDING_RESERVATION.token);
      PENDING_RESERVATION = null;
      pendingBlock.style.display='none';
      clearInterval(window._routesPendingInterval); window._routesPendingInterval=null;
    } else updatePendingTimer();
  }, 800);

  openConfirmModalForPending();
}

/* ---------- MODALS, UI wiring ---------- */
function openConfirmModal(){ confirmModal.style.display='flex'; }
function closeConfirmModal(){ confirmModal.style.display='none'; }
function showGate(){ gateModal.style.display = 'flex'; }
function closeGate(){ gateModal.style.display = 'none'; }

function attemptLoginFromModal(){
  const cs = document.getElementById('loginCall').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if(!cs){ alert('Введите позывной'); return; }
  const p = PILOTS.find(x=> (x.callSign||'').toLowerCase() === cs.toLowerCase());
  if(!p){ alert('Пилот не найден'); return; }
  if(pass === CODEWORD || (p.password && pass === p.password)){
    SESSION.pilotId = p.id; saveSession(); renderAll(); closeGate();
  } else alert('Неверный пароль или кодовое слово');
}

function logout(){ if(!SESSION.pilotId) return; SESSION.pilotId = null; saveSession(); renderAll(); showGate(); }

/* confirm/cancel handlers binding */
document.getElementById('confirmAccept')?.addEventListener('click', ()=> acceptPendingReservation());
document.getElementById('confirmCancel')?.addEventListener('click', ()=> cancelPendingReservation());
document.getElementById('confirmPendingBtn')?.addEventListener('click', ()=> acceptPendingReservation());
document.getElementById('cancelPendingBtn')?.addEventListener('click', ()=> cancelPendingReservation());

openGateBtn.addEventListener('click', ()=> showGate());
btnCloseGate.addEventListener('click', ()=> closeGate());
document.getElementById('btnLoginPilot')?.addEventListener('click', ()=> attemptLoginFromModal());
logoutBtn.addEventListener('click', ()=> logout());
document.getElementById('showGate').addEventListener('click', ()=> showGate());
document.getElementById('routeCloseBtn').addEventListener('click', ()=> routeModal.style.display='none');

genBtn.addEventListener('click', ()=> {
  if(!SESSION.pilotId){ alert('Пожалуйста, войдите — пилот назначается автоматически.'); showGate(); return; }
  generateCreatePending();
});

/* search pilot input */
pilotSearch.addEventListener('input', ()=> renderPilots());

/* filters binding */
filterAirline && filterAirline.addEventListener('change', ()=> renderRoutesPane());
filterHub && filterHub.addEventListener('change', ()=> renderRoutesPane());
filterDuration && filterDuration.addEventListener('change', ()=> renderRoutesPane());

filterFleetAirline && filterFleetAirline.addEventListener('change', ()=> renderFleetList());
filterFleetHub && filterFleetHub.addEventListener('change', ()=> renderFleetList());
filterFleetMaxFlight && filterFleetMaxFlight.addEventListener('input', ()=> renderFleetList());
filterFleetStatus && filterFleetStatus.addEventListener('change', ()=> renderFleetList());

/* tabs */
function moveUnderlineTo(el){
  if(!liquidUnderline || !el) return;
  const parentRect = el.parentElement.getBoundingClientRect();
  const rect = el.getBoundingClientRect();
  liquidUnderline.style.left = (rect.left - parentRect.left) + 'px';
  liquidUnderline.style.width = rect.width + 'px';
}
tabGenerate.addEventListener('click', ()=> switchTab('generate'));
tabRoutes.addEventListener('click', ()=> switchTab('routes'));
tabFleet.addEventListener('click', ()=> switchTab('fleet'));
function switchTab(name){
  tabGenerate.classList.toggle('active', name==='generate');
  tabRoutes.classList.toggle('active', name==='routes');
  tabFleet.classList.toggle('active', name==='fleet');

  document.getElementById('panelRoutes').style.display = (name==='routes') ? 'block' : 'none';
  document.getElementById('panelFleet').style.display = (name==='fleet') ? 'block' : 'none';
  generatorControls.style.display = (name === 'generate') ? 'flex' : 'none';

  const target = name==='generate' ? tabGenerate : (name==='routes' ? tabRoutes : tabFleet);
  moveUnderlineTo(target);
}

/* render current flight */
function renderCurrentFlight(){
  if(!SESSION.pilotId){
    pilotNameEl.textContent='—';
    sessionBadge.textContent='Неавторизован';
    logoutBtn.style.display='none';
    openGateBtn.style.display='inline-block';
    return;
  }
  const p = PILOTS.find(x=>x.id===SESSION.pilotId)||{};
  pilotNameEl.textContent = p.name || '—';
  sessionBadge.textContent = p.callSign ? `Вошёл ${p.callSign}` : 'Вошёл';
  logoutBtn.style.display='inline-block'; openGateBtn.style.display='none';

  const cur = loadCurrentFlight(SESSION.pilotId);
  if(cur){
    renderConfirmedSection({id:cur.aircraftId,airline:cur.airline}, cur.route, cur.pilotId);
  } else {
    if(confirmedSection){ confirmedSection.style.display='none'; confirmedSection.classList.add('hidden'); confirmedSection.innerHTML=''; }
  }
}

/* periodic expiry loop */
setInterval(()=>{
  const now = nowMs();
  FLEET.forEach(ac=>{
    if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil <= now){
      ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil; FLEET_LOG.push({ts:now,event:'reservation_expired',aircraft:ac.id});
      if(PENDING_RESERVATION && PENDING_RESERVATION.token === ac.reservedToken){
        PENDING_RESERVATION = null; pendingBlock.style.display='none';
      }
    }
    if(ac.status==='inFlight' && ac.availableAt && ac.availableAt <= now){
      ac.status='idle'; if(ac.nextLocation) ac.locationICAO = ac.nextLocation; delete ac.availableAt; delete ac.nextLocation; FLEET_LOG.push({ts:now,event:'aircraft_available',aircraft:ac.id,location:ac.locationICAO});
    }
  });
  renderAssignLog(); renderFleetList();
},1500);

/* ---------- INIT / RENDER ALL ---------- */
function renderAll(){
  renderAirlinePills();
  renderDurationPills();
  renderPilots();
  renderAssignLog();
  renderFleetList();
  renderRoutesPane();
  renderCurrentFlight();

  if(filterAirline) filterAirline.innerHTML = '<option value="all">Все авиакомпании</option>';
  if(filterFleetAirline) filterFleetAirline.innerHTML = '<option value="all">Все</option>';
  if(filterFleetHub) filterFleetHub.innerHTML = '<option value="any">Все хабы</option>';

  AIRLINES.forEach(a=>{
    if(filterAirline){ const o=document.createElement('option'); o.value=a.name; o.textContent=a.name; filterAirline.appendChild(o); }
    if(filterFleetAirline){ const o2=document.createElement('option'); o2.value=a.name; o2.textContent=a.name; filterFleetAirline.appendChild(o2); }
    (a.hubs || []).forEach(h=>{
      if(filterHub){
        const exists = Array.from(filterHub.options).some(opt=>opt.value===h);
        if(!exists){ const o=document.createElement('option'); o.value=h; o.textContent=h; filterHub.appendChild(o); }
      }
      if(filterFleetHub){
        const exists2 = Array.from(filterFleetHub.options).some(opt=>opt.value===h);
        if(!exists2){ const o=document.createElement('option'); o.value=h; o.textContent=h; filterFleetHub.appendChild(o); }
      }
    });
  });

  if(!SESSION.pilotId){
    showGate();
    sessionBadge.textContent='Неавторизован';
    logoutBtn.style.display='none';
    openGateBtn.style.display='inline-block';
  } else {
    closeGate();
    openGateBtn.style.display='none';
    logoutBtn.style.display='inline-block';
    const p=PILOTS.find(x=>x.id===SESSION.pilotId)||{};
    sessionBadge.textContent = p.callSign ? `Вошёл ${p.callSign}` : 'Вошёл';
    pilotNameEl.textContent = p.name || '—';
    const pb = document.getElementById('pilotBadge');
    if(pb) pb.querySelector('strong').textContent = p.name || '—';
  }

  setTimeout(()=>{ moveUnderlineTo(tabGenerate); },80);
  // expose debug
  window._lh = {PILOTS,ROUTES,AIRLINES,FLEET,SESSION,FLEET_LOG};
}

/* Initialize */
renderAll();
</script>
</body>
</html>
