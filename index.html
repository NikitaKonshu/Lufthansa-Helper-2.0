<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Flight Helper — Lufthansa Group</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg-1:#031022; --bg-2:#063046;
  --text:#eaf4ff; --muted:rgba(234,244,255,0.72);
  --muted-weak:rgba(234,244,255,0.54);
  --accent:#ffd54a; --accent2:#ffbf3a;
  --glass-border:rgba(255,255,255,0.06);
  --panel-radius:12px;
  --ease-soft:cubic-bezier(.16,.84,.35,1);
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  font-size:16px;
}

/* Reset + base */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;-webkit-text-size-adjust:100%;max-width:100%;overflow-x:hidden}
body{
  min-height:100vh;color:var(--text);
  background:
    radial-gradient(900px 600px at 10% 10%, rgba(6,24,44,0.36), transparent 34%),
    radial-gradient(700px 500px at 90% 0%, rgba(4,20,36,0.28), transparent 30%),
    linear-gradient(160deg,var(--bg-1),var(--bg-2));
  padding:14px;-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  transition:background .36s var(--ease-soft);
}
body.modal-open{ overflow:hidden; }

/* Shell */
.shell{max-width:1100px;margin:0 auto;border-radius:14px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid var(--glass-border);box-shadow:0 30px 120px rgba(0,0,0,0.5)}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(255,255,255,0.02);gap:12px}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);background:linear-gradient(180deg,#052b36,#041721)}
.title{font-weight:900;font-size:17px}
.subtitle{font-size:13px;color:var(--muted-weak)}
.session{display:flex;gap:8px;align-items:center}

/* Tabs */
.tabs{display:flex;gap:8px;align-items:center}
.tab{padding:8px 10px;border-radius:10px;font-weight:800;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);cursor:pointer;font-size:14px}
.tab.active{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#06141e;transform:translateY(-3px);box-shadow:0 24px 80px rgba(255,170,40,0.12)}

/* Layout */
.container{padding:14px}
.grid{display:block}

/* Panels */
.panel{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border:1px solid var(--glass-border);margin-bottom:12px;backdrop-filter: blur(6px)}
.panel .heading {font-weight:900}
.panel .note {color:var(--muted-weak);font-size:13px;margin-top:6px}

/* Inputs */
.input-glass{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));color:var(--text);outline:none;font-size:15px}
.input-glass::placeholder{color:rgba(234,244,255,0.42)}
.input-glass:focus{box-shadow:0 18px 56px rgba(0,0,0,0.42), 0 0 20px rgba(255,200,50,0.03)}

/* Lists & cards */
.airline-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;margin-top:12px}
.airline{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .12s;overflow:hidden;position:relative}
.brand-dot{width:12px;height:12px;border-radius:3px;flex:0 0 12px}
.airline .name{font-weight:800;color:var(--text);font-size:14px}
.airline .meta{font-size:12px;color:var(--muted)}
.code-pill{margin-left:auto;padding:6px 8px;border-radius:8px;background:rgba(0,0,0,0.12);border:1px solid rgba(255,255,255,0.03);font-weight:800;font-family:ui-monospace,monospace}
.airline:hover{transform:translateY(-3px)}
.airline.selected{outline:2px solid rgba(255,190,40,0.12);transform:translateY(-4px)}

/* cards */
.card-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;margin-top:12px}
.route-card, .fleet-card{padding:10px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);position:relative;overflow:hidden}

/* time-item */
.time-item{display:inline-flex;align-items:center;justify-content:center;padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);cursor:pointer;background:linear-gradient(180deg, rgba(255,255,255,0.008), rgba(0,0,0,0.02));color:var(--text);font-weight:800;transition:all 220ms var(--ease-soft);position:relative;overflow:hidden;font-size:14px}
.time-item.selected{ color:#06141e; background:linear-gradient(90deg,var(--accent),var(--accent2)); box-shadow:0 26px 90px rgba(255,170,40,0.12);transform:translateY(-4px)}

/* buttons */
.btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 12px;border-radius:10px;border:1px solid transparent;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));color:var(--text);font-weight:800;cursor:pointer;font-size:14px;position:relative;overflow:hidden}
.btn-primary{background: linear-gradient(180deg, var(--accent), var(--accent2));color:#06141e}
.btn-secondary{background: linear-gradient(180deg, rgba(6,24,44,0.88), rgba(4,18,34,0.92));color: var(--text)}
.btn-ghost{background: transparent;color: var(--text);border: 1px solid rgba(255,255,255,0.06)}

/* modals */
.modal-backdrop{
  display:none;
  position:fixed;inset:0;z-index:17000;
  background:rgba(0,0,0,0.56);
  align-items:center;justify-content:center;padding:18px;
  pointer-events:none;
  transition:opacity .18s ease;
}
.modal-card{width:min(820px,96%);max-height:86vh;overflow:auto;border-radius:12px;padding:16px;background:linear-gradient(180deg, rgba(20,28,38,0.98), rgba(10,14,20,0.98));border:1px solid var(--glass-border);box-shadow:0 40px 140px rgba(0,0,0,0.6);color:var(--text);transform:translateY(6px);opacity:0;transition:transform 260ms var(--ease-soft),opacity 220ms var(--ease-soft)}
.modal-backdrop.showing{ pointer-events:auto; }
.modal-backdrop.showing .modal-card{ transform:none; opacity:1; }

/* mobile nav and fixes */
.mobile-nav{
  display:none;
  position:fixed;left:0;right:0;bottom:0;z-index:16000;
  background:linear-gradient(180deg, rgba(6,10,18,0.98), rgba(2,6,12,0.98));
  border-top:1px solid rgba(255,255,255,0.04);
  padding:6px 8px;
  display:flex; gap:8px; justify-content:space-around; align-items:center;
}
.mobile-nav .nav-btn{ flex:1; padding:10px 6px; border-radius:10px; font-weight:800; font-size:13px; color:var(--text); background:transparent; border:1px solid rgba(255,255,255,0.04); }
.mobile-nav .nav-btn.active{ background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#06141e; box-shadow:0 14px 40px rgba(0,0,0,0.45); transform:translateY(-2px); }

/* Prevent overflow and ensure single column on small screens */
@media(max-width:720px){
  .mobile-nav{ display:flex; }
  .container{ padding-bottom:80px; }
  .tabs{ display:none; }
  .card-grid{ grid-template-columns: 1fr !important; }
  .route-card, .fleet-card { padding:10px; }
}

/* ===== Ripple fix: ensure parents anchor and clip ripple ===== */
.btn, .airline, .time-item, .route-card, .fleet-card {
  position: relative;
  overflow: hidden;
  -webkit-tap-highlight-color: transparent;
}

/* ripple element */
.ripple {
  position: absolute;
  pointer-events: none;
  border-radius: 50%;
  transform: scale(0);
  opacity: 0.28;
  background: radial-gradient(circle at center, rgba(255,255,255,0.45), rgba(255,255,255,0.06) 30%, transparent 60%);
  transition: transform 420ms cubic-bezier(.2,.9,.2,1), opacity 360ms;
  will-change: transform, opacity, left, top;
  mix-blend-mode: screen;
}

/* Mobile fit guarantee: ensure nothing overflows */
html, body { overflow-x: hidden !important; max-width: 100%; }
.shell, .container, .panel, .card-grid, #dynamicPages, .modal-card { box-sizing: border-box; max-width: 100%; width: 100%; }
@media (max-width: 768px) {
  .card-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .airline-grid { display:flex; gap:10px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:6px; }
  .airline { min-width: 160px; flex:0 0 auto; }
  .panel { padding: 12px; margin: 8px 0; max-height: calc(100vh - 160px); overflow: auto; -webkit-overflow-scrolling:touch; }
  .modal-card { max-height: 88vh; overflow:auto; -webkit-overflow-scrolling:touch; }
  .time-row { display:flex; gap:8px; overflow-x:auto; padding-bottom:6px; }
  .route-card, .fleet-card { min-width: 0; width: 100%; }
}
@media (max-width: 420px) {
  :root { font-size: 15px; }
  .input-glass { padding: 10px 12px; font-size:15px; }
  .btn { padding:10px; font-size:14px; }
  .airline { min-width: 140px; }
}

/* protect against long words/tables */
.panel * { min-width: 0 !important; word-break: break-word; -webkit-hyphens: auto; hyphens: auto; }

/* accessibility helpers */
.visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}

/* reduce motion */
@media (prefers-reduced-motion: reduce){ *{transition:none!important;animation:none!important} }
  /* --- Mobile responsive base --- */
:root { --gap: 12px; --panel-pad: 14px; --text: #eaf4ff; --muted: rgba(255,255,255,0.75); }

html,body { height:100%; margin:0; padding:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

body { background:#001018; color:var(--text); -webkit-text-size-adjust:100%; }

/* Container safety */
.app-ui, .welcome-screen, #main-content, .panel {
  box-sizing: border-box;
  width:100% !important;
  max-width:100% !important;
  padding-left: var(--gap) !important;
  padding-right: var(--gap) !important;
}

/* Grid -> single column on small screens */
.card-grid, .fleet-list, .routes-list, .panel .grid {
  display: grid !important;
  grid-template-columns: 1fr !important;
  gap: var(--gap) !important;
}

/* Table wrapper for horizontal scroll */
.table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
table.responsive { width:100%; border-collapse:collapse; min-width: 600px; }

/* Make table cells wrap and be readable */
table.responsive td, table.responsive th {
  white-space: normal !important;
  word-break: break-word !important;
  padding: 8px 10px;
  vertical-align: top;
}

/* Buttons adapt */
button, .btn, .splash-btn {
  min-width: 0 !important;
  width: auto !important;
  padding: 8px 12px !important;
  font-size: 15px !important;
  box-sizing: border-box;
}

/* Prevent absolute positioning inside panels from breaking layout */
.panel *[style*="position: absolute"], .app-ui *[style*="position:absolute"] {
  position: static !important;
  left: auto !important;
  top: auto !important;
  transform: none !important;
}

/* Small screen tweaks */
@media (max-width: 520px) {
  .splash-inner h1 { font-size: 20px !important; }
  .splash-inner p { font-size: 14px !important; }
  .nav { gap:8px; font-size:14px; flex-wrap:wrap; }
  .panel { padding: 12px !important; border-radius:10px; }
  .fleet-item, .route-item { padding:10px 6px !important; }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  * { transition: none !important; animation: none !important; }
}
/* layout safety */
.app-shell, .app-ui, #main-content { box-sizing: border-box; width:100%; max-width:100%; }

/* двухколоночная сетка, которая автоматически сворачивается на мобильных */
.columns {
  display: grid;
  grid-template-columns: 320px 1fr; /* левый столбец фиксированно узкий, правый растёт */
  gap: 16px;
  align-items: start;
}
@media (max-width: 720px) {
  .columns { grid-template-columns: 1fr; padding: 0 12px; }
}

/* левый список авиакомпаний — скролл внутри, не ломает страницу */
.airlines {
  max-height: calc(100vh - 160px);
  overflow-y: auto;
  padding: 12px;
  background: rgba(255,255,255,0.02);
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.04);
}

/* карточки направлений — адаптивная сетка внутри правого столбца */
.destinations {
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}
@media (min-width: 980px) {
  .destinations { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
}

/* карточка направления — не использовать абсолютные размеры */
.destination-card {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 12px;
  background: rgba(255,255,255,0.03);
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.04);
  word-break: break-word;
}

/* строка заголовка маршрута — перенос и иконки */
.route-line {
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
  font-weight:600;
}

/* метки и кнопки */
.airline-badge { background: #ffd54a; color:#06141e; padding:4px 8px; border-radius:8px; font-weight:700; }
.select-btn { align-self:flex-start; padding:8px 12px; border-radius:8px; background:linear-gradient(180deg,#f6d16a,#d9a017); color:#06141e; border:none; cursor:pointer; }

/* таблицы и списки — обёртка с горизонтальным скроллом */
.table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; }
table.responsive { width:100%; min-width:600px; border-collapse:collapse; }

/* защитные правила против inline absolute */
*[style*="position: absolute"], *[style*="left:"] { position: static !important; left:auto !important; top:auto !important; transform:none !important; }

/* мелкие экраны — уменьшение отступов и шрифтов */
@media (max-width: 420px) {
  .columns { gap:10px; }
  .airlines { padding:8px; max-height: calc(100vh - 120px); }
  .destination-card { padding:10px; }
  .route-line { font-size:14px; }
  .select-btn { padding:7px 10px; font-size:14px; }
}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash" aria-hidden="false" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:16000;background:linear-gradient(180deg, rgba(0,6,18,0.96), rgba(2,14,30,0.99));">
  <div style="text-align:center;max-width:92%;padding:18px;">
    <h2 style="font-size:22px;color:var(--text);margin-bottom:8px">Welcome to Lufthansa Group</h2>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:10px">
      <button id="splashContinue" class="btn btn-primary" type="button">Продолжить</button>
    </div>
  </div>
</div>

<div class="shell" role="application" aria-label="Flight Helper">
  <div class="topbar">
    <div class="brand">
      <div class="logo">LH</div>
      <div><div class="title">Lufthansa Helper</div><div class="subtitle">—</div></div>
    </div>

    <div style="display:flex;align-items:center;gap:8px">
      <div class="tabs" id="tabs">
        <div class="tab active" data-page="home">Главная</div>
        <div class="tab" data-page="routes">Направления</div>
        <div class="tab" data-page="fleet">Флот</div>
        <div class="tab" data-page="flights">Рейсы</div>
        <div class="tab" data-page="pilots">Пилоты</div>
      </div>

      <div class="session">
        <div id="sessionBadge" class="subtitle">Неавторизован</div>
        <button id="openGateBtn" class="btn btn-secondary" type="button">Вход</button>
        <button id="logoutBtn" class="btn btn-ghost" style="display:none" type="button">Выйти</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <div id="pageHost">
        <section id="page-home" class="panel page page-home active">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
            <div>
              <div class="heading">Генерация рейса</div>
              <div class="note">Выбери авиакомпанию, интервал времени и запусти генерацию</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="openInstructionBtn" class="btn btn-secondary" type="button">Инструкция</button>
            </div>
          </div>

          <div style="margin-top:12px" class="cols">
            <div style="margin-bottom:12px">
              <input id="airSearchMain" class="input-glass" placeholder="Поиск авиакомпании или кода" aria-label="Поиск авиакомпании" />
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start;margin-bottom:12px">
              <div style="flex:1">
                <div style="font-weight:800;margin-bottom:8px">Интервал времени</div>
                <div id="durationsMain" style="display:flex;gap:8px;flex-wrap:wrap"></div>
              </div>
              <div style="width:140px;min-width:120px">
                <div style="font-weight:800;margin-bottom:8px">Действия</div>
                <div style="display:flex;flex-direction:column;gap:8px">
                  <button id="generateBtn" class="btn btn-primary" type="button">Сгенерировать</button>
                  <button id="clearSelection" class="btn btn-ghost" type="button">Сбросить</button>
                </div>
              </div>
            </div>

            <div>
              <div style="font-weight:800;margin-bottom:8px">Авиакомпании</div>
              <div id="airGrid" class="airline-grid" aria-live="polite"></div>
            </div>

            <div style="margin-top:10px">
              <div style="font-weight:900">Выбранная авиакомпания</div>
              <div id="selectedAir" style="margin-top:6px;color:var(--muted)">Не выбрана</div>
            </div>
          </div>
        </section>

        <div id="dynamicPages"></div>
      </div>
    </div>
  </div>
</div>

<!-- Mobile bottom navigation (hidden on desktop by default) -->
<div class="mobile-nav" id="mobileNav" aria-hidden="false">
  <button class="nav-btn" data-page="home" id="navHome">Главная</button>
  <button class="nav-btn" data-page="routes" id="navRoutes">Направления</button>
  <button class="nav-btn" data-page="fleet" id="navFleet">Флот</button>
  <button class="nav-btn" data-page="flights" id="navFlights">Рейсы</button>
  <button class="nav-btn" data-page="pilots" id="navPilots">Пилоты</button>
</div>

<!-- FILTER modal -->
<div id="filterPanel" class="modal-backdrop" role="dialog" aria-hidden="true" aria-modal="true">
  <div class="modal-card" role="document" aria-label="Фильтры">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="title">Фильтры</div>
      <div class="subtitle" style="color:var(--muted)">Компактно</div>
    </div>

    <div class="body" style="margin-top:12px">
      <label for="filterCompany" style="font-weight:700;font-size:13px">Авиакомпания</label>
      <select id="filterCompany" class="input-glass" style="margin-top:8px">
        <option value="">Все</option>
      </select>

      <label style="font-weight:700;font-size:13px;margin-top:12px;display:block">Интервал (ч)</label>
      <div id="filterDurations" style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap"></div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
        <button id="applyFilters" class="btn btn-primary" type="button">Применить</button>
        <button id="resetFilters" class="btn btn-ghost" type="button">Сброс</button>
      </div>
    </div>
  </div>
</div>

<!-- FLIGHT DETAIL modal -->
<div id="flightDetailModal" class="modal-backdrop" role="dialog" aria-hidden="true">
  <div class="modal-card" role="document" aria-label="Детали рейса">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="title" id="detailTitle">Рейс</div>
      <div class="subtitle" id="detailStatus"></div>
    </div>
    <div class="body" id="detailBody" style="margin-top:10px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="btnArrived" class="btn btn-primary" type="button">Прилетел</button>
      <button id="btnCancelFlight" class="btn btn-ghost" type="button">Отменить</button>
      <button id="closeDetail" class="btn btn-secondary" type="button">Закрыть</button>
    </div>
  </div>
</div>

<!-- GATE modal (labels fixed for accessibility) -->
<div id="gateModal" class="modal-backdrop" role="dialog" aria-hidden="true" aria-modal="true">
  <div class="modal-card" role="document" aria-label="Вход">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="title">Вход</div>
      <div class="subtitle" style="color:var(--muted)">Авторизация</div>
    </div>
    <div class="body" style="margin-top:12px">
      <div style="margin-bottom:10px">
        <label for="loginCall" style="display:block;font-weight:700;font-size:13px;color:var(--muted)">Позывной (callSign)</label>
        <input id="loginCall" class="input-glass" placeholder="Позывной (callSign)" aria-label="Позывной (callSign)" />
      </div>

      <div style="margin-bottom:10px">
        <label for="loginPass" style="display:block;font-weight:700;font-size:13px;color:var(--muted)">Пароль</label>
        <input id="loginPass" class="input-glass" type="password" placeholder="Пароль" aria-label="Пароль" />
      </div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="btnLogin" class="btn btn-primary" type="button">Войти</button>
    </div>
  </div>
</div>

<!-- INSTRUCTION modal -->
<div id="instructionModal" class="modal-backdrop" role="dialog" aria-hidden="true" aria-modal="true">
  <div class="modal-card" role="document" aria-label="Инструкция">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="title">Инструкция</div>
      <div class="subtitle" style="color:var(--muted)">Кратко</div>
    </div>
    <div class="body" style="margin-top:12px">
      <div style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px"><strong>Вход</strong>: Введите позывной и пароль.</div>
      <div style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px"><strong>Генерация</strong>: Выберите авиакомпанию и интервал; затем нажмите «Сгенерировать».</div>
      <div style="padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)"><strong>Подтверждение</strong>: Подтвердите резерв — рейс сохранится в вашем профиле.</div>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="closeInstruction" class="btn btn-secondary" type="button">Закрыть</button>
    </div>
  </div>
</div>

<!-- CONFIRM modal -->
<div id="confirmModal" class="modal-backdrop" role="dialog" aria-hidden="true" aria-modal="true">
  <div class="modal-card" role="document" aria-label="Подтвердить рейс">
    <div class="title">Подтвердить рейс</div>
    <div id="confirmDetails" class="body" style="margin-top:8px;color:var(--muted)"></div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="btn btn-ghost" type="button">Отменить</button>
      <button id="confirmAccept" class="btn btn-primary" type="button">Подтвердить</button>
    </div>
  </div>
</div>

<script>
/* ============================
   ДАННЫЕ (как прежде)
   ============================ */
const AIRLINES = [
  {name:"Swiss International Air Lines",code:"LX",colorA:"#D81E5B",colorB:"#C1144A"},
  {name:"Austrian Airlines",code:"OS",colorA:"#DA291C",colorB:"#A71D1D"},
  {name:"AirBaltic",code:"BT",colorA:"#00A859",colorB:"#007A45"},
  {name:"Brussels Airlines",code:"SN",colorA:"#125B9E",colorB:"#0D4B84"},
  {name:"Eurowings",code:"EW",colorA:"#8A4BFF",colorB:"#6A29E8"},
  {name:"Discover Airlines",code:"4Y",colorA:"#3FA9F5",colorB:"#0B78D1"},
  {name:"Edelweiss Air",code:"WK",colorA:"#FF8C66",colorB:"#FF6A3C"},
  {name:"Lufthansa Cargo",code:"G0",colorA:"#0A63D6",colorB:"#0747A6"},
  {name:"Lufthansa CityLine",code:"CL",colorA:"#1E6FFF",colorB:"#0F4EDC"},
  {name:"Lufthansa City Airlines",code:"LC",colorA:"#1B6AE6",colorB:"#0B53B0"},
  {name:"Lufthansa Technik",code:"LT",colorA:"#6F7C8C",colorB:"#3F4B59"},
  {name:"Lufthansa Private Jet",code:"LP",colorA:"#B38B4B",colorB:"#8A6638"},
  {name:"Air Dolomiti",code:"EN",colorA:"#2B8F6F",colorB:"#1F6E55"},
  {name:"ITA Airways",code:"AZ",colorA:"#0066A1",colorB:"#004C7A"},
  {name:"Widerøe",code:"WF",colorA:"#2DAE4A",colorB:"#228A3A"},
  {name:"Norwegian Air Shuttle",code:"DY",colorA:"#E03A3E",colorB:"#B92B2C"},
  {name:"Finnair",code:"AY",colorA:"#1B2A43",colorB:"#0F1B2C"},
  {name:"SAS Scandinavian Airlines",code:"SK",colorA:"#0077C8",colorB:"#005B9E"},
  {name:"Condor",code:"DE",colorA:"#FFD23F",colorB:"#E6BF2F"},
  {name:"AeroLogic",code:"3S",colorA:"#7AA6E6",colorB:"#4B86C6"},
  {name:"SunExpress",code:"XQ",colorA:"#FF7A2D",colorB:"#E65A00"}
];

const DURATIONS = [
  {label:"1–2 часа", min:1, max:2},
  {label:"3–4 часа", min:3, max:4},
  {label:"5–6 часов", min:5, max:6},
  {label:"7–8 часов", min:7, max:8},
  {label:"9–10 часов", min:9, max:10},
  {label:"10+ часов", min:10}
];

const TYPE_RANGES = {
  "A220": {minH:1, maxH:6},
  "A320": {minH:1, maxH:6},
  "A321": {minH:1, maxH:7},
  "B737": {minH:1, maxH:6},
  "A330": {minH:3, maxH:14},
  "B787": {minH:5, maxH:16},
  "A350": {minH:6, maxH:16}
};

let ROUTES = []; (function(){
  const bases = ["EDDF","EGLL","LFPG","LEBL","LSZH","KJFK","EHAM","LOWW","LIRF","LEMD","UUEE"];
  let seq = 1000;
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
  AIRLINES.forEach((a, ai) => {
    DURATIONS.forEach((d, di) => {
      const from = bases[(ai*2 + di) % bases.length];
      const to = bases[(ai*2 + di + 3) % bases.length];
      let hours = d.max ? randInt(d.min, d.max) : randInt(d.min, d.min + 6);
      const minutes = hours * 60 + randInt(0,45);
      ROUTES.push({
        id: `${a.code}-${seq++}`,
        airline: a.name,
        airlineCode: a.code,
        fromICAO: from,
        toICAO: to,
        fromCity: 'City-' + from,
        toCity: 'City-' + to,
        durationMinutes: minutes
      });
    });
  });
})();

let FLEET = []; (function(){ const types=["A320","A321","B737","A220","A330","B787","A350"]; AIRLINES.forEach((a,ai)=>{ for(let i=1;i<=2;i++){ FLEET.push({ id:`${a.code}-AC${String(i).padStart(2,'0')}`, airline:a.name, type:types[(ai+i)%types.length], locationICAO:i===1?"EDDF":"EGLL", status:"idle", fuelMinutes:420 + i*60, turnaround:20 + i*5, reserveMargin:30 }); } }); })();

let PILOTS = [
  {id:"pilot_ivan",name:"Ivan Petrov",callSign:"IPET",verified:true,password:"ivanpass"},
  {id:"pilot_loui",name:"Loui Desulier",callSign:"FRENCH",verified:true,password:"louiSecret"}
];

let SESSION = { pilotId:null };
let CONFIRMED_FLIGHTS = [];
let chosenAirline = null;
let chosenDurationIdx = null;
let filterCompany = '';
let PENDING_RESERVATION = null;

/* DOM refs */
const splashEl = document.getElementById('splash');
const airGrid = document.getElementById('airGrid');
const durationsMain = document.getElementById('durationsMain');
const sessionBadge = document.getElementById('sessionBadge');
const openGateBtn = document.getElementById('openGateBtn');
const logoutBtn = document.getElementById('logoutBtn');
const dynamicPages = document.getElementById('dynamicPages');

/* ============================
   UI helpers: modals, focus, ripple (updated)
   ============================ */
function modalShow(el){
  if(!el) return;
  el.setAttribute('aria-hidden','false');
  el.style.display='flex';
  el.classList.add('showing');
  const card = el.querySelector('.modal-card');
  if(card){
    card.style.transform='translateY(6px)';
    card.style.opacity='0';
    requestAnimationFrame(()=>{ card.style.transform='none'; card.style.opacity='1'; });
  }
  document.body.classList.add('modal-open');
  trapFocus(el);
}
function modalHide(el){
  if(!el) return;
  el.setAttribute('aria-hidden','true');
  el.classList.remove('showing');
  const card = el.querySelector('.modal-card');
  if(card){
    card.style.transform='translateY(6px)';
    card.style.opacity='0';
  }
  setTimeout(()=>{
    el.style.display='none';
    releaseFocus();
    document.body.classList.remove('modal-open');
  }, 200);
}

/* focus trap */
let lastFocusedBeforeModal = null;
function trapFocus(modalBackdrop){
  lastFocusedBeforeModal = document.activeElement;
  const focusable = modalBackdrop.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
  const first = focusable[0], last = focusable[focusable.length-1];
  function keyHandler(e){
    if(e.key === 'Tab'){
      if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
      else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
    }
    if(e.key === 'Escape'){ e.preventDefault(); }
  }
  modalBackdrop._keyHandler = keyHandler;
  document.addEventListener('keydown', keyHandler);
  if(first) first.focus();
}
function releaseFocus(){
  const modalWithHandler = document.querySelectorAll('.modal-backdrop[style*="display:flex"]');
  modalWithHandler.forEach(m=>{ if(m._keyHandler) document.removeEventListener('keydown', m._keyHandler); delete m._keyHandler; });
  if(lastFocusedBeforeModal && lastFocusedBeforeModal.focus) lastFocusedBeforeModal.focus();
}

/* ripple and wave: robust implementation (fixes white dot on mobile) */
(function(){
  function removeRipple(r){
    if(!r) return;
    r.style.transition = 'opacity 220ms, transform 260ms';
    r.style.opacity = '0';
    r.style.transform = 'scale(0)';
    clearTimeout(r._rmT);
    r._rmT = setTimeout(()=> { r.style.width = '0px'; r.style.height = '0px'; }, 300);
  }
  function createOrGetRipple(el){
    let r = el.querySelector('.ripple');
    if(!r){
      r = document.createElement('span');
      r.className = 'ripple';
      r.style.position = 'absolute';
      r.style.pointerEvents = 'none';
      r.style.borderRadius = '50%';
      r.style.transform = 'scale(0)';
      r.style.opacity = '0';
      r.style.willChange = 'transform, opacity, left, top';
      el.appendChild(r);
    }
    return r;
  }
  function attachRipple(scope=document){
    const els = scope.querySelectorAll('.btn, .airline, .time-item, .route-card, .fleet-card');
    els.forEach(el=>{
      if(el._ripAttached) return;
      el._ripAttached = true;

      el.addEventListener('pointerdown', function(ev){
        if(ev.button && ev.button !== 0) return;
        const r = createOrGetRipple(el);
        const rect = el.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height) * 1.6;
        const x = ev.clientX - rect.left - size/2;
        const y = ev.clientY - rect.top - size/2;
        r.style.width = size + 'px';
        r.style.height = size + 'px';
        r.style.left = Math.max(Math.min(x, rect.width - size), 0) + 'px';
        r.style.top = Math.max(Math.min(y, rect.height - size), 0) + 'px';
        r.style.transition = 'none';
        r.style.transform = 'scale(0)';
        r.style.opacity = '.28';
        try { if (ev.target && ev.target.setPointerCapture) ev.target.setPointerCapture(ev.pointerId); } catch(e){}
        requestAnimationFrame(()=> {
          r.style.transition = 'transform 420ms cubic-bezier(.2,.9,.2,1), opacity 360ms';
          r.style.transform = 'scale(1)';
          clearTimeout(r._fadeT);
          r._fadeT = setTimeout(()=> { r.style.opacity = '0'; }, 300);
        });
        clearTimeout(r._rmT);
        r._rmT = setTimeout(()=> removeRipple(r), 900);
        el._lastRipple = r;
      }, {passive:true});

      el.addEventListener('pointerup', function(ev){
        const r = el._lastRipple || el.querySelector('.ripple');
        if(r) removeRipple(r);
        try { if (ev.target && ev.target.releasePointerCapture) ev.target.releasePointerCapture(ev.pointerId); } catch(e){}
      });
      el.addEventListener('pointercancel', function(ev){
        const r = el._lastRipple || el.querySelector('.ripple');
        if(r) removeRipple(r);
        try { if (ev.target && ev.target.releasePointerCapture) ev.target.releasePointerCapture(ev.pointerId); } catch(e){}
      });

      // ensure tapend/touchcancel globally clears stray ripples on some mobile browsers
      if(!document._rippleGlobalHandlers){
        document._rippleGlobalHandlers = true;
        ['touchend','touchcancel','pointerup','pointercancel'].forEach(evt=>{
          document.addEventListener(evt, function(){
            document.querySelectorAll('.ripple').forEach(r=> removeRipple(r));
          }, {capture:true, passive:true});
        });
      }
    });
  }
  window.attachRipple = attachRipple;
  attachRipple(document);
  const moRip = new MutationObserver(()=> attachRipple(document));
  moRip.observe(document.body, { childList:true, subtree:true });
})();

/* ============================
   RENDER / INTERACTION
   ============================ */

function initDurations(){
  durationsMain.innerHTML=''; const filterDur = document.getElementById('filterDurations');
  DURATIONS.forEach((d,i)=>{
    const btn=document.createElement('div'); btn.className='time-item'; btn.textContent=d.label; btn.dataset.idx=i;
    btn.addEventListener('click', ()=>{ chosenDurationIdx = chosenDurationIdx===i ? null : i; document.querySelectorAll('.time-item').forEach(t=>t.classList.toggle('selected', Number(t.dataset.idx)===chosenDurationIdx)); if(currentPage==='routes') renderRoutesPage(); });
    durationsMain.appendChild(btn);

    if(filterDur){
      const fbtn=document.createElement('div'); fbtn.className='time-item'; fbtn.textContent=d.label; fbtn.dataset.idx=i;
      fbtn.addEventListener('click', ()=>{ chosenDurationIdx = chosenDurationIdx===i ? null : i; document.querySelectorAll('#filterDurations .time-item').forEach(t=>t.classList.toggle('selected', Number(t.dataset.idx)===chosenDurationIdx)); if(currentPage==='routes') renderRoutesPage(); });
      filterDur.appendChild(fbtn);
    }
  });
  attachRipple(document);
}

/* Reusable airline list with delegation */
function renderAirlineList(container, selectedName){
  container.innerHTML = '';
  const q = (document.getElementById('airSearchMain').value||'').trim().toLowerCase();
  const list = AIRLINES.filter(a=>{ if(!q) return true; return a.name.toLowerCase().includes(q) || a.code.toLowerCase().includes(q); });
  list.forEach(a=>{
    const el = document.createElement('div'); el.className='airline'; el.tabIndex=0; el.dataset.air = a.name;
    el.innerHTML = `<div class="brand-dot" style="background:linear-gradient(180deg, ${a.colorA}, ${a.colorB});"></div>
      <div style="min-width:0"><div class="name">${a.name}</div><div class="meta">${a.code}</div></div>
      <div class="code-pill">${a.code}</div>`;
    if(selectedName && selectedName===a.name) el.classList.add('selected');
    container.appendChild(el);
  });

  container.onclick = function(ev){
    const node = ev.target.closest('.airline');
    if(!node) return;
    const name = node.dataset.air;
    if(container.id === 'fleetAirList' || container.id === 'routesAirList'){
      filterCompany = (filterCompany === name) ? '' : name;
      container.querySelectorAll('.airline').forEach(n=> n.classList.toggle('selected', n.dataset.air === filterCompany));
      if(container.id === 'fleetAirList') renderFleetGroups(filterCompany);
      if(container.id === 'routesAirList') renderRoutesGrid();
    } else {
      chosenAirline = (chosenAirline === name) ? null : name;
      document.getElementById('selectedAir').textContent = chosenAirline || 'Не выбрана';
      document.querySelectorAll('#airGrid .airline').forEach(n=> n.classList.toggle('selected', n.dataset.air === chosenAirline));
    }
  };
  attachRipple(container);
}

/* main airlines render */
function renderAirlines(){ renderAirlineList(airGrid, chosenAirline); }

/* pagination/state */
let currentPage = 'home';
function activatePage(id){
  currentPage = id;
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.page===id));
  document.getElementById('page-home').style.display = id==='home' ? 'block' : 'none';
  dynamicPages.innerHTML = '';
  if(id==='routes') renderRoutesPage();
  if(id==='fleet') renderFleetPage();
  if(id==='flights') renderFlightsPage();
  if(id==='pilots') renderPilotsPage();
  updateMobileNavActive();
  attachRipple(document);
}
document.querySelectorAll('.tab').forEach(tab=>tab.addEventListener('click', ()=> activatePage(tab.dataset.page)));
activatePage('home');

/* mobile nav update */
function updateMobileNavActive(){
  const nav = document.getElementById('mobileNav');
  if(!nav) return;
  nav.querySelectorAll('.nav-btn').forEach(b=> b.classList.toggle('active', b.dataset.page === currentPage));
}
document.addEventListener('click', (e)=>{
  const btn = e.target.closest && e.target.closest('.nav-btn');
  if(btn && btn.dataset.page){ activatePage(btn.dataset.page); window.scrollTo({top:0,behavior:'smooth'}); }
});

/* representative durations */
function representativeDurationForAirline(airlineName){
  const r = ROUTES.find(x=>x.airline===airlineName);
  if(!r) return null; return Math.round(r.durationMinutes/60);
}
function representativeDurationForAircraft(ac){
  const rts = ROUTES.filter(r=> r.airline === ac.airline);
  if(!rts.length) return null;
  const avg = Math.round(rts.reduce((s,r)=>s + r.durationMinutes,0)/rts.length/60);
  return avg;
}

/* ROUTES page */
function renderRoutesPage(){
  const container = document.createElement('section'); container.className='panel'; container.id='page-routes';
  container.innerHTML = `
    <div style="display:grid;grid-template-columns:240px 1fr;gap:12px;align-items:start">
      <div>
        <div style="font-weight:900;margin-bottom:8px">Авиакомпании</div>
        <div id="routesAirList" style="min-height:60px"></div>
        <div style="font-weight:900;margin-top:14px;margin-bottom:8px">Фильтры времени</div>
        <div id="routesDurList" class="small-note"></div>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
          <div style="min-width:0"><div style="font-weight:900">Направления</div><div style="color:var(--muted);margin-top:6px">Карточки маршрутов. Фильтр по авиакомпаниям и времени</div></div>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="localCompanyFilter" class="input-glass" style="min-width:200px"><option value="">Все авиакомпании</option></select>
            <button id="closeRoutesBtn" class="btn btn-ghost">Закрыть</button>
          </div>
        </div>
        <div style="margin-top:12px" id="routesGrid" class="card-grid"></div>
      </div>
    </div>
  `;
  dynamicPages.appendChild(container);

  const airList = container.querySelector('#routesAirList');
  renderAirlineList(airList, filterCompany);

  const durBox = container.querySelector('#routesDurList');
  DURATIONS.forEach((d, idx)=>{ const el=document.createElement('div'); el.textContent=d.label; el.style.marginBottom='6px'; el.style.cursor='pointer'; el.addEventListener('click', ()=>{ chosenDurationIdx = chosenDurationIdx===idx ? null : idx; renderRoutesGrid(); }); if(chosenDurationIdx===idx) el.style.outline='2px solid rgba(255,190,60,0.18)'; durBox.appendChild(el); });

  const localSelect = container.querySelector('#localCompanyFilter');
  AIRLINES.forEach(a=>{ const o=document.createElement('option'); o.value=a.name; o.textContent=`${a.name} (${a.code})`; localSelect.appendChild(o); });
  localSelect.addEventListener('change', ()=>{ filterCompany = localSelect.value; renderRoutesGrid(); renderAirlineList(airList, filterCompany); });
  container.querySelector('#closeRoutesBtn').addEventListener('click', ()=> activatePage('home'));

  renderRoutesGrid();
  // clamp layout after render
  if(window.clampLayoutForMobile) window.clampLayoutForMobile();
}

function renderRoutesGrid(){
  const grid = document.getElementById('routesGrid'); if(!grid) return;
  grid.innerHTML = '';
  const qCompany = filterCompany || chosenAirline || '';
  const list = ROUTES.filter(r=>{
    if(qCompany && r.airline !== qCompany) return false;
    if(chosenDurationIdx !== null){
      const d = DURATIONS[chosenDurationIdx];
      if(d.max){ if(!(r.durationMinutes >= d.min*60 && r.durationMinutes <= d.max*60)) return false; } else { if(!(r.durationMinutes >= d.min*60)) return false; }
    }
    return true;
  });
  if(!list.length){ grid.innerHTML = '<div style="color:var(--muted)">Нет направлений по текущим фильтрам</div>'; return; }
  list.forEach(r=>{
    const durH = Math.round(r.durationMinutes/60);
    const node = document.createElement('div'); node.className='route-card';
    node.innerHTML = `<div class="title">${r.fromICAO} → ${r.toICAO} · ${r.airlineCode}</div>
      <div class="meta">${r.fromCity} → ${r.toCity} · ${durH} ч · ${r.airline}</div>
      <div class="small-note">Длительность: примерно ${durH} ч ${r.durationMinutes%60} мин</div>
      <div style="display:flex;justify-content:flex-end;margin-top:10px"><button class="btn btn-primary select-route" data-id="${r.id}">Выбрать</button></div>`;
    grid.appendChild(node);
  });
  grid.querySelectorAll('.select-route').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.dataset.id; const route = ROUTES.find(x=>x.id===id);
      if(!SESSION.pilotId){ modalShow(document.getElementById('gateModal')); return; }
      openConfirmFromRoute(route);
    });
  });
  attachRipple(grid);
  if(window.clampLayoutForMobile) window.clampLayoutForMobile();
}

/* FLEET page */
function renderFleetPage(){
  const container = document.createElement('section'); container.className='panel'; container.id='page-fleet';
  container.innerHTML = `
    <div style="display:grid;grid-template-columns:240px 1fr;gap:12px;align-items:start">
      <div>
        <div style="font-weight:900;margin-bottom:8px">Авиакомпании</div>
        <div id="fleetAirList" style="min-height:60px"></div>
      </div>
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center"><div style="min-width:0"><div style="font-weight:900">Флот</div><div style="color:var(--muted);margin-top:6px">Показывается по авиакомпаниям. В карточке указан ориентировочное время полёта</div></div><div><button id="closeFleetBtn" class="btn btn-ghost">Закрыть</button></div></div>
        <div id="fleetGroups" style="margin-top:12px"></div>
      </div>
    </div>
  `;
  dynamicPages.appendChild(container);
  const fleetAir = container.querySelector('#fleetAirList');
  renderAirlineList(fleetAir, filterCompany);
  container.querySelector('#closeFleetBtn').addEventListener('click', ()=> activatePage('home'));
  renderFleetGroups(filterCompany);
  if(window.clampLayoutForMobile) window.clampLayoutForMobile();
}

function renderFleetGroups(filterBy){
  const groups = document.getElementById('fleetGroups'); if(!groups) return;
  groups.innerHTML = '';
  const airlines = filterBy ? AIRLINES.filter(a=>a.name===filterBy) : AIRLINES;
  airlines.forEach(a=>{
    const items = FLEET.filter(f=>f.airline===a.name);
    const group = document.createElement('div'); group.style.marginBottom='12px';
    group.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;gap:12px"><div style="display:flex;align-items:center;gap:12px"><div style="width:12px;height:12px;border-radius:3px;background:linear-gradient(180deg, ${a.colorA}, ${a.colorB})"></div><div style="font-weight:900">${a.name}</div></div><div class="small-note">Ориентир. время: ${representativeDurationForAirline(a.name) ? representativeDurationForAirline(a.name) + ' ч' : '—'}</div></div><div class="fleet-list" data-air="${a.name}" style="margin-top:8px"></div>`;
    groups.appendChild(group);
    const list = group.querySelector('.fleet-list');
    if(!items.length){ list.innerHTML = `<div style="color:var(--muted)">Нет самолётов</div>`; return; }
    items.forEach(f=>{
      const rep = representativeDurationForAircraft(f);
      const approx = rep ? `~${rep} ч` : '—';
      const card = document.createElement('div'); card.className='fleet-card'; card.style.marginBottom='8px';
      card.innerHTML = `<div class="title">${f.id} · ${f.type}</div>
        <div class="meta">${f.locationICAO} · Топливо: ${f.fuelMinutes} мин · Статус: ${f.status}</div>
        <div class="small-note">Ориентировочное время полёта для этого самолёта: ${approx}</div>`;
      list.appendChild(card);
    });
  });
  attachRipple(groups);
  if(window.clampLayoutForMobile) window.clampLayoutForMobile();
}

/* FLIGHTS */
function renderFlightsPage(){
  const container = document.createElement('section'); container.className='panel'; container.id='page-flights';
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:900">Рейсы пилота</div><div style="color:var(--muted);margin-top:6px">Текущие и ранее подтверждённые рейсы</div></div><div><button id="closeFlightsBtn" class="btn btn-ghost">Закрыть</button></div></div><div id="flightsList" style="margin-top:12px"></div>`;
  dynamicPages.appendChild(container);
  container.querySelector('#closeFlightsBtn').addEventListener('click', ()=> activatePage('home'));
  renderFlightsList();
  if(window.clampLayoutForMobile) window.clampLayoutForMobile();
}
function renderFlightsList(){
  const listEl = document.getElementById('flightsList'); listEl.innerHTML = '';
  if(!SESSION.pilotId){ listEl.innerHTML = '<div style="color:var(--muted)">Войдите, чтобы видеть ваши рейсы</div>'; return; }
  if(CONFIRMED_FLIGHTS.length===0){ listEl.innerHTML = '<div style="color:var(--muted)">Нет подтверждённых рейсов</div>'; return; }
  CONFIRMED_FLIGHTS.forEach((f, idx)=>{
    const row = document.createElement('div'); row.className='route-card';
    row.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px"><div><div class="title">${f.aircraftId} · ${f.fromICAO} → ${f.toICAO}</div><div class="meta">Пилот ${f.pilotCallsign} · ${Math.round(f.durationMinutes/60)} ч</div></div><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-secondary" data-action="view" data-idx="${idx}">Детали</button>${f.status==='inFlight'?`<button class="btn btn-primary" data-action="arrived" data-idx="${idx}">Прилетел</button>`:''}<button class="btn btn-ghost" data-action="cancel" data-idx="${idx}">Отменить</button></div></div>`;
    listEl.appendChild(row);
  });
  listEl.querySelectorAll('button[data-action]').forEach(b=>{
    const action=b.dataset.action, idx=Number(b.dataset.idx);
    b.addEventListener('click', ()=>{ const f=CONFIRMED_FLIGHTS[idx]; if(!f) return; if(action==='view') openFlightDetail(f, idx); if(action==='arrived') markFlightArrived(idx); if(action==='cancel') cancelFlight(idx); });
  });
  attachRipple(listEl);
  if(window.clampLayoutForMobile) window.clampLayoutForMobile();
}

/* PILOTS */
function renderPilotsPage(){
  const container = document.createElement('section'); container.className='panel'; container.id='page-pilots';
  container.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:900">Пилоты</div><div style="color:var(--muted);margin-top:6px">Существующие пилоты — можно быстро войти за любого</div></div><div><button id="closePilotsBtn" class="btn btn-ghost">Закрыть</button></div></div><div id="pilotsList" style="margin-top:12px" class="card-grid"></div>`;
  dynamicPages.appendChild(container);
  container.querySelector('#closePilotsBtn').addEventListener('click', ()=> activatePage('home'));
  const list = container.querySelector('#pilotsList'); list.innerHTML='';
  PILOTS.forEach(p=>{
    const card = document.createElement('div'); card.className='route-card';
    card.innerHTML = `<div><div class="title">${p.name}</div><div class="meta">Позывной: ${p.callSign} · ${p.verified ? 'Проверен' : 'Непроверен'}</div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button class="btn btn-primary quick-login" data-id="${p.id}">Войти как</button></div>`;
    list.appendChild(card);
  });
  list.querySelectorAll('.quick-login').forEach(b=> b.addEventListener('click', ()=>{ quickLoginAsPilot(b.dataset.id); }));
  attachRipple(list);
  if(window.clampLayoutForMobile) window.clampLayoutForMobile();
}

/* Flight detail modal actions */
function openFlightDetail(flight, idx){
  const detailModal = document.getElementById('flightDetailModal');
  document.getElementById('detailTitle').textContent = `${flight.aircraftId} · ${flight.fromICAO}→${flight.toICAO}`;
  document.getElementById('detailStatus').textContent = flight.status || '';
  document.getElementById('detailBody').innerHTML = `
    <div>Пилот: <strong>${flight.pilotCallsign}</strong></div>
    <div style="margin-top:6px">Длительность: <strong>${flight.durationMinutes} мин</strong></div>
    <div style="margin-top:6px">Подтверждён: <strong>${new Date(flight.ts).toLocaleString()}</strong></div>
    <div style="margin-top:8px">Остаток топлива: <strong>${flight.fuelLeft || '—'} мин</strong></div>
    <div style="margin-top:6px">Turnaround: <strong>${flight.turnaround || '—'} мин</strong></div>`;
  detailModal.dataset.idx = idx;
  modalShow(detailModal);
}
document.getElementById('closeDetail').addEventListener('click', ()=> modalHide(document.getElementById('flightDetailModal')));
document.getElementById('btnArrived').addEventListener('click', ()=>{ const idx=Number(document.getElementById('flightDetailModal').dataset.idx); markFlightArrived(idx); modalHide(document.getElementById('flightDetailModal')); if(currentPage==='flights') renderFlightsList(); });
document.getElementById('btnCancelFlight').addEventListener('click', ()=>{ const idx=Number(document.getElementById('flightDetailModal').dataset.idx); cancelFlight(idx); modalHide(document.getElementById('flightDetailModal')); if(currentPage==='flights') renderFlightsList(); });

function markFlightArrived(idx){
  const f = CONFIRMED_FLIGHTS[idx]; if(!f) return; f.status='arrived'; f.arrivedAt = Date.now();
  const ac = FLEET.find(a=>a.id===f.aircraftId); if(ac){ ac.status='idle'; delete ac.availableAt; }
  if(SESSION.pilotId) localStorage.setItem('lh_flights_' + SESSION.pilotId, JSON.stringify(CONFIRMED_FLIGHTS));
}
function cancelFlight(idx){
  const f = CONFIRMED_FLIGHTS[idx]; if(!f) return;
  const ac = FLEET.find(a=>a.id===f.aircraftId);
  if(ac){ ac.status='idle'; delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil; delete ac.availableAt; }
  CONFIRMED_FLIGHTS.splice(idx,1);
  if(SESSION.pilotId) localStorage.setItem('lh_flights_' + SESSION.pilotId, JSON.stringify(CONFIRMED_FLIGHTS));
}

/* Candidate selection logic */
function typeFitsDuration(type, routeHours){
  const range = TYPE_RANGES[type];
  if(!range) return true;
  return routeHours >= range.minH && routeHours <= range.maxH;
}
function findCandidateAircraftForRoute(route){
  const routeHours = Math.ceil(route.durationMinutes / 60);
  const dur = Number(route.durationMinutes) || 0;
  const hasFuel = ac => (ac.fuelMinutes || 0) >= dur + (ac.reserveMargin || 30);
  const fitsType = ac => typeFitsDuration(ac.type, routeHours);
  let candidates = FLEET.filter(ac => ac.status === 'idle' && ac.airline === route.airline && hasFuel(ac) && fitsType(ac));
  if(!candidates.length) candidates = FLEET.filter(ac => ac.status === 'idle' && hasFuel(ac) && fitsType(ac));
  if(!candidates.length) candidates = FLEET.filter(ac => ac.status === 'idle' && ac.airline === route.airline && hasFuel(ac));
  if(!candidates.length) candidates = FLEET.filter(ac => ac.status === 'idle' && hasFuel(ac));
  candidates.sort((a,b)=>{
    const sameA = a.airline===route.airline ? 1:0; const sameB = b.airline===route.airline ? 1:0;
    if(sameB - sameA) return sameB - sameA;
    const fuelDiff = (b.fuelMinutes||0) - (a.fuelMinutes||0);
    if(fuelDiff) return fuelDiff;
    const ar = TYPE_RANGES[a.type], br = TYPE_RANGES[b.type];
    const midA = ar ? (ar.minH + ar.maxH)/2 : 0; const midB = br ? (br.minH + br.maxH)/2 : 0;
    return Math.abs(midA - routeHours) - Math.abs(midB - routeHours);
  });
  return candidates[0] || null;
}
function getCandidatesForRoute(route){
  const routeHours = Math.ceil(route.durationMinutes/60);
  const dur = Number(route.durationMinutes) || 0;
  const hasFuel = ac => (ac.fuelMinutes || 0) >= dur + (ac.reserveMargin || 30);
  const fitsType = ac => typeFitsDuration(ac.type, routeHours);
  let set = FLEET.filter(ac => ac.status==='idle' && ac.airline===route.airline && hasFuel(ac) && fitsType(ac));
  if(!set.length) set = FLEET.filter(ac => ac.status==='idle' && hasFuel(ac) && fitsType(ac));
  if(!set.length) set = FLEET.filter(ac => ac.status==='idle' && ac.airline===route.airline && hasFuel(ac));
  if(!set.length) set = FLEET.filter(ac => ac.status==='idle' && hasFuel(ac));
  set.sort((a,b)=> { const sameA = a.airline===route.airline?1:0, sameB = b.airline===route.airline?1:0; if(sameB-sameA) return sameB-sameA; return (b.fuelMinutes||0)-(a.fuelMinutes||0); });
  return set;
}
function openConfirmFromRoute(route){
  const pilot = PILOTS.find(x=>x.id===SESSION.pilotId) || { id:SESSION.pilotId, callSign:SESSION.pilotId };
  const candidate = findCandidateAircraftForRoute(route);
  if(!candidate){ alert('Нет подходящих самолётов с запасом топлива и подходящим типом'); return; }
  candidate.status='reserved'; candidate.reservedBy = pilot.id; candidate.reservedToken = pilot.id+':'+Date.now()+':'+Math.random().toString(36).slice(2,6); candidate.reservedUntil = Date.now() + 120000;
  PENDING_RESERVATION = { token:candidate.reservedToken, aircraft:candidate, route, pilotId:pilot.id, expires:candidate.reservedUntil };
  document.getElementById('confirmDetails').textContent = `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${Math.round(route.durationMinutes/60)} ч · Пилот ${pilot.callSign}`;
  modalShow(document.getElementById('confirmModal'));
}

/* Confirm handlers */
document.getElementById('confirmAccept').addEventListener('click', ()=>{
  if(!PENDING_RESERVATION){ modalHide(document.getElementById('confirmModal')); return; }
  const ac = FLEET.find(a=>a.reservedToken===PENDING_RESERVATION.token);
  if(!ac){ alert('Резервация потеряна'); modalHide(document.getElementById('confirmModal')); return; }
  const p = PILOTS.find(x=>x.id===PENDING_RESERVATION.pilotId) || { id:PENDING_RESERVATION.pilotId, callSign:PENDING_RESERVATION.pilotId };
  ac.fuelMinutes = Math.max(0, (ac.fuelMinutes||0) - Number(PENDING_RESERVATION.route.durationMinutes));
  ac.status = 'inFlight';
  ac.availableAt = Date.now() + (PENDING_RESERVATION.route.durationMinutes||120)*60000 + (ac.turnaround||0)*60000;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;
  const flight = { id:'flt_'+Math.random().toString(36).slice(2,8), aircraftId:ac.id, airline:ac.airline, fromICAO:PENDING_RESERVATION.route.fromICAO, toICAO:PENDING_RESERVATION.route.toICAO, durationMinutes:PENDING_RESERVATION.route.durationMinutes, pilotId:p.id, pilotCallsign:p.callSign, ts:Date.now(), status:'inFlight', fuelLeft:ac.fuelMinutes, turnaround:ac.turnaround };
  CONFIRMED_FLIGHTS.unshift(flight);
  if(SESSION.pilotId) localStorage.setItem('lh_flights_' + SESSION.pilotId, JSON.stringify(CONFIRMED_FLIGHTS));
  PENDING_RESERVATION = null; modalHide(document.getElementById('confirmModal'));
  if(currentPage==='fleet') renderFleetPage();
  if(currentPage==='routes') renderRoutesPage();
  if(currentPage==='flights') renderFlightsList();
});
document.getElementById('confirmCancel').addEventListener('click', ()=>{
  if(PENDING_RESERVATION){
    const token=PENDING_RESERVATION.token;
    FLEET.forEach(a=>{ if(a.reservedToken===token){ a.status='idle'; delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; } });
    PENDING_RESERVATION=null;
  }
  modalHide(document.getElementById('confirmModal'));
});

/* Login */
document.getElementById('btnLogin').addEventListener('click', ()=>{
  const cs = (document.getElementById('loginCall').value||'').trim(); const pass = (document.getElementById('loginPass').value||'').trim();
  if(!cs || !pass){ alert('Введите позывной и пароль'); return; }
  const p = PILOTS.find(x=>x.callSign.toLowerCase()===cs.toLowerCase());
  if(p && p.password===pass){ SESSION.pilotId = p.id; sessionBadge.textContent = `Вошёл ${p.callSign}`; } else { SESSION.pilotId = 'guest_'+cs.toLowerCase(); sessionBadge.textContent = `Вошёл ${SESSION.pilotId}`; }
  document.getElementById('openGateBtn').style.display='none'; document.getElementById('logoutBtn').style.display='inline-flex';
  modalHide(document.getElementById('gateModal'));
  const stored = localStorage.getItem('lh_flights_' + SESSION.pilotId);
  CONFIRMED_FLIGHTS = stored ? JSON.parse(stored) : [];
  modalShow(document.getElementById('instructionModal'));
});
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  if(SESSION.pilotId) localStorage.setItem('lh_flights_' + SESSION.pilotId, JSON.stringify(CONFIRMED_FLIGHTS));
  SESSION.pilotId=null; CONFIRMED_FLIGHTS=[]; sessionBadge.textContent='Неавторизован'; document.getElementById('openGateBtn').style.display='inline-flex'; document.getElementById('logoutBtn').style.display='none';
  if(currentPage==='flights') renderFlightsList();
});
document.getElementById('openGateBtn').addEventListener('click', ()=> modalShow(document.getElementById('gateModal')));
document.getElementById('openInstructionBtn').addEventListener('click', ()=> modalShow(document.getElementById('instructionModal')));
document.getElementById('closeInstruction').addEventListener('click', ()=> modalHide(document.getElementById('instructionModal')));

/* Filters */
document.getElementById('applyFilters').addEventListener('click', ()=>{
  filterCompany = document.getElementById('filterCompany').value;
  modalHide(document.getElementById('filterPanel'));
  if(currentPage==='routes') renderRoutesPage();
});
document.getElementById('resetFilters').addEventListener('click', ()=>{
  filterCompany = ''; chosenDurationIdx = null; document.querySelectorAll('.time-item').forEach(x=>x.classList.remove('selected')); document.getElementById('filterCompany').value=''; modalHide(document.getElementById('filterPanel'));
  if(currentPage==='routes') renderRoutesPage();
});
function populateFilterCompanies(){
  const sel = document.getElementById('filterCompany'); sel.innerHTML = '<option value="">Все</option>';
  AIRLINES.forEach(a=>{ const o=document.createElement('option'); o.value=a.name; o.textContent = `${a.name} (${a.code})`; sel.appendChild(o); });
}

/* Generate random */
document.getElementById('generateBtn').addEventListener('click', ()=>{
  if(!SESSION.pilotId){ modalShow(document.getElementById('gateModal')); return; }
  const pool = ROUTES.filter(r=>{
    if(chosenAirline && r.airline !== chosenAirline) return false;
    if(chosenDurationIdx !== null){
      const d = DURATIONS[chosenDurationIdx];
      if(d.max){ if(!(r.durationMinutes >= d.min*60 && r.durationMinutes <= d.max*60)) return false; } else { if(!(r.durationMinutes >= d.min*60)) return false; }
    }
    return true;
  });
  if(!pool.length){ alert('Нет маршрутов по текущим фильтрам'); return; }
  const route = pool[Math.floor(Math.random()*pool.length)];
  const candidates = getCandidatesForRoute(route);
  if(!candidates.length){ alert('Нет подходящих самолётов для выбранного маршрута'); return; }
  const candidate = candidates[Math.floor(Math.random()*candidates.length)];
  candidate.status='reserved'; candidate.reservedBy = SESSION.pilotId; candidate.reservedToken = SESSION.pilotId+':'+Date.now()+':'+Math.random().toString(36).slice(2,6); candidate.reservedUntil = Date.now() + 120000;
  PENDING_RESERVATION = { token:candidate.reservedToken, aircraft:candidate, route, pilotId:SESSION.pilotId, expires:candidate.reservedUntil };
  document.getElementById('confirmDetails').textContent = `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${Math.round(route.durationMinutes/60)} ч`;
  modalShow(document.getElementById('confirmModal'));
});
function getCandidatesForRoute(route){
  const routeHours = Math.ceil(route.durationMinutes/60);
  const dur = Number(route.durationMinutes) || 0;
  const hasFuel = ac => (ac.fuelMinutes || 0) >= dur + (ac.reserveMargin || 30);
  const fitsType = ac => typeFitsDuration(ac.type, routeHours);
  let set = FLEET.filter(ac => ac.status==='idle' && ac.airline===route.airline && hasFuel(ac) && fitsType(ac));
  if(!set.length) set = FLEET.filter(ac => ac.status==='idle' && hasFuel(ac) && fitsType(ac));
  if(!set.length) set = FLEET.filter(ac => ac.status==='idle' && ac.airline===route.airline && hasFuel(ac));
  if(!set.length) set = FLEET.filter(ac => ac.status==='idle' && hasFuel(ac));
  set.sort((a,b)=> { const sameA = a.airline===route.airline?1:0, sameB = b.airline===route.airline?1:0; if(sameB-sameA) return sameB-sameA; return (b.fuelMinutes||0)-(a.fuelMinutes||0); });
  return set;
}

/* quick login */
function quickLoginAsPilot(pid){
  const p = PILOTS.find(x=>x.id===pid); if(!p) return;
  SESSION.pilotId = p.id; sessionBadge.textContent = `Вошёл ${p.callSign}`; document.getElementById('openGateBtn').style.display='none'; document.getElementById('logoutBtn').style.display='inline-flex';
  const stored = localStorage.getItem('lh_flights_' + SESSION.pilotId); CONFIRMED_FLIGHTS = stored ? JSON.parse(stored) : [];
  activatePage('flights');
}

/* maintenance loop */
setInterval(()=>{
  const now = Date.now();
  FLEET.forEach(ac=>{
    if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil <= now){ ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil; }
    if(ac.status==='inFlight' && ac.availableAt && ac.availableAt <= now){ ac.status='idle'; delete ac.availableAt; CONFIRMED_FLIGHTS.forEach(f=>{ if(f.aircraftId===ac.id && f.status==='inFlight'){ f.status='arrived'; f.arrivedAt = now; } }); if(SESSION.pilotId) localStorage.setItem('lh_flights_' + SESSION.pilotId, JSON.stringify(CONFIRMED_FLIGHTS)); }
  });
  if(currentPage==='flights') renderFlightsList();
}, 3000);

/* splash handler */
function continueFromSplash(){ try{ if(splashEl){ splashEl.style.display='none'; splashEl.setAttribute('aria-hidden','true'); } }catch(e){} setTimeout(()=> modalShow(document.getElementById('gateModal')), 60); }
(function attachSplashHandler(){ const btn = document.getElementById('splashContinue'); if(!btn) return; btn.replaceWith(btn.cloneNode(true)); const fresh = document.getElementById('splashContinue'); fresh.addEventListener('click', continueFromSplash, { passive:true }); fresh.onclick = continueFromSplash; })();

/* Init */
function init(){ initDurations(); renderAirlines(); populateFilterCompanies(); attachRipple(document); attachGlobalHandlers(); updateMobileNavActive(); if(window.clampLayoutForMobile) window.clampLayoutForMobile(); }
init();

/* mutation observer for ripple/attachments */
const mo = new MutationObserver(()=> attachRipple(document));
mo.observe(document.body,{childList:true,subtree:true});

/* small UX */
document.getElementById('clearSelection').addEventListener('click', ()=>{ chosenAirline=null; chosenDurationIdx=null; document.getElementById('selectedAir').textContent='Не выбрана'; document.querySelectorAll('.time-item').forEach(x=>x.classList.remove('selected')); renderAirlines(); if(currentPage==='routes') renderRoutesPage(); if(currentPage==='fleet') renderFleetPage(); });
document.getElementById('airSearchMain').addEventListener('input', ()=>{ renderAirlines(); if(currentPage==='routes'){ const c = document.getElementById('routesAirList'); if(c) renderAirlineList(c, filterCompany); } if(currentPage==='fleet'){ const c = document.getElementById('fleetAirList'); if(c) renderAirlineList(c, filterCompany); } });

document.querySelectorAll('.modal-backdrop').forEach(mb=>{
  mb.addEventListener('click', (ev)=>{ if(ev.target === mb){ modalHide(mb); }});
});

function attachGlobalHandlers(){
  document.getElementById('closeInstruction').addEventListener('click', ()=> modalHide(document.getElementById('instructionModal')));
  populateFilterCompanies();
}

/* prevent accidental horizontal overflow */
window.addEventListener('resize', ()=>{ document.documentElement.style.overflowX = 'hidden'; document.body.style.overflowX = 'hidden'; });

</script>
</body>
</html>




