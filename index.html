<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lufthansa Helper — Redesigned</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<style>
/* =======================
   Variables & base
   ======================= */
:root{
  --bg-1:#031022; --bg-2:#063046;
  --text:#eaf4ff; --muted:rgba(234,244,255,0.68);
  --accent:#ffd54a; --accent2:#ffbf3a;
  --glass-border:rgba(255,255,255,0.06);
  --card-bg:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
  --glass-blur:blur(10px);
  font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  font-size:15px;
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  min-height:100vh;
  background:
    radial-gradient(900px 600px at 10% 10%, rgba(6,24,44,0.36), transparent 34%),
    radial-gradient(700px 500px at 90% 0%, rgba(4,20,36,0.28), transparent 30%),
    linear-gradient(160deg,var(--bg-1),var(--bg-2));
  color:var(--text);
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  padding:18px;
}

/* Utility */
.row{display:flex;gap:12px;align-items:center}
.col{display:flex;flex-direction:column;gap:8px}
.btn{padding:10px 14px;border-radius:12px;border:1px solid var(--glass-border);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.03));color:var(--text);font-weight:800;cursor:pointer;transition:transform .12s}
.btn:active{transform:translateY(1px)}
.btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#06141e;box-shadow:0 18px 80px rgba(255,170,40,0.12)}
.subtitle{font-size:13px;color:var(--muted)}

/* =======================
   Shell & topbar
   ======================= */
.shell{
  max-width:1200px;margin:0 auto;border-radius:16px;overflow:hidden;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
  border:1px solid var(--glass-border); box-shadow:0 40px 140px rgba(0,0,0,0.55);
}
.topbar{
  display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.02);
  gap:12px;position:sticky;top:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
  z-index:20;
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:900;color:var(--accent);background:linear-gradient(180deg,#052b36,#041721);box-shadow:0 12px 44px rgba(0,0,0,0.5)}
.title{font-weight:900}
.session{display:flex;gap:8px;align-items:center}

/* Tabs: desktop shows full tabs, mobile collapses into hamburger */
.tabs{display:flex;gap:8px;align-items:center}
.tab{
  padding:10px 12px;border-radius:12px;font-weight:800;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .12s;
}
.tab.active{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#06141e;transform:translateY(-4px);box-shadow:0 34px 120px rgba(255,170,40,0.12)}
.underline{position:absolute;bottom:-10px;height:8px;border-radius:8px;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 18px 60px rgba(255,170,40,0.10);transition:left .22s, width .22s, opacity .22s;opacity:0}

/* Hamburger for mobile */
.hamburger{display:none;padding:8px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.02)}
.hamburger .bar{width:20px;height:2px;background:var(--text);margin:3px 0;border-radius:2px}

/* =======================
   Content layout
   ======================= */
.container{display:grid;grid-template-columns:1fr 380px;gap:18px;padding:18px}
@media(max-width:900px){ .container{grid-template-columns:1fr;padding:12px} }

/* Panels */
.panel{padding:16px;border-radius:12px;background:var(--card-bg);border:1px solid var(--glass-border);backdrop-filter: blur(8px) saturate(140%); box-shadow:0 18px 60px rgba(0,0,0,0.45)}
.panel h3{font-weight:900}
.controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

/* =======================
   Inputs - liquid glass
   ======================= */
.input-glass{
  padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.03));
  color:var(--text);outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);
  transition:transform .12s, box-shadow .12s;
}
.input-glass:focus{transform:translateY(-3px);box-shadow:0 22px 80px rgba(0,0,0,0.48), 0 0 30px rgba(255,200,50,0.06)}

/* =======================
   Airline cards - new design
   ======================= */
.airline-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.airline{
  display:flex;align-items:center;gap:14px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));
  border:1px solid rgba(255,255,255,0.03);cursor:pointer;transition:transform .16s,box-shadow .16s,border-color .16s;
  min-height:64px; position:relative;
}
.brand-dot{width:36px;height:36px;border-radius:8px;flex:0 0 36px;box-shadow:0 12px 40px rgba(0,0,0,0.36), inset 0 1px 0 rgba(255,255,255,0.04)}
.airline .name{font-weight:900}
.airline .meta{font-size:13px;color:var(--muted);margin-top:4px}
.code-pill{margin-left:auto;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,0.14);border:1px solid rgba(255,255,255,0.03);font-weight:900;font-family:ui-monospace,monospace}
.selected-badge{position:absolute;right:10px;top:10px;padding:6px 8px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#06141e;font-weight:800;transform:translateY(-6px);opacity:0;transition:all .18s}
.airline:hover{transform:translateY(-6px);box-shadow:0 36px 120px rgba(0,0,0,0.48)}
.airline:active{transform:translateY(-2px)}
.airline:focus-visible{outline:2px solid rgba(30,111,255,0.18);outline-offset:4px}
.airline.selected{border:1px solid rgba(255,190,60,0.28);box-shadow:0 44px 160px rgba(255,180,60,0.09);transform:translateY(-6px) scale(1.02)}
.airline.selected .code-pill{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#06141e}
.airline.selected .selected-badge{transform:none;opacity:1}

/* =======================
   Lists (routes, fleet, flights)
   ======================= */
.list{max-height:620px;overflow:auto;padding-right:6px}
.row-card{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.03);margin-bottom:10px}
.row-card .left{min-width:0}
.row-card .title{font-weight:900}
.row-card .muted{font-size:13px;color:var(--muted)}

/* current flight visual */
.current-flight{outline:2px solid rgba(30,111,255,0.12);box-shadow:0 40px 160px rgba(30,111,255,0.06)}

/* detail panel (mobile: inline under content) */
.detail-panel{position:fixed;right:20px;top:120px;width:360px;border-radius:12px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));border:1px solid rgba(255,255,255,0.03);box-shadow:0 40px 160px rgba(0,0,0,0.6);display:none;z-index:60}
.detail-panel.show{display:block}
@media(max-width:900px){ .detail-panel{position:static;width:auto;margin-top:12px} }

/* instruction modal small tweaks */
.instructions .step{margin-top:12px;padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03));border:1px solid rgba(255,255,255,0.03)}

/* small screens: show hamburger, collapse tabs horizontally */
@media(max-width:900px){
  .tabs{display:none}
  .hamburger{display:inline-flex}
  .container{grid-template-columns:1fr;padding:12px}
  .airline-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
  .topbar{padding:10px}
}
</style>
</head>
<body>

<!-- App Shell -->
<div class="shell" role="application" aria-label="Lufthansa Helper">

  <!-- Topbar -->
  <div class="topbar">
    <div class="brand">
      <div class="logo">LH</div>
      <div>
        <div class="title">Lufthansa Helper</div>
        <div class="subtitle">liquid glass · tactile</div>
      </div>
    </div>

    <!-- Tabs (desktop) -->
    <div class="tabs" id="tabs">
      <div class="tab active" data-page="home">Главная</div>
      <div class="tab" data-page="routes">Направления</div>
      <div class="tab" data-page="fleet">Флот</div>
      <div class="tab" data-page="pilots">Пилоты</div>
      <div class="tab" data-page="flights">Рейсы</div>
    </div>

    <!-- Hamburger (mobile) -->
    <button class="hamburger" id="hamburger" aria-label="Меню">
      <span class="bar"></span><span class="bar"></span><span class="bar"></span>
    </button>

    <div class="session">
      <div id="sessionBadge" class="subtitle">Неавторизован</div>
      <button id="openGateBtn" class="btn">Вход</button>
      <button id="logoutBtn" class="btn" style="display:none">Выйти</button>
    </div>
  </div>

  <!-- Content -->
  <div class="container">

    <!-- Main column -->
    <main>

      <!-- Home page -->
      <section id="page-home" class="panel page active">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Фильтры</h3>
          <div class="subtitle">Выбор авиакомпании и интервала времени</div>
        </div>

        <div class="controls" style="margin-top:12px">
          <input id="airSearch" class="input-glass" placeholder="Поиск авиакомпании или кода" />
          <button id="genBtn" class="btn btn-primary">СГЕНЕРИРОВАТЬ</button>
          <button id="openInstructionBtn" class="btn">Инструкция</button>
        </div>

        <div id="durations" style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap"></div>

        <div id="airGrid" class="airline-grid" style="margin-top:12px"></div>
      </section>

      <!-- Routes -->
      <section id="page-routes" class="panel page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Направления</h3>
          <div class="subtitle">Список доступных маршрутов</div>
        </div>
        <div id="routesList" class="list" style="margin-top:12px"></div>
      </section>

      <!-- Fleet -->
      <section id="page-fleet" class="panel page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Флот</h3>
          <div class="subtitle">Самолёты и статус</div>
        </div>
        <div id="fleetList" class="list" style="margin-top:12px"></div>
      </section>

      <!-- Pilots -->
      <section id="page-pilots" class="panel page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Пилоты</h3>
          <div class="subtitle">Demo</div>
        </div>
        <div id="pilotList" class="list" style="margin-top:12px"></div>
      </section>

      <!-- Flights -->
      <section id="page-flights" class="panel page" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Рейсы</h3>
          <div class="subtitle">Текущий и сохранённые рейсы пилота</div>
        </div>
        <div id="confirmedList" class="list" style="margin-top:12px"></div>
      </section>
    </main>

    <!-- Right column: quick overview -->
    <aside>
      <div class="panel">
        <h4>Краткий обзор</h4>
        <div style="margin-top:8px" class="subtitle">Выбранная авиакомпания и текущие активные рейсы</div>
        <div id="quickSelected" style="margin-top:12px"></div>
      </div>

      <div id="upcomingPanel" class="panel" style="margin-top:14px">
        <h4>Последние действия</h4>
        <div id="activity" class="subtitle" style="margin-top:10px">Пусто</div>
      </div>
    </aside>
  </div>
</div>

<!-- Modals -->
<!-- Gate -->
<div id="gateModal" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:80">
  <div style="width:min(640px,92%);padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border:1px solid var(--glass-border);box-shadow:0 40px 120px rgba(0,0,0,0.6)">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900">Вход</div>
      <div class="subtitle">Введите позывной и пароль</div>
    </div>
    <div style="margin-top:12px">
      <input id="loginCall" class="input-glass" placeholder="Позывной (callSign)" />
    </div>
    <div style="margin-top:8px">
      <input id="loginPass" class="input-glass" type="password" placeholder="Пароль" />
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="btnLogin" class="btn btn-primary">Войти</button>
    </div>
  </div>
</div>

<!-- Instruction modal -->
<div id="instructionModal" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:90">
  <div style="width:min(820px,96%);max-height:86vh;overflow:auto;padding:18px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border:1px solid var(--glass-border);box-shadow:0 40px 160px rgba(0,0,0,0.6)">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:18px">Инструкция</div>
      <div class="subtitle">Все действия и анимации</div>
    </div>
    <div style="margin-top:12px" class="instructions">
      <div class="step">
        <h4>Вход</h4>
        <div class="subtitle">Введи позывной и пароль. Если учётная запись пилота есть в списке — её рейсы загрузятся.</div>
      </div>
      <div class="step">
        <h4>Фильтры</h4>
        <div class="subtitle">Поиск по названию/коду авиакомпании, выбор интервала времени. Нажми СГЕНЕРИРОВАТЬ — выберется подходящий маршрут.</div>
      </div>
      <div class="step">
        <h4>Подтверждение рейса</h4>
        <div class="subtitle">При подтверждении — рейс сохраняется у пилота. На странице «Рейсы» можно открыть детали, отметить «Прилетел» или «Отменить».</div>
      </div>
      <div class="step">
        <h4>Детали рейса</h4>
        <div class="subtitle">Клика по текущему рейсу откроет подробную панель с ETA, остатком топлива, turnaround и временем подтверждения.</div>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="closeInstruction" class="btn">Закрыть</button>
    </div>
  </div>
</div>

<!-- Confirm modal -->
<div id="confirmModal" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:85">
  <div style="width:min(640px,92%);padding:16px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));border:1px solid var(--glass-border);box-shadow:0 40px 120px rgba(0,0,0,0.6)">
    <div style="font-weight:900">Подтвердить рейс</div>
    <div id="confirmDetails" class="subtitle" style="margin-top:8px"></div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:12px">
      <button id="confirmCancel" class="btn">Отменить</button>
      <button id="confirmAccept" class="btn btn-primary">Подтвердить</button>
    </div>
  </div>
</div>

<!-- Flight detail panel -->
<div id="flightDetail" class="detail-panel" role="dialog" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div id="detailTitle" style="font-weight:900">Рейс</div>
    <div id="detailStatus" class="subtitle"></div>
  </div>
  <div id="detailBody" style="margin-top:10px" class="subtitle"></div>
  <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
    <button id="btnArrived" class="btn">Прилетел</button>
    <button id="btnCancelFlight" class="btn">Отменить рейс</button>
    <button id="closeDetail" class="btn btn-primary">Закрыть</button>
  </div>
</div>

<script>
/* =======================
   Data / state
   ======================= */
const DURATIONS = [
  {label:"1–2ч",min:60,max:120},{label:"2–3ч",min:120,max:180},{label:"3–4ч",min:180,max:240},
  {label:"4–5ч",min:240,max:300},{label:"5–6ч",min:300,max:360}
];
const AIRLINES = [
  {name:"Lufthansa",code:"LH",colorA:"#1E6FFF",colorB:"#0F4EDC"},
  {name:"Lufthansa Cargo",code:"G0",colorA:"#0A63D6",colorB:"#0747A6"},
  {name:"Swiss",code:"LX",colorA:"#D81E5B",colorB:"#B71543"},
  {name:"Austrian",code:"OS",colorA:"#DA291C",colorB:"#A71D1D"},
  {name:"Eurowings",code:"EW",colorA:"#8A4BFF",colorB:"#6A29E8"}
];

let ROUTES = []; (function(){ let seq=100; const base=["EDDF","EGLL","LFPG","LEBL","LSZH","KJFK","EHAM"]; AIRLINES.forEach((a,ai)=>{ for(let i=0;i<6;i++){ const from=base[(ai*2+i)%base.length]; const to=base[(ai*2+i+2)%base.length]; const dur=80 + (i*25) + (ai*8); ROUTES.push({ id:`${a.code}-${seq++}`, airline:a.name, airlineCode:a.code, fromICAO:from, toICAO:to, fromCity:'City-'+from, toCity:'City-'+to, durationMinutes:dur }); } }); })();

let FLEET = []; (function(){ AIRLINES.forEach((a,ai)=>{ const types=["A320","A321","B737","A220"]; for(let i=1;i<=3;i++){ FLEET.push({ id:`${a.code}-AC${String(i).padStart(2,'0')}`, airline:a.name, type:types[(ai+i)%types.length], locationICAO:i===1?"EDDF":(i===2?"EGLL":"LSZH"), status:"idle", fuelMinutes:420 + i*70, turnaround:20 + i*5, reserveMargin:30 }); } }); })();

let PILOTS = [
  {id:"pilot_ivan",name:"Ivan Petrov",callSign:"IPET",verified:true,password:"ivanpass"},
  {id:"pilot_loui",name:"Loui Desulier",callSign:"FRENCH",verified:true,password:"louiSecret"}
];

let SESSION = { pilotId:null };
let CONFIRMED_FLIGHTS = []; // saved per pilot in localStorage
let chosenAirline = null;
let chosenDurationIdx = null;
let searchQuery = '';
let PENDING_RESERVATION = null;

/* DOM refs */
const tabs = document.getElementById('tabs');
const pages = { home: document.getElementById('page-home'), routes: document.getElementById('page-routes'), fleet: document.getElementById('page-fleet'), pilots: document.getElementById('page-pilots'), flights: document.getElementById('page-flights') };
const airGrid = document.getElementById('airGrid');
const durationsEl = document.getElementById('durations');
const routesList = document.getElementById('routesList');
const fleetList = document.getElementById('fleetList');
const pilotList = document.getElementById('pilotList');
const confirmedList = document.getElementById('confirmedList');
const sessionBadge = document.getElementById('sessionBadge');
const openGateBtn = document.getElementById('openGateBtn');
const logoutBtn = document.getElementById('logoutBtn');
const gateModal = document.getElementById('gateModal');
const instructionModal = document.getElementById('instructionModal');
const confirmModal = document.getElementById('confirmModal');
const loginCall = document.getElementById('loginCall');
const loginPass = document.getElementById('loginPass');
const btnLogin = document.getElementById('btnLogin');
const splash = null; // no separate splash now
const airSearch = document.getElementById('airSearch');
const genBtn = document.getElementById('genBtn');
const openInstructionBtn = document.getElementById('openInstructionBtn');
const closeInstruction = document.getElementById('closeInstruction');
const confirmDetails = document.getElementById('confirmDetails');
const confirmAccept = document.getElementById('confirmAccept') || document.getElementById('confirmAccept'); // safe
const confirmCancel = document.getElementById('confirmCancel');
const quickSelected = document.getElementById('quickSelected');
const activity = document.getElementById('activity');
const hamburger = document.getElementById('hamburger');
const underline = document.querySelector('.underline') || null;

/* Detail panel */
const flightDetail = document.getElementById('flightDetail');
const detailTitle = document.getElementById('detailTitle');
const detailStatus = document.getElementById('detailStatus');
const detailBody = document.getElementById('detailBody');
const btnArrived = document.getElementById('btnArrived');
const btnCancelFlight = document.getElementById('btnCancelFlight');
const closeDetail = document.getElementById('closeDetail');

/* Helpers */
function nowMs(){ return Date.now(); }
function show(el){ el.style.display = 'block' }
function hide(el){ el.style.display = 'none' }
function showModal(el){ el.style.display='flex' }
function hideModal(el){ el.style.display='none' }
function flightsKey(pid){ return 'lh_flights_' + pid }

/* =======================
   Navigation (tabs + hamburger for mobile)
   ======================= */
function activatePage(id){
  Object.keys(pages).forEach(k=>{
    pages[k].style.display = (k===id) ? 'block' : 'none';
    pages[k].classList.toggle('active', k===id);
  });
  // render relevant data
  if(id==='home'){ renderDurations(); renderAirlines(); }
  if(id==='routes'){ renderRoutes(); }
  if(id==='fleet'){ renderFleet(); }
  if(id==='pilots'){ renderPilots(); }
  if(id==='flights'){ renderConfirmed(); }
}
tabs.querySelectorAll('.tab').forEach(tab=>{
  tab.addEventListener('click', ()=>{
    tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
    activatePage(tab.dataset.page);
  });
});
hamburger && hamburger.addEventListener('click', ()=>{
  // show a simple menu to switch tabs on mobile
  const list = Array.from(tabs.querySelectorAll('.tab')).map(t=>t.dataset.page + ':' + t.textContent).join(',');
  const choice = prompt('Открыть вкладку (home/routes/fleet/pilots/flights):', 'home');
  if(choice) {
    const tab = tabs.querySelector('.tab[data-page="'+choice+'"]');
    if(tab){ tab.click(); window.scrollTo({top:0,behavior:'smooth'}) }
    else alert('Неверная вкладка');
  }
});

/* =======================
   Ripple helper (tactile feedback)
   ======================= */
function attachRipple(scope=document){
  const els = scope.querySelectorAll('.btn, .airline, .pill');
  els.forEach(el=>{
    if(el._rip) return; el._rip=true;
    el.addEventListener('pointerdown', ev=>{
      let r = el.querySelector('.ripple');
      if(!r){ r = document.createElement('span'); r.className='ripple'; r.style.position='absolute'; r.style.borderRadius='50%'; r.style.pointerEvents='none'; r.style.background='rgba(255,255,255,0.9)'; el.prepend(r); }
      const rect=el.getBoundingClientRect(); const size=Math.max(rect.width,rect.height)*1.6;
      r.style.width=size+'px'; r.style.height=size+'px';
      r.style.left=(ev.clientX-rect.left-size/2)+'px'; r.style.top=(ev.clientY-rect.top-size/2)+'px';
      r.style.transform='scale(0)'; r.style.opacity='.36'; r.style.transition='transform 420ms cubic-bezier(.2,.9,.2,1), opacity 360ms';
      requestAnimationFrame(()=> r.style.transform='scale(1)');
      setTimeout(()=> r.style.opacity='0',420);
    }, {passive:true});
  });
}

/* =======================
   Renderers
   ======================= */
function renderDurations(){
  durationsEl.innerHTML='';
  DURATIONS.forEach((d,i)=>{
    const btn = document.createElement('div');
    btn.className='pill';
    btn.textContent = d.label;
    btn.style.padding='8px 12px'; btn.style.borderRadius='10px'; btn.style.background='linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03))'; btn.style.border='1px solid rgba(255,255,255,0.03)'; btn.style.fontWeight='800'; btn.style.cursor='pointer';
    if(chosenDurationIdx===i) { btn.style.boxShadow='0 26px 76px rgba(255,180,60,0.12)'; btn.style.outline='2px solid rgba(255,190,60,0.14)'; }
    btn.addEventListener('click', ()=>{ chosenDurationIdx = (chosenDurationIdx===i?null:i); renderDurations(); renderRoutes(); });
    durationsEl.appendChild(btn);
  });
  attachRipple(durationsEl);
}

function renderAirlines(){
  airGrid.innerHTML='';
  const filtered = AIRLINES.filter(a=>{
    if(!searchQuery) return true;
    const q = searchQuery.toLowerCase();
    return a.name.toLowerCase().includes(q) || a.code.toLowerCase().includes(q);
  });
  filtered.forEach(a=>{
    const card = document.createElement('div'); card.className='airline'; card.tabIndex=0;
    card.innerHTML = `
      <div class="brand-dot" style="background:linear-gradient(180deg, ${a.colorA}, ${a.colorB});"></div>
      <div style="min-width:0">
        <div class="name">${a.name}</div>
        <div class="meta">${a.code}</div>
      </div>
      <div class="code-pill">${a.code}</div>
      <div class="selected-badge" aria-hidden="true">Выбрано</div>
    `;
    card.addEventListener('click', ()=>{
      chosenAirline = (chosenAirline===a.name?null:a.name);
      renderAirlines(); renderRoutes(); updateQuickSelected();
    });
    card.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ card.click(); } });
    if(chosenAirline===a.name) card.classList.add('selected');
    airGrid.appendChild(card);
  });
  attachRipple(airGrid);
}

function renderRoutes(){
  routesList.innerHTML='';
  const list = ROUTES.filter(r=>{
    if(chosenAirline && r.airline !== chosenAirline) return false;
    if(chosenDurationIdx !== null){ const d=DURATIONS[chosenDurationIdx]; if(!(r.durationMinutes>=d.min && r.durationMinutes<=d.max)) return false; }
    return true;
  });
  if(!list.length){ routesList.innerHTML = '<div class="subtitle">Нет направлений по текущим фильтрам</div>'; return; }
  list.forEach(r=>{
    const row = document.createElement('div'); row.className='row-card';
    row.innerHTML = `<div class="left"><div class="title">${r.fromICAO} → ${r.toICAO} · ${r.airlineCode}</div><div class="muted">${r.fromCity} → ${r.toCity}</div></div>
      <div style="text-align:right"><div class="muted">${r.durationMinutes} мин</div><div style="margin-top:8px"><button class="btn btn-primary" data-id="${r.id}">Выбрать</button></div></div>`;
    routesList.appendChild(row);
  });
  routesList.querySelectorAll('button[data-id]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const route = ROUTES.find(x=>x.id===b.dataset.id);
      if(!SESSION.pilotId){ showModal(gateModal); return; }
      openConfirmFromRoute(route);
    });
  });
  attachRipple(routesList);
}

function renderFleet(){
  fleetList.innerHTML='';
  FLEET.forEach(f=>{
    const row = document.createElement('div'); row.className='row-card';
    row.innerHTML = `<div class="left"><div class="title">${f.id}</div><div class="muted">${f.airline} · ${f.type} · ${f.fuelMinutes} мин · ${f.locationICAO} · ${f.status}</div></div>`;
    if(f.status === 'inFlight') row.classList.add('current-flight');
    fleetList.appendChild(row);
  });
}

function renderPilots(){
  pilotList.innerHTML='';
  PILOTS.forEach(p=>{
    const row = document.createElement('div'); row.className='row-card';
    row.innerHTML = `<div class="left"><div class="title">${p.name}</div><div class="muted">${p.callSign} ${p.verified? '· Verified' : ''}</div></div><div><button class="btn">Войти</button></div>`;
    row.querySelector('button').addEventListener('click', ()=>{ loginCall.value = p.callSign; loginPass.value = ''; showModal(gateModal); });
    pilotList.appendChild(row);
  });
  attachRipple(pilotList);
}

function renderConfirmed(){
  confirmedList.innerHTML='';
  if(!SESSION.pilotId){ confirmedList.innerHTML = '<div class="subtitle">Войдите, чтобы видеть ваши рейсы</div>'; return; }
  if(CONFIRMED_FLIGHTS.length===0){ confirmedList.innerHTML = '<div class="subtitle">Нет подтверждённых рейсов</div>'; return; }
  CONFIRMED_FLIGHTS.forEach((f, idx)=>{
    const row = document.createElement('div'); row.className='row-card';
    row.innerHTML = `<div class="left"><div class="title">${f.aircraftId} · ${f.fromICAO} → ${f.toICAO}</div><div class="muted">Пилот ${f.pilotCallsign} · ${f.durationMinutes} мин · ${new Date(f.ts).toLocaleString()}</div></div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div><button class="btn" data-action="view" data-idx="${idx}">Детали</button></div>
        <div>
          ${f.status==='inFlight' ? `<button class="btn btn-primary" data-action="arrived" data-idx="${idx}">Прилетел</button>` : ''}
          <button class="btn" data-action="cancel" data-idx="${idx}">Отменить</button>
        </div>
      </div>`;
    if(f.status==='inFlight') row.classList.add('current-flight');
    confirmedList.appendChild(row);
  });
  // attach actions
  confirmedList.querySelectorAll('button[data-action]').forEach(b=>{
    const action = b.dataset.action, idx = Number(b.dataset.idx);
    b.addEventListener('click', ()=>{
      const f = CONFIRMED_FLIGHTS[idx];
      if(!f) return;
      if(action==='view') openFlightDetail(f, idx);
      if(action==='arrived') markFlightArrived(idx);
      if(action==='cancel') cancelFlight(idx);
    });
  });
  attachRipple(confirmedList);
}

/* quick selected UI */
function updateQuickSelected(){
  quickSelected.innerHTML = '';
  if(!chosenAirline){ quickSelected.innerHTML = '<div class="subtitle">Авиакомпания не выбрана</div>'; return; }
  const a = AIRLINES.find(x=>x.name===chosenAirline);
  if(!a){ quickSelected.innerHTML = '<div class="subtitle">—</div>'; return; }
  quickSelected.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div style="width:28px;height:28px;border-radius:8px;background:linear-gradient(180deg,${a.colorA},${a.colorB})"></div><div style="font-weight:900">${a.name}</div></div>`;
}

/* =======================
   Confirm flow / aircraft matching
   ======================= */
function findCandidateAircraftForRoute(route){
  const dur = Number(route.durationMinutes) || 0;
  const can = ac => ac.status==='idle' && (ac.fuelMinutes >= dur + (ac.reserveMargin||30));
  let cand = FLEET.filter(ac => (ac.locationICAO||'').toUpperCase() === (route.fromICAO||'').toUpperCase() && can(ac));
  if(!cand.length) cand = FLEET.filter(can);
  cand.sort((a,b)=> (b.fuelMinutes||0) - (a.fuelMinutes||0));
  return cand[0] || null;
}

function openConfirmFromRoute(route){
  const pilot = PILOTS.find(x=>x.id===SESSION.pilotId) || { id:SESSION.pilotId, callSign:SESSION.pilotId };
  const candidate = findCandidateAircraftForRoute(route);
  if(!candidate){ alert('Нет подходящих самолётов с запасом топлива'); return; }
  candidate.status='reserved';
  candidate.reservedBy = pilot.id;
  candidate.reservedToken = pilot.id+':'+Date.now()+':'+Math.random().toString(36).slice(2,6);
  candidate.reservedUntil = Date.now() + 120000;
  PENDING_RESERVATION = { token:candidate.reservedToken, aircraft:candidate, route, pilotId:pilot.id, expires:candidate.reservedUntil };
  confirmDetails.textContent = `${candidate.id} · ${candidate.airline} · ${route.fromICAO}→${route.toICAO} · ${route.durationMinutes} мин · Пилот ${pilot.callSign}`;
  showModal(confirmModal);
}

/* confirm accept */
document.getElementById('confirmAccept')?.addEventListener('click', ()=>{ confirmAcceptAction(); });
function confirmAcceptAction(){
  if(!PENDING_RESERVATION){ hideModal(confirmModal); return; }
  const ac = FLEET.find(a=>a.reservedToken===PENDING_RESERVATION.token);
  if(!ac){ alert('Резервация потеряна'); hideModal(confirmModal); return; }
  const p = PILOTS.find(x=>x.id===PENDING_RESERVATION.pilotId) || { id:PENDING_RESERVATION.pilotId, callSign:PENDING_RESERVATION.pilotId };
  ac.fuelMinutes = Math.max(0, (ac.fuelMinutes||0) - Number(PENDING_RESERVATION.route.durationMinutes));
  ac.status = 'inFlight';
  ac.availableAt = Date.now() + (PENDING_RESERVATION.route.durationMinutes||120)*60000 + (ac.turnaround||0)*60000;
  delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil;
  const flight = {
    id: 'flt_' + Math.random().toString(36).slice(2,8),
    aircraftId: ac.id,
    airline: ac.airline,
    fromICAO: PENDING_RESERVATION.route.fromICAO,
    toICAO: PENDING_RESERVATION.route.toICAO,
    durationMinutes: PENDING_RESERVATION.route.durationMinutes,
    pilotId: p.id,
    pilotCallsign: p.callSign,
    ts: Date.now(),
    status: 'inFlight',
    fuelLeft: ac.fuelMinutes,
    turnaround: ac.turnaround
  };
  CONFIRMED_FLIGHTS.unshift(flight);
  if(SESSION.pilotId) localStorage.setItem(flightsKey(SESSION.pilotId), JSON.stringify(CONFIRMED_FLIGHTS));
  PENDING_RESERVATION = null;
  hideModal(confirmModal);
  renderFleet(); renderRoutes();
  // switch to flights
  const tab = tabs.querySelector('.tab[data-page="flights"]');
  if(tab){ tab.click(); }
}

/* cancel confirm before accept */
confirmCancel && confirmCancel.addEventListener('click', ()=>{
  if(PENDING_RESERVATION){
    const token = PENDING_RESERVATION.token;
    FLEET.forEach(a=>{ if(a.reservedToken===token){ a.status='idle'; delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; } });
    PENDING_RESERVATION = null;
  }
  hideModal(confirmModal);
});

/* =======================
   Flight actions
   ======================= */
function openFlightDetail(flight, idx){
  detailTitle.textContent = `${flight.aircraftId} · ${flight.fromICAO}→${flight.toICAO}`;
  detailStatus.textContent = (flight.status || '');
  detailBody.innerHTML = `
    <div>Пилот: <strong>${flight.pilotCallsign}</strong></div>
    <div style="margin-top:6px">Длительность: <strong>${flight.durationMinutes} мин</strong></div>
    <div style="margin-top:6px">Подтверждён: <strong>${new Date(flight.ts).toLocaleString()}</strong></div>
    <div style="margin-top:8px">Остаток топлива: <strong>${flight.fuelLeft || '—'} мин</strong></div>
    <div style="margin-top:6px">Turnaround: <strong>${flight.turnaround || '—'} мин</strong></div>
  `;
  flightDetail.dataset.idx = idx;
  flightDetail.classList.add('show');
  flightDetail.style.display='block';
}
closeDetail.addEventListener('click', ()=>{ flightDetail.classList.remove('show'); flightDetail.style.display='none'; });

btnArrived.addEventListener('click', ()=>{
  const idx = Number(flightDetail.dataset.idx); markFlightArrived(idx);
  flightDetail.classList.remove('show'); flightDetail.style.display='none';
});
btnCancelFlight.addEventListener('click', ()=>{
  const idx = Number(flightDetail.dataset.idx); cancelFlight(idx);
  flightDetail.classList.remove('show'); flightDetail.style.display='none';
});

function markFlightArrived(idx){
  const f = CONFIRMED_FLIGHTS[idx];
  if(!f) return;
  f.status = 'arrived';
  f.arrivedAt = Date.now();
  const ac = FLEET.find(a=>a.id===f.aircraftId);
  if(ac){ ac.status='idle'; delete ac.availableAt; }
  if(SESSION.pilotId) localStorage.setItem(flightsKey(SESSION.pilotId), JSON.stringify(CONFIRMED_FLIGHTS));
  renderConfirmed(); renderFleet();
}

function cancelFlight(idx){
  const f = CONFIRMED_FLIGHTS[idx];
  if(!f) return;
  const ac = FLEET.find(a=>a.id===f.aircraftId);
  if(ac){ ac.status='idle'; delete ac.reservedToken; delete ac.reservedBy; delete ac.reservedUntil; delete ac.availableAt; }
  CONFIRMED_FLIGHTS.splice(idx,1);
  if(SESSION.pilotId) localStorage.setItem(flightsKey(SESSION.pilotId), JSON.stringify(CONFIRMED_FLIGHTS));
  renderConfirmed(); renderFleet();
}

/* =======================
   Login & persistence
   ======================= */
btnLogin.addEventListener('click', ()=>{
  const cs = loginCall.value.trim(); const pass = loginPass.value.trim();
  if(!cs || !pass){ alert('Введите позывной и пароль'); return; }
  const p = PILOTS.find(x=>x.callSign.toLowerCase()===cs.toLowerCase());
  if(p && p.password===pass){ SESSION.pilotId = p.id; }
  else { SESSION.pilotId = 'guest_' + cs.toLowerCase(); }
  sessionBadge.textContent = p ? `Вошёл ${p.callSign}` : `Вошёл ${SESSION.pilotId}`;
  openGateBtn.style.display='none'; logoutBtn.style.display='inline-flex';
  hideModal(gateModal);
  // load flights for pilot
  const stored = localStorage.getItem(flightsKey(SESSION.pilotId));
  CONFIRMED_FLIGHTS = stored ? JSON.parse(stored) : [];
  // show inline instruction panel and instruction modal
  document.getElementById('inlineTour').style.display='block'; requestAnimationFrame(()=>{ document.getElementById('inlineTour').style.opacity='1'; document.getElementById('inlineTour').style.transform='translateY(0)'; });
  showModal(instructionModal);
  renderConfirmed(); renderFleet();
});

logoutBtn.addEventListener('click', ()=>{
  if(SESSION.pilotId) localStorage.setItem(flightsKey(SESSION.pilotId), JSON.stringify(CONFIRMED_FLIGHTS));
  SESSION.pilotId = null; CONFIRMED_FLIGHTS = []; sessionBadge.textContent='Неавторизован';
  openGateBtn.style.display='inline-flex'; logoutBtn.style.display='none';
  activatePage('home'); renderConfirmed();
});

/* open/close modals */
openGateBtn.addEventListener('click', ()=> showModal(gateModal));
openInstructionBtn.addEventListener('click', ()=> showModal(instructionModal));
closeInstruction.addEventListener('click', ()=> hideModal(instructionModal));

/* click confirm modal accept/cancel (buttons are inside modal earlier) */
document.querySelectorAll('#confirmModal .btn').forEach(b=>{
  if(b.textContent.trim()==='Подтвердить') b.addEventListener('click', ()=> confirmAcceptAction());
  if(b.textContent.trim()==='Отменить') b.addEventListener('click', ()=> { if(PENDING_RESERVATION){ const token=PENDING_RESERVATION.token; FLEET.forEach(a=>{ if(a.reservedToken===token){ a.status='idle'; delete a.reservedBy; delete a.reservedToken; delete a.reservedUntil; } }); PENDING_RESERVATION=null; } hideModal(confirmModal); });
});

/* =======================
   Generate & search
   ======================= */
genBtn.addEventListener('click', ()=>{
  if(!SESSION.pilotId){ showModal(gateModal); return; }
  const pool = ROUTES.filter(r=>{
    if(chosenAirline && r.airline!==chosenAirline) return false;
    if(chosenDurationIdx!==null){ const d=DURATIONS[chosenDurationIdx]; if(!(r.durationMinutes>=d.min && r.durationMinutes<=d.max)) return false; }
    return true;
  });
  if(!pool.length){ alert('Нет маршрутов по текущим фильтрам'); return; }
  const route = pool[Math.floor(Math.random()*pool.length)];
  openConfirmFromRoute(route);
});
airSearch.addEventListener('input', ()=>{ searchQuery = airSearch.value.trim(); renderAirlines(); });

/* =======================
   Maintenance: reservations & returns
   ======================= */
setInterval(()=>{
  const now = Date.now();
  FLEET.forEach(ac=>{
    if(ac.status==='reserved' && ac.reservedUntil && ac.reservedUntil <= now){
      ac.status='idle'; delete ac.reservedBy; delete ac.reservedToken; delete ac.reservedUntil;
    }
    if(ac.status==='inFlight' && ac.availableAt && ac.availableAt <= now){
      ac.status='idle'; delete ac.availableAt;
      // mark flights as arrived optionally
      CONFIRMED_FLIGHTS.forEach(f=>{ if(f.aircraftId===ac.id && f.status==='inFlight'){ f.status='arrived'; f.arrivedAt = now; } });
      if(SESSION.pilotId) localStorage.setItem(flightsKey(SESSION.pilotId), JSON.stringify(CONFIRMED_FLIGHTS));
    }
  });
  renderFleet();
}, 2500);

/* =======================
   Init
   ======================= */
function init(){
  renderDurations(); renderAirlines(); renderRoutes(); renderFleet(); renderPilots(); renderConfirmed();
  attachRipple(document);
  activatePage('home');
}
init();

/* Re-attach ripple on dynamic DOM changes */
const mo = new MutationObserver(()=> attachRipple(document));
mo.observe(document.body,{childList:true,subtree:true});
</script>
</body>
</html>
